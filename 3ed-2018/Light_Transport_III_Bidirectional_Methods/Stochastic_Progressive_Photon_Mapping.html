
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link href="https://fonts.googleapis.com/css?family=Domine|Roboto+Mono" rel="stylesheet">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

  <script async src="https://cse.google.com/cse.js?cx=003601324460585362024:4xwpwgaitgd"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
        
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <title>Stochastic Progressive Photon Mapping</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_III_Bidirectional_Methods.html">Light Transport III: Bidirectional Methods</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Stochastic Progressive Photon Mapping</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html">(Previous: The Path-Space Measurement Equation)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:photon-mapping"></span><h2>16.2 Stochastic Progressive Photon Mapping</h2><p>



</p>
<p>Photon mapping is one of a family of particle-tracing algorithms, which are
based on the idea of constructing paths starting from the lights and
connecting vertices in these paths to the camera to deposit energy on the
film.  In this section, we will start by introducing a theory of
particle-tracing algorithms and will discuss the conditions that must be
fulfilled by a particle-tracing algorithm so that arbitrary measurements
can be computed correctly using the particles created by the algorithm.  We
will then describe an implementation of a photon mapping integrator that
uses particles to estimate illumination by interpolating lighting
contributions from particles close to but not quite at the point being
shaded.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#TheoreticalBasisforParticleTracing"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:particle-tracing-theory"></span><span id="TheoreticalBasisforParticleTracing"></span><h3>16.2.1  Theoretical Basis for Particle Tracing</h3><p>



</p>
<p>Particle-tracing algorithms in computer graphics are often explained in
terms of packets of energy being shot from the light sources in the scene
that deposit energy at surfaces they intersect before scattering in new
directions.  This is an intuitive way of thinking about particle tracing,
but the intuition that it provides doesn&rsquo;t make it easy to answer basic
questions about how propagation and scattering affect the particles.  For
example, does their contribution fall off with squared distance like flux
density?  Or, which <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.589ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1975.7 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="1506" y="0"></use>
</g>
</svg> terms, if any, affect particles after
they scatter from a surface?

</p>
<p>In order to give a solid theoretical basis for particle tracing, we will
describe it using a framework introduced by
Veach (<a href="Further_Reading.html#cite:VeachThesis">1997</a>, Appendix&nbsp;4.A), which instead interprets the stored
particle histories as samples from the scene&rsquo;s equilibrium radiance
distribution.  Under certain conditions on the distribution and weights of
the particles, the particles can be used to compute estimates of nearly any
measurement based on the light distribution in the scene.  In this
framework, it is quite easy to answer questions about the details of
particle propagation like the ones earlier.  After developing this theory
here, the remainder of this section will demonstrate its application to
photon mapping.

</p>
<p>A particle-tracing algorithm generates a set of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.047ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 881.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
</g>
</svg> samples of illumination
at points <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.028ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 873.2 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="787" y="-213"></use>
</g>
</svg>, on surfaces in the scene
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.959ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 4718.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis normal p Subscript j Baseline comma omega Subscript j Baseline comma beta Subscript j Baseline right-parenthesis comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
<g transform="translate(389,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1262" y="0"></use>
<g transform="translate(1707,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2647" y="0"></use>
<g transform="translate(3092,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="801" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4050" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4439" y="0"></use>
</g>
</svg>
</div>
<p>

where each sample records incident illumination from direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.323ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1000 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal r</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="880" y="-213"></use>
</g>
</svg> and has
some throughput weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.225ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 958.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="801" y="-213"></use>
</g>
</svg> associated with it
(Figure&nbsp;<a href="#fig:photon-particle-history">16.5</a>). As the notation already indicates,
this weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.225ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 958.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="801" y="-213"></use>
</g>
</svg> will contain ratios of terms of the throughput
function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.636ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 704.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
</g>
</svg> and the associated sampling PDFs much like the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> variable of
the path tracer (Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#sec:path-implementation">14.5.4</a>). We would like to
determine the conditions on the weights and distribution of particle positions
so that we can use them to correctly compute estimates of arbitrary
measurements.

</p>
<p></p>
<span class="anchor" id="fig:photon-particle-history"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="photon-history.svg" title=""><img src="photon-history.svg" width=382 height=322 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.5: <span class="legend"> When a particle is traced
following a path from a light source, an entry in its particle history is
recorded at each surface it intersects.  Each entry in the history is
represented by
position <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.293ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 556.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
</g>
</svg>, the direction of the ray it arrived along <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg>, and
particle weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg>.</span>
</figcaption><p>
 

</p>
</div></div><p>


</p>
<p>Given an importance function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.738ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3762 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper W Subscript normal e Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1358" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1748" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2304" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="2749" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3372" y="0"></use>
</g>
</svg> that describes the measurement
to be taken, the natural condition we would like to be fulfilled is that the particles
should be distributed and weighted such that using them to compute an
estimate has the same expected value as the measurement equation for the
same importance function:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:particle-tracing-weights"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="64.748ex" height="7.676ex" style="vertical-align: -3.338ex;" viewBox="0 -1867.7 27877.5 3304.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper E left-bracket StartFraction 1 Over upper N EndFraction sigma-summation Underscript j equals 1 Overscript upper N Endscripts beta Subscript j Baseline upper W Subscript normal e Baseline left-parenthesis normal p Subscript j Baseline comma omega Subscript j Baseline right-parenthesis right-bracket equals integral Underscript upper A Endscripts integral Underscript script upper S squared Endscripts upper W Subscript normal e Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript Baseline right-parenthesis upper L Subscript normal i Superscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript Baseline right-parenthesis StartAbsoluteValue cosine theta EndAbsoluteValue normal d upper A Subscript Baseline normal d omega Subscript Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D438" d="M763 653l-20 -173c-2 -19 -3 -25 -14 -25c-9 0 -12 7 -12 12s1 12 1 18c4 27 4 29 4 53c0 82 -30 111 -152 111h-141c-44 0 -45 -4 -54 -39l-60 -241h94c92 0 110 23 131 99c3 12 5 18 14 18c7 0 12 -5 12 -11l-57 -234c-4 -15 -7 -20 -15 -20c-9 0 -13 6 -13 11 c0 3 1 6 3 11c7 30 7 42 7 49c0 25 0 46 -85 46h-99l-68 -273c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h146c171 0 208 67 273 215c2 6 4 12 13 12c12 0 12 -11 12 -11s-3 -9 -5 -14l-92 -216c-7 -16 -8 -17 -31 -17h-519c-19 0 -28 0 -28 12 c0 19 11 19 28 19c79 0 81 8 91 47l132 529c5 18 5 20 5 24c0 18 -28 18 -65 18c-19 0 -28 0 -28 11c0 20 10 20 30 20h505c25 0 30 0 27 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-5B" d="M647 -1220c0 -17 -13 -30 -30 -30h-296v3000h296c17 0 30 -13 30 -30s-13 -30 -30 -30h-236v-2880h236c17 0 30 -13 30 -30Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-5D" d="M346 -1250h-296c-17 0 -30 13 -30 30s13 30 30 30h236v2880h-236c-17 0 -30 13 -30 30s13 30 30 30h296v-3000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D434" d="M721 20c0 -20 -12 -20 -18 -20c-25 0 -88 3 -113 3c-41 0 -84 -3 -125 -3c0 0 -14 0 -14 11c0 20 10 20 24 20c20 0 72 3 72 33c0 10 -14 146 -16 167h-251c-68 -116 -69 -116 -76 -128c-8 -14 -14 -25 -14 -37c0 -25 24 -33 47 -35c7 0 16 -1 16 -12 c0 -19 -13 -19 -19 -19c-32 0 -67 3 -100 3c-28 0 -59 -3 -86 -3c-8 0 -13 5 -13 11c0 19 9 19 21 20c44 3 83 17 123 84l348 584c6 10 10 17 26 17c17 0 17 -4 19 -24l61 -625c3 -29 3 -36 65 -36c13 0 23 0 23 -11zM528 262l-32 330l-197 -330h229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D438" x="0" y="0"></use>
<g transform="translate(930,0)">
 <use xlink:href="#E1-LATINMODERNSIZE7-5B"></use>
<g transform="translate(667,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="1001" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="250" y="676"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="60" y="-704"></use>
</g>
</g>
<g transform="translate(2075,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
<g transform="translate(124,-1090)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="412" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1191" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="580" y="1627"></use>
</g>
<g transform="translate(3686,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="801" y="-213"></use>
</g>
<g transform="translate(4645,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6003" y="0"></use>
<g transform="translate(6393,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7266" y="0"></use>
<g transform="translate(7711,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="8650" y="0"></use>
 <use xlink:href="#E1-LATINMODERNSIZE7-5D" x="9040" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="10915" y="0"></use>
<g transform="translate(11972,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D434" x="812" y="-1270"></use>
</g>
<g transform="translate(13344,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(14936,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="16295" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="16685" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="17241" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="17686" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="18309" y="0"></use>
<g transform="translate(18698,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1367" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1924" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="2369" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2992" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="22246" y="0"></use>
<g transform="translate(22525,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="24031" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="24501" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="24946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D434" x="25502" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="26419" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="26976" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="27598" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:particle-tracing-weights">16.7</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p>For example, we might want to use the particles to compute the total flux
incident on a wall.  Using the definition of flux,
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="38.166ex" height="6.009ex" style="vertical-align: -2.671ex;" viewBox="0 -1437.2 16432.6 2587.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi equals integral Underscript upper A Subscript normal w normal a normal l normal l Baseline Endscripts integral Underscript script upper H squared left-parenthesis bold n Subscript Baseline right-parenthesis Endscripts upper L Subscript normal i Superscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript Baseline right-parenthesis StartAbsoluteValue cosine theta EndAbsoluteValue normal d upper A Subscript Baseline normal d omega Subscript Baseline comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D434" d="M721 20c0 -20 -12 -20 -18 -20c-25 0 -88 3 -113 3c-41 0 -84 -3 -125 -3c0 0 -14 0 -14 11c0 20 10 20 24 20c20 0 72 3 72 33c0 10 -14 146 -16 167h-251c-68 -116 -69 -116 -76 -128c-8 -14 -14 -25 -14 -37c0 -25 24 -33 47 -35c7 0 16 -1 16 -12 c0 -19 -13 -19 -19 -19c-32 0 -67 3 -100 3c-28 0 -59 -3 -86 -3c-8 0 -13 5 -13 11c0 19 9 19 21 20c44 3 83 17 123 84l348 584c6 10 10 17 26 17c17 0 17 -4 19 -24l61 -625c3 -29 3 -36 65 -36c13 0 23 0 23 -11zM528 262l-32 330l-197 -330h229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-48" d="M716 0c-35 3 -110 3 -148 3s-112 0 -147 -3v31h24c77 0 79 11 79 47v262h-299v-262c0 -36 2 -47 79 -47h24v-31c-35 3 -110 3 -148 3s-112 0 -147 -3v31h24c77 0 79 11 79 47v527c0 36 -2 47 -79 47h-24v31c35 -3 110 -3 148 -3s112 0 147 3v-31h-24 c-77 0 -79 -11 -79 -47v-234h299v234c0 36 -2 47 -79 47h-24v31c35 -3 110 -3 148 -3s112 0 147 3v-31h-24c-77 0 -79 -11 -79 -47v-527c0 -36 2 -47 79 -47h24v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D427" d="M615 0l-126 3l-126 -3v47h69v270c0 76 -21 97 -55 97c-63 0 -149 -49 -149 -158v-209h69v-47l-126 3l-126 -3v47h69v309c0 39 -7 39 -69 39v47l172 8v-108c26 51 79 108 175 108c100 0 154 -39 154 -144v-259h69v-47Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1000" y="0"></use>
<g transform="translate(2056,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D434" x="0" y="0"></use>
<g transform="translate(530,-156)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-77" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-61" x="722" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1223" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1501" y="0"></use>
</g>
</g>
</g>
<g transform="translate(4520,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-48" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="924" y="456"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-28" x="1256" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D427" x="1646" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-29" x="2285" y="0"></use>
</g>
</g>
<g transform="translate(7253,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1367" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1924" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="2369" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2992" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="10802" y="0"></use>
<g transform="translate(11080,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="12586" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="13056" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="13501" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D434" x="14057" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="14975" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="15531" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="16154" y="0"></use>
</g>
</svg>
</div>
<p>

the following importance function selects the particles that
lie on the wall and arrived from the hemisphere around the normal:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="54.817ex" height="5.509ex" style="vertical-align: -2.171ex;" viewBox="0 -1437.2 23601.6 2372" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper W Subscript normal e Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript Baseline right-parenthesis equals StartLayout Enlarged left-brace 1st Row 1st Column 1 2nd Column normal p Subscript Baseline is on wall surface and left-parenthesis omega Subscript Baseline dot bold n Subscript Baseline right-parenthesis greater-than 0 2nd Row 1st Column 0 2nd Column otherwise period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7B" d="M425 -238c0 -7 -5 -12 -12 -12c-105 0 -196 52 -196 125v250c0 58 -55 113 -130 113c-7 0 -12 5 -12 12s5 12 12 12c75 0 130 55 130 113v250c0 73 91 125 196 125c7 0 12 -5 12 -12s-5 -12 -12 -12c-75 0 -130 -49 -130 -101v-250c0 -58 -48 -104 -115 -125 c67 -21 115 -67 115 -125v-250c0 -52 55 -101 130 -101c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-66" d="M357 635c0 -24 -15 -44 -44 -44c-27 0 -43 20 -43 43c0 25 18 38 30 42c-15 7 -30 7 -33 7c-44 0 -92 -48 -92 -136v-116h117v-31h-114v-322c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v324h-79v31h79v115c0 106 85 159 155 159 c53 0 90 -33 90 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-22C5" d="M192 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D427" d="M615 0l-126 3l-126 -3v47h69v270c0 76 -21 97 -55 97c-63 0 -149 -49 -149 -158v-209h69v-47l-126 3l-126 -3v47h69v309c0 39 -7 39 -69 39v47l172 8v-108c26 51 79 108 175 108c100 0 154 -39 154 -144v-259h69v-47Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3E" d="M688 230l-581 -275c-25 -11 -42 25 -18 36l548 259l-548 259c-24 11 -7 47 18 36l581 -275c17 -8 17 -32 0 -40Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE5-7B" d="M608 -780c0 -11 -9 -20 -20 -20c-2 0 -3 0 -5 1c-145 37 -273 148 -273 261v526c0 99 -81 213 -195 243c-9 2 -15 10 -15 19s6 17 15 19c114 30 195 144 195 243v526c0 113 128 224 273 261c2 1 3 1 5 1c11 0 20 -9 20 -20c0 -9 -6 -17 -15 -19 c-114 -29 -195 -134 -195 -223v-526c0 -108 -96 -212 -215 -262c119 -50 215 -154 215 -262v-526c0 -89 81 -194 195 -223c9 -2 15 -10 15 -19Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1358" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1748" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2304" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="2749" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3372" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="4039" y="0"></use>
<g transform="translate(5096,0)">
 <use xlink:href="#E1-LATINMODERNSIZE5-7B"></use>
<g transform="translate(874,0)">
<g transform="translate(-11,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="524"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="0" y="-625"></use>
</g>
<g transform="translate(1490,0)">
<g transform="translate(0,524)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="332" y="0"></use>
<g transform="translate(888,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="332" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="610" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="1337" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="1837" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-77" x="2726" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-61" x="3448" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6C" x="3949" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6C" x="4227" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="4838" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-75" x="5232" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="5789" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-66" x="6181" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-61" x="6488" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-63" x="6988" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="7433" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-61" x="8209" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="8710" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="9266" y="0"></use>
</g>
<g transform="translate(11043,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="1234" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D427" x="1734" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2374" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3E" x="3041" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="4098" y="0"></use>
</g>
</g>
<g transform="translate(0,-625)">
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="332" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="832" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-68" x="1222" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="1778" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="2223" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-77" x="2615" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="3338" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="3616" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="4011" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="4455" y="0"></use>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>

If the conditions on the distribution of particle weights and positions are true for arbitrary
importance functions such that Equation&nbsp;(<a href="#eq:particle-tracing-weights">16.7</a>)
holds,
then the flux estimate can be computed directly as a sum of the
particle weights for the particles on the wall.
If we
want to estimate flux over a different wall, a subset of the original
wall, and so on, we only need to recompute the weighted sum with an updated
importance function. The particles and weights can be reused, and we have an
unbiased estimate for all of these measurements.  (The estimates will be
correlated, however, which is potentially a source of image artifacts.) 

</p>
<p>To see how to generate and weight particles that fulfill these
conditions, consider the task of evaluating the measurement equation
integral
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="66.04ex" height="12.176ex" style="vertical-align: -5.505ex;" viewBox="0 -2872.4 28433.7 5242.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column Blank 2nd Column integral Underscript upper A Endscripts integral Underscript script upper S squared Endscripts upper W Subscript normal e Baseline left-parenthesis normal p 0 comma omega Subscript Baseline right-parenthesis upper L left-parenthesis normal p 0 comma omega Subscript Baseline right-parenthesis StartAbsoluteValue cosine theta EndAbsoluteValue normal d omega Subscript Baseline normal d upper A Subscript Baseline left-parenthesis normal p 0 right-parenthesis 2nd Row 1st Column Blank 2nd Column equals integral Underscript upper A Endscripts integral Underscript upper A Endscripts upper W Subscript normal e Baseline left-parenthesis normal p 0 right-arrow normal p 1 right-parenthesis upper L left-parenthesis normal p 1 right-arrow normal p 0 right-parenthesis upper G left-parenthesis normal p 0 left-right-arrow normal p 1 right-parenthesis normal d upper A Subscript Baseline left-parenthesis normal p 0 right-parenthesis normal d upper A Subscript Baseline left-parenthesis normal p 1 right-parenthesis comma EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D434" d="M721 20c0 -20 -12 -20 -18 -20c-25 0 -88 3 -113 3c-41 0 -84 -3 -125 -3c0 0 -14 0 -14 11c0 20 10 20 24 20c20 0 72 3 72 33c0 10 -14 146 -16 167h-251c-68 -116 -69 -116 -76 -128c-8 -14 -14 -25 -14 -37c0 -25 24 -33 47 -35c7 0 16 -1 16 -12 c0 -19 -13 -19 -19 -19c-32 0 -67 3 -100 3c-28 0 -59 -3 -86 -3c-8 0 -13 5 -13 11c0 19 9 19 21 20c44 3 83 17 123 84l348 584c6 10 10 17 26 17c17 0 17 -4 19 -24l61 -625c3 -29 3 -36 65 -36c13 0 23 0 23 -11zM528 262l-32 330l-197 -330h229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43A" d="M760 695l-63 -255c-5 -18 -5 -20 -18 -20c-4 0 -15 0 -15 10s3 11 3 51c0 116 -59 193 -161 193c-99 0 -196 -61 -250 -129c-105 -130 -115 -295 -115 -326c0 -153 105 -210 201 -210c35 0 165 11 193 121c10 37 21 82 21 91c0 13 -5 16 -31 19c-23 2 -53 2 -53 2 c-22 0 -30 0 -30 11c0 20 12 20 21 20l140 -3c23 0 82 3 105 3c8 0 13 -4 13 -11c0 -19 -11 -20 -16 -20c-57 -1 -58 -3 -69 -48c-4 -17 -9 -34 -13 -51l-19 -77c-5 -21 -15 -59 -17 -61c0 0 -2 -4 -7 -4c-10 0 -36 37 -45 62c-18 -20 -37 -41 -87 -61 c-36 -15 -81 -24 -125 -24c-162 0 -273 115 -273 274c0 232 225 453 448 453c111 0 157 -75 166 -89l70 77c11 11 12 12 15 12c9 0 11 -7 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2194" d="M942 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-686c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4 c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72 h686c-30 20 -56 44 -78 72c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(267,0)">
<g transform="translate(0,1405)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D434" x="812" y="-1270"></use>
<g transform="translate(1371,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(2964,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4323" y="0"></use>
<g transform="translate(4712,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="5723" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="6168" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6790" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="7347" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="8028" y="0"></use>
<g transform="translate(8418,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="9428" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="9873" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10496" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="11052" y="0"></use>
<g transform="translate(11330,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="12837" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="13306" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="13751" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="14308" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="15097" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D434" x="15653" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="16404" y="0"></use>
<g transform="translate(16793,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="17804" y="0"></use>
</g>
<g transform="translate(0,-1370)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1000" y="0"></use>
<g transform="translate(2056,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D434" x="812" y="-1270"></use>
</g>
<g transform="translate(3428,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D434" x="812" y="-1270"></use>
</g>
<g transform="translate(4799,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6158" y="0"></use>
<g transform="translate(6548,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="7836" y="0"></use>
<g transform="translate(9114,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10125" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="10681" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="11362" y="0"></use>
<g transform="translate(11752,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="13040" y="0"></use>
<g transform="translate(14318,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15329" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43A" x="15885" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="16671" y="0"></use>
<g transform="translate(17061,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="18349" y="0"></use>
<g transform="translate(19627,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="20638" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="21194" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D434" x="21750" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="22501" y="0"></use>
<g transform="translate(22890,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="23901" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="24457" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D434" x="25013" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="25764" y="0"></use>
<g transform="translate(26153,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="27164" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="27553" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>

where the vertex densities <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.995ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2581.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p left-parenthesis normal p Subscript i italic comma j Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2160" y="0"></use>
</g>
</svg> are expressed as
a probability per unit area and where
the importance function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.156ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1358.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper W Subscript normal e Superscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
</svg> that describes the measurement is a black box
and thus cannot be used to drive the sampling of the integral at all.  We
can still compute an estimate of the integral with Monte Carlo integration
but must sample a set of
points <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1010.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1010.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
</svg>  from all of the surfaces in
the scene, using some sampling distribution that doesn&rsquo;t depend on <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.156ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1358.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper W Subscript normal e Superscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
</svg>
(e.g., by uniformly sampling points by surface area).  

</p>
<p>By expanding the LTE in
the integrand and applying the standard Monte Carlo estimator for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.047ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 881.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
</g>
</svg>
samples, we can find the estimator for this measurement,
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="60.809ex" height="7.509ex" style="vertical-align: -3.171ex;" viewBox="0 -1867.7 26181.6 3233.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper E left-bracket StartFraction 1 Over upper N EndFraction sigma-summation Underscript i equals 1 Overscript upper N Endscripts upper W Subscript normal e Baseline left-parenthesis normal p Subscript i comma 0 Baseline right-arrow normal p Subscript i comma 1 Baseline right-parenthesis StartSet StartFraction upper L left-parenthesis normal p Subscript i comma 1 Baseline right-arrow normal p Subscript i comma 0 Baseline right-parenthesis upper G left-parenthesis normal p Subscript i comma 0 Baseline left-right-arrow normal p Subscript i comma 1 Baseline right-parenthesis Over p left-parenthesis normal p Subscript i comma 0 Baseline right-parenthesis p left-parenthesis normal p Subscript i comma 1 Baseline right-parenthesis EndFraction EndSet right-bracket period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D438" d="M763 653l-20 -173c-2 -19 -3 -25 -14 -25c-9 0 -12 7 -12 12s1 12 1 18c4 27 4 29 4 53c0 82 -30 111 -152 111h-141c-44 0 -45 -4 -54 -39l-60 -241h94c92 0 110 23 131 99c3 12 5 18 14 18c7 0 12 -5 12 -11l-57 -234c-4 -15 -7 -20 -15 -20c-9 0 -13 6 -13 11 c0 3 1 6 3 11c7 30 7 42 7 49c0 25 0 46 -85 46h-99l-68 -273c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h146c171 0 208 67 273 215c2 6 4 12 13 12c12 0 12 -11 12 -11s-3 -9 -5 -14l-92 -216c-7 -16 -8 -17 -31 -17h-519c-19 0 -28 0 -28 12 c0 19 11 19 28 19c79 0 81 8 91 47l132 529c5 18 5 20 5 24c0 18 -28 18 -65 18c-19 0 -28 0 -28 11c0 20 10 20 30 20h505c25 0 30 0 27 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7B" d="M425 -238c0 -7 -5 -12 -12 -12c-105 0 -196 52 -196 125v250c0 58 -55 113 -130 113c-7 0 -12 5 -12 12s5 12 12 12c75 0 130 55 130 113v250c0 73 91 125 196 125c7 0 12 -5 12 -12s-5 -12 -12 -12c-75 0 -130 -49 -130 -101v-250c0 -58 -48 -104 -115 -125 c67 -21 115 -67 115 -125v-250c0 -52 55 -101 130 -101c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43A" d="M760 695l-63 -255c-5 -18 -5 -20 -18 -20c-4 0 -15 0 -15 10s3 11 3 51c0 116 -59 193 -161 193c-99 0 -196 -61 -250 -129c-105 -130 -115 -295 -115 -326c0 -153 105 -210 201 -210c35 0 165 11 193 121c10 37 21 82 21 91c0 13 -5 16 -31 19c-23 2 -53 2 -53 2 c-22 0 -30 0 -30 11c0 20 12 20 21 20l140 -3c23 0 82 3 105 3c8 0 13 -4 13 -11c0 -19 -11 -20 -16 -20c-57 -1 -58 -3 -69 -48c-4 -17 -9 -34 -13 -51l-19 -77c-5 -21 -15 -59 -17 -61c0 0 -2 -4 -7 -4c-10 0 -36 37 -45 62c-18 -20 -37 -41 -87 -61 c-36 -15 -81 -24 -125 -24c-162 0 -273 115 -273 274c0 232 225 453 448 453c111 0 157 -75 166 -89l70 77c11 11 12 12 15 12c9 0 11 -7 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2194" d="M942 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-686c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4 c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72 h686c-30 20 -56 44 -78 72c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7D" d="M425 250c0 -7 -5 -12 -12 -12c-75 0 -130 -55 -130 -113v-250c0 -73 -91 -125 -196 -125c-7 0 -12 5 -12 12s5 12 12 12c75 0 130 49 130 101v250c0 58 48 104 115 125c-67 21 -115 67 -115 125v250c0 52 -55 101 -130 101c-7 0 -12 5 -12 12s5 12 12 12 c105 0 196 -52 196 -125v-250c0 -58 55 -113 130 -113c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-7B" d="M648 -928c0 -12 -10 -22 -22 -22c-2 0 -4 0 -6 1c-155 48 -292 176 -292 299v600c0 110 -87 241 -210 279c-9 3 -16 11 -16 21s7 18 16 21c123 38 210 169 210 279v600c0 123 137 251 292 299c2 1 4 1 6 1c12 0 22 -10 22 -22c0 -10 -7 -18 -16 -21 c-122 -38 -210 -159 -210 -257v-600c0 -120 -107 -240 -237 -300c130 -60 237 -180 237 -300v-600c0 -98 88 -219 210 -257c9 -3 16 -11 16 -21Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-7D" d="M648 250c0 -10 -7 -18 -16 -21c-123 -38 -210 -169 -210 -279v-600c0 -123 -137 -251 -292 -299c-2 -1 -4 -1 -6 -1c-12 0 -22 10 -22 22c0 10 7 18 16 21c122 38 210 159 210 257v600c0 120 107 240 237 300c-130 60 -237 180 -237 300v600c0 98 -88 219 -210 257 c-9 3 -16 11 -16 21c0 12 10 22 22 22c2 0 4 0 6 -1c155 -48 292 -176 292 -299v-600c0 -110 87 -241 210 -279c9 -3 16 -11 16 -21Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-5B" d="M647 -1220c0 -17 -13 -30 -30 -30h-296v3000h296c17 0 30 -13 30 -30s-13 -30 -30 -30h-236v-2880h236c17 0 30 -13 30 -30Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-5D" d="M346 -1250h-296c-17 0 -30 13 -30 30s13 30 30 30h236v2880h-236c-17 0 -30 13 -30 30s13 30 30 30h296v-3000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D438" x="0" y="0"></use>
<g transform="translate(930,0)">
 <use xlink:href="#E1-LATINMODERNSIZE7-5B"></use>
<g transform="translate(667,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="1001" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="250" y="676"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="60" y="-704"></use>
</g>
</g>
<g transform="translate(2075,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
<g transform="translate(147,-1090)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="580" y="1627"></use>
</g>
<g transform="translate(3686,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5045" y="0"></use>
<g transform="translate(5435,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="7117" y="0"></use>
<g transform="translate(8395,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9799" y="0"></use>
<g transform="translate(10355,0)">
 <use xlink:href="#E1-LATINMODERNSIZE6-7B"></use>
<g transform="translate(750,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="12041" height="60" x="0" y="220"></rect>
<g transform="translate(60,806)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="681" y="0"></use>
<g transform="translate(1071,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2753" y="0"></use>
<g transform="translate(4031,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5435" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43A" x="5991" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6778" y="0"></use>
<g transform="translate(7167,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="8849" y="0"></use>
<g transform="translate(10128,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11532" y="0"></use>
</g>
<g transform="translate(3250,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2297" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="2853" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="3356" y="0"></use>
<g transform="translate(3746,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5150" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE6-7D" x="13032" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE7-5D" x="24138" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="25903" y="0"></use>
</g>
</svg>
</div>
<p>

We can further expand out the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.583ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 681.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript Superscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
</g>
</svg> term into the sum over paths and use
the fact that <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.754ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 7213.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper E left-bracket a b right-bracket equals upper E left-bracket a upper E left-bracket b right-bracket right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D438" d="M763 653l-20 -173c-2 -19 -3 -25 -14 -25c-9 0 -12 7 -12 12s1 12 1 18c4 27 4 29 4 53c0 82 -30 111 -152 111h-141c-44 0 -45 -4 -54 -39l-60 -241h94c92 0 110 23 131 99c3 12 5 18 14 18c7 0 12 -5 12 -11l-57 -234c-4 -15 -7 -20 -15 -20c-9 0 -13 6 -13 11 c0 3 1 6 3 11c7 30 7 42 7 49c0 25 0 46 -85 46h-99l-68 -273c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h146c171 0 208 67 273 215c2 6 4 12 13 12c12 0 12 -11 12 -11s-3 -9 -5 -14l-92 -216c-7 -16 -8 -17 -31 -17h-519c-19 0 -28 0 -28 12 c0 19 11 19 28 19c79 0 81 8 91 47l132 529c5 18 5 20 5 24c0 18 -28 18 -65 18c-19 0 -28 0 -28 11c0 20 10 20 30 20h505c25 0 30 0 27 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44E" d="M498 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293c45 0 74 -27 92 -64c3 22 18 44 42 44c17 0 29 -10 29 -27c0 -4 0 -6 -7 -34l-36 -140l-22 -90 c-11 -44 -13 -52 -13 -74c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37l50 196c1 5 3 11 3 17Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44F" d="M415 282c0 -144 -123 -293 -241 -293c-74 0 -127 62 -127 157c0 35 4 51 16 101l82 326c5 21 14 55 14 62c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-74 -301c30 31 71 60 117 60c80 0 133 -69 133 -160zM343 326 c0 64 -27 94 -63 94c-26 0 -71 -15 -120 -80c-9 -11 -9 -13 -15 -35l-22 -92c-16 -63 -16 -82 -16 -101c0 -74 33 -101 67 -101c39 0 85 36 118 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D438" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="763" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44E" x="1042" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44F" x="1571" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="2001" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2557" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D438" x="3613" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="4377" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44E" x="4655" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D438" x="5185" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="5948" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44F" x="6227" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="6656" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="6935" y="0"></use>
</g>
</svg> and the fact that for a particular sample, the expected
value
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="18.981ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 8172.3 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper E left-bracket StartFraction upper L left-parenthesis normal p Subscript i comma 1 Baseline right-arrow normal p Subscript i comma 0 Baseline right-parenthesis Over p left-parenthesis normal p Subscript i comma 0 Baseline right-parenthesis EndFraction right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D438" d="M763 653l-20 -173c-2 -19 -3 -25 -14 -25c-9 0 -12 7 -12 12s1 12 1 18c4 27 4 29 4 53c0 82 -30 111 -152 111h-141c-44 0 -45 -4 -54 -39l-60 -241h94c92 0 110 23 131 99c3 12 5 18 14 18c7 0 12 -5 12 -11l-57 -234c-4 -15 -7 -20 -15 -20c-9 0 -13 6 -13 11 c0 3 1 6 3 11c7 30 7 42 7 49c0 25 0 46 -85 46h-99l-68 -273c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h146c171 0 208 67 273 215c2 6 4 12 13 12c12 0 12 -11 12 -11s-3 -9 -5 -14l-92 -216c-7 -16 -8 -17 -31 -17h-519c-19 0 -28 0 -28 12 c0 19 11 19 28 19c79 0 81 8 91 47l132 529c5 18 5 20 5 24c0 18 -28 18 -65 18c-19 0 -28 0 -28 11c0 20 10 20 30 20h505c25 0 30 0 27 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-5B" d="M509 -921c0 -16 -13 -29 -29 -29h-247v2400h247c16 0 29 -13 29 -29s-13 -29 -29 -29h-189v-2284h189c16 0 29 -13 29 -29Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-5D" d="M295 1450v-2400h-247c-16 0 -29 13 -29 29s13 29 29 29h189v2284h-189c-16 0 -29 13 -29 29s13 29 29 29h247Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D438" x="0" y="0"></use>
<g transform="translate(930,0)">
 <use xlink:href="#E1-LATINMODERNSIZE6-5B"></use>
<g transform="translate(528,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="5945" height="60" x="0" y="220"></rect>
<g transform="translate(60,806)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="681" y="0"></use>
<g transform="translate(1071,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2753" y="0"></use>
<g transform="translate(4031,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5435" y="0"></use>
</g>
<g transform="translate(1629,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2297" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE6-5D" x="6713" y="0"></use>
</g>
</g>
</svg>
</div>
<p>

can be written as a finite sum
of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.194ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 944.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="849" y="-213"></use>
</g>
</svg> terms in just the same way that we generated a finite set of
weighted path vertices for path tracing.  If the sum is truncated with
Russian roulette such that the probability of terminating
the sum after <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.987ex" height="2.509ex" style="vertical-align: -0.671ex; margin-left: -0.029ex;" viewBox="-12.5 -791.3 425 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D457" x="0" y="0"></use>
</g>
</svg> terms is <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1279.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q Subscript i comma j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
<g transform="translate(446,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
</g>
</svg>, then the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.987ex" height="2.509ex" style="vertical-align: -0.671ex; margin-left: -0.029ex;" viewBox="-12.5 -791.3 425 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D457" x="0" y="0"></use>
</g>
</svg>th term of the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th
sample has contribution
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:particle-weight-definition"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="79.657ex" height="7.843ex" style="vertical-align: -3.338ex;" viewBox="0 -1939.5 34296.8 3376.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column Blank 2nd Column beta Subscript i comma j Baseline equals StartFraction upper L Subscript normal e Baseline left-parenthesis normal p Subscript i italic comma n Sub Subscript i Subscript Baseline right-arrow normal p Subscript i italic comma n Sub Subscript i Subscript minus 1 Baseline right-parenthesis Over p left-parenthesis normal p Subscript i italic comma n Sub Subscript i Subscript Baseline right-parenthesis EndFraction product Underscript j equals 1 Overscript n Subscript i Baseline minus 1 Endscripts StartFraction 1 Over 1 minus q Subscript i comma j Baseline EndFraction StartFraction f Subscript Baseline left-parenthesis normal p Subscript i italic comma j plus 1 Baseline right-arrow normal p Subscript i italic comma j Baseline right-arrow normal p Subscript i italic comma j minus 1 Baseline right-parenthesis upper G left-parenthesis normal p Subscript i italic comma j plus 1 Baseline left-right-arrow normal p Subscript i italic comma j Baseline right-parenthesis Over p left-parenthesis normal p Subscript i italic comma j Baseline right-parenthesis EndFraction period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-220F" d="M1221 -450h-481v54c132 0 164 45 164 110v1182h-531v-1182c0 -64 31 -110 164 -110v-54h-481v54c132 0 164 45 164 110v1072c0 64 -31 110 -164 110v54h1165v-54c-132 0 -164 -45 -164 -110v-1072c0 -64 31 -110 164 -110v-54Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43A" d="M760 695l-63 -255c-5 -18 -5 -20 -18 -20c-4 0 -15 0 -15 10s3 11 3 51c0 116 -59 193 -161 193c-99 0 -196 -61 -250 -129c-105 -130 -115 -295 -115 -326c0 -153 105 -210 201 -210c35 0 165 11 193 121c10 37 21 82 21 91c0 13 -5 16 -31 19c-23 2 -53 2 -53 2 c-22 0 -30 0 -30 11c0 20 12 20 21 20l140 -3c23 0 82 3 105 3c8 0 13 -4 13 -11c0 -19 -11 -20 -16 -20c-57 -1 -58 -3 -69 -48c-4 -17 -9 -34 -13 -51l-19 -77c-5 -21 -15 -59 -17 -61c0 0 -2 -4 -7 -4c-10 0 -36 37 -45 62c-18 -20 -37 -41 -87 -61 c-36 -15 -81 -24 -125 -24c-162 0 -273 115 -273 274c0 232 225 453 448 453c111 0 157 -75 166 -89l70 77c11 11 12 12 15 12c9 0 11 -7 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2194" d="M942 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-686c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4 c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72 h686c-30 20 -56 44 -78 72c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(267,0)">
<g transform="translate(0,28)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1677" y="0"></use>
<g transform="translate(2455,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="7804" height="60" x="0" y="220"></rect>
<g transform="translate(60,806)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1095" y="0"></use>
<g transform="translate(1485,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-69" x="685" y="-234"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="3437" y="0"></use>
<g transform="translate(4715,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-69" x="685" y="-234"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="1439" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="2218" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7294" y="0"></use>
</g>
<g transform="translate(2423,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-69" x="685" y="-234"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2567" y="0"></use>
</g>
</g>
</g>
<g transform="translate(10944,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-220F" x="159" y="0"></use>
<g transform="translate(200,-1090)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="412" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1191" y="0"></use>
</g>
<g transform="translate(0,1205)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="739" y="-238"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="980" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1759" y="0"></use>
</g>
</g>
<g transform="translate(12542,0)">
<g transform="translate(286,0)">
<rect stroke="none" width="3122" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1311" y="676"></use>
<g transform="translate(60,-687)">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="722" y="0"></use>
<g transform="translate(1723,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
<g transform="translate(446,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
</g>
</g>
</g>
</g>
<g transform="translate(16071,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="17105" height="60" x="0" y="220"></rect>
<g transform="translate(60,815)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="757" y="0"></use>
<g transform="translate(1146,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="863" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1642" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="3595" y="0"></use>
<g transform="translate(4874,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="6419" y="0"></use>
<g transform="translate(7697,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="863" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1642" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9868" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43A" x="10424" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="11211" y="0"></use>
<g transform="translate(11600,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="863" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1642" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="14050" y="0"></use>
<g transform="translate(15328,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="16595" y="0"></use>
</g>
<g transform="translate(7277,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2160" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="33416" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:particle-weight-definition">16.8</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p>Note that the path integral framework provides us with the freedom to generate
a set of particles in all sorts of different ways&mdash;i.e., with different
underlying vertex probability densities <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.995ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2581.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p left-parenthesis normal p Subscript i italic comma j Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2160" y="0"></use>
</g>
</svg>. Although the
natural approach is to start from points on lights and incrementally sample
paths using the BSDFs at the path vertices, similar to how the path-tracing
integrator generates paths (starting here from the light, rather than from the
camera), we could generate them with any number of different sampling
strategies, as long as there is nonzero probability of generating a particle at
any point where the numerator is nonzero and the particle weights
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.25ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1399.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript i comma j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
</g>
</svg> are computed using the above definition.

</p>
<p>If we only had a single measurement to make, it would be better if we used
information about <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.156ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1358.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper W Subscript normal e Superscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
</svg> and could compute the estimate more intelligently,
since the general particle-tracing approach described here may generate
many useless samples if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.156ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1358.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper W Subscript normal e Superscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
</svg> only covers a small subset of the points on
scene objects.  If we will be computing many measurements, however, the
key advantage that particle tracing brings is that we can generate the
samples and weights once and can then reuse them over a large number of
measurements, potentially computing results much more efficiently than if
the measurements were all computed from scratch.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#PhotonMapping"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:photon-mapping-theory"></span><span id="PhotonMapping"></span><h3>16.2.2  Photon Mapping</h3><p>



</p>
<p>The photon mapping algorithm is based on tracing particles into the scene and
blurring their contribution to approximate the incident illumination at
shading points.  For consistency with other descriptions of the algorithm,
we will refer to particles generated for photon mapping as photons.

</p>
<p>In order to compute reflected radiance at a point, we need to estimate the
exitant radiance equation at a point <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.293ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 556.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
</g>
</svg> in a direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg>, which
can equivalently (and cumbersomely) be written as a measurement over all
points on surfaces in the scene where a Dirac delta distribution selects
only particles precisely at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.293ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 556.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
</g>
</svg>:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="62.914ex" height="12.176ex" style="vertical-align: -5.505ex;" viewBox="0 -2872.4 27088.1 5242.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column Blank 2nd Column integral Underscript script upper S squared Endscripts upper L Subscript normal i Superscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal i Baseline EndAbsoluteValue normal d omega Subscript normal i 2nd Row 1st Column Blank 2nd Column equals integral Underscript upper A Endscripts integral Underscript script upper S squared Endscripts delta left-parenthesis normal p Subscript Baseline minus normal p Superscript prime Baseline right-parenthesis upper L Subscript normal i Superscript Baseline left-parenthesis normal p prime comma omega Subscript normal i Baseline right-parenthesis f left-parenthesis normal p prime comma omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal i Baseline EndAbsoluteValue normal d omega Subscript normal i Baseline normal d upper A Subscript Baseline left-parenthesis normal p Superscript prime Baseline right-parenthesis comma EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D434" d="M721 20c0 -20 -12 -20 -18 -20c-25 0 -88 3 -113 3c-41 0 -84 -3 -125 -3c0 0 -14 0 -14 11c0 20 10 20 24 20c20 0 72 3 72 33c0 10 -14 146 -16 167h-251c-68 -116 -69 -116 -76 -128c-8 -14 -14 -25 -14 -37c0 -25 24 -33 47 -35c7 0 16 -1 16 -12 c0 -19 -13 -19 -19 -19c-32 0 -67 3 -100 3c-28 0 -59 -3 -86 -3c-8 0 -13 5 -13 11c0 19 9 19 21 20c44 3 83 17 123 84l348 584c6 10 10 17 26 17c17 0 17 -4 19 -24l61 -625c3 -29 3 -36 65 -36c13 0 23 0 23 -11zM528 262l-32 330l-197 -330h229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FF" d="M452 667c0 -6 -2 -12 -5 -18c-7 -13 -22 -22 -36 -22c-3 0 -7 1 -11 2c-38 16 -66 48 -111 50c-11 0 -21 -1 -32 -6c-9 -5 -17 -14 -22 -23c-3 -5 -4 -11 -4 -17c0 -45 63 -124 107 -181c28 -35 49 -75 58 -122c2 -15 3 -30 3 -46c0 -33 -5 -68 -14 -102 c-24 -98 -96 -193 -184 -193c-56 0 -103 26 -130 68c-19 29 -28 63 -28 100c0 20 2 40 8 61c14 58 48 115 98 158c35 30 75 51 116 60c-30 56 -61 120 -61 173c0 19 3 36 12 51c7 14 18 26 31 34c14 9 29 13 43 16c8 1 17 2 26 2c36 0 78 -10 115 -19c13 -3 21 -13 21 -26z M330 244c0 17 -1 34 -5 50c-8 42 -26 80 -46 116l-3 5c-31 -9 -62 -29 -86 -55c-40 -42 -60 -95 -73 -147c-7 -28 -13 -57 -13 -84c0 -22 4 -43 12 -61c15 -34 45 -57 86 -57c63 0 99 79 118 152c7 27 10 55 10 81Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(267,0)">
<g transform="translate(0,1413)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
<g transform="translate(1592,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1367" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1924" y="0"></use>
<g transform="translate(2369,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3289" y="0"></use>
</g>
<g transform="translate(5437,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6195" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="6584" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7141" y="0"></use>
<g transform="translate(7586,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="8662" y="0"></use>
<g transform="translate(9107,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10027" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="10583" y="0"></use>
<g transform="translate(10861,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(12368,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="13134" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="13579" y="0"></use>
<g transform="translate(14136,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</g>
<g transform="translate(0,-1362)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1000" y="0"></use>
<g transform="translate(2056,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D434" x="812" y="-1270"></use>
</g>
<g transform="translate(3428,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FF" x="5020" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5473" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="5862" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="6641" y="0"></use>
<g transform="translate(7642,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="8586" y="0"></use>
<g transform="translate(8976,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
<g transform="translate(1367,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2312" y="0"></use>
<g transform="translate(2757,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3677" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="13209" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13762" y="0"></use>
<g transform="translate(14151,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="15096" y="0"></use>
<g transform="translate(15541,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="16617" y="0"></use>
<g transform="translate(17063,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="17982" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="18538" y="0"></use>
<g transform="translate(18817,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(20323,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="21089" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="21535" y="0"></use>
<g transform="translate(22091,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="23177" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D434" x="23734" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="24484" y="0"></use>
<g transform="translate(24874,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="25818" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="26208" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>

and so, from Equation&nbsp;(<a href="#eq:particle-tracing-weights">16.7</a>), the function
that describes the measurement is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:photon-we-func"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="33.833ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 14566.8 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper W Subscript normal e Baseline left-parenthesis normal p prime comma omega Subscript Baseline right-parenthesis equals delta left-parenthesis normal p prime minus normal p Subscript Baseline right-parenthesis f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FF" d="M452 667c0 -6 -2 -12 -5 -18c-7 -13 -22 -22 -36 -22c-3 0 -7 1 -11 2c-38 16 -66 48 -111 50c-11 0 -21 -1 -32 -6c-9 -5 -17 -14 -22 -23c-3 -5 -4 -11 -4 -17c0 -45 63 -124 107 -181c28 -35 49 -75 58 -122c2 -15 3 -30 3 -46c0 -33 -5 -68 -14 -102 c-24 -98 -96 -193 -184 -193c-56 0 -103 26 -130 68c-19 29 -28 63 -28 100c0 20 2 40 8 61c14 58 48 115 98 158c35 30 75 51 116 60c-30 56 -61 120 -61 173c0 19 3 36 12 51c7 14 18 26 31 34c14 9 29 13 43 16c8 1 17 2 26 2c36 0 78 -10 115 -19c13 -3 21 -13 21 -26z M330 244c0 17 -1 34 -5 50c-8 42 -26 80 -46 116l-3 5c-31 -9 -62 -29 -86 -55c-40 -42 -60 -95 -73 -147c-7 -28 -13 -57 -13 -84c0 -22 4 -43 12 -61c15 -34 45 -57 86 -57c63 0 99 79 118 152c7 27 10 55 10 81Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1358" y="0"></use>
<g transform="translate(1748,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2692" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3138" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3760" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="4427" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FF" x="5484" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5936" y="0"></use>
<g transform="translate(6326,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="7493" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="8493" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9050" y="0"></use>
<g transform="translate(9606,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="10363" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="10753" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="11309" y="0"></use>
<g transform="translate(11754,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="12831" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="13276" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="13898" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="14288" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:photon-we-func">16.9</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

Unfortunately, because there is a delta distribution in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.156ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1358.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper W Subscript normal e Superscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
</svg>, all of the
particle histories that were generated during the particle-tracing step
have zero probability of having nonzero contribution if
Equation&nbsp;(<a href="#eq:particle-tracing-weights">16.7</a>) is used to compute the
estimate of the measurement value (just as we will never be able to choose
a direction from a diffuse surface that intersects a point light source unless the
direction is sampled based on the light source&rsquo;s position).

</p>
<p>Here is the point at which bias is introduced into the photon mapping
algorithm.  Under the assumption that the information about illumination at
nearby points gives a reasonable approximation to illumination at the
shading point, photon mapping interpolates illumination from nearby photons
around the point being shaded; the delta function of position in
Equation&nbsp;(<a href="#eq:photon-we-func">16.9</a>) is effectively converted to a filter
function.  Given Equation&nbsp;(<a href="#eq:particle-tracing-weights">16.7</a>), the more photons
there are around the point and the higher their weights, the more radiance
is estimated to be incident at the point.

</p>
<p>One factor that contributes to photon mapping&rsquo;s efficiency is this reuse of
photons: having gone through the trouble to compute a light-carrying path,
allowing it to potentially contribute illumination at multiple points
amortizes the cost of generating it.  While photon mapping derives some
benefit from this efficiency improvement, there&rsquo;s a subtler but much
more important benefit from using nearby photons at a point: some
light-carrying paths are impossible to sample with unbiased algorithms
based on incremental path construction (including path tracing and
bidirectional path tracing), but are handled well with photon mapping.
These paths can arise in very common situations.

</p>
<p>For example, consider the task of rendering an image of a photograph with a plate of
glass in front of it.  Assume a pinhole camera model and a point light
illuminating the scene, and also assume for simplicity that the glass is
only transmissive (Figure&nbsp;<a href="#fig:difficult-sds-path">16.6</a>).  If we start a
path from the camera that passes through the glass, then the point that it
intersects the photograph is completely determined by the effect of the
refraction. At this point, none of the direct lighting strategies we have
available has any chance of sampling an incident direction that will reach
the light: because any sampled incident direction leaving the diffuse
surface will be refracted on the way out through the glass, there&rsquo;s no
chance that the refracted ray will hit the point light.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="For a flat
sheet of glass, one could implement a specialized sampling technique that
accounted for this refraction, though doing so requires moving beyond the
incremental path construction framework we&rsquo;ve used so far. Such approaches
become more challenging with more complex scene geometry.">
      <sup>&dagger;</sup>
    </button>
		  Even with an
area light source, some refracted rays may be lucky enough to hit the
light, but in general, variance will be high since most will miss it.

</p>
<p></p>
<span class="anchor" id="fig:difficult-sds-path"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="impossible-path.svg" title=""><img src="impossible-path.svg" width=416 height=206 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.6: An Impossible-to-Sample Path for Path Tracing or Bidirectional
Path Tracing. <span class="legend">
The scene includes a point light, a pinhole camera, and a diffuse surface
behind a sheet
of glass. Given a ray leaving the camera, the point at which it intersects
the diffuse surface is determined based on refraction through the glass. At
this point, only a single direction provides illumination from the point
light, but there&rsquo;s no way to sample a direction leaving the surface that will
intersect the light. The corresponding problem arises when starting the
path from the light: there&rsquo;s no way to find a path back to the camera.
</span>
</figcaption><p>
 

</p>
</div></div><p>


</p>
<p>With photon mapping, we can trace photons leaving the light, let them
refract through the glass, and deposit illumination on the diffuse surface.
With a sufficient number of photons, the surface will be densely covered,
and the photons around a point give a good estimate of the incident
illumination.

</p>
<p>A statistical technique called <em>density estimation</em><button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="
Strictly speaking, density estimation can only be used to estimate the
(normalized) density function of a set of unweighted samples. When working
with weighted samples and general unnormalized functions, 
the term <em>kernel smoothing</em> is more commonly used.
Although the latter case is the one relevant for photon mapping,
we will continue refer to it as density estimation due to the heavy
usage of this term in computer graphics.">
      <sup>&dagger;</sup>
    </button>
		
provides the
mathematical tools to perform this interpolation.  Density estimation
constructs a PDF given a set of sample points under the assumption that the
samples are distributed according to the overall distribution of some
function of interest.

Histogramming is a straightforward example of the
idea.  In 1D, the line is divided into intervals with some width, and one
can count how many samples land in each interval and normalize so that the
areas of the intervals sum to one.

</p>
<p><em>Kernel methods</em> are a more sophisticated density estimation
technique.  They generally give better results and smoother
PDFs that don&rsquo;t suffer from the discontinuities that histograms do.  Given a
kernel function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.35ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 1873 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">k left-parenthesis x right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D458" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="521" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="911" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1483" y="0"></use>
</g>
</svg> that integrates to&nbsp;1.
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="17.143ex" height="6.009ex" style="vertical-align: -2.505ex;" viewBox="0 -1508.9 7380.8 2587.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">integral Subscript negative normal infinity Superscript normal infinity Baseline k left-parenthesis x right-parenthesis normal d x equals 1 comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-221E" d="M943 216c0 -118 -76 -227 -192 -227c-79 0 -138 42 -170 69c-22 19 -23 20 -90 101c-13 -22 -102 -170 -246 -170c-119 0 -189 115 -189 226c0 118 76 227 192 227c79 0 138 -42 170 -69c22 -19 23 -20 90 -101c13 22 102 170 246 170c119 0 189 -115 189 -226zM921 216 c0 90 -54 194 -160 194c-113 0 -189 -105 -227 -173c28 -34 73 -97 101 -128c45 -49 86 -72 132 -72c84 0 154 79 154 179zM465 194c-28 34 -73 97 -101 128c-45 49 -86 72 -132 72c-84 0 -154 -79 -154 -179c0 -90 54 -194 160 -194c113 0 189 105 227 173Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-221E" x="1490" y="1540"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-221E" x="778" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D458" x="2099" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2620" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="3010" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3582" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="4138" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="4695" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="5545" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="6601" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7102" y="0"></use>
</g>
</svg>
</div>
<p>

the kernel estimator for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.047ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 881.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
</g>
</svg> samples at locations <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.129ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 916.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="809" y="-213"></use>
</g>
</svg> is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28.682ex" height="7.343ex" style="vertical-align: -3.005ex; margin-left: -0.073ex;" viewBox="-31.5 -1867.7 12349 3161.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove p With caret left-parenthesis x right-parenthesis equals StartFraction 1 Over upper N h EndFraction sigma-summation Underscript i equals 1 Overscript upper N Endscripts k left-parenthesis StartFraction x minus x Subscript i Baseline Over h EndFraction right-parenthesis comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-210E" d="M546 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 5 32 13 55c24 61 62 170 62 224c0 36 -11 70 -54 70s-74 -19 -96 -35c-34 -27 -65 -83 -68 -92c-1 -6 -9 -39 -11 -45c-5 -23 -11 -45 -17 -67l-22 -90l-19 -76c-5 -14 -21 -26 -37 -26c-9 0 -29 5 -29 28 c0 6 0 8 4 22l145 576l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-78 -318c37 46 85 77 148 77c75 0 115 -42 115 -107c0 -58 -45 -177 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE5-28" d="M608 -780c0 -9 -7 -16 -16 -16c-4 0 -7 1 -10 3c-199 150 -381 545 -381 893v300c0 348 182 743 381 893c3 2 6 3 10 3c9 0 16 -7 16 -16c0 -5 -3 -10 -6 -13c-190 -142 -323 -535 -323 -867v-300c0 -332 133 -725 323 -867c3 -3 6 -8 6 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE5-29" d="M462 100c0 -348 -182 -743 -382 -893c-2 -2 -6 -3 -9 -3c-9 0 -16 7 -16 16c0 5 2 10 6 13c190 142 323 535 323 867v300c0 332 -133 725 -323 867c-4 3 -6 8 -6 13c0 9 7 16 16 16c3 0 7 -1 9 -3c200 -150 382 -545 382 -893v-300Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="474" y="-36"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1465" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2132" y="0"></use>
<g transform="translate(2911,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="1578" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="538" y="676"></use>
<g transform="translate(60,-715)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-210E" x="881" y="0"></use>
</g>
</g>
</g>
<g transform="translate(5173,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
<g transform="translate(147,-1090)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="580" y="1627"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D458" x="6784" y="0"></use>
<g transform="translate(7473,0)">
 <use xlink:href="#E1-LATINMODERNSIZE5-28"></use>
<g transform="translate(663,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="2832" height="60" x="0" y="220"></rect>
<g transform="translate(60,677)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="794" y="0"></use>
<g transform="translate(1795,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="809" y="-213"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-210E" x="1127" y="-715"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE5-29" x="3735" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="12038" y="0"></use>
</g>
</svg>
</div>
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.339ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 576.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">h</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-210E" d="M546 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 5 32 13 55c24 61 62 170 62 224c0 36 -11 70 -54 70s-74 -19 -96 -35c-34 -27 -65 -83 -68 -92c-1 -6 -9 -39 -11 -45c-5 -23 -11 -45 -17 -67l-22 -90l-19 -76c-5 -14 -21 -26 -37 -26c-9 0 -29 5 -29 28 c0 6 0 8 4 22l145 576l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-78 -318c37 46 85 77 148 77c75 0 115 -42 115 -107c0 -58 -45 -177 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-210E" x="0" y="0"></use>
</g>
</svg> is the window width (also known as the <em>smoothing
parameter</em> or <em>kernel bandwidth</em>).
Kernel methods can be thought of as placing a series of bumps at
observation points, where the sum of the bumps forms a PDF since they
individually integrate to&nbsp;1 and the sum is normalized.
Figure&nbsp;<a href="#fig:density-1d">16.7</a> shows an example of density estimation in 1D,
where a smooth PDF is computed from a set of sample points.

</p>
<p> </p>
<span class="anchor" id="fig:density-1d"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="density-estimation-1d.svg" title=""><img src="density-estimation-1d.svg" width=360 height=214 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.7: <span class="legend"> 1D example of density estimation,
using the Epanechnikov kernel, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.869ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 10707.4 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">k left-parenthesis t right-parenthesis equals 0.75 left-parenthesis 1 minus .2 t squared right-parenthesis slash StartRoot 5 EndRoot</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-37" d="M485 644c0 -21 0 -23 -9 -35l-135 -190c-44 -62 -58 -148 -62 -171c-8 -54 -11 -109 -11 -164v-51c0 -10 0 -55 -46 -55s-46 45 -46 55c0 102 33 241 123 376l112 158h-207c-13 0 -91 0 -98 -6c-13 -12 -22 -75 -25 -91h-25l33 206h25c4 -19 6 -32 128 -32h243Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-221A" d="M853 20c0 -5 -1 -6 -6 -17l-456 -944c-7 -15 -9 -19 -25 -19c-11 0 -13 1 -19 15l-198 435l-52 -39c-9 -8 -11 -8 -14 -8c-6 0 -10 4 -10 11c0 4 1 5 12 14l99 75c9 8 11 8 14 8c7 0 9 -6 13 -14l178 -392l423 876c6 12 9 19 21 19s20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D458" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="521" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="911" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1272" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1939" y="0"></use>
<g transform="translate(2996,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4776" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="5165" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="5888" y="0"></use>
<g transform="translate(6889,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-2E"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="278" y="0"></use>
</g>
<g transform="translate(7668,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="511" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="8483" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="8872" y="0"></use>
<g transform="translate(9373,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-221A" x="0" y="788"></use>
<rect stroke="none" width="500" height="60" x="833" y="769"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="833" y="0"></use>
</g>
</g>
</svg>, if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.036ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 3029.6 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t less-than StartRoot 5 EndRoot</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3C" d="M689 -9c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-221A" d="M853 20c0 -5 -1 -6 -6 -17l-456 -944c-7 -15 -9 -19 -25 -19c-11 0 -13 1 -19 15l-198 435l-52 -39c-9 -8 -11 -8 -14 -8c-6 0 -10 4 -10 11c0 4 1 5 12 14l99 75c9 8 11 8 14 8c7 0 9 -6 13 -14l178 -392l423 876c6 12 9 19 21 19s20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3C" x="639" y="0"></use>
<g transform="translate(1695,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-221A" x="0" y="788"></use>
<rect stroke="none" width="500" height="60" x="833" y="769"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="833" y="0"></use>
</g>
</g>
</svg>, 0 otherwise, and a width of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="779" y="0"></use>
</g>
</svg>.  The points marked with
closed circles are the sample points, and an instance of the kernel (dashed
lines) is
placed over each one.  The sum of the kernels gives a properly normalized
PDF that attempts to model a distribution that the points could be
distributed by.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The key question with kernel methods is how the window width <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.339ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 576.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">h</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-210E" d="M546 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 5 32 13 55c24 61 62 170 62 224c0 36 -11 70 -54 70s-74 -19 -96 -35c-34 -27 -65 -83 -68 -92c-1 -6 -9 -39 -11 -45c-5 -23 -11 -45 -17 -67l-22 -90l-19 -76c-5 -14 -21 -26 -37 -26c-9 0 -29 5 -29 28 c0 6 0 8 4 22l145 576l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-78 -318c37 46 85 77 148 77c75 0 115 -42 115 -107c0 -58 -45 -177 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-210E" x="0" y="0"></use>
</g>
</svg> is chosen.
If it is too wide, the PDF will blur out relevant detail in parts of the
domain with many samples; if it is too narrow, the PDF will be too
bumpy in the tails of the distribution where there aren&rsquo;t many samples.
Nearest-neighbor techniques solve this problem by choosing <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.339ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 576.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">h</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-210E" d="M546 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 5 32 13 55c24 61 62 170 62 224c0 36 -11 70 -54 70s-74 -19 -96 -35c-34 -27 -65 -83 -68 -92c-1 -6 -9 -39 -11 -45c-5 -23 -11 -45 -17 -67l-22 -90l-19 -76c-5 -14 -21 -26 -37 -26c-9 0 -29 5 -29 28 c0 6 0 8 4 22l145 576l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-78 -318c37 46 85 77 148 77c75 0 115 -42 115 -107c0 -58 -45 -177 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-210E" x="0" y="0"></use>
</g>
</svg> adaptively
based on local density of samples.  Where there are many samples, the width
is small; where there are few samples, the width is large.  For
example, one approach is to pick a number <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.047ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 881.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
</g>
</svg> and find the distance to the
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.047ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 881.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
</g>
</svg>th nearest sample from the point <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> and use that distance, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.028ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2595.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">d Subscript upper N Baseline left-parenthesis x right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D451" d="M516 683l-144 -578c-4 -17 -6 -24 -6 -48c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293 c45 0 74 -27 92 -64l60 237l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 13 6 18 14 19c17 2 112 11 127 11c13 0 13 -11 13 -11zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37 l50 196c1 5 3 11 3 17Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="736" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1243" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1633" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2205" y="0"></use>
</g>
</svg>, for
the window width.  This is the <em>generalized nth nearest-neighbor
estimate:</em>
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="33.71ex" height="7.343ex" style="vertical-align: -3.005ex; margin-left: -0.073ex;" viewBox="-31.5 -1867.7 14513.8 3161.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove p With caret left-parenthesis x right-parenthesis equals StartFraction 1 Over upper N d Subscript upper N Baseline left-parenthesis x right-parenthesis EndFraction sigma-summation Underscript i equals 1 Overscript upper N Endscripts k left-parenthesis StartFraction x minus x Subscript i Baseline Over d Subscript upper N Baseline left-parenthesis x right-parenthesis EndFraction right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D451" d="M516 683l-144 -578c-4 -17 -6 -24 -6 -48c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293 c45 0 74 -27 92 -64l60 237l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 13 6 18 14 19c17 2 112 11 127 11c13 0 13 -11 13 -11zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37 l50 196c1 5 3 11 3 17Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-28" d="M682 -928c0 -10 -8 -18 -18 -18c-4 0 -8 2 -11 4c-222 167 -427 613 -427 1006v372c0 393 205 839 427 1006c3 2 7 4 11 4c10 0 18 -8 18 -18c0 -6 -3 -11 -7 -14c-213 -160 -361 -603 -361 -978v-372c0 -375 148 -818 361 -978c4 -3 7 -8 7 -14Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-29" d="M510 64c0 -393 -205 -839 -427 -1006c-3 -2 -7 -4 -11 -4c-10 0 -18 8 -18 18c0 6 3 11 7 14c213 160 361 603 361 978v372c0 375 -148 818 -361 978c-4 3 -7 8 -7 14c0 10 8 18 18 18c4 0 8 -2 11 -4c222 -167 427 -613 427 -1006v-372Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="474" y="-36"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1465" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2132" y="0"></use>
<g transform="translate(2911,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3596" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1548" y="676"></use>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
<g transform="translate(881,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="736" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2125" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="2514" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3087" y="0"></use>
</g>
</g>
</g>
<g transform="translate(7192,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
<g transform="translate(147,-1090)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="580" y="1627"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D458" x="8803" y="0"></use>
<g transform="translate(9491,0)">
 <use xlink:href="#E1-LATINMODERNSIZE6-28"></use>
<g transform="translate(736,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="2832" height="60" x="0" y="220"></rect>
<g transform="translate(60,677)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="794" y="0"></use>
<g transform="translate(1795,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="809" y="-213"></use>
</g>
</g>
<g transform="translate(118,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="736" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1243" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1633" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2205" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE6-29" x="3808" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="14203" y="0"></use>
</g>
</svg>
</div>
<p>

In <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.209ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 520.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">d</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D451" d="M516 683l-144 -578c-4 -17 -6 -24 -6 -48c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293 c45 0 74 -27 92 -64l60 237l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 13 6 18 14 19c17 2 112 11 127 11c13 0 13 -11 13 -11zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37 l50 196c1 5 3 11 3 17Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
</g>
</svg> dimensions, this generalizes to
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:density-est"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="36.606ex" height="7.343ex" style="vertical-align: -3.005ex; margin-left: -0.073ex;" viewBox="-31.5 -1867.7 15760.8 3161.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove p With caret left-parenthesis x right-parenthesis equals StartFraction 1 Over upper N left-parenthesis d Subscript upper N Baseline left-parenthesis x right-parenthesis right-parenthesis Superscript d Baseline EndFraction sigma-summation Underscript i equals 1 Overscript upper N Endscripts k left-parenthesis StartFraction x minus x Subscript i Baseline Over d Subscript upper N Baseline left-parenthesis x right-parenthesis EndFraction right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D451" d="M516 683l-144 -578c-4 -17 -6 -24 -6 -48c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293 c45 0 74 -27 92 -64l60 237l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 13 6 18 14 19c17 2 112 11 127 11c13 0 13 -11 13 -11zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37 l50 196c1 5 3 11 3 17Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-28" d="M682 -928c0 -10 -8 -18 -18 -18c-4 0 -8 2 -11 4c-222 167 -427 613 -427 1006v372c0 393 205 839 427 1006c3 2 7 4 11 4c10 0 18 -8 18 -18c0 -6 -3 -11 -7 -14c-213 -160 -361 -603 -361 -978v-372c0 -375 148 -818 361 -978c4 -3 7 -8 7 -14Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-29" d="M510 64c0 -393 -205 -839 -427 -1006c-3 -2 -7 -4 -11 -4c-10 0 -18 8 -18 18c0 6 3 11 7 14c213 160 361 603 361 978v372c0 375 -148 818 -361 978c-4 3 -7 8 -7 14c0 10 8 18 18 18c4 0 8 -2 11 -4c222 -167 427 -613 427 -1006v-372Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="474" y="-36"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1465" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2132" y="0"></use>
<g transform="translate(2911,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="4843" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2171" y="676"></use>
<g transform="translate(60,-800)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="881" y="0"></use>
<g transform="translate(1271,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="736" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2514" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="2904" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3476" y="0"></use>
<g transform="translate(3866,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D451" x="550" y="408"></use>
</g>
</g>
</g>
</g>
<g transform="translate(8439,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
<g transform="translate(147,-1090)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="580" y="1627"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D458" x="10050" y="0"></use>
<g transform="translate(10738,0)">
 <use xlink:href="#E1-LATINMODERNSIZE6-28"></use>
<g transform="translate(736,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="2832" height="60" x="0" y="220"></rect>
<g transform="translate(60,677)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="794" y="0"></use>
<g transform="translate(1795,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="809" y="-213"></use>
</g>
</g>
<g transform="translate(118,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="736" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1243" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1633" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2205" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE6-29" x="3808" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="15450" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:density-est">16.10</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p>Substituting into the measurement equation, it can be shown that the
appropriate estimator for the measurement we&rsquo;d like to compute, the exitant
radiance at the point <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.293ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 556.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
</g>
</svg> in direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg>, is given by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:photon-est-outgoing-radiance"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="55.778ex" height="7.843ex" style="vertical-align: -3.338ex;" viewBox="0 -1939.5 24015.3 3376.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal o Superscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline right-parenthesis almost-equals StartFraction 1 Over upper N Subscript normal p Baseline d Subscript upper N Baseline left-parenthesis normal p Subscript Baseline right-parenthesis squared EndFraction sigma-summation Underscript j Overscript upper N Subscript normal p Baseline Endscripts k left-parenthesis StartFraction normal p Subscript Baseline minus normal p Subscript Baseline Subscript j Baseline Over d Subscript upper N Baseline left-parenthesis normal p Subscript Baseline right-parenthesis EndFraction right-parenthesis beta Subscript j Baseline f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript Baseline Subscript j Baseline right-parenthesis comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2248" d="M717 438v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76 c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12zM717 218v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124 c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D451" d="M516 683l-144 -578c-4 -17 -6 -24 -6 -48c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293 c45 0 74 -27 92 -64l60 237l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 13 6 18 14 19c17 2 112 11 127 11c13 0 13 -11 13 -11zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37 l50 196c1 5 3 11 3 17Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-28" d="M682 -928c0 -10 -8 -18 -18 -18c-4 0 -8 2 -11 4c-222 167 -427 613 -427 1006v372c0 393 205 839 427 1006c3 2 7 4 11 4c10 0 18 -8 18 -18c0 -6 -3 -11 -7 -14c-213 -160 -361 -603 -361 -978v-372c0 -375 148 -818 361 -978c4 -3 7 -8 7 -14Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE6-29" d="M510 64c0 -393 -205 -839 -427 -1006c-3 -2 -7 -4 -11 -4c-10 0 -18 8 -18 18c0 6 3 11 7 14c213 160 361 603 361 978v372c0 375 -148 818 -361 978c-4 3 -7 8 -7 14c0 10 8 18 18 18c4 0 8 -2 11 -4c222 -167 427 -613 427 -1006v-372Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1135" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1524" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2081" y="0"></use>
<g transform="translate(2526,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3602" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2248" x="4270" y="0"></use>
<g transform="translate(5043,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="4616" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2058" y="676"></use>
<g transform="translate(60,-780)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="1136" y="-213"></use>
<g transform="translate(1463,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="736" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2707" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="3096" y="0"></use>
<g transform="translate(3653,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="550" y="408"></use>
</g>
</g>
</g>
</g>
<g transform="translate(10345,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="815" y="-1536"></use>
<g transform="translate(243,1280)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-70" x="989" y="-185"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D458" x="11956" y="0"></use>
<g transform="translate(12644,0)">
 <use xlink:href="#E1-LATINMODERNSIZE6-28"></use>
<g transform="translate(736,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="2847" height="60" x="0" y="220"></rect>
<g transform="translate(60,895)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="778" y="0"></use>
<g transform="translate(1779,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="787" y="-326"></use>
</g>
</g>
<g transform="translate(134,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="736" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1243" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1633" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2189" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE6-29" x="3824" y="0"></use>
</g>
<g transform="translate(17538,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="801" y="-213"></use>
</g>
<g transform="translate(18663,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="19420" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="19809" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="20366" y="0"></use>
<g transform="translate(20811,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="21887" y="0"></use>
<g transform="translate(22333,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="23347" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="23736" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:photon-est-outgoing-radiance">16.11</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where we&rsquo;ve switched to using <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.012ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1297 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N Subscript normal p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="1136" y="-213"></use>
</g>
</svg> to denote the total number of
emitted photons, the sum is over all of the photons, and scale factors for
the photons are computed based on the density estimation Equation,
(<a href="#eq:density-est">16.10</a>).  Because we know that the kernel function is zero
for points farther away than the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.047ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 881.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
</g>
</svg>th nearest neighbor distance <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.028ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2595.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">d Subscript upper N Baseline left-parenthesis x right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D451" d="M516 683l-144 -578c-4 -17 -6 -24 -6 -48c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293 c45 0 74 -27 92 -64l60 237l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 13 6 18 14 19c17 2 112 11 127 11c13 0 13 -11 13 -11zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37 l50 196c1 5 3 11 3 17Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="736" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1243" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1633" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2205" y="0"></use>
</g>
</svg>,
implementations of this sum only need to sum over the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.047ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 881.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
</g>
</svg> closest
neighbors.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="It should be noted that including the n-th photon of
the nearest-neighbor search can introduce additional bias;
see Garc&iacute;a et&nbsp;al. (2012) for a
discussion including alternative estimators that avoid this issue.">
      <sup>&dagger;</sup>
    </button>
		

</p>
<p>The error introduced by this interpolation can be difficult to quantify.
Tracing more photons generally increases photon density and will almost always
improve the results. When the photons are more closely spaced, it isn&rsquo;t
necessary to use photons from as far away in the nearest-neighbor estimate. In
general, the error at any given point will depend on how quickly the
illumination is changing in its vicinity.  One can always construct
pathological cases where this error is unacceptable, but in practice it usually
isn&rsquo;t too bad. Because the interpolation step tends to blur out illumination,
high-frequency changes in lighting are sometimes poorly reconstructed with
photon mapping.  
If traditional methods are used for direct lighting, then this is generally
less of a problem since indirect illumination tends to be low frequency.

</p>
<p>The original formulation of photon mapping was based on a two-pass
algorithm where photons are first traced from the light sources.  Photon
interactions are recorded on surfaces of the scene and then organized in a
spatial data structure (generally a kd-tree) for use at rendering time.  A
second pass follows paths starting from the camera; at each path vertex,
nearby photons are used to estimate indirect illumination.

</p>
<p>While this approach is effective, it has the limitation that the
number of photons that can be used is limited by available memory
since all of the photons must be stored. No improvement is possible once
memory is full, even if one wants a higher quality result from using more
photons. (In contrast, with path tracing, for example, one can always add
more samples per pixel without any incremental storage cost&mdash;only the
computational expense increases.)

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x2-ProgressivePhotonMapping"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x2-ProgressivePhotonMapping"></span><h4>Progressive Photon Mapping</h4><p>


</p>
<p>The <em>progressive photon mapping</em> algorithm addressed this issue by
restructuring the algorithm: first, a camera pass traces paths starting
from the camera.  Each pixel stores a representation of all of the non-specular path
vertices found when generating paths that started in its extent. (For example,
if a camera ray
hits a diffuse surface, we might record the geometric information about the
intersection point and the diffuse reflectance. If it hit a perfectly
specular surface and then a diffuse surface, we would record the diffuse
reflectance scaled by the specular BSDF value, and so forth.)  We will dub
these stored path vertices <em>visible points</em> in the
following.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="The term <em>hit points</em> is often used to describe these
points in the photon mapping literature. We prefer the additional clarity
of phrasing that includes the idea that these points are at least
indirectly visible from the camera.">
      <sup>&dagger;</sup>
    </button>
		  A second pass traces photons from the
light sources; at each photon&ndash;surface intersection, the photon contributes
to the reflected radiance estimate for nearby visible points.

</p>
<p>To understand how progressive photon mapping works, we consider a
decomposition of the LTE into separate integrals over direct <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.729ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1175 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal d</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-64" x="963" y="-213"></use>
</g>
</svg>
and indirect <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg> incident radiance at each vertex. (Recall the
discussion of partitioning the LTE in Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/The_Light_Transport_Equation.html#sec:lte-partition">14.4.6</a>.)

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:ppm-lte-decomp"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="59.514ex" height="18.843ex" style="vertical-align: -8.838ex;" viewBox="0 -4307.5 25624.2 8112.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column upper L left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline right-parenthesis 2nd Column equals upper L Subscript normal e Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline right-parenthesis plus integral Underscript script upper S squared Endscripts f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis upper L left-parenthesis normal p Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal i Baseline EndAbsoluteValue normal d omega Subscript normal i Baseline 2nd Row 1st Column Blank 2nd Column equals upper L Subscript normal e Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline right-parenthesis plus integral Underscript script upper S squared Endscripts f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis upper L Subscript normal d Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal i Baseline EndAbsoluteValue normal d omega Subscript normal i Baseline 3rd Row 1st Column Blank 2nd Column plus integral Underscript script upper S squared Endscripts f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis upper L Subscript normal i Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal i Baseline EndAbsoluteValue normal d omega Subscript normal i Baseline period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,2801)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="681" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1071" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1627" y="0"></use>
<g transform="translate(2072,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3149" y="0"></use>
</g>
</g>
<g transform="translate(3805,0)">
<g transform="translate(0,2801)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(1056,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2152" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="2541" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3098" y="0"></use>
<g transform="translate(3543,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4619" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="5231" y="0"></use>
<g transform="translate(6232,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(7824,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="8581" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="8971" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="9527" y="0"></use>
<g transform="translate(9973,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="11049" y="0"></use>
<g transform="translate(11494,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="12414" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="12970" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13651" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="14041" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="14597" y="0"></use>
<g transform="translate(15042,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="16518" y="0"></use>
<g transform="translate(16797,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(18303,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="19069" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="19514" y="0"></use>
<g transform="translate(20071,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</g>
<g transform="translate(0,25)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(1056,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2152" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="2541" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3098" y="0"></use>
<g transform="translate(3543,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4619" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="5231" y="0"></use>
<g transform="translate(6232,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(7824,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="8581" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="8971" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="9527" y="0"></use>
<g transform="translate(9973,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="11049" y="0"></use>
<g transform="translate(11494,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="12414" y="0"></use>
<g transform="translate(12970,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-64" x="963" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="14145" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="14534" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="15091" y="0"></use>
<g transform="translate(15536,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="16455" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="17012" y="0"></use>
<g transform="translate(17290,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(18796,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="19563" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="20008" y="0"></use>
<g transform="translate(20564,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</g>
<g transform="translate(0,-2750)">
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="4387" y="0"></use>
<g transform="translate(5554,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(7147,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="7904" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="8294" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="8850" y="0"></use>
<g transform="translate(9295,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="10372" y="0"></use>
<g transform="translate(10817,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11736" y="0"></use>
<g transform="translate(12293,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13271" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="13661" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="14217" y="0"></use>
<g transform="translate(14662,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15582" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="16138" y="0"></use>
<g transform="translate(16416,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(17923,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="18689" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="19134" y="0"></use>
<g transform="translate(19691,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="20610" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:ppm-lte-decomp">16.12</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

The emitted term is straightforward, and direct lighting can be handled
using the usual approaches from Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#sec:direct-lighting">14.3</a>.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="
Other decompositions are also possible&mdash;for instance, some implementations use
photon density estimation to handle the direct illumination component.">
      <sup>&dagger;</sup>
    </button>
		  The
indirect term with the integral over <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg> is handled in one of
two ways.  First, a ray may be sampled from the BSDF&rsquo;s sampling
distribution and traced to find the next vertex in the path, where the same
issue of how to estimate outgoing radiance is faced&mdash;just like a path
tracer.  Alternatively, the current point can be saved to receive
illumination from photons.  The final contribution of such a point to
radiance at the film plane is found by summing the product of the photons&rsquo;
weights and the
path throughput weight of the sequence of vertices before
it in the path.

</p>
<p>For a perfectly specular BSDF, the only reasonable choice is to trace
another ray: a photon will never arrive at exactly the right direction to
match the delta distribution in the BSDF.  For highly glossy surfaces, it&rsquo;s
also advisable to trace a ray, since it will take many photons for
enough to hit a narrow specular lobe to compute an accurate estimate.

</p>
<p>For diffuse surfaces, it&rsquo;s generally worth using photons, though it can be
worthwhile to trace one last bounce.  This approach is called <em>final
gathering;</em> if photons are used only after a diffuse bounce, then any
errors from insufficient photon density are generally less visible, though
more camera paths may need to be traced to eliminate noise.  (See
Exercise&nbsp;16.8 for further discussion of final gathering.)

</p>
<p>With this approach, no photon storage is needed, and an arbitrary number of
photons can be traced; the memory limit is instead tied to the storage
required for the visible points and their reflection information.  For
high-resolution images or images that require many samples per pixel to
resolve motion blur or depth of field, memory can still be a limitation.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x2-StochasticProgressivePhotonMapping"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x2-StochasticProgressivePhotonMapping"></span><h4>Stochastic Progressive Photon Mapping</h4><p>


</p>
<p>Stochastic progressive photon mapping is a modification of progressive
photon mapping that doesn&rsquo;t suffer from either of these memory limits. Like
progressive photon mapping, it generates a set of visible points from the
camera but at a low sampling rate (e.g., following just one camera
path per pixel).  Next, a number of photons are shot from lights,
accumulating contributions at nearby visible points. This process then
repeats: the visible points are discarded, a new set is generated at
different positions, another round of photons is traced, and so forth.

</p>
<p>SPPM starts with the photon estimation equation,
(<a href="#eq:photon-est-outgoing-radiance">16.11</a>), and makes two adjustments.  First,
it uses a constant kernel function; in conjunction with the fact that the
estimation is over 2D (the local tangent plane around the visible point),
we have
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="39.196ex" height="7.843ex" style="vertical-align: -3.338ex;" viewBox="0 -1939.5 16875.9 3376.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal o Superscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline right-parenthesis almost-equals StartFraction 1 Over upper N Subscript normal p Baseline pi r squared EndFraction sigma-summation Underscript j Overscript upper N Subscript normal p Baseline Endscripts beta Subscript j Baseline f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript Baseline Subscript j Baseline right-parenthesis comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2248" d="M717 438v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76 c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12zM717 218v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124 c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1135" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1524" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2081" y="0"></use>
<g transform="translate(2526,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3602" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2248" x="4270" y="0"></use>
<g transform="translate(5043,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3059" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1279" y="676"></use>
<g transform="translate(60,-780)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="1136" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="1463" y="0"></use>
<g transform="translate(2034,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="638" y="408"></use>
</g>
</g>
</g>
</g>
<g transform="translate(8787,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="815" y="-1536"></use>
<g transform="translate(243,1280)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-70" x="989" y="-185"></use>
</g>
</g>
<g transform="translate(10398,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="801" y="-213"></use>
</g>
<g transform="translate(11523,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="12280" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="12670" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="13226" y="0"></use>
<g transform="translate(13672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="14748" y="0"></use>
<g transform="translate(15193,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="16207" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="16597" y="0"></use>
</g>
</svg>
</div>
<p>

where, as before, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.012ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1297 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N Subscript normal p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="1136" y="-213"></use>
</g>
</svg> is the number of photons emitted from the
light sources, and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.428ex" height="2.509ex" style="vertical-align: -0.338ex;" viewBox="0 -934.9 1475.9 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">pi r squared</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="0" y="0"></use>
<g transform="translate(570,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="638" y="513"></use>
</g>
</g>
</svg> is the surface area of
the disk-shaped kernel function.

</p>
<p>The second adjustment, based on an approach first implemented in
progressive photon mapping, is to progressively reduce the photon search
radius as more photons contribute to the visible point.  The general idea
is that as more photons are found within the search radius, we have
more evidence that a sufficient density of photons is arriving to estimate
the incident radiance distribution well.  By reducing the radius, we
ensure that future photons that are used will be closer to the point and thus
contribute to a more accurate estimate of the incident radiance
distribution.

</p>
<p>Reducing the radius requires an adjustment to how the reflected radiance
estimate is computed, as now the photons in the sum in
Equation&nbsp;(<a href="#eq:photon-est-outgoing-radiance">16.11</a>) come from different radii.
The following three update rules describe how to update the radius and
dependent variables:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:sppm-update-rules"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="22.991ex" height="18.843ex" style="vertical-align: -8.838ex;" viewBox="0 -4307.5 9899 8112.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column upper N Subscript i plus 1 2nd Column equals upper N Subscript i Baseline plus gamma upper M Subscript i Baseline 2nd Row 1st Column r Subscript i plus 1 2nd Column equals r Subscript i Baseline StartRoot StartFraction upper N Subscript i plus 1 Baseline Over upper N Subscript i Baseline plus upper M Subscript i Baseline EndFraction EndRoot 3rd Row 1st Column tau Subscript i plus 1 2nd Column equals left-parenthesis tau Subscript i Baseline plus normal upper Phi Subscript i Baseline right-parenthesis StartFraction r Subscript i plus 1 Superscript 2 Baseline Over r Subscript i Superscript 2 Baseline EndFraction comma EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FE" d="M543 421c0 -4 -12 -26 -19 -38c-40 -79 -104 -228 -136 -327c-4 -13 -6 -26 -8 -39c-4 -31 -14 -88 -37 -172c-11 -38 -19 -60 -32 -60c-8 0 -13 7 -13 18c0 26 30 142 52 215c7 20 12 37 12 98c0 79 -11 254 -162 254c-11 0 -120 -1 -159 -116l-4 -5c-10 0 -19 0 -19 10 c0 31 70 183 195 183c69 0 109 -49 133 -110c39 -97 40 -173 41 -204c40 101 80 201 132 296c3 7 9 7 12 7c0 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE4-221A" d="M1020 1730l-554 -2954c-5 -26 -11 -26 -42 -26l-231 1343l-68 -132s-14 12 -14 16c0 0 1 3 6 13l132 260l216 -1255h1l512 2725c3 17 6 30 22 30c12 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70F" d="M511 407c0 -34 -36 -34 -49 -34h-168l-67 -342c-3 -15 -8 -43 -41 -43c-22 0 -29 16 -29 27c0 4 6 25 10 37l98 321h-83c-21 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 6 28 54 61 90c44 47 83 47 103 47h280c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,3414)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
<g transform="translate(803,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
<g transform="translate(352,885)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
<g transform="translate(366,-2567)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70F" x="0" y="0"></use>
<g transform="translate(437,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
</g>
<g transform="translate(2319,0)">
<g transform="translate(0,3414)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(1056,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1136" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2426" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FE" x="3427" y="0"></use>
<g transform="translate(3970,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1372" y="-213"></use>
</g>
</g>
<g transform="translate(0,885)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(1056,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
</g>
<g transform="translate(1852,0)">
 <use xlink:href="#E1-LATINMODERNSIZE4-221A" x="0" y="1"></use>
<rect stroke="none" width="4045" height="60" x="1000" y="1692"></rect>
<g transform="translate(1000,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="3805" height="60" x="0" y="220"></rect>
<g transform="translate(876,728)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
<g transform="translate(803,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
<g transform="translate(60,-704)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1136" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="1370" y="0"></use>
<g transform="translate(2370,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1372" y="-213"></use>
</g>
</g>
</g>
</g>
</g>
</g>
<g transform="translate(0,-2567)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1056" y="0"></use>
<g transform="translate(1445,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="618" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2449" y="0"></use>
<g transform="translate(3450,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1021" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4517" y="0"></use>
<g transform="translate(4906,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="1820" height="60" x="0" y="220"></rect>
<g transform="translate(60,885)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="638" y="488"></use>
<g transform="translate(451,-308)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
<g transform="translate(457,-837)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="638" y="488"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-430"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6967" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:sppm-update-rules">16.13</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.666ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1147.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1136" y="-213"></use>
</g>
</svg> is the number of photons that have contributed to the point
after the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th iteration, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.054ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1314.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1372" y="-213"></use>
</g>
</svg> is the number of photons that contributed
during the current iteration, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.848ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 795.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
</g>
</svg> is the search radius to use for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th
iteration, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.188ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 511.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">tau</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70F" d="M511 407c0 -34 -36 -34 -49 -34h-168l-67 -342c-3 -15 -8 -43 -41 -43c-22 0 -29 16 -29 27c0 4 6 25 10 37l98 321h-83c-21 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 6 28 54 61 90c44 47 83 47 103 47h280c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70F" x="0" y="0"></use>
</g>
</svg> maintains the sum of products of photons with BSDF values,
and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.478ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1066.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1021" y="-213"></use>
</g>
</svg> is computed during the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th iteration as
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:sppm-phi"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.362ex" height="7.676ex" style="vertical-align: -3.338ex;" viewBox="0 -1867.7 10489 3304.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi Subscript i Baseline equals sigma-summation Underscript j Overscript upper M Subscript i Baseline Endscripts beta Subscript j Baseline f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript Baseline Subscript j Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1021" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1344" y="0"></use>
<g transform="translate(2400,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="815" y="-1536"></use>
<g transform="translate(244,1205)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1195" y="-238"></use>
</g>
</g>
<g transform="translate(4012,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="801" y="-213"></use>
</g>
<g transform="translate(5136,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5894" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="6283" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6840" y="0"></use>
<g transform="translate(7285,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="8361" y="0"></use>
<g transform="translate(8806,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9820" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="10210" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:sppm-phi">16.14</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

The <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.262ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 543.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">gamma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FE" d="M543 421c0 -4 -12 -26 -19 -38c-40 -79 -104 -228 -136 -327c-4 -13 -6 -26 -8 -39c-4 -31 -14 -88 -37 -172c-11 -38 -19 -60 -32 -60c-8 0 -13 7 -13 18c0 26 30 142 52 215c7 20 12 37 12 98c0 79 -11 254 -162 254c-11 0 -120 -1 -159 -116l-4 -5c-10 0 -19 0 -19 10 c0 31 70 183 195 183c69 0 109 -49 133 -110c39 -97 40 -173 41 -204c40 101 80 201 132 296c3 7 9 7 12 7c0 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FE" x="0" y="0"></use>
</g>
</svg> parameter, which is typically around <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.487ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 1501.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2 slash 3</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-33" x="1001" y="0"></use>
</g>
</svg>, determines how
quickly the contributions from photons from earlier iterations, with wider
search radii, are faded out. (Hachisuka and Jensen&rsquo;s original paper on SPPM
(<a href="Further_Reading.html#cite:Hachisuka09">2009</a>) uses the notation <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.488ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 640.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">alpha</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FC" d="M602 383c0 0 -21 -117 -115 -235c-10 -12 -10 -14 -10 -35c0 -24 0 -102 31 -102c0 0 38 0 56 49c3 7 6 10 13 10c6 0 12 -3 12 -10c0 -16 -31 -71 -84 -71c-45 0 -78 31 -91 84c-76 -61 -148 -84 -211 -84c-102 0 -162 76 -162 169c0 141 132 284 269 284 c74 0 167 -49 167 -206v-62c47 59 80 135 98 198c5 18 5 21 15 21c11 0 12 -10 12 -10zM410 99c-2 17 -2 75 -2 112c0 78 0 209 -99 209c-35 0 -89 -19 -136 -92c-32 -51 -58 -159 -58 -208c0 -64 30 -109 90 -109c40 0 117 11 205 88Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FC" x="0" y="0"></use>
</g>
</svg> for this quantity; we opt for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.262ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 543.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">gamma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FE" d="M543 421c0 -4 -12 -26 -19 -38c-40 -79 -104 -228 -136 -327c-4 -13 -6 -26 -8 -39c-4 -31 -14 -88 -37 -172c-11 -38 -19 -60 -32 -60c-8 0 -13 7 -13 18c0 26 30 142 52 215c7 20 12 37 12 98c0 79 -11 254 -162 254c-11 0 -120 -1 -159 -116l-4 -5c-10 0 -19 0 -19 10 c0 31 70 183 195 183c69 0 109 -49 133 -110c39 -97 40 -173 41 -204c40 101 80 201 132 296c3 7 9 7 12 7c0 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FE" x="0" y="0"></use>
</g>
</svg>
here, having used <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.488ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 640.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">alpha</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FC" d="M602 383c0 0 -21 -117 -115 -235c-10 -12 -10 -14 -10 -35c0 -24 0 -102 31 -102c0 0 38 0 56 49c3 7 6 10 13 10c6 0 12 -3 12 -10c0 -16 -31 -71 -84 -71c-45 0 -78 31 -91 84c-76 -61 -148 -84 -211 -84c-102 0 -162 76 -162 169c0 141 132 284 269 284 c74 0 167 -49 167 -206v-62c47 59 80 135 98 198c5 18 5 21 15 21c11 0 12 -10 12 -10zM410 99c-2 17 -2 75 -2 112c0 78 0 209 -99 209c-35 0 -89 -19 -136 -92c-32 -51 -58 -159 -58 -208c0 -64 30 -109 90 -109c40 0 117 11 205 88Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FC" x="0" y="0"></use>
</g>
</svg> for other quantities already.)

</p>
<p>

</p>
<p>Note that the radius is a per-pixel property, not a per-visible-point
property.  Remarkably, a consistent estimate for the reflected radiance is
computed even with this single radius shared over all of the series of
visible points in the pixel.  We won&rsquo;t show this derivation here, but with
the rules in Equation&nbsp;(<a href="#eq:sppm-update-rules">16.13</a>), as the number of
photons traced <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.95ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 3853.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper N Subscript normal p Baseline right-arrow normal infinity</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D441" d="M881 672c0 -19 -12 -20 -17 -20c-80 -3 -98 -34 -108 -74l-140 -557c-5 -18 -5 -21 -16 -21c-9 0 -12 2 -19 19l-249 589c-5 10 -5 12 -9 18l-132 -528c-3 -11 -4 -16 -4 -23c0 -20 8 -42 66 -44c11 0 20 -1 20 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3 c-33 0 -68 -3 -100 -3c-8 0 -13 4 -13 11c0 19 11 20 17 20c81 3 98 35 108 75l134 537c0 9 -63 9 -68 9c-19 0 -28 0 -28 11c0 20 9 20 29 20h134c23 0 24 -1 32 -19l221 -522l112 445c1 3 3 18 3 21c0 22 -11 43 -68 44c-8 0 -18 0 -18 11c0 20 12 20 18 20 c33 0 68 -3 102 -3c33 0 68 3 101 3c13 0 13 -11 13 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-221E" d="M943 216c0 -118 -76 -227 -192 -227c-79 0 -138 42 -170 69c-22 19 -23 20 -90 101c-13 -22 -102 -170 -246 -170c-119 0 -189 115 -189 226c0 118 76 227 192 227c79 0 138 -42 170 -69c22 -19 23 -20 90 -101c13 22 102 170 246 170c119 0 189 -115 189 -226zM921 216 c0 90 -54 194 -160 194c-113 0 -189 -105 -227 -173c28 -34 73 -97 101 -128c45 -49 86 -72 132 -72c84 0 154 79 154 179zM465 194c-28 34 -73 97 -101 128c-45 49 -86 72 -132 72c-84 0 -154 -79 -154 -179c0 -90 54 -194 160 -194c113 0 189 105 227 173Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D441" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="1136" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="1574" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-221E" x="2853" y="0"></use>
</g>
</svg>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.825ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2508.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r right-arrow 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="729" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="2007" y="0"></use>
</g>
</svg>,
and the reflected radiance estimates are consistent and converge to the
correct values.

</p>
<p>Figure&nbsp;<a href="#fig:sppm-render">16.8</a> shows a rendered scene with path tracing and
SPPM. SPPM is much more effective at handling light that passes through the glass light
fixtures than the path tracing algorithm is.

</p>
<p></p>
<span class="anchor" id="fig:sppm-render"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 102.400%;  position:relative;">
<div id="Path_tracing66" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('Path_tracing66'), {
  title: 'Path_tracing66', children: [
 { title: 'Path tracing', image: 'breakfast-path.exr' },  { title: 'Stochastic progressive photon mapping', image: 'breakfast-sppm.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 16.8: <span class="legend"> Scene rendered with (a) path tracing and (b) stochastic
progressive photon mapping, using approximately the same amount of
computation. In this case, photon mapping
is effective at handling light paths from the light source through the
glass light fixtures, while path tracing gives a result with high
variance. (<em>Scene courtesy &ldquo;Wig42&rdquo; from <a href="http://blendswap.com">blendswap.com</a></em>)</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#SPPMIntegrator"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="SPPMIntegrator"></span><h3>16.2.3  SPPMIntegrator</h3><p>


</p>
<p>

</p>
<p>The <tt>SPPMIntegrator</tt>, implemented in the files
<a href="https://github.com/mmp/pbrt-v3/tree/master/src/integrators/sppm.h"><tt>integrators/sppm.h</tt></a><span class="anchor" id="integratorssppm.h"></span> and
<tt>integrators/sppm.cpp</tt><span class="anchor" id="integratorssppm.cpp"></span>, implements
the SPPM light transport algorithm.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMDeclarations-0"></span><div class="fragmentname">&lt;&lt;SPPM Declarations&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="SPPMIntegrator"></span>SPPMIntegrator : public <a href="../Introduction/pbrt_System_Overview.html#Integrator" class="code">Integrator</a> {
public:
    &lt;&lt;<span class="fragmentname">SPPMIntegrator Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1531" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1531"><i></i></a><div id="fragbit-1531" class="collapse"><div class="fragmentcode">       SPPMIntegrator(std::shared_ptr&lt;const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>&gt; &amp;camera, int nIterations,
               int photonsPerIteration, int maxDepth,
               Float initialSearchRadius, int writeFrequency)
           : camera(camera), nIterations(nIterations),
             photonsPerIteration(photonsPerIteration &gt; 0 ? photonsPerIteration :
                                 camera-&gt;film-&gt;croppedPixelBounds.Area()),
             maxDepth(maxDepth), initialSearchRadius(initialSearchRadius),
             writeFrequency(writeFrequency) { }
       void Render(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene);</div></div>
private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-SPPMIntegratorPrivateData-0">SPPMIntegrator Private Data</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1532" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1532"><i></i></a><div id="fragbit-1532" class="collapse"><div class="fragmentcode">       std::shared_ptr&lt;const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>&gt; camera;
       const Float initialSearchRadius;
       const int nIterations;
       const int maxDepth;
       const int photonsPerIteration;
       const int writeFrequency;</div></div>
};</div><p>


</p>
<p>The <tt>SPPMIntegrator</tt> constructor isn&rsquo;t particularly interesting; it
just sets various member variables with values passed in. We therefore
won&rsquo;t include it here but will discuss the various member variables that
configure the <tt>SPPMIntegrator</tt>&rsquo;s operation as they appear in the
following.

</p>
<p>

</p>
<p>The <tt>SPPMIntegrator</tt> is not a <a href="../Introduction/pbrt_System_Overview.html#SamplerIntegrator"><tt>SamplerIntegrator</tt></a>, so it implements
its own <tt>Render()</tt> method. After some initial setup has been
performed, it runs a number of iterations of the SPPM algorithm, finding a
set of visible points and then accumulating illumination from photons at
them.  Each iteration creates a new path starting from the camera in each
pixel, which helps with antialiasing geometric edges and sampling motion
blur and depth of field well.

</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-SPPMMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;SPPM Method Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">void <span class="anchor" id="SPPMIntegrator::Render"></span>SPPMIntegrator::Render(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonopixelBoundsandmonopixelsarrayforSPPM-0">Initialize <tt>pixelBounds</tt> and <tt>pixels</tt> array for SPPM</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1533" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1533"><i></i></a><div id="fragbit-1533" class="collapse"><div class="fragmentcode">       Bounds2i pixelBounds = <a href="#SPPMIntegrator::camera" class="code">camera</a>-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::film" class="code">film</a>-&gt;<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#Film::croppedPixelBounds" class="code">croppedPixelBounds</a>;
       int nPixels = pixelBounds.Area();
       std::unique_ptr&lt;SPPMPixel[]&gt; pixels(new SPPMPixel[nPixels]);
       for (int i = 0; i &lt; nPixels; ++i)
           pixels[i].<a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMIntegrator::initialSearchRadius" class="code">initialSearchRadius</a>;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputemonolightDistrforsamplinglightsproportionaltopower-0">Compute <tt>lightDistr</tt> for sampling lights proportional to power</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1534" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1534"><i></i></a><div id="fragbit-1534" class="collapse"><div class="fragmentcode">       std::unique_ptr&lt;Distribution1D&gt; lightDistr =
           <a href="#ComputeLightPowerDistribution" class="code">ComputeLightPowerDistribution</a>(scene);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PerformmononIterationsofSPPMintegration-0">Perform <tt>nIterations</tt> of SPPM integration</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1535" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1535"><i></i></a><div id="fragbit-1535" class="collapse"><div class="fragmentcode">       HaltonSampler sampler(<a href="#SPPMIntegrator::nIterations" class="code">nIterations</a>, pixelBounds);
       &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputenumberoftilestouseforSPPMcamerapass-0">Compute number of tiles to use for SPPM camera pass</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1536" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1536"><i></i></a><div id="fragbit-1536" class="collapse"><div class="fragmentcode">          Vector2i pixelExtent = pixelBounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::Diagonal" class="code">Diagonal</a>();
          const int tileSize = 16;
          <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> nTiles((pixelExtent.x + tileSize - 1) / tileSize,
                         (pixelExtent.y + tileSize - 1) / tileSize);</div></div>
       for (int iter = 0; iter &lt; <a href="#SPPMIntegrator::nIterations" class="code">nIterations</a>; ++iter) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-GenerateSPPMvisiblepoints-0">Generate SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1537" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1537"><i></i></a><div id="fragbit-1537" class="collapse"><div class="fragmentcode">              std::vector&lt;<a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a>&gt; perThreadArenas(<a href="../Utilities/Parallelism.html#MaxThreadIndex" class="code">MaxThreadIndex</a>());
              <a href="../Utilities/Parallelism.html#ParallelFor2D" class="code">ParallelFor2D</a>(
                  [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> tile) {
                      <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = perThreadArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-FollowcamerapathsformonotileinimageforSPPM-0">Follow camera paths for <tt>tile</tt> in image for SPPM</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1538" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1538"><i></i></a><div id="fragbit-1538" class="collapse"><div class="fragmentcode">                         int tileIndex = tile.y * nTiles.x + tile.x;
                         std::unique_ptr&lt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a>&gt; tileSampler = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Clone" class="code">Clone</a>(tileIndex);
                         &lt;&lt;<span class="fragmentname">Compute <tt>tileBounds</tt> for SPPM tile</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1539" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1539"><i></i></a><div id="fragbit-1539" class="collapse"><div class="fragmentcode">                            int x0 = pixelBounds.pMin.x + tile.x * tileSize;
                            int x1 = std::min(x0 + tileSize, pixelBounds.pMax.x);
                            int y0 = pixelBounds.pMin.y + tile.y * tileSize;
                            int y1 = std::min(y0 + tileSize, pixelBounds.pMax.y);
                            Bounds2i tileBounds(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(x0, y0), <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(x1, y1));</div></div>
                         for (<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixel : tileBounds) {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-PreparemonotileSamplerformonopPixel-0">Prepare <tt>tileSampler</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1540" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1540"><i></i></a><div id="fragbit-1540" class="collapse"><div class="fragmentcode">                                tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::StartPixel" class="code">StartPixel</a>(pPixel);
                                tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::SetSampleNumber" class="code">SetSampleNumber</a>(iter);</div></div>
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratecamerarayforpixelforSPPM-0">Generate camera ray for pixel for SPPM</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1541" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1541"><i></i></a><div id="fragbit-1541" class="collapse"><div class="fragmentcode">                                CameraSample cameraSample = tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::GetCameraSample" class="code">GetCameraSample</a>(pPixel);
                                RayDifferential ray;
                                <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::GenerateRayDifferential" class="code">GenerateRayDifferential</a>(cameraSample, &amp;ray);
                                </div></div>
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Followcameraraypathuntilavisiblepointiscreated-0">Follow camera ray path until a visible point is created</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1542" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1542"><i></i></a><div id="fragbit-1542" class="collapse"><div class="fragmentcode">                                &lt;&lt;<span class="fragmentname"><a href="#fragment-GetmonoSPPMPixelformonopPixel-0">Get <tt>SPPMPixel</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1543" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1543"><i></i></a><div id="fragbit-1543" class="collapse"><div class="fragmentcode">                                   <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixelO = <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(pPixel - pixelBounds.pMin);
                                   int pixelOffset = pPixelO.x +
                                                     pPixelO.y * (pixelBounds.pMax.x - pixelBounds.pMin.x);
                                   SPPMPixel &amp;pixel = pixels[pixelOffset];</div></div>
                                bool specularBounce = false;
                                for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
                                    <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
                                    if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(ray, &amp;isect)) {
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatelightcontributionsforraywithnointersection-0">Accumulate light contributions for ray with no intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1544" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1544"><i></i></a><div id="fragbit-1544" class="collapse"><div class="fragmentcode">                                           for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
                                              pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(ray);</div></div>
                                        break;
                                    }
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcessSPPMcamerarayintersection-0">Process SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1545" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1545"><i></i></a><div id="fragbit-1545" class="collapse"><div class="fragmentcode">                                       &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatSPPMcamerarayintersection-0">Compute BSDF at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1546" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1546"><i></i></a><div id="fragbit-1546" class="collapse"><div class="fragmentcode">                                          isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true);
                                          if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                                              ray = isect.SpawnRay(ray.d);
                                              --depth;
                                              continue;
                                          }
                                          const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a> = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
                                       &lt;&lt;<span class="fragmentname"><a href="#fragment-AccumulatedirectilluminationatSPPMcamerarayintersection-0">Accumulate direct illumination at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1547" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1547"><i></i></a><div id="fragbit-1547" class="collapse"><div class="fragmentcode">                                          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                                          if (depth == 0 || specularBounce)
                                              pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(wo);
                                          pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta *
                                              <a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#UniformSampleOneLight" class="code">UniformSampleOneLight</a>(isect, scene, arena, *tileSampler);</div></div>
                                       &lt;&lt;<span class="fragmentname"><a href="#fragment-Possiblycreatevisiblepointandendcamerapath-0">Possibly create visible point and end camera path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1548" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1548"><i></i></a><div id="fragbit-1548" class="collapse"><div class="fragmentcode">                                          bool isDiffuse =
                                              bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_DIFFUSE | BSDF_REFLECTION |
                                                                          BSDF_TRANSMISSION)) &gt; 0;
                                          bool isGlossy =
                                              bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_GLOSSY | BSDF_REFLECTION |
                                                                          BSDF_TRANSMISSION)) &gt; 0;
                                          if (isDiffuse || (isGlossy &amp;&amp; depth == maxDepth - 1)) {
                                              pixel.<a href="#SPPMPixel::vp" class="code">vp</a> = {isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, wo, &amp;bsdf, beta};
                                              break;
                                          }</div></div>
                                       &lt;&lt;<span class="fragmentname">Spawn ray from SPPM camera path vertex</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1549" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1549"><i></i></a><div id="fragbit-1549" class="collapse"><div class="fragmentcode">                                          if (depth &lt; maxDepth - 1) {
                                              Float pdf;
                                              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
                                              BxDFType type;
                                              <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = bsdf.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdf, BSDF_ALL, &amp;type);
                                              if (pdf == 0. || f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                                                  break;
                                              specularBounce = (type &amp; BSDF_SPECULAR) != 0;
                                              beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi,     isect.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading" class="code">shading</a>.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / pdf;
                                              if (beta.y() &lt; 0.25) {
                                                  Float continueProb = std::min((Float)1, beta.y());
                                                  if (tileSampler-&gt;Get1D() &gt; continueProb)
                                                      break;
                                                  beta /= continueProb;
                                              }
                                              ray = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);
                                          }</div></div></div></div>
                                }</div></div>
                         }</div></div>
                  }, nTiles);
              &lt;&lt;<span class="fragmentname"><a href="#fragment-CreategridofallSPPMvisiblepoints-0">Create grid of all SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1550" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1550"><i></i></a><div id="fragbit-1550" class="collapse"><div class="fragmentcode">                 &lt;&lt;<span class="fragmentname"><a href="#fragment-AllocategridforSPPMvisiblepoints-0">Allocate grid for SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1551" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1551"><i></i></a><div id="fragbit-1551" class="collapse"><div class="fragmentcode">                    int hashSize = nPixels;
                    std::vector&lt;std::atomic&lt;SPPMPixelListNode *&gt;&gt; grid(hashSize);</div></div>
                 &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputegridboundsforSPPMvisiblepoints-0">Compute grid bounds for SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1552" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1552"><i></i></a><div id="fragbit-1552" class="collapse"><div class="fragmentcode">                    <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> gridBounds;
                    Float maxRadius = 0.;
                    for (int i = 0; i &lt; nPixels; ++i) {
                        const SPPMPixel &amp;pixel = pixels[i];
                        if (pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                            continue;
                        <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> vpBound = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Expand" class="code">Expand</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.p), pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
                        gridBounds = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Union" class="code">Union</a>(gridBounds, vpBound);
                        maxRadius = std::max(maxRadius, pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
                    }</div></div>
                 &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeresolutionofSPPMgridineachdimension-0">Compute resolution of SPPM grid in each dimension</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1553" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1553"><i></i></a><div id="fragbit-1553" class="collapse"><div class="fragmentcode">                    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> diag = gridBounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>();
                    Float maxDiag = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::MaxComponent" class="code">MaxComponent</a>(diag);
                    int baseGridRes = (int)(maxDiag / maxRadius);
                    int gridRes[3];
                    for (int i = 0; i &lt; 3; ++i)
                        gridRes[i] = std::max((int)(baseGridRes * diag[i] / maxDiag), 1);</div></div>
                 &lt;&lt;<span class="fragmentname"><a href="#fragment-AddvisiblepointstoSPPMgrid-0">Add visible points to SPPM grid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1554" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1554"><i></i></a><div id="fragbit-1554" class="collapse"><div class="fragmentcode">                    <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(
                        [&amp;](int pixelIndex) {
                            <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = perThreadArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
                            SPPMPixel &amp;pixel = pixels[pixelIndex];
                            if (!pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) {
                                &lt;&lt;<span class="fragmentname"><a href="#fragment-Addpixelsvisiblepointtoapplicablegridcells-0">Add pixel&rsquo;s visible point to applicable grid cells</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1555" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1555"><i></i></a><div id="fragbit-1555" class="collapse"><div class="fragmentcode">                                   Float <a href="#SPPMPixel::radius" class="code">radius</a> = pixel.<a href="#SPPMPixel::radius" class="code">radius</a>;
                                   Point3i pMin, pMax;
                                   <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> - <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                                          gridBounds, gridRes, &amp;pMin);
                                   <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> + <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                                          gridBounds, gridRes, &amp;pMax);
                                   for (int z = pMin.z; z &lt;= pMax.z; ++z)
                                       for (int y = pMin.y; y &lt;= pMax.y; ++y)
                                           for (int x = pMin.x; x &lt;= pMax.x; ++x) {
                                               &lt;&lt;<span class="fragmentname"><a href="#fragment-Addvisiblepointtogridcellxyz-0">Add visible point to grid cell <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.432ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3199.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y comma z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1897" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="2342" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2810" y="0"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1556" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1556"><i></i></a><div id="fragbit-1556" class="collapse"><div class="fragmentcode">                                                  int h = <a href="#hash" class="code">hash</a>(Point3i(x, y, z), hashSize);
                                                  SPPMPixelListNode *node = arena.Alloc&lt;SPPMPixelListNode&gt;();
                                                  node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                                                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Atomicallyaddmononodetothestartofmonogridhslinkedlist-0">Atomically add <tt>node</tt> to the start of <tt>grid[h]</tt>&rsquo;s linked list</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1557" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1557"><i></i></a><div id="fragbit-1557" class="collapse"><div class="fragmentcode">                                                     node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a> = grid[h];
                                                     while (grid[h].compare_exchange_weak(node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>, node) == false)
                                                         ;</div></div></div></div>
                                           }
                                   </div></div>
                            }
                        }, nPixels, 4096);
                    </div></div></div></div></div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Tracephotonsandaccumulatecontributions-0">Trace photons and accumulate contributions</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1558" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1558"><i></i></a><div id="fragbit-1558" class="collapse"><div class="fragmentcode">              std::vector&lt;<a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a>&gt; photonShootArenas(<a href="../Utilities/Parallelism.html#MaxThreadIndex" class="code">MaxThreadIndex</a>());
              <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(
                  [&amp;](int photonIndex) {
                      <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = photonShootArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-FollowphotonpathformonophotonIndex-0">Follow photon path for <tt>photonIndex</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1559" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1559"><i></i></a><div id="fragbit-1559" class="collapse"><div class="fragmentcode">                         uint64_t haltonIndex = (uint64_t)iter * (uint64_t)<a href="#SPPMIntegrator::photonsPerIteration" class="code">photonsPerIteration</a> +
                                                photonIndex;
                         int haltonDim = 0;
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Chooselighttoshootphotonfrom-0">Choose light to shoot photon from</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1560" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1560"><i></i></a><div id="fragbit-1560" class="collapse"><div class="fragmentcode">                            Float lightPdf;
                            Float lightSample = <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex);
                            int lightNum = lightDistr-&gt;<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(lightSample, &amp;lightPdf);
                            const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[lightNum];</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Computesamplevaluesforphotonrayleavinglightsource-0">Compute sample values for photon ray leaving light source</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1561" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1561"><i></i></a><div id="fragbit-1561" class="collapse"><div class="fragmentcode">                            <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight0(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                                            <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
                            <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight1(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 2, haltonIndex),
                                            <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 3, haltonIndex));
                            Float uLightTime = <a href="../Utilities/Mathematical_Routines.html#Lerp" class="code">Lerp</a>(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 4, haltonIndex),
                                                    camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterOpen" class="code">shutterOpen</a>, camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterClose" class="code">shutterClose</a>);
                            haltonDim += 5;</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonophotonRayfromlightsourceandinitializemonobeta-0">Generate <tt>photonRay</tt> from light source and initialize <tt>beta</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1562" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1562"><i></i></a><div id="fragbit-1562" class="collapse"><div class="fragmentcode">                            RayDifferential photonRay;
                            <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> nLight;
                            Float pdfPos, pdfDir;
                            <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Le =
                                light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le" class="code">Sample_Le</a>(uLight0, uLight1, uLightTime,
                                                 &amp;photonRay, &amp;nLight, &amp;pdfPos, &amp;pdfDir);
                            if (pdfPos == 0 || pdfDir == 0 || Le.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) return;
                            <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = (<a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(nLight, photonRay.d) * Le) /
                                            (lightPdf * pdfPos * pdfDir);
                            if (beta.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                                return;</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Followphotonpaththroughsceneandrecordintersections-0">Follow photon path through scene and record intersections</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1563" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1563"><i></i></a><div id="fragbit-1563" class="collapse"><div class="fragmentcode">                            <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
                            for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
                                if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(photonRay, &amp;isect))
                                    break;
                                if (depth &gt; 0) {
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontonearbyvisiblepoints-0">Add photon contribution to nearby visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1564" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1564"><i></i></a><div id="fragbit-1564" class="collapse"><div class="fragmentcode">                                       Point3i photonGridIndex;
                                       if (<a href="#ToGrid" class="code">ToGrid</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, gridBounds, gridRes, &amp;photonGridIndex)) {
                                           int h = <a href="#hash" class="code">hash</a>(photonGridIndex, hashSize);
                                           &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontovisiblepointsinmonogridh-0">Add photon contribution to visible points in <tt>grid[h]</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1565" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1565"><i></i></a><div id="fragbit-1565" class="collapse"><div class="fragmentcode">                                              for (SPPMPixelListNode *node = grid[h].load(std::memory_order_relaxed);
                                                   node != nullptr; node = node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>) {
                                                  SPPMPixel &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = *node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                                                  Float <a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::radius" class="code">radius</a>;
                                                  if (<a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>) &gt; <a href="#SPPMPixel::radius" class="code">radius</a> * <a href="#SPPMPixel::radius" class="code">radius</a>)
                                                      continue;
                                                  &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopixelPhiandMfornearbyphoton-0">Update <tt>pixel</tt> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> for nearby photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1566" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1566"><i></i></a><div id="fragbit-1566" class="collapse"><div class="fragmentcode">                                                     <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                                                     <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a> = beta * pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::wo" class="code">wo</a>, wi);
                                                     for (int i = 0; i &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++i)
                                                         pixel.<a href="#SPPMPixel::Phi" class="code">Phi</a>[i].<a href="../Utilities/Parallelism.html#AtomicFloat::Add" class="code">Add</a>(<a href="#SPPMPixel::Phi" class="code">Phi</a>[i]);
                                                     ++pixel.M;</div></div> 
                                              }</div></div>
                                       }</div></div>
                                }
                                &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewphotonraydirection-0">Sample new photon ray direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1567" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1567"><i></i></a><div id="fragbit-1567" class="collapse"><div class="fragmentcode">                                   &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatphotonintersectionpoint-0">Compute BSDF at photon intersection point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1568" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1568"><i></i></a><div id="fragbit-1568" class="collapse"><div class="fragmentcode">                                      isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(photonRay, arena, true,
                                                                       <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance);
                                      if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                                          --depth;
                                          photonRay = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(photonRay.d);
                                          continue;
                                      }
                                      const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;photonBSDF = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
                                   &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFmonofranddirectionmonowiforreflectedphoton-0">Sample BSDF <tt>fr</tt> and direction <tt>wi</tt> for reflected photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1569" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1569"><i></i></a><div id="fragbit-1569" class="collapse"><div class="fragmentcode">                                      <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, wo = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                                      Float pdf;
                                      BxDFType flags;
                                      &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonobsdfSampleforoutgoingphotonsample-0">Generate <tt>bsdfSample</tt> for outgoing photon sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1570" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1570"><i></i></a><div id="fragbit-1570" class="collapse"><div class="fragmentcode">                                         <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> bsdfSample(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                                                            <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
                                         haltonDim += 2;</div></div>
                                      <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> fr = photonBSDF.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, bsdfSample,
                                                                        &amp;pdf, BSDF_ALL, &amp;flags);
                                      if (fr.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdf == 0.f) break;</div></div>
                                   <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> bnew = beta * fr * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdf;
                                   &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatephotonpathwithRussianroulette-0">Possibly terminate photon path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1571" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1571"><i></i></a><div id="fragbit-1571" class="collapse"><div class="fragmentcode">                                      Float q = std::max((Float)0, 1 - bnew.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>() / beta.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>());
                                      if (<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex) &lt; q)
                                          break;
                                      beta = bnew / (1 - q);</div></div>
                                   photonRay = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
                            }</div></div></div></div>
                      arena.<a href="../Utilities/Memory_Management.html#MemoryArena::Reset" class="code">Reset</a>();
                  }, <a href="#SPPMIntegrator::photonsPerIteration" class="code">photonsPerIteration</a>, 8192);
              </div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatepixelvaluesfromthispasssphotons-0">Update pixel values from this pass&rsquo;s photons</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1572" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1572"><i></i></a><div id="fragbit-1572" class="collapse"><div class="fragmentcode">              for (int i = 0; i &lt; nPixels; ++i) {
                  SPPMPixel &amp;p = pixels[i];
                  if (p.<a href="#SPPMPixel::M" class="code">M</a> &gt; 0) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatepixelphotoncountsearchradiusandtaufromphotons-0">Update pixel photon count, search radius, and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.188ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 511.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">tau</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70F" d="M511 407c0 -34 -36 -34 -49 -34h-168l-67 -342c-3 -15 -8 -43 -41 -43c-22 0 -29 16 -29 27c0 4 6 25 10 37l98 321h-83c-21 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 6 28 54 61 90c44 47 83 47 103 47h280c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70F" x="0" y="0"></use>
</g>
</svg> from photons</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1573" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1573"><i></i></a><div id="fragbit-1573" class="collapse"><div class="fragmentcode">                         Float gamma = (Float)2 / (Float)3;
                         Float Nnew = p.<a href="#SPPMPixel::N" class="code">N</a> + gamma * p.M;
                         Float Rnew = p.<a href="#SPPMPixel::radius" class="code">radius</a> * std::sqrt(Nnew / (p.<a href="#SPPMPixel::N" class="code">N</a> + p.M));
                         <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a>;
                         for (int j = 0; j &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++j)
                             <a href="#SPPMPixel::Phi" class="code">Phi</a>[j] = p.<a href="#SPPMPixel::Phi" class="code">Phi</a>[j];
                         p.<a href="#SPPMPixel::tau" class="code">tau</a> = (p.<a href="#SPPMPixel::tau" class="code">tau</a> + p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a> * <a href="#SPPMPixel::Phi" class="code">Phi</a>) *
                                 (Rnew * Rnew) / (p.<a href="#SPPMPixel::radius" class="code">radius</a> * p.<a href="#SPPMPixel::radius" class="code">radius</a>);
                         p.<a href="#SPPMPixel::N" class="code">N</a> = Nnew;
                         p.<a href="#SPPMPixel::radius" class="code">radius</a> = Rnew;</div></div>
                      p.<a href="#SPPMPixel::M" class="code">M</a> = 0;
                      for (int j = 0; j &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++j)
                          p.<a href="#SPPMPixel::Phi" class="code">Phi</a>[j] = (Float)0;
                  }
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-ResetmonoVisiblePointinpixel-0">Reset <tt>VisiblePoint</tt> in pixel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1574" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1574"><i></i></a><div id="fragbit-1574" class="collapse"><div class="fragmentcode">                     p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a> = 0.;
                     p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a> = nullptr;</div></div>
              }
              </div></div>
           &lt;&lt;<span class="fragmentname">Periodically store SPPM image in film and write image</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1575" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1575"><i></i></a><div id="fragbit-1575" class="collapse"><div class="fragmentcode">              if (iter + 1 == nIterations || ((iter + 1) % writeFrequency) == 0) {
                  int x0 = pixelBounds.pMin.x;
                  int x1 = pixelBounds.pMax.x;
                  uint64_t Np = (uint64_t)(iter + 1) * (uint64_t)photonsPerIteration;
                  std::unique_ptr&lt;<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>[]&gt; image(new <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>[pixelBounds.Area()]);
                  int offset = 0;
                  for (int y = pixelBounds.pMin.y; y &lt; pixelBounds.pMax.y; ++y) {
                      for (int x = x0; x &lt; x1; ++x) {
                          &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeradiancemonoLforSPPMpixelmonopixel-0">Compute radiance <tt>L</tt> for SPPM pixel <tt>pixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1576" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1576"><i></i></a><div id="fragbit-1576" class="collapse"><div class="fragmentcode">                             const SPPMPixel &amp;pixel = pixels[(y - pixelBounds.pMin.y) * (x1 - x0) +
                                                             (x - x0)];
                             <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> L = pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> / (iter + 1);
                             L += pixel.<a href="#SPPMPixel::tau" class="code">tau</a> / (Np * <a href="../Utilities/Main_Include_File.html#Pi" class="code">Pi</a> * pixel.<a href="#SPPMPixel::radius" class="code">radius</a> * pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);</div></div>
                          image[offset++] = L;
                      }
                  }
                  camera-&gt;film-&gt;SetImage(image.get());
                  camera-&gt;film-&gt;WriteImage();
              }</div></div>
       }
       </div></div>
}</div><p>


</p>
<p>The <tt>pixels</tt> array stores a <tt>SPPMPixel</tt> (to be defined shortly) for each pixel in the
final image.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonopixelBoundsandmonopixelsarrayforSPPM-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>pixelBounds</tt> and <tt>pixels</tt> array for SPPM&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Bounds2i pixelBounds = <a href="#SPPMIntegrator::camera" class="code">camera</a>-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::film" class="code">film</a>-&gt;<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#Film::croppedPixelBounds" class="code">croppedPixelBounds</a>;
int nPixels = pixelBounds.Area();
std::unique_ptr&lt;SPPMPixel[]&gt; pixels(new SPPMPixel[nPixels]);
for (int i = 0; i &lt; nPixels; ++i)
    pixels[i].<a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMIntegrator::initialSearchRadius" class="code">initialSearchRadius</a>;</div><p>


</p>
<p>A user-supplied radius, <tt>initialSearchRadius</tt>, is used for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.103ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 905.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="638" y="-213"></use>
</g>
</svg>, the
initial search radius for photons.  If the supplied radius is too large,
too many photons will contribute to visible points during early iterations
(before the radius is automatically decreased), which may be inefficient.
If it&rsquo;s too small, not enough photons will be found to estimate incident
radiance well.  A radius corresponding to a few pixels in the final image
is generally a good starting point.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMIntegratorPrivateData-0"></span><div class="fragmentname">&lt;&lt;SPPMIntegrator Private Data&gt;&gt;=&nbsp;<a href="#fragment-SPPMIntegratorPrivateData-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">std::shared_ptr&lt;const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>&gt; <span class="anchor" id="SPPMIntegrator::camera"></span>camera;
const Float <span class="anchor" id="SPPMIntegrator::initialSearchRadius"></span>initialSearchRadius;</div><p>


</p>
<p>The <a href="#SPPMPixel"><tt>SPPMPixel</tt></a> structure serves three purposes.  First, it stores the
current estimated average radiance visible over the extent of a pixel
(including the time the shutter is open and accounting for depth of field,
if present). Second, it stores parameters related to the photon density
estimation for the pixel (e.g., various quantities from
Equation&nbsp;(<a href="#eq:sppm-update-rules">16.13</a>)). Finally, it stores the geometric and
reflection information for a visible point in the pixel after the camera
pass.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMLocalDefinitions-0"></span><div class="fragmentname">&lt;&lt;SPPM Local Definitions&gt;&gt;=&nbsp;<a href="#fragment-SPPMLocalDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">struct <span class="anchor" id="SPPMPixel"></span>SPPMPixel {
    &lt;&lt;<span class="fragmentname">SPPMPixel Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1577" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1577"><i></i></a><div id="fragbit-1577" class="collapse"><div class="fragmentcode">       SPPMPixel() : M(0) { }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-SPPMPixelPublicData-0">SPPMPixel Public Data</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1578" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1578"><i></i></a><div id="fragbit-1578" class="collapse"><div class="fragmentcode">       Float radius = 0;
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Ld;
       struct VisiblePoint {
           &lt;&lt;<span class="fragmentname">VisiblePoint Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1579" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1579"><i></i></a><div id="fragbit-1579" class="collapse"><div class="fragmentcode">              VisiblePoint() { }
              VisiblePoint(const <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> &amp;p, const <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> &amp;wo, const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> *bsdf,
                           const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;beta)
                  : p(p), wo(wo), bsdf(bsdf), beta(beta) { }</div></div>
           <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p;
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo;
           const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> *bsdf = nullptr;
           <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta;
       } vp;
       AtomicFloat Phi[<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples];
       std::atomic&lt;int&gt; M;
       Float N = 0;
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> tau;</div></div>
};</div><p>


</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-SPPMPixelPublicData-0"></span><div class="fragmentname">&lt;&lt;SPPMPixel Public Data&gt;&gt;=&nbsp;<a href="#fragment-SPPMPixelPublicData-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="SPPMPixel::radius"></span>radius = 0;</div><p>


</p>
<p>Working with weighted photons allows for two very different overall
sampling
approaches: on the one hand, we could try to distribute photons uniformly with
a weight that approximates the irradiance on surfaces, while also accounting
for discontinuities and other important geometric and lighting features.
However, this type of photon distribution is challenging to realize for general input;
hence we will instead strive to generate photons that have the same (or similar)
weights, so that it is their varying density throughout the scene that
represents the variation in illumination.  

</p>
<p>Furthermore, if the photon weights on a surface have substantial variation that is not related
to the irradiance, there can be unpleasant image artifacts: if one photon takes
on a much larger weight than the others, a bright circular artifact will reveal
the region of the scene where that photon contributes to the interpolated radiance.

</p>
<p>Therefore, we&rsquo;d like to shoot more photons from the brighter lights so that
the initial weights of photons leaving all lights will be of similar
magnitudes, and thus, the light to start each photon path from is chosen according
to a PDF defined by the lights&rsquo; respective powers.  Thus, it is a greater
number of photons from the brighter lights that accounts for their greater
contributions to illumination in the scene rather than the same number of
photons from all, with larger weights for the more powerful lights.

</p>
<p></p>
<span class="anchor" id="fragment-ComputemonolightDistrforsamplinglightsproportionaltopower-0"></span><div class="fragmentname">&lt;&lt;Compute <tt>lightDistr</tt> for sampling lights proportional to power&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">std::unique_ptr&lt;Distribution1D&gt; lightDistr =
    <a href="#ComputeLightPowerDistribution" class="code">ComputeLightPowerDistribution</a>(scene);</div><p>


</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-IntegratorUtilityFunctions-3"></span><div class="fragmentname">&lt;&lt;Integrator Utility Functions&gt;&gt;+=&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#fragment-IntegratorUtilityFunctions-2"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">std::unique_ptr&lt;<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D" class="code">Distribution1D</a>&gt; <span class="anchor" id="ComputeLightPowerDistribution"></span>ComputeLightPowerDistribution(
        const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene) {
    std::vector&lt;Float&gt; lightPower;
    for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
        lightPower.push_back(light-&gt;<a href="../Light_Sources/Light_Interface.html#Light::Power" class="code">Power</a>().<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>());
    return std::unique_ptr&lt;<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D" class="code">Distribution1D</a>&gt;(
        new <a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D" class="code">Distribution1D</a>(&amp;lightPower[0], lightPower.size()));
}</div><p>


</p>
<p>Each iteration of the SPPM algorithm traces a new path from the camera at
each pixel and then collects incident photons at each path&rsquo;s endpoint.
Figure&nbsp;<a href="#fig:sppm-niterations">16.9</a> shows the effect of increasing the
number of iterations
with SPPM. Here, we see the caustic from light passing through the glass
becoming increasingly sharp. In general,
more iterations improve the sampling of
visible edges, motion blur, and depth of field, but as more photons are
accumulated in each pixel, the indirect lighting estimate becomes more
accurate. Note how the artifacts from under-sampling here are low-frequency
blotches, a quite different visual artifact from the high-frequency noise
from under-sampling seen in path tracing.

</p>
<p> </p>
<span class="anchor" id="fig:sppm-niterations"></span><div class="card outerfigure"><div class="card-body figure"><p>




</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 146.286%;  position:relative;">
<div id="x10_iterations67" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('x10_iterations67'), {
  title: '10_iterations67', children: [
 { title: '10 iterations', image: 'glass-sppm-10.exr' },  { title: '100 iterations', image: 'glass-sppm-100.exr' },  { title: '10,000 iterations', image: 'glass-sppm-10000.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 16.9: Effect of the number of iterations on results from the
<tt>SPPMIntegrator</tt>.
<span class="legend">
As the number of iterations increases (and thus, the more photons are
traced), the quality of the final result improves. Note in particular how
the size of the visible circular blotches gets smaller.
(1) 10 iterations,
(2) 100 iterations,
(3) 10,000 iterations. (<em>Model courtesy Simon Wendsche.</em>)</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The implementation here uses a <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#HaltonSampler"><tt>HaltonSampler</tt></a> to generate camera
paths; doing so ensures that well-distributed samples are used over all of
the iterations in the aggregate.

</p>
<p></p>
<span class="anchor" id="fragment-PerformmononIterationsofSPPMintegration-0"></span><div class="fragmentname">&lt;&lt;Perform <tt>nIterations</tt> of SPPM integration&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">HaltonSampler sampler(<a href="#SPPMIntegrator::nIterations" class="code">nIterations</a>, pixelBounds);
&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputenumberoftilestouseforSPPMcamerapass-0">Compute number of tiles to use for SPPM camera pass</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1580" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1580"><i></i></a><div id="fragbit-1580" class="collapse"><div class="fragmentcode">   Vector2i pixelExtent = pixelBounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::Diagonal" class="code">Diagonal</a>();
   const int tileSize = 16;
   <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> nTiles((pixelExtent.x + tileSize - 1) / tileSize,
                  (pixelExtent.y + tileSize - 1) / tileSize);</div></div>
for (int iter = 0; iter &lt; <a href="#SPPMIntegrator::nIterations" class="code">nIterations</a>; ++iter) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-GenerateSPPMvisiblepoints-0">Generate SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1581" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1581"><i></i></a><div id="fragbit-1581" class="collapse"><div class="fragmentcode">       std::vector&lt;<a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a>&gt; perThreadArenas(<a href="../Utilities/Parallelism.html#MaxThreadIndex" class="code">MaxThreadIndex</a>());
       <a href="../Utilities/Parallelism.html#ParallelFor2D" class="code">ParallelFor2D</a>(
           [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> tile) {
               <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = perThreadArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
               &lt;&lt;<span class="fragmentname"><a href="#fragment-FollowcamerapathsformonotileinimageforSPPM-0">Follow camera paths for <tt>tile</tt> in image for SPPM</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1582" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1582"><i></i></a><div id="fragbit-1582" class="collapse"><div class="fragmentcode">                  int tileIndex = tile.y * nTiles.x + tile.x;
                  std::unique_ptr&lt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a>&gt; tileSampler = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Clone" class="code">Clone</a>(tileIndex);
                  &lt;&lt;<span class="fragmentname">Compute <tt>tileBounds</tt> for SPPM tile</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1583" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1583"><i></i></a><div id="fragbit-1583" class="collapse"><div class="fragmentcode">                     int x0 = pixelBounds.pMin.x + tile.x * tileSize;
                     int x1 = std::min(x0 + tileSize, pixelBounds.pMax.x);
                     int y0 = pixelBounds.pMin.y + tile.y * tileSize;
                     int y1 = std::min(y0 + tileSize, pixelBounds.pMax.y);
                     Bounds2i tileBounds(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(x0, y0), <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(x1, y1));</div></div>
                  for (<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixel : tileBounds) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-PreparemonotileSamplerformonopPixel-0">Prepare <tt>tileSampler</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1584" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1584"><i></i></a><div id="fragbit-1584" class="collapse"><div class="fragmentcode">                         tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::StartPixel" class="code">StartPixel</a>(pPixel);
                         tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::SetSampleNumber" class="code">SetSampleNumber</a>(iter);</div></div>
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratecamerarayforpixelforSPPM-0">Generate camera ray for pixel for SPPM</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1585" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1585"><i></i></a><div id="fragbit-1585" class="collapse"><div class="fragmentcode">                         CameraSample cameraSample = tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::GetCameraSample" class="code">GetCameraSample</a>(pPixel);
                         RayDifferential ray;
                         <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::GenerateRayDifferential" class="code">GenerateRayDifferential</a>(cameraSample, &amp;ray);
                         </div></div>
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Followcameraraypathuntilavisiblepointiscreated-0">Follow camera ray path until a visible point is created</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1586" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1586"><i></i></a><div id="fragbit-1586" class="collapse"><div class="fragmentcode">                         &lt;&lt;<span class="fragmentname"><a href="#fragment-GetmonoSPPMPixelformonopPixel-0">Get <tt>SPPMPixel</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1587" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1587"><i></i></a><div id="fragbit-1587" class="collapse"><div class="fragmentcode">                            <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixelO = <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(pPixel - pixelBounds.pMin);
                            int pixelOffset = pPixelO.x +
                                              pPixelO.y * (pixelBounds.pMax.x - pixelBounds.pMin.x);
                            SPPMPixel &amp;pixel = pixels[pixelOffset];</div></div>
                         bool specularBounce = false;
                         for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
                             <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
                             if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(ray, &amp;isect)) {
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatelightcontributionsforraywithnointersection-0">Accumulate light contributions for ray with no intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1588" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1588"><i></i></a><div id="fragbit-1588" class="collapse"><div class="fragmentcode">                                    for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
                                       pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(ray);</div></div>
                                 break;
                             }
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcessSPPMcamerarayintersection-0">Process SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1589" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1589"><i></i></a><div id="fragbit-1589" class="collapse"><div class="fragmentcode">                                &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatSPPMcamerarayintersection-0">Compute BSDF at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1590" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1590"><i></i></a><div id="fragbit-1590" class="collapse"><div class="fragmentcode">                                   isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true);
                                   if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                                       ray = isect.SpawnRay(ray.d);
                                       --depth;
                                       continue;
                                   }
                                   const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a> = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
                                &lt;&lt;<span class="fragmentname"><a href="#fragment-AccumulatedirectilluminationatSPPMcamerarayintersection-0">Accumulate direct illumination at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1591" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1591"><i></i></a><div id="fragbit-1591" class="collapse"><div class="fragmentcode">                                   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                                   if (depth == 0 || specularBounce)
                                       pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(wo);
                                   pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta *
                                       <a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#UniformSampleOneLight" class="code">UniformSampleOneLight</a>(isect, scene, arena, *tileSampler);</div></div>
                                &lt;&lt;<span class="fragmentname"><a href="#fragment-Possiblycreatevisiblepointandendcamerapath-0">Possibly create visible point and end camera path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1592" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1592"><i></i></a><div id="fragbit-1592" class="collapse"><div class="fragmentcode">                                   bool isDiffuse =
                                       bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_DIFFUSE | BSDF_REFLECTION |
                                                                   BSDF_TRANSMISSION)) &gt; 0;
                                   bool isGlossy =
                                       bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_GLOSSY | BSDF_REFLECTION |
                                                                   BSDF_TRANSMISSION)) &gt; 0;
                                   if (isDiffuse || (isGlossy &amp;&amp; depth == maxDepth - 1)) {
                                       pixel.<a href="#SPPMPixel::vp" class="code">vp</a> = {isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, wo, &amp;bsdf, beta};
                                       break;
                                   }</div></div>
                                &lt;&lt;<span class="fragmentname">Spawn ray from SPPM camera path vertex</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1593" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1593"><i></i></a><div id="fragbit-1593" class="collapse"><div class="fragmentcode">                                   if (depth &lt; maxDepth - 1) {
                                       Float pdf;
                                       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
                                       BxDFType type;
                                       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = bsdf.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdf, BSDF_ALL, &amp;type);
                                       if (pdf == 0. || f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                                           break;
                                       specularBounce = (type &amp; BSDF_SPECULAR) != 0;
                                       beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi,     isect.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading" class="code">shading</a>.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / pdf;
                                       if (beta.y() &lt; 0.25) {
                                           Float continueProb = std::min((Float)1, beta.y());
                                           if (tileSampler-&gt;Get1D() &gt; continueProb)
                                               break;
                                           beta /= continueProb;
                                       }
                                       ray = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);
                                   }</div></div></div></div>
                         }</div></div>
                  }</div></div>
           }, nTiles);
       &lt;&lt;<span class="fragmentname"><a href="#fragment-CreategridofallSPPMvisiblepoints-0">Create grid of all SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1594" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1594"><i></i></a><div id="fragbit-1594" class="collapse"><div class="fragmentcode">          &lt;&lt;<span class="fragmentname"><a href="#fragment-AllocategridforSPPMvisiblepoints-0">Allocate grid for SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1595" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1595"><i></i></a><div id="fragbit-1595" class="collapse"><div class="fragmentcode">             int hashSize = nPixels;
             std::vector&lt;std::atomic&lt;SPPMPixelListNode *&gt;&gt; grid(hashSize);</div></div>
          &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputegridboundsforSPPMvisiblepoints-0">Compute grid bounds for SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1596" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1596"><i></i></a><div id="fragbit-1596" class="collapse"><div class="fragmentcode">             <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> gridBounds;
             Float maxRadius = 0.;
             for (int i = 0; i &lt; nPixels; ++i) {
                 const SPPMPixel &amp;pixel = pixels[i];
                 if (pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                     continue;
                 <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> vpBound = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Expand" class="code">Expand</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.p), pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
                 gridBounds = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Union" class="code">Union</a>(gridBounds, vpBound);
                 maxRadius = std::max(maxRadius, pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
             }</div></div>
          &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeresolutionofSPPMgridineachdimension-0">Compute resolution of SPPM grid in each dimension</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1597" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1597"><i></i></a><div id="fragbit-1597" class="collapse"><div class="fragmentcode">             <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> diag = gridBounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>();
             Float maxDiag = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::MaxComponent" class="code">MaxComponent</a>(diag);
             int baseGridRes = (int)(maxDiag / maxRadius);
             int gridRes[3];
             for (int i = 0; i &lt; 3; ++i)
                 gridRes[i] = std::max((int)(baseGridRes * diag[i] / maxDiag), 1);</div></div>
          &lt;&lt;<span class="fragmentname"><a href="#fragment-AddvisiblepointstoSPPMgrid-0">Add visible points to SPPM grid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1598" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1598"><i></i></a><div id="fragbit-1598" class="collapse"><div class="fragmentcode">             <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(
                 [&amp;](int pixelIndex) {
                     <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = perThreadArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
                     SPPMPixel &amp;pixel = pixels[pixelIndex];
                     if (!pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) {
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Addpixelsvisiblepointtoapplicablegridcells-0">Add pixel&rsquo;s visible point to applicable grid cells</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1599" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1599"><i></i></a><div id="fragbit-1599" class="collapse"><div class="fragmentcode">                            Float <a href="#SPPMPixel::radius" class="code">radius</a> = pixel.<a href="#SPPMPixel::radius" class="code">radius</a>;
                            Point3i pMin, pMax;
                            <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> - <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                                   gridBounds, gridRes, &amp;pMin);
                            <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> + <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                                   gridBounds, gridRes, &amp;pMax);
                            for (int z = pMin.z; z &lt;= pMax.z; ++z)
                                for (int y = pMin.y; y &lt;= pMax.y; ++y)
                                    for (int x = pMin.x; x &lt;= pMax.x; ++x) {
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-Addvisiblepointtogridcellxyz-0">Add visible point to grid cell <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.432ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3199.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y comma z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1897" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="2342" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2810" y="0"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1600" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1600"><i></i></a><div id="fragbit-1600" class="collapse"><div class="fragmentcode">                                           int h = <a href="#hash" class="code">hash</a>(Point3i(x, y, z), hashSize);
                                           SPPMPixelListNode *node = arena.Alloc&lt;SPPMPixelListNode&gt;();
                                           node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                                           &lt;&lt;<span class="fragmentname"><a href="#fragment-Atomicallyaddmononodetothestartofmonogridhslinkedlist-0">Atomically add <tt>node</tt> to the start of <tt>grid[h]</tt>&rsquo;s linked list</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1601" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1601"><i></i></a><div id="fragbit-1601" class="collapse"><div class="fragmentcode">                                              node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a> = grid[h];
                                              while (grid[h].compare_exchange_weak(node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>, node) == false)
                                                  ;</div></div></div></div>
                                    }
                            </div></div>
                     }
                 }, nPixels, 4096);
             </div></div></div></div></div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Tracephotonsandaccumulatecontributions-0">Trace photons and accumulate contributions</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1602" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1602"><i></i></a><div id="fragbit-1602" class="collapse"><div class="fragmentcode">       std::vector&lt;<a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a>&gt; photonShootArenas(<a href="../Utilities/Parallelism.html#MaxThreadIndex" class="code">MaxThreadIndex</a>());
       <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(
           [&amp;](int photonIndex) {
               <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = photonShootArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
               &lt;&lt;<span class="fragmentname"><a href="#fragment-FollowphotonpathformonophotonIndex-0">Follow photon path for <tt>photonIndex</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1603" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1603"><i></i></a><div id="fragbit-1603" class="collapse"><div class="fragmentcode">                  uint64_t haltonIndex = (uint64_t)iter * (uint64_t)<a href="#SPPMIntegrator::photonsPerIteration" class="code">photonsPerIteration</a> +
                                         photonIndex;
                  int haltonDim = 0;
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Chooselighttoshootphotonfrom-0">Choose light to shoot photon from</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1604" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1604"><i></i></a><div id="fragbit-1604" class="collapse"><div class="fragmentcode">                     Float lightPdf;
                     Float lightSample = <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex);
                     int lightNum = lightDistr-&gt;<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(lightSample, &amp;lightPdf);
                     const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[lightNum];</div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Computesamplevaluesforphotonrayleavinglightsource-0">Compute sample values for photon ray leaving light source</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1605" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1605"><i></i></a><div id="fragbit-1605" class="collapse"><div class="fragmentcode">                     <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight0(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                                     <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
                     <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight1(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 2, haltonIndex),
                                     <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 3, haltonIndex));
                     Float uLightTime = <a href="../Utilities/Mathematical_Routines.html#Lerp" class="code">Lerp</a>(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 4, haltonIndex),
                                             camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterOpen" class="code">shutterOpen</a>, camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterClose" class="code">shutterClose</a>);
                     haltonDim += 5;</div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonophotonRayfromlightsourceandinitializemonobeta-0">Generate <tt>photonRay</tt> from light source and initialize <tt>beta</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1606" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1606"><i></i></a><div id="fragbit-1606" class="collapse"><div class="fragmentcode">                     RayDifferential photonRay;
                     <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> nLight;
                     Float pdfPos, pdfDir;
                     <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Le =
                         light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le" class="code">Sample_Le</a>(uLight0, uLight1, uLightTime,
                                          &amp;photonRay, &amp;nLight, &amp;pdfPos, &amp;pdfDir);
                     if (pdfPos == 0 || pdfDir == 0 || Le.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) return;
                     <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = (<a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(nLight, photonRay.d) * Le) /
                                     (lightPdf * pdfPos * pdfDir);
                     if (beta.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                         return;</div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Followphotonpaththroughsceneandrecordintersections-0">Follow photon path through scene and record intersections</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1607" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1607"><i></i></a><div id="fragbit-1607" class="collapse"><div class="fragmentcode">                     <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
                     for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
                         if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(photonRay, &amp;isect))
                             break;
                         if (depth &gt; 0) {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontonearbyvisiblepoints-0">Add photon contribution to nearby visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1608" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1608"><i></i></a><div id="fragbit-1608" class="collapse"><div class="fragmentcode">                                Point3i photonGridIndex;
                                if (<a href="#ToGrid" class="code">ToGrid</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, gridBounds, gridRes, &amp;photonGridIndex)) {
                                    int h = <a href="#hash" class="code">hash</a>(photonGridIndex, hashSize);
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontovisiblepointsinmonogridh-0">Add photon contribution to visible points in <tt>grid[h]</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1609" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1609"><i></i></a><div id="fragbit-1609" class="collapse"><div class="fragmentcode">                                       for (SPPMPixelListNode *node = grid[h].load(std::memory_order_relaxed);
                                            node != nullptr; node = node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>) {
                                           SPPMPixel &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = *node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                                           Float <a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::radius" class="code">radius</a>;
                                           if (<a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>) &gt; <a href="#SPPMPixel::radius" class="code">radius</a> * <a href="#SPPMPixel::radius" class="code">radius</a>)
                                               continue;
                                           &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopixelPhiandMfornearbyphoton-0">Update <tt>pixel</tt> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> for nearby photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1610" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1610"><i></i></a><div id="fragbit-1610" class="collapse"><div class="fragmentcode">                                              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                                              <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a> = beta * pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::wo" class="code">wo</a>, wi);
                                              for (int i = 0; i &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++i)
                                                  pixel.<a href="#SPPMPixel::Phi" class="code">Phi</a>[i].<a href="../Utilities/Parallelism.html#AtomicFloat::Add" class="code">Add</a>(<a href="#SPPMPixel::Phi" class="code">Phi</a>[i]);
                                              ++pixel.M;</div></div> 
                                       }</div></div>
                                }</div></div>
                         }
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewphotonraydirection-0">Sample new photon ray direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1611" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1611"><i></i></a><div id="fragbit-1611" class="collapse"><div class="fragmentcode">                            &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatphotonintersectionpoint-0">Compute BSDF at photon intersection point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1612" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1612"><i></i></a><div id="fragbit-1612" class="collapse"><div class="fragmentcode">                               isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(photonRay, arena, true,
                                                                <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance);
                               if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                                   --depth;
                                   photonRay = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(photonRay.d);
                                   continue;
                               }
                               const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;photonBSDF = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
                            &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFmonofranddirectionmonowiforreflectedphoton-0">Sample BSDF <tt>fr</tt> and direction <tt>wi</tt> for reflected photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1613" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1613"><i></i></a><div id="fragbit-1613" class="collapse"><div class="fragmentcode">                               <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, wo = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                               Float pdf;
                               BxDFType flags;
                               &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonobsdfSampleforoutgoingphotonsample-0">Generate <tt>bsdfSample</tt> for outgoing photon sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1614" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1614"><i></i></a><div id="fragbit-1614" class="collapse"><div class="fragmentcode">                                  <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> bsdfSample(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                                                     <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
                                  haltonDim += 2;</div></div>
                               <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> fr = photonBSDF.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, bsdfSample,
                                                                 &amp;pdf, BSDF_ALL, &amp;flags);
                               if (fr.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdf == 0.f) break;</div></div>
                            <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> bnew = beta * fr * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdf;
                            &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatephotonpathwithRussianroulette-0">Possibly terminate photon path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1615" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1615"><i></i></a><div id="fragbit-1615" class="collapse"><div class="fragmentcode">                               Float q = std::max((Float)0, 1 - bnew.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>() / beta.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>());
                               if (<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex) &lt; q)
                                   break;
                               beta = bnew / (1 - q);</div></div>
                            photonRay = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
                     }</div></div></div></div>
               arena.<a href="../Utilities/Memory_Management.html#MemoryArena::Reset" class="code">Reset</a>();
           }, <a href="#SPPMIntegrator::photonsPerIteration" class="code">photonsPerIteration</a>, 8192);
       </div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatepixelvaluesfromthispasssphotons-0">Update pixel values from this pass&rsquo;s photons</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1616" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1616"><i></i></a><div id="fragbit-1616" class="collapse"><div class="fragmentcode">       for (int i = 0; i &lt; nPixels; ++i) {
           SPPMPixel &amp;p = pixels[i];
           if (p.<a href="#SPPMPixel::M" class="code">M</a> &gt; 0) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatepixelphotoncountsearchradiusandtaufromphotons-0">Update pixel photon count, search radius, and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.188ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 511.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">tau</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70F" d="M511 407c0 -34 -36 -34 -49 -34h-168l-67 -342c-3 -15 -8 -43 -41 -43c-22 0 -29 16 -29 27c0 4 6 25 10 37l98 321h-83c-21 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 6 28 54 61 90c44 47 83 47 103 47h280c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70F" x="0" y="0"></use>
</g>
</svg> from photons</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1617" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1617"><i></i></a><div id="fragbit-1617" class="collapse"><div class="fragmentcode">                  Float gamma = (Float)2 / (Float)3;
                  Float Nnew = p.<a href="#SPPMPixel::N" class="code">N</a> + gamma * p.M;
                  Float Rnew = p.<a href="#SPPMPixel::radius" class="code">radius</a> * std::sqrt(Nnew / (p.<a href="#SPPMPixel::N" class="code">N</a> + p.M));
                  <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a>;
                  for (int j = 0; j &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++j)
                      <a href="#SPPMPixel::Phi" class="code">Phi</a>[j] = p.<a href="#SPPMPixel::Phi" class="code">Phi</a>[j];
                  p.<a href="#SPPMPixel::tau" class="code">tau</a> = (p.<a href="#SPPMPixel::tau" class="code">tau</a> + p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a> * <a href="#SPPMPixel::Phi" class="code">Phi</a>) *
                          (Rnew * Rnew) / (p.<a href="#SPPMPixel::radius" class="code">radius</a> * p.<a href="#SPPMPixel::radius" class="code">radius</a>);
                  p.<a href="#SPPMPixel::N" class="code">N</a> = Nnew;
                  p.<a href="#SPPMPixel::radius" class="code">radius</a> = Rnew;</div></div>
               p.<a href="#SPPMPixel::M" class="code">M</a> = 0;
               for (int j = 0; j &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++j)
                   p.<a href="#SPPMPixel::Phi" class="code">Phi</a>[j] = (Float)0;
           }
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ResetmonoVisiblePointinpixel-0">Reset <tt>VisiblePoint</tt> in pixel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1618" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1618"><i></i></a><div id="fragbit-1618" class="collapse"><div class="fragmentcode">              p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a> = 0.;
              p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a> = nullptr;</div></div>
       }
       </div></div>
    &lt;&lt;<span class="fragmentname">Periodically store SPPM image in film and write image</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1619" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1619"><i></i></a><div id="fragbit-1619" class="collapse"><div class="fragmentcode">       if (iter + 1 == nIterations || ((iter + 1) % writeFrequency) == 0) {
           int x0 = pixelBounds.pMin.x;
           int x1 = pixelBounds.pMax.x;
           uint64_t Np = (uint64_t)(iter + 1) * (uint64_t)photonsPerIteration;
           std::unique_ptr&lt;<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>[]&gt; image(new <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>[pixelBounds.Area()]);
           int offset = 0;
           for (int y = pixelBounds.pMin.y; y &lt; pixelBounds.pMax.y; ++y) {
               for (int x = x0; x &lt; x1; ++x) {
                   &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeradiancemonoLforSPPMpixelmonopixel-0">Compute radiance <tt>L</tt> for SPPM pixel <tt>pixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1620" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1620"><i></i></a><div id="fragbit-1620" class="collapse"><div class="fragmentcode">                      const SPPMPixel &amp;pixel = pixels[(y - pixelBounds.pMin.y) * (x1 - x0) +
                                                      (x - x0)];
                      <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> L = pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> / (iter + 1);
                      L += pixel.<a href="#SPPMPixel::tau" class="code">tau</a> / (Np * <a href="../Utilities/Main_Include_File.html#Pi" class="code">Pi</a> * pixel.<a href="#SPPMPixel::radius" class="code">radius</a> * pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);</div></div>
                   image[offset++] = L;
               }
           }
           camera-&gt;film-&gt;SetImage(image.get());
           camera-&gt;film-&gt;WriteImage();
       }</div></div>
}
</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-SPPMIntegratorPrivateData-1"></span><div class="fragmentname">&lt;&lt;SPPMIntegrator Private Data&gt;&gt;+=&nbsp;<a href="#fragment-SPPMIntegratorPrivateData-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-SPPMIntegratorPrivateData-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">const int <span class="anchor" id="SPPMIntegrator::nIterations"></span>nIterations;</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#AccumulatingVisiblePoints"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="per-thread-arenas"></span><span id="AccumulatingVisiblePoints"></span><h3>16.2.4  Accumulating Visible Points</h3><p>


</p>
<p>Similar to the <a href="../Introduction/pbrt_System_Overview.html#SamplerIntegrator"><tt>SamplerIntegrator</tt></a>, the <tt>SPPMIntegrator</tt>
decomposes the image into tiles of 16 pixels square and parallelizes the
generation of camera paths and visible points over these tiles.  The number
of tiles is computed in the same manner as in the fragment
&lt;&lt;<span class="fragmentname"><a href="../Introduction/pbrt_System_Overview.html#fragment-ComputenumberoftilesmononTilestouseforparallelrendering-0">Compute number of tiles, <tt>nTiles</tt>, to use for parallel
rendering</a></span>&gt;&gt;.

</p>
<p></p>
<span class="anchor" id="fragment-ComputenumberoftilestouseforSPPMcamerapass-0"></span><div class="fragmentname">&lt;&lt;Compute number of tiles to use for SPPM camera pass&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Vector2i pixelExtent = pixelBounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::Diagonal" class="code">Diagonal</a>();
const int tileSize = 16;
<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> nTiles((pixelExtent.x + tileSize - 1) / tileSize,
               (pixelExtent.y + tileSize - 1) / tileSize);</div><p>


</p>
<p>Unlike the path tracer, where the BSDF can be discarded after estimating
the direct illumination and sampling the outgoing direction at each vertex,
here we need to store the <tt>BSDF</tt>s for the visible points until the
photon pass for the current iteration is done.  Therefore, the
<a href="../Utilities/Memory_Management.html#MemoryArena"><tt>MemoryArena</tt></a>s used for allocating the <a href="../Materials/BSDFs.html#BSDF"><tt>BSDF</tt></a>s during camera path
tracing aren&rsquo;t reset at the end of loop iterations here.

</p>
<p>Note also that we only allocate one arena per worker thread used to run the
parallel <tt>for</tt> loop and use the <a href="../Utilities/Parallelism.html#ThreadIndex"><tt>ThreadIndex</tt></a> global
to index into the vector, rather than allocating a
separate arena for each loop iteration.  In this way, we avoid the overhead
of having many separate <tt>MemoryArena</tt>s while still ensuring that each
arena is not used by more than one processing thread (which would lead to
race conditions in the <tt>MemoryArena</tt> methods).

</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-GenerateSPPMvisiblepoints-0"></span><div class="fragmentname">&lt;&lt;Generate SPPM visible points&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">std::vector&lt;<a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a>&gt; perThreadArenas(<a href="../Utilities/Parallelism.html#MaxThreadIndex" class="code">MaxThreadIndex</a>());
<a href="../Utilities/Parallelism.html#ParallelFor2D" class="code">ParallelFor2D</a>(
    [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> tile) {
        <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = perThreadArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
        &lt;&lt;<span class="fragmentname"><a href="#fragment-FollowcamerapathsformonotileinimageforSPPM-0">Follow camera paths for <tt>tile</tt> in image for SPPM</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1621" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1621"><i></i></a><div id="fragbit-1621" class="collapse"><div class="fragmentcode">           int tileIndex = tile.y * nTiles.x + tile.x;
           std::unique_ptr&lt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a>&gt; tileSampler = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Clone" class="code">Clone</a>(tileIndex);
           &lt;&lt;<span class="fragmentname">Compute <tt>tileBounds</tt> for SPPM tile</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1622" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1622"><i></i></a><div id="fragbit-1622" class="collapse"><div class="fragmentcode">              int x0 = pixelBounds.pMin.x + tile.x * tileSize;
              int x1 = std::min(x0 + tileSize, pixelBounds.pMax.x);
              int y0 = pixelBounds.pMin.y + tile.y * tileSize;
              int y1 = std::min(y0 + tileSize, pixelBounds.pMax.y);
              Bounds2i tileBounds(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(x0, y0), <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(x1, y1));</div></div>
           for (<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixel : tileBounds) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-PreparemonotileSamplerformonopPixel-0">Prepare <tt>tileSampler</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1623" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1623"><i></i></a><div id="fragbit-1623" class="collapse"><div class="fragmentcode">                  tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::StartPixel" class="code">StartPixel</a>(pPixel);
                  tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::SetSampleNumber" class="code">SetSampleNumber</a>(iter);</div></div>
               &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratecamerarayforpixelforSPPM-0">Generate camera ray for pixel for SPPM</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1624" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1624"><i></i></a><div id="fragbit-1624" class="collapse"><div class="fragmentcode">                  CameraSample cameraSample = tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::GetCameraSample" class="code">GetCameraSample</a>(pPixel);
                  RayDifferential ray;
                  <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::GenerateRayDifferential" class="code">GenerateRayDifferential</a>(cameraSample, &amp;ray);
                  </div></div>
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Followcameraraypathuntilavisiblepointiscreated-0">Follow camera ray path until a visible point is created</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1625" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1625"><i></i></a><div id="fragbit-1625" class="collapse"><div class="fragmentcode">                  &lt;&lt;<span class="fragmentname"><a href="#fragment-GetmonoSPPMPixelformonopPixel-0">Get <tt>SPPMPixel</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1626" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1626"><i></i></a><div id="fragbit-1626" class="collapse"><div class="fragmentcode">                     <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixelO = <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(pPixel - pixelBounds.pMin);
                     int pixelOffset = pPixelO.x +
                                       pPixelO.y * (pixelBounds.pMax.x - pixelBounds.pMin.x);
                     SPPMPixel &amp;pixel = pixels[pixelOffset];</div></div>
                  bool specularBounce = false;
                  for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
                      <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
                      if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(ray, &amp;isect)) {
                          &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatelightcontributionsforraywithnointersection-0">Accumulate light contributions for ray with no intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1627" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1627"><i></i></a><div id="fragbit-1627" class="collapse"><div class="fragmentcode">                             for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
                                pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(ray);</div></div>
                          break;
                      }
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcessSPPMcamerarayintersection-0">Process SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1628" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1628"><i></i></a><div id="fragbit-1628" class="collapse"><div class="fragmentcode">                         &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatSPPMcamerarayintersection-0">Compute BSDF at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1629" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1629"><i></i></a><div id="fragbit-1629" class="collapse"><div class="fragmentcode">                            isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true);
                            if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                                ray = isect.SpawnRay(ray.d);
                                --depth;
                                continue;
                            }
                            const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a> = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-AccumulatedirectilluminationatSPPMcamerarayintersection-0">Accumulate direct illumination at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1630" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1630"><i></i></a><div id="fragbit-1630" class="collapse"><div class="fragmentcode">                            <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                            if (depth == 0 || specularBounce)
                                pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(wo);
                            pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta *
                                <a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#UniformSampleOneLight" class="code">UniformSampleOneLight</a>(isect, scene, arena, *tileSampler);</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Possiblycreatevisiblepointandendcamerapath-0">Possibly create visible point and end camera path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1631" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1631"><i></i></a><div id="fragbit-1631" class="collapse"><div class="fragmentcode">                            bool isDiffuse =
                                bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_DIFFUSE | BSDF_REFLECTION |
                                                            BSDF_TRANSMISSION)) &gt; 0;
                            bool isGlossy =
                                bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_GLOSSY | BSDF_REFLECTION |
                                                            BSDF_TRANSMISSION)) &gt; 0;
                            if (isDiffuse || (isGlossy &amp;&amp; depth == maxDepth - 1)) {
                                pixel.<a href="#SPPMPixel::vp" class="code">vp</a> = {isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, wo, &amp;bsdf, beta};
                                break;
                            }</div></div>
                         &lt;&lt;<span class="fragmentname">Spawn ray from SPPM camera path vertex</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1632" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1632"><i></i></a><div id="fragbit-1632" class="collapse"><div class="fragmentcode">                            if (depth &lt; maxDepth - 1) {
                                Float pdf;
                                <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
                                BxDFType type;
                                <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = bsdf.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdf, BSDF_ALL, &amp;type);
                                if (pdf == 0. || f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                                    break;
                                specularBounce = (type &amp; BSDF_SPECULAR) != 0;
                                beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi,     isect.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading" class="code">shading</a>.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / pdf;
                                if (beta.y() &lt; 0.25) {
                                    Float continueProb = std::min((Float)1, beta.y());
                                    if (tileSampler-&gt;Get1D() &gt; continueProb)
                                        break;
                                    beta /= continueProb;
                                }
                                ray = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);
                            }</div></div></div></div>
                  }</div></div>
           }</div></div>
    }, nTiles);
&lt;&lt;<span class="fragmentname"><a href="#fragment-CreategridofallSPPMvisiblepoints-0">Create grid of all SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1633" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1633"><i></i></a><div id="fragbit-1633" class="collapse"><div class="fragmentcode">   &lt;&lt;<span class="fragmentname"><a href="#fragment-AllocategridforSPPMvisiblepoints-0">Allocate grid for SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1634" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1634"><i></i></a><div id="fragbit-1634" class="collapse"><div class="fragmentcode">      int hashSize = nPixels;
      std::vector&lt;std::atomic&lt;SPPMPixelListNode *&gt;&gt; grid(hashSize);</div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputegridboundsforSPPMvisiblepoints-0">Compute grid bounds for SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1635" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1635"><i></i></a><div id="fragbit-1635" class="collapse"><div class="fragmentcode">      <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> gridBounds;
      Float maxRadius = 0.;
      for (int i = 0; i &lt; nPixels; ++i) {
          const SPPMPixel &amp;pixel = pixels[i];
          if (pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
              continue;
          <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> vpBound = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Expand" class="code">Expand</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.p), pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
          gridBounds = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Union" class="code">Union</a>(gridBounds, vpBound);
          maxRadius = std::max(maxRadius, pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
      }</div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeresolutionofSPPMgridineachdimension-0">Compute resolution of SPPM grid in each dimension</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1636" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1636"><i></i></a><div id="fragbit-1636" class="collapse"><div class="fragmentcode">      <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> diag = gridBounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>();
      Float maxDiag = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::MaxComponent" class="code">MaxComponent</a>(diag);
      int baseGridRes = (int)(maxDiag / maxRadius);
      int gridRes[3];
      for (int i = 0; i &lt; 3; ++i)
          gridRes[i] = std::max((int)(baseGridRes * diag[i] / maxDiag), 1);</div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-AddvisiblepointstoSPPMgrid-0">Add visible points to SPPM grid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1637" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1637"><i></i></a><div id="fragbit-1637" class="collapse"><div class="fragmentcode">      <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(
          [&amp;](int pixelIndex) {
              <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = perThreadArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
              SPPMPixel &amp;pixel = pixels[pixelIndex];
              if (!pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Addpixelsvisiblepointtoapplicablegridcells-0">Add pixel&rsquo;s visible point to applicable grid cells</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1638" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1638"><i></i></a><div id="fragbit-1638" class="collapse"><div class="fragmentcode">                     Float <a href="#SPPMPixel::radius" class="code">radius</a> = pixel.<a href="#SPPMPixel::radius" class="code">radius</a>;
                     Point3i pMin, pMax;
                     <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> - <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                            gridBounds, gridRes, &amp;pMin);
                     <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> + <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                            gridBounds, gridRes, &amp;pMax);
                     for (int z = pMin.z; z &lt;= pMax.z; ++z)
                         for (int y = pMin.y; y &lt;= pMax.y; ++y)
                             for (int x = pMin.x; x &lt;= pMax.x; ++x) {
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Addvisiblepointtogridcellxyz-0">Add visible point to grid cell <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.432ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3199.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y comma z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1897" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="2342" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2810" y="0"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1639" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1639"><i></i></a><div id="fragbit-1639" class="collapse"><div class="fragmentcode">                                    int h = <a href="#hash" class="code">hash</a>(Point3i(x, y, z), hashSize);
                                    SPPMPixelListNode *node = arena.Alloc&lt;SPPMPixelListNode&gt;();
                                    node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-Atomicallyaddmononodetothestartofmonogridhslinkedlist-0">Atomically add <tt>node</tt> to the start of <tt>grid[h]</tt>&rsquo;s linked list</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1640" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1640"><i></i></a><div id="fragbit-1640" class="collapse"><div class="fragmentcode">                                       node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a> = grid[h];
                                       while (grid[h].compare_exchange_weak(node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>, node) == false)
                                           ;</div></div></div></div>
                             }
                     </div></div>
              }
          }, nPixels, 4096);
      </div></div></div></div></div><p>


</p>
<p>We also need a unique <tt>Sampler</tt> for the thread processing the tile; as
before, <tt>Sampler::Clone()</tt> provides one.

</p>
<p></p>
<span class="anchor" id="fragment-FollowcamerapathsformonotileinimageforSPPM-0"></span><div class="fragmentname">&lt;&lt;Follow camera paths for <tt>tile</tt> in image for SPPM&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int tileIndex = tile.y * nTiles.x + tile.x;
std::unique_ptr&lt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a>&gt; tileSampler = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Clone" class="code">Clone</a>(tileIndex);
&lt;&lt;<span class="fragmentname">Compute <tt>tileBounds</tt> for SPPM tile</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1641" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1641"><i></i></a><div id="fragbit-1641" class="collapse"><div class="fragmentcode">   int x0 = pixelBounds.pMin.x + tile.x * tileSize;
   int x1 = std::min(x0 + tileSize, pixelBounds.pMax.x);
   int y0 = pixelBounds.pMin.y + tile.y * tileSize;
   int y1 = std::min(y0 + tileSize, pixelBounds.pMax.y);
   Bounds2i tileBounds(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(x0, y0), <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(x1, y1));</div></div>
for (<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixel : tileBounds) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PreparemonotileSamplerformonopPixel-0">Prepare <tt>tileSampler</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1642" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1642"><i></i></a><div id="fragbit-1642" class="collapse"><div class="fragmentcode">       tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::StartPixel" class="code">StartPixel</a>(pPixel);
       tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::SetSampleNumber" class="code">SetSampleNumber</a>(iter);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratecamerarayforpixelforSPPM-0">Generate camera ray for pixel for SPPM</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1643" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1643"><i></i></a><div id="fragbit-1643" class="collapse"><div class="fragmentcode">       CameraSample cameraSample = tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::GetCameraSample" class="code">GetCameraSample</a>(pPixel);
       RayDifferential ray;
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::GenerateRayDifferential" class="code">GenerateRayDifferential</a>(cameraSample, &amp;ray);
       </div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Followcameraraypathuntilavisiblepointiscreated-0">Follow camera ray path until a visible point is created</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1644" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1644"><i></i></a><div id="fragbit-1644" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-GetmonoSPPMPixelformonopPixel-0">Get <tt>SPPMPixel</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1645" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1645"><i></i></a><div id="fragbit-1645" class="collapse"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixelO = <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(pPixel - pixelBounds.pMin);
          int pixelOffset = pPixelO.x +
                            pPixelO.y * (pixelBounds.pMax.x - pixelBounds.pMin.x);
          SPPMPixel &amp;pixel = pixels[pixelOffset];</div></div>
       bool specularBounce = false;
       for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
           <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
           if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(ray, &amp;isect)) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatelightcontributionsforraywithnointersection-0">Accumulate light contributions for ray with no intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1646" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1646"><i></i></a><div id="fragbit-1646" class="collapse"><div class="fragmentcode">                  for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
                     pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(ray);</div></div>
               break;
           }
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcessSPPMcamerarayintersection-0">Process SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1647" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1647"><i></i></a><div id="fragbit-1647" class="collapse"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatSPPMcamerarayintersection-0">Compute BSDF at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1648" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1648"><i></i></a><div id="fragbit-1648" class="collapse"><div class="fragmentcode">                 isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true);
                 if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                     ray = isect.SpawnRay(ray.d);
                     --depth;
                     continue;
                 }
                 const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a> = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-AccumulatedirectilluminationatSPPMcamerarayintersection-0">Accumulate direct illumination at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1649" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1649"><i></i></a><div id="fragbit-1649" class="collapse"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                 if (depth == 0 || specularBounce)
                     pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(wo);
                 pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta *
                     <a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#UniformSampleOneLight" class="code">UniformSampleOneLight</a>(isect, scene, arena, *tileSampler);</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Possiblycreatevisiblepointandendcamerapath-0">Possibly create visible point and end camera path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1650" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1650"><i></i></a><div id="fragbit-1650" class="collapse"><div class="fragmentcode">                 bool isDiffuse =
                     bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_DIFFUSE | BSDF_REFLECTION |
                                                 BSDF_TRANSMISSION)) &gt; 0;
                 bool isGlossy =
                     bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_GLOSSY | BSDF_REFLECTION |
                                                 BSDF_TRANSMISSION)) &gt; 0;
                 if (isDiffuse || (isGlossy &amp;&amp; depth == maxDepth - 1)) {
                     pixel.<a href="#SPPMPixel::vp" class="code">vp</a> = {isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, wo, &amp;bsdf, beta};
                     break;
                 }</div></div>
              &lt;&lt;<span class="fragmentname">Spawn ray from SPPM camera path vertex</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1651" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1651"><i></i></a><div id="fragbit-1651" class="collapse"><div class="fragmentcode">                 if (depth &lt; maxDepth - 1) {
                     Float pdf;
                     <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
                     BxDFType type;
                     <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = bsdf.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdf, BSDF_ALL, &amp;type);
                     if (pdf == 0. || f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                         break;
                     specularBounce = (type &amp; BSDF_SPECULAR) != 0;
                     beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi,     isect.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading" class="code">shading</a>.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / pdf;
                     if (beta.y() &lt; 0.25) {
                         Float continueProb = std::min((Float)1, beta.y());
                         if (tileSampler-&gt;Get1D() &gt; continueProb)
                             break;
                         beta /= continueProb;
                     }
                     ray = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);
                 }</div></div></div></div>
       }</div></div>
}</div><p>


</p>
<p>The fragment &lt;&lt;<span class="fragmentname">Compute <tt>tileBounds</tt> for SPPM tile</span>&gt;&gt; is very
similar to &lt;&lt;<span class="fragmentname"><a href="../Introduction/pbrt_System_Overview.html#fragment-Computesampleboundsfortile-0">Compute sample bounds for tile</a></span>&gt;&gt; from
Section&nbsp;<a href="../Introduction/pbrt_System_Overview.html#sec:rendering-loop">1.3.4</a> and therefore won&rsquo;t be included here.

</p>
<p>

</p>
<p>Recall that in <tt>SamplerIntegrator</tt>s, the sample vectors in each pixel are
all requested in sequence until the last one is consumed, at which point work
starts on the next pixel. In contrast, the
first SPPM iteration uses the first sample vector for
each pixel; later, the second iteration uses the second sample vector, and
so forth. (In other words, the loop nesting has been interchanged from
&ldquo;for each pixel, for each sample number,&rdquo; to &ldquo;for each sample number,
for each pixel.&rdquo;)  It is for just this use case that the <tt>Sampler</tt>
provides the <tt>SetSampleNumber()</tt> method, which configures the sampler
to provide samples from the given sample vector for the pixel.

</p>
<p></p>
<span class="anchor" id="fragment-PreparemonotileSamplerformonopPixel-0"></span><div class="fragmentname">&lt;&lt;Prepare <tt>tileSampler</tt> for <tt>pPixel</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::StartPixel" class="code">StartPixel</a>(pPixel);
tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::SetSampleNumber" class="code">SetSampleNumber</a>(iter);</div><p>


</p>
<p>We can now start the path from the camera, following the usual approach. As
with the <a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#PathIntegrator"><tt>PathIntegrator</tt></a>, the <tt>beta</tt> variable holds the current path
throughput weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fragment-GeneratecamerarayforpixelforSPPM-0"></span><div class="fragmentname">&lt;&lt;Generate camera ray for pixel for SPPM&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">CameraSample cameraSample = tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::GetCameraSample" class="code">GetCameraSample</a>(pPixel);
RayDifferential ray;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::GenerateRayDifferential" class="code">GenerateRayDifferential</a>(cameraSample, &amp;ray);
</div><p>


</p>
<p>Path tracing can now proceed. As with most other <tt>Integrator</tt>s, the
path length is limited by a predefined maximum depth.

</p>
<p></p>
<span class="anchor" id="fragment-Followcameraraypathuntilavisiblepointiscreated-0"></span><div class="fragmentname">&lt;&lt;Follow camera ray path until a visible point is created&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-GetmonoSPPMPixelformonopPixel-0">Get <tt>SPPMPixel</tt> for <tt>pPixel</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1652" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1652"><i></i></a><div id="fragbit-1652" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixelO = <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(pPixel - pixelBounds.pMin);
   int pixelOffset = pPixelO.x +
                     pPixelO.y * (pixelBounds.pMax.x - pixelBounds.pMin.x);
   SPPMPixel &amp;pixel = pixels[pixelOffset];</div></div>
bool specularBounce = false;
for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
    <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
    if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(ray, &amp;isect)) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatelightcontributionsforraywithnointersection-0">Accumulate light contributions for ray with no intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1653" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1653"><i></i></a><div id="fragbit-1653" class="collapse"><div class="fragmentcode">           for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
              pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(ray);</div></div>
        break;
    }
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcessSPPMcamerarayintersection-0">Process SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1654" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1654"><i></i></a><div id="fragbit-1654" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatSPPMcamerarayintersection-0">Compute BSDF at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1655" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1655"><i></i></a><div id="fragbit-1655" class="collapse"><div class="fragmentcode">          isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true);
          if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
              ray = isect.SpawnRay(ray.d);
              --depth;
              continue;
          }
          const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a> = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-AccumulatedirectilluminationatSPPMcamerarayintersection-0">Accumulate direct illumination at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1656" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1656"><i></i></a><div id="fragbit-1656" class="collapse"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
          if (depth == 0 || specularBounce)
              pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(wo);
          pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta *
              <a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#UniformSampleOneLight" class="code">UniformSampleOneLight</a>(isect, scene, arena, *tileSampler);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Possiblycreatevisiblepointandendcamerapath-0">Possibly create visible point and end camera path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1657" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1657"><i></i></a><div id="fragbit-1657" class="collapse"><div class="fragmentcode">          bool isDiffuse =
              bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_DIFFUSE | BSDF_REFLECTION |
                                          BSDF_TRANSMISSION)) &gt; 0;
          bool isGlossy =
              bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_GLOSSY | BSDF_REFLECTION |
                                          BSDF_TRANSMISSION)) &gt; 0;
          if (isDiffuse || (isGlossy &amp;&amp; depth == maxDepth - 1)) {
              pixel.<a href="#SPPMPixel::vp" class="code">vp</a> = {isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, wo, &amp;bsdf, beta};
              break;
          }</div></div>
       &lt;&lt;<span class="fragmentname">Spawn ray from SPPM camera path vertex</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1658" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1658"><i></i></a><div id="fragbit-1658" class="collapse"><div class="fragmentcode">          if (depth &lt; maxDepth - 1) {
              Float pdf;
              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
              BxDFType type;
              <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = bsdf.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdf, BSDF_ALL, &amp;type);
              if (pdf == 0. || f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                  break;
              specularBounce = (type &amp; BSDF_SPECULAR) != 0;
              beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi,     isect.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading" class="code">shading</a>.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / pdf;
              if (beta.y() &lt; 0.25) {
                  Float continueProb = std::min((Float)1, beta.y());
                  if (tileSampler-&gt;Get1D() &gt; continueProb)
                      break;
                  beta /= continueProb;
              }
              ray = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);
          }</div></div></div></div>
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-SPPMIntegratorPrivateData-2"></span><div class="fragmentname">&lt;&lt;SPPMIntegrator Private Data&gt;&gt;+=&nbsp;<a href="#fragment-SPPMIntegratorPrivateData-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-SPPMIntegratorPrivateData-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">const int <span class="anchor" id="SPPMIntegrator::maxDepth"></span>maxDepth;</div><p>


</p>
<p>To find the <tt>SPPMPixel</tt> in the <tt>pixels</tt> array for the current
pixel, we need to offset by the minimum pixel coordinate and convert to a
linear index.

</p>
<p></p>
<span class="anchor" id="fragment-GetmonoSPPMPixelformonopPixel-0"></span><div class="fragmentname">&lt;&lt;Get <tt>SPPMPixel</tt> for <tt>pPixel</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pPixelO = <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(pPixel - pixelBounds.pMin);
int pixelOffset = pPixelO.x +
                  pPixelO.y * (pixelBounds.pMax.x - pixelBounds.pMin.x);
SPPMPixel &amp;pixel = pixels[pixelOffset];</div><p>


</p>
<p>As described in Section&nbsp;<a href="#sec:photon-mapping-theory">16.2.2</a>, a regular direct
lighting calculation is performed at each vertex of the camera path.  Thus,
for rays that don&rsquo;t intersect any scene geometry, infinite area lights must
be allowed a chance to contribute direct lighting via the
<tt>Light::Le()</tt> method.

</p>
<p></p>
<span class="anchor" id="fragment-Accumulatelightcontributionsforraywithnointersection-0"></span><div class="fragmentname">&lt;&lt;Accumulate light contributions for ray with no intersection&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
   pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(ray);</div><p>


</p>
<p><tt>SPPMPixel::Ld</tt> records the weighted sum of emitted and reflected
direct illumination for all camera path vertices for the pixel (in other
words, the first two terms of Equation&nbsp;(<a href="#eq:ppm-lte-decomp">16.12</a>)).  Note
that these terms are also evaluated at vertices found by sampling the BSDF
and tracing a ray for the third term; <tt>Ld</tt> doesn&rsquo;t just store direct
illumination at the first vertex.  Because this sum of outgoing radiance
includes contributions of all of the samples in a pixel, this value must be
divided by <a href="#SPPMIntegrator::nIterations"><tt>SPPMIntegrator::nIterations</tt></a> to get the average direct
illumination for the final pixel radiance estimate.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMPixelPublicData-1"></span><div class="fragmentname">&lt;&lt;SPPMPixel Public Data&gt;&gt;+=&nbsp;<a href="#fragment-SPPMPixelPublicData-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-SPPMPixelPublicData-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <span class="anchor" id="SPPMPixel::Ld"></span>Ld;</div><p>


</p>
<p>More commonly, the ray intersects a surface
and &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcessSPPMcamerarayintersection-0">Process SPPM camera ray intersection</a></span>&gt;&gt; executes

</p>
<p></p>
<span class="anchor" id="fragment-ProcessSPPMcamerarayintersection-0"></span><div class="fragmentname">&lt;&lt;Process SPPM camera ray intersection&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatSPPMcamerarayintersection-0">Compute BSDF at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1659" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1659"><i></i></a><div id="fragbit-1659" class="collapse"><div class="fragmentcode">   isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true);
   if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
       ray = isect.SpawnRay(ray.d);
       --depth;
       continue;
   }
   const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a> = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-AccumulatedirectilluminationatSPPMcamerarayintersection-0">Accumulate direct illumination at SPPM camera ray intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1660" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1660"><i></i></a><div id="fragbit-1660" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
   if (depth == 0 || specularBounce)
       pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(wo);
   pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta *
       <a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#UniformSampleOneLight" class="code">UniformSampleOneLight</a>(isect, scene, arena, *tileSampler);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Possiblycreatevisiblepointandendcamerapath-0">Possibly create visible point and end camera path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1661" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1661"><i></i></a><div id="fragbit-1661" class="collapse"><div class="fragmentcode">   bool isDiffuse =
       bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_DIFFUSE | BSDF_REFLECTION |
                                   BSDF_TRANSMISSION)) &gt; 0;
   bool isGlossy =
       bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_GLOSSY | BSDF_REFLECTION |
                                   BSDF_TRANSMISSION)) &gt; 0;
   if (isDiffuse || (isGlossy &amp;&amp; depth == maxDepth - 1)) {
       pixel.<a href="#SPPMPixel::vp" class="code">vp</a> = {isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, wo, &amp;bsdf, beta};
       break;
   }</div></div>
&lt;&lt;<span class="fragmentname">Spawn ray from SPPM camera path vertex</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1662" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1662"><i></i></a><div id="fragbit-1662" class="collapse"><div class="fragmentcode">   if (depth &lt; maxDepth - 1) {
       Float pdf;
       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
       BxDFType type;
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = bsdf.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdf, BSDF_ALL, &amp;type);
       if (pdf == 0. || f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
           break;
       specularBounce = (type &amp; BSDF_SPECULAR) != 0;
       beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi,     isect.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading" class="code">shading</a>.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / pdf;
       if (beta.y() &lt; 0.25) {
           Float continueProb = std::min((Float)1, beta.y());
           if (tileSampler-&gt;Get1D() &gt; continueProb)
               break;
           beta /= continueProb;
       }
       ray = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);
   }</div></div></div><p>


</p>
<p>First, we need the BSDF at the intersection point. Recall from
Section&nbsp;<a href="../Volume_Scattering/Media.html#sec:media">11.3</a> that a <tt>nullptr</tt>-valued <tt>BSDF *</tt> means that
an intersection should be ignored, as the surface intersected is only in the
scene to delineate the boundary of participating media.  The
<a href="#SPPMIntegrator"><tt>SPPMIntegrator</tt></a> does not account for participating media; thus we simply
skip over the intersection and restart the current loop iteration.
 
</p>
<span class="anchor" id="fragment-ComputeBSDFatSPPMcamerarayintersection-0"></span><div class="fragmentname">&lt;&lt;Compute BSDF at SPPM camera ray intersection&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true);
if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
    ray = isect.SpawnRay(ray.d);
    --depth;
    continue;
}
const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a> = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div><p>


</p>
<p>As in other integrators, emitted radiance from the surface is only included
for the first intersection from the camera or after a specular bounce,
where no direct lighting calculation was possible.

</p>
<p></p>
<span class="anchor" id="fragment-AccumulatedirectilluminationatSPPMcamerarayintersection-0"></span><div class="fragmentname">&lt;&lt;Accumulate direct illumination at SPPM camera ray intersection&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
if (depth == 0 || specularBounce)
    pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta * isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(wo);
pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> += beta *
    <a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#UniformSampleOneLight" class="code">UniformSampleOneLight</a>(isect, scene, arena, *tileSampler);</div><p>


</p>
<p>The implementation here creates a visible point at the first diffuse
surface found or if the path is about to hit its maximum length and we
have a glossy surface. As explained earlier, a visible point at a perfectly
specular surface will never respond to incident photons, and a glossy
surface may have high variance if the specular lobe is tight and not enough
photons have arrived to represent the incident radiance distribution well.

</p>
<p></p>
<span class="anchor" id="fragment-Possiblycreatevisiblepointandendcamerapath-0"></span><div class="fragmentname">&lt;&lt;Possibly create visible point and end camera path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">bool isDiffuse =
    bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_DIFFUSE | BSDF_REFLECTION |
                                BSDF_TRANSMISSION)) &gt; 0;
bool isGlossy =
    bsdf.<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(BxDFType(BSDF_GLOSSY | BSDF_REFLECTION |
                                BSDF_TRANSMISSION)) &gt; 0;
if (isDiffuse || (isGlossy &amp;&amp; depth == maxDepth - 1)) {
    pixel.<a href="#SPPMPixel::vp" class="code">vp</a> = {isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, wo, &amp;bsdf, beta};
    break;
}</div><p>


</p>
<p>The <tt>VisiblePoint</tt> structure records a point found along a camera path
at which we&rsquo;ll look for nearby photons during the photon shooting pass. It
stores enough information to compute the reflected radiance due to an
incident photon, which in turn is scaled by the path throughput weight of the
visible point to find the overall contribution to the original image
sample.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMPixelPublicData-2"></span><div class="fragmentname">&lt;&lt;SPPMPixel Public Data&gt;&gt;+=&nbsp;<a href="#fragment-SPPMPixelPublicData-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-SPPMPixelPublicData-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">struct <span class="anchor" id="VisiblePoint"></span>VisiblePoint {
    &lt;&lt;<span class="fragmentname">VisiblePoint Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1663" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1663"><i></i></a><div id="fragbit-1663" class="collapse"><div class="fragmentcode">       VisiblePoint() { }
       VisiblePoint(const <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> &amp;p, const <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> &amp;wo, const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> *bsdf,
                    const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;beta)
           : p(p), wo(wo), bsdf(bsdf), beta(beta) { }</div></div>
    <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <span class="anchor" id="VisiblePoint::p"></span>p;
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <span class="anchor" id="VisiblePoint::wo"></span>wo;
    const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> *<span class="anchor" id="VisiblePoint::bsdf"></span>bsdf = nullptr;
    <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <span class="anchor" id="VisiblePoint::beta"></span>beta;
} <span class="anchor" id="SPPMPixel::vp"></span>vp;</div><p>


</p>
<p>

</p>
<p>Sampling a ray leaving a vertex follows the same form as &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#fragment-SampleBSDFtogetnewpathdirection-0">Sample
BSDF to get new path direction</a></span>&gt;&gt; in the <a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#PathIntegrator"><tt>PathIntegrator</tt></a> and is
therefore not included here.

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#VisiblePointGridConstruction"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:sppm-hit-point-grid"></span><span id="VisiblePointGridConstruction"></span><h3>16.2.5  Visible Point Grid Construction</h3><p>



</p>
<p>During the photon pass, whenever a photon intersects a surface, we need to
efficiently find the visible points where the distance from the visible
point to the photon&rsquo;s intersection is less than the current search radius <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.848ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 795.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
</g>
</svg>
for the visible point&rsquo;s pixel.  The implementation here uses a uniform grid
over the bounding box of all of the visible points; Exercise&nbsp;16.7 at the
end of the chapter has you implement other data structures in place of the
grid and investigate trade-offs.

</p>
<p></p>
<span class="anchor" id="fragment-CreategridofallSPPMvisiblepoints-0"></span><div class="fragmentname">&lt;&lt;Create grid of all SPPM visible points&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-AllocategridforSPPMvisiblepoints-0">Allocate grid for SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1664" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1664"><i></i></a><div id="fragbit-1664" class="collapse"><div class="fragmentcode">   int hashSize = nPixels;
   std::vector&lt;std::atomic&lt;SPPMPixelListNode *&gt;&gt; grid(hashSize);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputegridboundsforSPPMvisiblepoints-0">Compute grid bounds for SPPM visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1665" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1665"><i></i></a><div id="fragbit-1665" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> gridBounds;
   Float maxRadius = 0.;
   for (int i = 0; i &lt; nPixels; ++i) {
       const SPPMPixel &amp;pixel = pixels[i];
       if (pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
           continue;
       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> vpBound = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Expand" class="code">Expand</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.p), pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
       gridBounds = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Union" class="code">Union</a>(gridBounds, vpBound);
       maxRadius = std::max(maxRadius, pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeresolutionofSPPMgridineachdimension-0">Compute resolution of SPPM grid in each dimension</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1666" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1666"><i></i></a><div id="fragbit-1666" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> diag = gridBounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>();
   Float maxDiag = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::MaxComponent" class="code">MaxComponent</a>(diag);
   int baseGridRes = (int)(maxDiag / maxRadius);
   int gridRes[3];
   for (int i = 0; i &lt; 3; ++i)
       gridRes[i] = std::max((int)(baseGridRes * diag[i] / maxDiag), 1);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-AddvisiblepointstoSPPMgrid-0">Add visible points to SPPM grid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1667" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1667"><i></i></a><div id="fragbit-1667" class="collapse"><div class="fragmentcode">   <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(
       [&amp;](int pixelIndex) {
           <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = perThreadArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
           SPPMPixel &amp;pixel = pixels[pixelIndex];
           if (!pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Addpixelsvisiblepointtoapplicablegridcells-0">Add pixel&rsquo;s visible point to applicable grid cells</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1668" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1668"><i></i></a><div id="fragbit-1668" class="collapse"><div class="fragmentcode">                  Float <a href="#SPPMPixel::radius" class="code">radius</a> = pixel.<a href="#SPPMPixel::radius" class="code">radius</a>;
                  Point3i pMin, pMax;
                  <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> - <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                         gridBounds, gridRes, &amp;pMin);
                  <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> + <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                         gridBounds, gridRes, &amp;pMax);
                  for (int z = pMin.z; z &lt;= pMax.z; ++z)
                      for (int y = pMin.y; y &lt;= pMax.y; ++y)
                          for (int x = pMin.x; x &lt;= pMax.x; ++x) {
                              &lt;&lt;<span class="fragmentname"><a href="#fragment-Addvisiblepointtogridcellxyz-0">Add visible point to grid cell <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.432ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3199.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y comma z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1897" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="2342" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2810" y="0"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1669" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1669"><i></i></a><div id="fragbit-1669" class="collapse"><div class="fragmentcode">                                 int h = <a href="#hash" class="code">hash</a>(Point3i(x, y, z), hashSize);
                                 SPPMPixelListNode *node = arena.Alloc&lt;SPPMPixelListNode&gt;();
                                 node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Atomicallyaddmononodetothestartofmonogridhslinkedlist-0">Atomically add <tt>node</tt> to the start of <tt>grid[h]</tt>&rsquo;s linked list</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1670" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1670"><i></i></a><div id="fragbit-1670" class="collapse"><div class="fragmentcode">                                    node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a> = grid[h];
                                    while (grid[h].compare_exchange_weak(node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>, node) == false)
                                        ;</div></div></div></div>
                          }
                  </div></div>
           }
       }, nPixels, 4096);
   </div></div></div><p>


</p>
<p>The grid is usually sparsely filled; many voxels have no visible points
inside their extent. (For starters, any voxel in the grid with no surfaces
in its volume will never have a visible point in it.)  Therefore, rather
than allocating storage for all of the voxels, the grid is represented by a
hash table where a hash function transforms 3D voxel coordinates to an
index into the <tt>grid</tt> array.

</p>
<p>In the following, we&rsquo;ll construct the grid in parallel using multiple
threads. These threads will use atomic operations to update the grid, so a
<tt>std::atomic</tt> is used for the grid voxel element type here.

</p>
<p></p>
<span class="anchor" id="fragment-AllocategridforSPPMvisiblepoints-0"></span><div class="fragmentname">&lt;&lt;Allocate grid for SPPM visible points&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int hashSize = nPixels;
std::vector&lt;std::atomic&lt;SPPMPixelListNode *&gt;&gt; grid(hashSize);</div><p>


</p>
<p>Each grid cell stores a linked list, where each node points to an
<tt>SPPMPixel</tt> whose visible point&rsquo;s search volume overlaps the grid cell.  A visible
point may overlap multiple grid cells, so it&rsquo;s desirable to keep the node representation
compact by only storing a pointer to the <tt>SPPMPixel</tt> rather than making a
copy for each cell it overlaps.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMLocalDefinitions-1"></span><div class="fragmentname">&lt;&lt;SPPM Local Definitions&gt;&gt;+=&nbsp;<a href="#fragment-SPPMLocalDefinitions-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-SPPMLocalDefinitions-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">struct <span class="anchor" id="SPPMPixelListNode"></span>SPPMPixelListNode {
    <a href="#SPPMPixel" class="code">SPPMPixel</a> *<span class="anchor" id="SPPMPixelListNode::pixel"></span>pixel;
    SPPMPixelListNode *<span class="anchor" id="SPPMPixelListNode::next"></span>next;
};</div><p>


</p>
<p>If there&rsquo;s no visible point for the pixel for the current iteration, the
pixel will have a path throughput weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.595ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2409.1 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="852" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1908" y="0"></use>
</g>
</svg> (and no
attempt should be made to place a visible point in the grid for that
pixel).  This case can happen if the path from the camera leaves the scene
or is terminated before intersecting a diffuse surface.

</p>
<p>Otherwise, the implementation here computes the bounding box centered at
the visible point with extent <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.656ex" height="2.343ex" style="vertical-align: -0.671ex;" viewBox="0 -719.6 1574.3 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">plus-or-minus r Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-B1" d="M722 -64c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h293v274h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20s-9 -20 -20 -20h-293v-274h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-B1" x="0" y="0"></use>
<g transform="translate(778,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
</g>
</g>
</svg>, the current photon
search radius for the pixel. In turn, when we later have a photon
intersection point, we will only need to consider the visible points for
the grid cell that the photon is in to find the visible points that the
photon may contribute to (Figure&nbsp;<a href="#fig:sppm-grid">16.10</a>).  Because different
visible points will have different search radii depending on how many photons have
contributed to their pixel so far, it would otherwise be unwieldy to find the
potentially relevant visible points for a photon if the visible points were
stored without accounting for the volume of space they will accept photons
from.

</p>
<p> </p>
<span class="anchor" id="fig:sppm-grid"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="ppm-grid.svg" title=""><img src="ppm-grid.svg" width=296 height=296 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.10: 
<span class="legend">
Given a visible point (filled circle) with search radius <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.049ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 451.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
</g>
</svg>, the visible
point is added to the linked list in all grid cells that the bounding
box of the sphere of radius <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.049ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 451.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
</g>
</svg> overlaps.  Given a photon incident on a surface in the scene
(open circle), we only need to check the visible points in the voxel the
photon is in to find the ones that it may contribute to.
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-ComputegridboundsforSPPMvisiblepoints-0"></span><div class="fragmentname">&lt;&lt;Compute grid bounds for SPPM visible points&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> gridBounds;
Float maxRadius = 0.;
for (int i = 0; i &lt; nPixels; ++i) {
    const SPPMPixel &amp;pixel = pixels[i];
    if (pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
        continue;
    <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> vpBound = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Expand" class="code">Expand</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.p), pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
    gridBounds = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Union" class="code">Union</a>(gridBounds, vpBound);
    maxRadius = std::max(maxRadius, pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);
}</div><p>


</p>
<p>Given the overall bound of the grid, we need to decide how large the voxels
should be and thus how finely to subdivide space. On one hand, if the
voxels are too large, the photon shooting pass will be inefficient, as each
photon will have to check many visible points to see if it contributes to
each one. If they&rsquo;re too small, then each visible point will overlap many
voxels, and the memory needed to represent the grid will be excessive.

</p>
<p>Here, we compute an initial resolution such that the voxel width in the
largest grid dimension is roughly equal to the largest current search
radius of all of the visible points.  This limits the maximum number of
voxels any visible point can overlap.  In turn, resolutions for the other
two dimensions of the grid are set so that voxels have roughly the same
width in all dimensions.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeresolutionofSPPMgridineachdimension-0"></span><div class="fragmentname">&lt;&lt;Compute resolution of SPPM grid in each dimension&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> diag = gridBounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>();
Float maxDiag = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::MaxComponent" class="code">MaxComponent</a>(diag);
int baseGridRes = (int)(maxDiag / maxRadius);
int gridRes[3];
for (int i = 0; i &lt; 3; ++i)
    gridRes[i] = std::max((int)(baseGridRes * diag[i] / maxDiag), 1);</div><p>


</p>
<p>The visible points can now be added to the grid.  Because both the grid and
the <tt>BSDF</tt>s for visible points from the camera path must be kept
around until the end of the photon tracing pass, we can reuse the per-thread
<tt>MemoryArena</tt>s that were created earlier for the <tt>BSDF</tt>s to
allocate <a href="#SPPMPixelListNode"><tt>SPPMPixelListNode</tt></a>s.

</p>
<p></p>
<span class="anchor" id="fragment-AddvisiblepointstoSPPMgrid-0"></span><div class="fragmentname">&lt;&lt;Add visible points to SPPM grid&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(
    [&amp;](int pixelIndex) {
        <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = perThreadArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
        SPPMPixel &amp;pixel = pixels[pixelIndex];
        if (!pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a>.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) {
            &lt;&lt;<span class="fragmentname"><a href="#fragment-Addpixelsvisiblepointtoapplicablegridcells-0">Add pixel&rsquo;s visible point to applicable grid cells</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1671" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1671"><i></i></a><div id="fragbit-1671" class="collapse"><div class="fragmentcode">               Float <a href="#SPPMPixel::radius" class="code">radius</a> = pixel.<a href="#SPPMPixel::radius" class="code">radius</a>;
               Point3i pMin, pMax;
               <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> - <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                      gridBounds, gridRes, &amp;pMin);
               <a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> + <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
                      gridBounds, gridRes, &amp;pMax);
               for (int z = pMin.z; z &lt;= pMax.z; ++z)
                   for (int y = pMin.y; y &lt;= pMax.y; ++y)
                       for (int x = pMin.x; x &lt;= pMax.x; ++x) {
                           &lt;&lt;<span class="fragmentname"><a href="#fragment-Addvisiblepointtogridcellxyz-0">Add visible point to grid cell <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.432ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3199.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y comma z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1897" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="2342" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2810" y="0"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1672" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1672"><i></i></a><div id="fragbit-1672" class="collapse"><div class="fragmentcode">                              int h = <a href="#hash" class="code">hash</a>(Point3i(x, y, z), hashSize);
                              SPPMPixelListNode *node = arena.Alloc&lt;SPPMPixelListNode&gt;();
                              node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                              &lt;&lt;<span class="fragmentname"><a href="#fragment-Atomicallyaddmononodetothestartofmonogridhslinkedlist-0">Atomically add <tt>node</tt> to the start of <tt>grid[h]</tt>&rsquo;s linked list</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1673" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1673"><i></i></a><div id="fragbit-1673" class="collapse"><div class="fragmentcode">                                 node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a> = grid[h];
                                 while (grid[h].compare_exchange_weak(node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>, node) == false)
                                     ;</div></div></div></div>
                       }
               </div></div>
        }
    }, nPixels, 4096);
</div><p>


</p>
<p>Each visible point is added to all of the grid cells that its bounding box
overlaps.

</p>
<p></p>
<span class="anchor" id="fragment-Addpixelsvisiblepointtoapplicablegridcells-0"></span><div class="fragmentname">&lt;&lt;Add pixel&rsquo;s visible point to applicable grid cells&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float <a href="#SPPMPixel::radius" class="code">radius</a> = pixel.<a href="#SPPMPixel::radius" class="code">radius</a>;
Point3i pMin, pMax;
<a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> - <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
       gridBounds, gridRes, &amp;pMin);
<a href="#ToGrid" class="code">ToGrid</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::p" class="code">p</a> + <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>, <a href="#SPPMPixel::radius" class="code">radius</a>),
       gridBounds, gridRes, &amp;pMax);
for (int z = pMin.z; z &lt;= pMax.z; ++z)
    for (int y = pMin.y; y &lt;= pMax.y; ++y)
        for (int x = pMin.x; x &lt;= pMax.x; ++x) {
            &lt;&lt;<span class="fragmentname"><a href="#fragment-Addvisiblepointtogridcellxyz-0">Add visible point to grid cell <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.432ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3199.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y comma z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1897" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="2342" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2810" y="0"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1674" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1674"><i></i></a><div id="fragbit-1674" class="collapse"><div class="fragmentcode">               int h = <a href="#hash" class="code">hash</a>(Point3i(x, y, z), hashSize);
               SPPMPixelListNode *node = arena.Alloc&lt;SPPMPixelListNode&gt;();
               node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Atomicallyaddmononodetothestartofmonogridhslinkedlist-0">Atomically add <tt>node</tt> to the start of <tt>grid[h]</tt>&rsquo;s linked list</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1675" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1675"><i></i></a><div id="fragbit-1675" class="collapse"><div class="fragmentcode">                  node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a> = grid[h];
                  while (grid[h].compare_exchange_weak(node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>, node) == false)
                      ;</div></div></div></div>
        }
</div><p>


</p>
<p><tt>ToGrid()</tt> returns the coordinates of the voxel in the grid that the
given point lies in.  The Boolean return value indicates whether the point
<tt>p</tt> is inside the grid&rsquo;s bounds; if it isn&rsquo;t, the returned coordinates
<tt>pi</tt> are clamped to be inside the range of valid coordinates.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMLocalDefinitions-2"></span><div class="fragmentname">&lt;&lt;SPPM Local Definitions&gt;&gt;+=&nbsp;<a href="#fragment-SPPMLocalDefinitions-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">static bool <span class="anchor" id="ToGrid"></span>ToGrid(const <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> &amp;p, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;bounds,
                   const int gridRes[3], Point3i *pi) {
    bool inBounds = true;
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> pg = bounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(p);
    for (int i = 0; i &lt; 3; ++i) {
        (*pi)[i] = (int)(gridRes[i] * pg[i]);
        inBounds &amp;= ((*pi)[i] &gt;= 0 &amp;&amp; (*pi)[i] &lt; gridRes[i]);
        (*pi)[i] = <a href="../Utilities/Main_Include_File.html#Clamp" class="code">Clamp</a>((*pi)[i], 0, gridRes[i] - 1);
    }
    return inBounds;
}</div><p>


</p>
<p><tt>hash()</tt><span class="anchor" id="hash"></span> hashes the coordinates of the voxel,
returning an index into the <tt>grid</tt> array defined earlier; it is a
straightforward hash function, and its implementation isn&rsquo;t included
here.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="Note that hash collisions are possible&mdash;different cells
in the grid may hash to the same index.  This is almost fine: photons will
end up checking more visible points than they need to, but the test with
the pixel&rsquo;s search radius will reject the visible points that are too far
away anyway.  See, however, Exercise&nbsp;16.9 for one nit related to
collisions.">
      <sup>&dagger;</sup>
    </button>
		  A new <tt>SPPMPixelListNode</tt> is allocated and the task now
is to add this list node to the head of the linked list in <tt>grid[h]</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Addvisiblepointtogridcellxyz-0"></span><div class="fragmentname">&lt;&lt;Add visible point to grid cell <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.432ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3199.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y comma z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1897" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="2342" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2810" y="0"></use>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int h = <a href="#hash" class="code">hash</a>(Point3i(x, y, z), hashSize);
SPPMPixelListNode *node = arena.Alloc&lt;SPPMPixelListNode&gt;();
node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
&lt;&lt;<span class="fragmentname"><a href="#fragment-Atomicallyaddmononodetothestartofmonogridhslinkedlist-0">Atomically add <tt>node</tt> to the start of <tt>grid[h]</tt>&rsquo;s linked list</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1676" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1676"><i></i></a><div id="fragbit-1676" class="collapse"><div class="fragmentcode">   node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a> = grid[h];
   while (grid[h].compare_exchange_weak(node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>, node) == false)
       ;</div></div></div><p>


</p>
<p>Given the grid index, atomic operations can be used to allow multiple
threads to add visible points to the grid concurrently without needing to
hold any locks.  (See Appendix&nbsp;<a href="../Utilities/Parallelism.html#sec:atomic-ops">A.6.2</a> for further discussion
of atomic operations.)  In the absence of concurrency, we&rsquo;d just want to set
<tt>node-&gt;next</tt> to point to the head of the list in <tt>grid[h]</tt> and
assign <tt>node</tt> to <tt>grid[h]</tt>. That approach will not work if 
multiple threads are updating the lists concurrently; it&rsquo;s possible that the
first assignment will become stale: another thread might modify <tt>grid[h]</tt>
between the current thread initializing <tt>node-&gt;next</tt> and then
trying to assign <tt>node</tt> to <tt>grid[h]</tt>.

</p>
<p>The <tt>compare_exchange_weak()</tt> method of <tt>std::atomic</tt> addresses
this issue: the first parameter is the value that we expect <tt>grid[h]</tt>
to have, and the second gives the value that we&rsquo;d like to set it to.  It
performs the assignment only if our expectation was correct.  Thus, in the
common case, <tt>node-&gt;next</tt> and <tt>grid[h]</tt> have the same pointer
value, the assignment occurs, and <tt>true</tt> is returned. The node has
been added to the list.

</p>
<p>If the pointer stored in <tt>grid[h]</tt> has been changed by another thread,
then <tt>compare_exchange_weak()</tt> actually updates the first parameter,
<tt>node-&gt;next</tt>, with the current value of <tt>grid[h]</tt> before
returning <tt>false</tt>. We are thus all set to try the atomic compare and
exchange again, as <tt>node-&gt;next</tt> points to the new head of the list.
This process continues until the assignment is successful.

</p>
<p></p>
<span class="anchor" id="fragment-Atomicallyaddmononodetothestartofmonogridhslinkedlist-0"></span><div class="fragmentname">&lt;&lt;Atomically add <tt>node</tt> to the start of <tt>grid[h]</tt>&rsquo;s linked list&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a> = grid[h];
while (grid[h].compare_exchange_weak(node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>, node) == false)
    ;</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#AccumulatingPhotonContributions"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:photon-contrib"></span><span id="AccumulatingPhotonContributions"></span><h3>16.2.6  Accumulating Photon Contributions</h3><p>



</p>
<p>Given the grid of visible points, the <tt>SPPMIntegrator</tt> can now follow
photon paths through the scene. The total of <tt>photonsPerIteration</tt>
photons to be traced for the current iteration are traced using multiple
threads.  A separate <a href="../Utilities/Memory_Management.html#MemoryArena"><tt>MemoryArena</tt></a> is available for each worker thread;
this arena is reset after each photon path, so a new pool of per-thread
arenas is allocated rather than reusing the one used for BSDFs and grid linked
list nodes.
     
</p>
<span class="anchor" id="fragment-Tracephotonsandaccumulatecontributions-0"></span><div class="fragmentname">&lt;&lt;Trace photons and accumulate contributions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">std::vector&lt;<a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a>&gt; photonShootArenas(<a href="../Utilities/Parallelism.html#MaxThreadIndex" class="code">MaxThreadIndex</a>());
<a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(
    [&amp;](int photonIndex) {
        <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena = photonShootArenas[<a href="../Utilities/Parallelism.html#ThreadIndex" class="code">ThreadIndex</a>];
        &lt;&lt;<span class="fragmentname"><a href="#fragment-FollowphotonpathformonophotonIndex-0">Follow photon path for <tt>photonIndex</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1677" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1677"><i></i></a><div id="fragbit-1677" class="collapse"><div class="fragmentcode">           uint64_t haltonIndex = (uint64_t)iter * (uint64_t)<a href="#SPPMIntegrator::photonsPerIteration" class="code">photonsPerIteration</a> +
                                  photonIndex;
           int haltonDim = 0;
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Chooselighttoshootphotonfrom-0">Choose light to shoot photon from</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1678" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1678"><i></i></a><div id="fragbit-1678" class="collapse"><div class="fragmentcode">              Float lightPdf;
              Float lightSample = <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex);
              int lightNum = lightDistr-&gt;<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(lightSample, &amp;lightPdf);
              const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[lightNum];</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Computesamplevaluesforphotonrayleavinglightsource-0">Compute sample values for photon ray leaving light source</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1679" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1679"><i></i></a><div id="fragbit-1679" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight0(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                              <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
              <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight1(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 2, haltonIndex),
                              <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 3, haltonIndex));
              Float uLightTime = <a href="../Utilities/Mathematical_Routines.html#Lerp" class="code">Lerp</a>(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 4, haltonIndex),
                                      camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterOpen" class="code">shutterOpen</a>, camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterClose" class="code">shutterClose</a>);
              haltonDim += 5;</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonophotonRayfromlightsourceandinitializemonobeta-0">Generate <tt>photonRay</tt> from light source and initialize <tt>beta</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1680" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1680"><i></i></a><div id="fragbit-1680" class="collapse"><div class="fragmentcode">              RayDifferential photonRay;
              <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> nLight;
              Float pdfPos, pdfDir;
              <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Le =
                  light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le" class="code">Sample_Le</a>(uLight0, uLight1, uLightTime,
                                   &amp;photonRay, &amp;nLight, &amp;pdfPos, &amp;pdfDir);
              if (pdfPos == 0 || pdfDir == 0 || Le.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) return;
              <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = (<a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(nLight, photonRay.d) * Le) /
                              (lightPdf * pdfPos * pdfDir);
              if (beta.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                  return;</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Followphotonpaththroughsceneandrecordintersections-0">Follow photon path through scene and record intersections</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1681" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1681"><i></i></a><div id="fragbit-1681" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
              for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
                  if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(photonRay, &amp;isect))
                      break;
                  if (depth &gt; 0) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontonearbyvisiblepoints-0">Add photon contribution to nearby visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1682" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1682"><i></i></a><div id="fragbit-1682" class="collapse"><div class="fragmentcode">                         Point3i photonGridIndex;
                         if (<a href="#ToGrid" class="code">ToGrid</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, gridBounds, gridRes, &amp;photonGridIndex)) {
                             int h = <a href="#hash" class="code">hash</a>(photonGridIndex, hashSize);
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontovisiblepointsinmonogridh-0">Add photon contribution to visible points in <tt>grid[h]</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1683" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1683"><i></i></a><div id="fragbit-1683" class="collapse"><div class="fragmentcode">                                for (SPPMPixelListNode *node = grid[h].load(std::memory_order_relaxed);
                                     node != nullptr; node = node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>) {
                                    SPPMPixel &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = *node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                                    Float <a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::radius" class="code">radius</a>;
                                    if (<a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>) &gt; <a href="#SPPMPixel::radius" class="code">radius</a> * <a href="#SPPMPixel::radius" class="code">radius</a>)
                                        continue;
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopixelPhiandMfornearbyphoton-0">Update <tt>pixel</tt> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> for nearby photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1684" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1684"><i></i></a><div id="fragbit-1684" class="collapse"><div class="fragmentcode">                                       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                                       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a> = beta * pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::wo" class="code">wo</a>, wi);
                                       for (int i = 0; i &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++i)
                                           pixel.<a href="#SPPMPixel::Phi" class="code">Phi</a>[i].<a href="../Utilities/Parallelism.html#AtomicFloat::Add" class="code">Add</a>(<a href="#SPPMPixel::Phi" class="code">Phi</a>[i]);
                                       ++pixel.M;</div></div> 
                                }</div></div>
                         }</div></div>
                  }
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewphotonraydirection-0">Sample new photon ray direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1685" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1685"><i></i></a><div id="fragbit-1685" class="collapse"><div class="fragmentcode">                     &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatphotonintersectionpoint-0">Compute BSDF at photon intersection point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1686" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1686"><i></i></a><div id="fragbit-1686" class="collapse"><div class="fragmentcode">                        isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(photonRay, arena, true,
                                                         <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance);
                        if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                            --depth;
                            photonRay = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(photonRay.d);
                            continue;
                        }
                        const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;photonBSDF = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFmonofranddirectionmonowiforreflectedphoton-0">Sample BSDF <tt>fr</tt> and direction <tt>wi</tt> for reflected photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1687" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1687"><i></i></a><div id="fragbit-1687" class="collapse"><div class="fragmentcode">                        <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, wo = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                        Float pdf;
                        BxDFType flags;
                        &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonobsdfSampleforoutgoingphotonsample-0">Generate <tt>bsdfSample</tt> for outgoing photon sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1688" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1688"><i></i></a><div id="fragbit-1688" class="collapse"><div class="fragmentcode">                           <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> bsdfSample(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                                              <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
                           haltonDim += 2;</div></div>
                        <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> fr = photonBSDF.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, bsdfSample,
                                                          &amp;pdf, BSDF_ALL, &amp;flags);
                        if (fr.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdf == 0.f) break;</div></div>
                     <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> bnew = beta * fr * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdf;
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatephotonpathwithRussianroulette-0">Possibly terminate photon path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1689" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1689"><i></i></a><div id="fragbit-1689" class="collapse"><div class="fragmentcode">                        Float q = std::max((Float)0, 1 - bnew.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>() / beta.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>());
                        if (<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex) &lt; q)
                            break;
                        beta = bnew / (1 - q);</div></div>
                     photonRay = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
              }</div></div></div></div>
        arena.<a href="../Utilities/Memory_Management.html#MemoryArena::Reset" class="code">Reset</a>();
    }, <a href="#SPPMIntegrator::photonsPerIteration" class="code">photonsPerIteration</a>, 8192);
</div><p>


</p>
<p>There&rsquo;s a balance to strike in choosing the number of photons to trace for
each SPPM iteration: too many, and pixels&rsquo; radii won&rsquo;t have a chance to
decrease as more photons arrive and too many too-far-away photons are
used.  Too few, and the overhead of finding visible points and making the
grid of them won&rsquo;t be amortized over enough photons.  In practice, a few
hundred thousand to a few million per iteration generally works well (see
Figure&nbsp;<a href="#fig:sppm-photons-per-iter">16.11</a>).

</p>
<p></p>
<span class="anchor" id="fig:sppm-photons-per-iter"></span><div class="card outerfigure"><div class="card-body figure"><p>




</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 111.628%;  position:relative;">
<div id="x10000_photons_per_iteration68" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('x10000_photons_per_iteration68'), {
  title: '10,000_photons_per_iteration68', children: [
 { title: '10,000 photons per iteration', image: 'glass-sppm-10k-per-iter.exr' },  { title: '1,000,000 photons per iteration', image: 'glass-sppm-1M-per-iter.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 16.11: The Effect of Varying the Number of Photons Traced Per Iteration.
<span class="legend">
The number of iterations is set so that the total number of photons traced
is the same&mdash;10 million&mdash;for both cases. (1)&nbsp;10,000 photons (1000
iterations): results are good, and rendering time is 137 seconds; time spent
creating visible points is 68% of the total. (2)&nbsp;1,000,000 photons (10 iterations):
results are much blurrier, though rendering time has dropped to 50 seconds, most of it
due to spending much less time on the camera&nbsp;pass.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-SPPMIntegratorPrivateData-3"></span><div class="fragmentname">&lt;&lt;SPPMIntegrator Private Data&gt;&gt;+=&nbsp;<a href="#fragment-SPPMIntegratorPrivateData-2"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">const int <span class="anchor" id="SPPMIntegrator::photonsPerIteration"></span>photonsPerIteration;</div><p>


</p>
<p>A Halton sequence provides a set of well-distributed sample points for all
of the photon paths over all of the iterations.  <tt>haltonIndex</tt> records
the index of the Halton sequence (corresponding to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.23ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 529.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44E" d="M498 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293c45 0 74 -27 92 -64c3 22 18 44 42 44c17 0 29 -10 29 -27c0 -4 0 -6 -7 -34l-36 -140l-22 -90 c-11 -44 -13 -52 -13 -74c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37l50 196c1 5 3 11 3 17Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44E" x="0" y="0"></use>
</g>
</svg> in
Equation&nbsp;(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#eq:radical-inverse">7.7</a>)) for the current photon; it can also be
seen as a global index of photons traced.  In other words, it starts at&nbsp;0
for the first photon and passes through all subsequent integer values
for following photons. It&rsquo;s important to use a 64-bit integer for this value, since an
unsigned 32-bit integer would overflow after roughly 4 billion photons; many more
photons may be needed for high-quality images.

</p>
<p>The dimension of the sample, corresponding to the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.998ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 429.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44F" d="M415 282c0 -144 -123 -293 -241 -293c-74 0 -127 62 -127 157c0 35 4 51 16 101l82 326c5 21 14 55 14 62c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-74 -301c30 31 71 60 117 60c80 0 133 -69 133 -160zM343 326 c0 64 -27 94 -63 94c-26 0 -71 -15 -120 -80c-9 -11 -9 -13 -15 -35l-22 -92c-16 -63 -16 -82 -16 -101c0 -74 33 -101 67 -101c39 0 85 36 118 103c18 38 51 153 51 212Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44F" x="0" y="0"></use>
</g>
</svg>th prime number in
Equation&nbsp;(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#eq:radical-inverse">7.7</a>), is maintained in <tt>haltonDim</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-FollowphotonpathformonophotonIndex-0"></span><div class="fragmentname">&lt;&lt;Follow photon path for <tt>photonIndex</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">uint64_t haltonIndex = (uint64_t)iter * (uint64_t)<a href="#SPPMIntegrator::photonsPerIteration" class="code">photonsPerIteration</a> +
                       photonIndex;
int haltonDim = 0;
&lt;&lt;<span class="fragmentname"><a href="#fragment-Chooselighttoshootphotonfrom-0">Choose light to shoot photon from</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1690" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1690"><i></i></a><div id="fragbit-1690" class="collapse"><div class="fragmentcode">   Float lightPdf;
   Float lightSample = <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex);
   int lightNum = lightDistr-&gt;<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(lightSample, &amp;lightPdf);
   const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[lightNum];</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Computesamplevaluesforphotonrayleavinglightsource-0">Compute sample values for photon ray leaving light source</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1691" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1691"><i></i></a><div id="fragbit-1691" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight0(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                   <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
   <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight1(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 2, haltonIndex),
                   <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 3, haltonIndex));
   Float uLightTime = <a href="../Utilities/Mathematical_Routines.html#Lerp" class="code">Lerp</a>(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 4, haltonIndex),
                           camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterOpen" class="code">shutterOpen</a>, camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterClose" class="code">shutterClose</a>);
   haltonDim += 5;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonophotonRayfromlightsourceandinitializemonobeta-0">Generate <tt>photonRay</tt> from light source and initialize <tt>beta</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1692" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1692"><i></i></a><div id="fragbit-1692" class="collapse"><div class="fragmentcode">   RayDifferential photonRay;
   <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> nLight;
   Float pdfPos, pdfDir;
   <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Le =
       light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le" class="code">Sample_Le</a>(uLight0, uLight1, uLightTime,
                        &amp;photonRay, &amp;nLight, &amp;pdfPos, &amp;pdfDir);
   if (pdfPos == 0 || pdfDir == 0 || Le.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) return;
   <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = (<a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(nLight, photonRay.d) * Le) /
                   (lightPdf * pdfPos * pdfDir);
   if (beta.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
       return;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Followphotonpaththroughsceneandrecordintersections-0">Follow photon path through scene and record intersections</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1693" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1693"><i></i></a><div id="fragbit-1693" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
   for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
       if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(photonRay, &amp;isect))
           break;
       if (depth &gt; 0) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontonearbyvisiblepoints-0">Add photon contribution to nearby visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1694" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1694"><i></i></a><div id="fragbit-1694" class="collapse"><div class="fragmentcode">              Point3i photonGridIndex;
              if (<a href="#ToGrid" class="code">ToGrid</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, gridBounds, gridRes, &amp;photonGridIndex)) {
                  int h = <a href="#hash" class="code">hash</a>(photonGridIndex, hashSize);
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontovisiblepointsinmonogridh-0">Add photon contribution to visible points in <tt>grid[h]</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1695" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1695"><i></i></a><div id="fragbit-1695" class="collapse"><div class="fragmentcode">                     for (SPPMPixelListNode *node = grid[h].load(std::memory_order_relaxed);
                          node != nullptr; node = node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>) {
                         SPPMPixel &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = *node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                         Float <a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::radius" class="code">radius</a>;
                         if (<a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>) &gt; <a href="#SPPMPixel::radius" class="code">radius</a> * <a href="#SPPMPixel::radius" class="code">radius</a>)
                             continue;
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopixelPhiandMfornearbyphoton-0">Update <tt>pixel</tt> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> for nearby photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1696" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1696"><i></i></a><div id="fragbit-1696" class="collapse"><div class="fragmentcode">                            <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                            <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a> = beta * pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::wo" class="code">wo</a>, wi);
                            for (int i = 0; i &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++i)
                                pixel.<a href="#SPPMPixel::Phi" class="code">Phi</a>[i].<a href="../Utilities/Parallelism.html#AtomicFloat::Add" class="code">Add</a>(<a href="#SPPMPixel::Phi" class="code">Phi</a>[i]);
                            ++pixel.M;</div></div> 
                     }</div></div>
              }</div></div>
       }
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewphotonraydirection-0">Sample new photon ray direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1697" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1697"><i></i></a><div id="fragbit-1697" class="collapse"><div class="fragmentcode">          &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatphotonintersectionpoint-0">Compute BSDF at photon intersection point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1698" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1698"><i></i></a><div id="fragbit-1698" class="collapse"><div class="fragmentcode">             isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(photonRay, arena, true,
                                              <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance);
             if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                 --depth;
                 photonRay = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(photonRay.d);
                 continue;
             }
             const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;photonBSDF = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
          &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFmonofranddirectionmonowiforreflectedphoton-0">Sample BSDF <tt>fr</tt> and direction <tt>wi</tt> for reflected photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1699" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1699"><i></i></a><div id="fragbit-1699" class="collapse"><div class="fragmentcode">             <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, wo = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
             Float pdf;
             BxDFType flags;
             &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonobsdfSampleforoutgoingphotonsample-0">Generate <tt>bsdfSample</tt> for outgoing photon sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1700" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1700"><i></i></a><div id="fragbit-1700" class="collapse"><div class="fragmentcode">                <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> bsdfSample(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                                   <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
                haltonDim += 2;</div></div>
             <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> fr = photonBSDF.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, bsdfSample,
                                               &amp;pdf, BSDF_ALL, &amp;flags);
             if (fr.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdf == 0.f) break;</div></div>
          <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> bnew = beta * fr * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdf;
          &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatephotonpathwithRussianroulette-0">Possibly terminate photon path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1701" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1701"><i></i></a><div id="fragbit-1701" class="collapse"><div class="fragmentcode">             Float q = std::max((Float)0, 1 - bnew.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>() / beta.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>());
             if (<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex) &lt; q)
                 break;
             beta = bnew / (1 - q);</div></div>
          photonRay = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
   }</div></div></div><p>


</p>
<p>Which light to start the path from is determined by sampling from the PDF
based on light power computed previously.  The first dimension of the
Halton sequence is used for the sample value.

</p>
<p></p>
<span class="anchor" id="fragment-Chooselighttoshootphotonfrom-0"></span><div class="fragmentname">&lt;&lt;Choose light to shoot photon from&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float lightPdf;
Float lightSample = <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex);
int lightNum = lightDistr-&gt;<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(lightSample, &amp;lightPdf);
const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[lightNum];</div><p>


</p>
<p>The next five dimensions of the sample from the Halton sequence are used
for the sample values used to generate the ray leaving the light source.

</p>
<p></p>
<span class="anchor" id="fragment-Computesamplevaluesforphotonrayleavinglightsource-0"></span><div class="fragmentname">&lt;&lt;Compute sample values for photon ray leaving light source&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight0(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight1(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 2, haltonIndex),
                <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 3, haltonIndex));
Float uLightTime = <a href="../Utilities/Mathematical_Routines.html#Lerp" class="code">Lerp</a>(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 4, haltonIndex),
                        camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterOpen" class="code">shutterOpen</a>, camera-&gt;<a href="../Camera_Models/Camera_Model.html#Camera::shutterClose" class="code">shutterClose</a>);
haltonDim += 5;</div><p>


</p>
<p>After the light has been chosen, its <tt>Sample_Le()</tt> method is used to
sample an outgoing ray.  Given a light, a ray from the light source is
sampled and its <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> value is initialized based on
Equation&nbsp;(<a href="#eq:particle-weight-definition">16.8</a>):
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:sppm-particle-weight"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.83ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 10260.1 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript Baseline equals StartFraction StartAbsoluteValue cosine omega 0 EndAbsoluteValue upper L Subscript normal e Superscript Baseline left-parenthesis normal p 0 comma omega 0 right-parenthesis Over p left-parenthesis normal l normal i normal g normal h normal t right-parenthesis p left-parenthesis normal p 0 comma omega 0 right-parenthesis EndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-67" d="M485 404c0 -23 -19 -30 -29 -30c-16 0 -29 12 -29 29c0 12 5 23 16 27c-3 1 -10 1 -10 1c-18 0 -54 -5 -90 -39c25 -23 41 -60 41 -97c0 -77 -69 -146 -162 -146c-19 0 -60 3 -99 31c-17 -20 -17 -43 -17 -47c0 -32 21 -63 53 -67c7 -1 50 -1 75 -1c61 0 119 0 172 -28 c51 -28 65 -79 65 -114c0 -78 -104 -129 -222 -129c-122 0 -221 55 -221 127c0 40 32 83 92 100c-31 20 -44 58 -44 89c0 35 18 68 31 83c-25 21 -47 59 -47 103c0 77 69 146 162 146c22 0 64 -3 106 -36c42 41 86 47 106 47c39 0 51 -32 51 -49zM309 296 c0 23 0 123 -87 123c-40 0 -63 -28 -71 -40c-15 -25 -16 -57 -16 -84c0 -23 0 -123 87 -123c40 0 63 28 71 40c15 25 16 57 16 84zM419 -79c0 86 -112 86 -198 86h-59c-44 -3 -82 -40 -82 -86c0 -53 69 -104 170 -104c98 0 169 50 169 104Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="852" y="0"></use>
<g transform="translate(1630,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="7833" height="60" x="0" y="220"></rect>
<g transform="translate(60,770)">
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(1784,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="2861" y="0"></use>
<g transform="translate(3306,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1095" y="0"></use>
<g transform="translate(1485,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2495" y="0"></use>
<g transform="translate(2940,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4017" y="0"></use>
</g>
</g>
<g transform="translate(282,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-67" x="557" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-68" x="1057" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="1614" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2896" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="3452" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="3956" y="0"></use>
<g transform="translate(4345,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="5356" y="0"></use>
<g transform="translate(5801,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6877" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="9981" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:sppm-particle-weight">16.15</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.705ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3317.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p left-parenthesis normal l normal i normal g normal h normal t right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-67" d="M485 404c0 -23 -19 -30 -29 -30c-16 0 -29 12 -29 29c0 12 5 23 16 27c-3 1 -10 1 -10 1c-18 0 -54 -5 -90 -39c25 -23 41 -60 41 -97c0 -77 -69 -146 -162 -146c-19 0 -60 3 -99 31c-17 -20 -17 -43 -17 -47c0 -32 21 -63 53 -67c7 -1 50 -1 75 -1c61 0 119 0 172 -28 c51 -28 65 -79 65 -114c0 -78 -104 -129 -222 -129c-122 0 -221 55 -221 127c0 40 32 83 92 100c-31 20 -44 58 -44 89c0 35 18 68 31 83c-25 21 -47 59 -47 103c0 77 69 146 162 146c22 0 64 -3 106 -36c42 41 86 47 106 47c39 0 51 -32 51 -49zM309 296 c0 23 0 123 -87 123c-40 0 -63 -28 -71 -40c-15 -25 -16 -57 -16 -84c0 -23 0 -123 87 -123c40 0 63 28 71 40c15 25 16 57 16 84zM419 -79c0 86 -112 86 -198 86h-59c-44 -3 -82 -40 -82 -86c0 -53 69 -104 170 -104c98 0 169 50 169 104Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-67" x="557" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-68" x="1057" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="1614" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2896" y="0"></use>
</g>
</svg> is the probability for sampling this particular
light and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.933ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3846 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p left-parenthesis normal p 0 comma omega 0 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1903" y="0"></use>
<g transform="translate(2348,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3424" y="0"></use>
</g>
</svg> is the product of the area and directional
densities for sampling this particular ray leaving the light.
Intersecting this ray against the scene geometry to obtain <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1010.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
</svg> also
samples part of the geometric term <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.944ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 5142.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper G left-parenthesis normal p 0 left-right-arrow normal p 1 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43A" d="M760 695l-63 -255c-5 -18 -5 -20 -18 -20c-4 0 -15 0 -15 10s3 11 3 51c0 116 -59 193 -161 193c-99 0 -196 -61 -250 -129c-105 -130 -115 -295 -115 -326c0 -153 105 -210 201 -210c35 0 165 11 193 121c10 37 21 82 21 91c0 13 -5 16 -31 19c-23 2 -53 2 -53 2 c-22 0 -30 0 -30 11c0 20 12 20 21 20l140 -3c23 0 82 3 105 3c8 0 13 -4 13 -11c0 -19 -11 -20 -16 -20c-57 -1 -58 -3 -69 -48c-4 -17 -9 -34 -13 -51l-19 -77c-5 -21 -15 -59 -17 -61c0 0 -2 -4 -7 -4c-10 0 -36 37 -45 62c-18 -20 -37 -41 -87 -61 c-36 -15 -81 -24 -125 -24c-162 0 -273 115 -273 274c0 232 225 453 448 453c111 0 157 -75 166 -89l70 77c11 11 12 12 15 12c9 0 11 -7 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2194" d="M942 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-686c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4 c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72 h686c-30 20 -56 44 -78 72c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43A" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="786" y="0"></use>
<g transform="translate(1176,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="2464" y="0"></use>
<g transform="translate(3742,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4752" y="0"></use>
</g>
</svg> except for a cosine
factor that must be explicitly integrated into the particle weight
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fragment-GeneratemonophotonRayfromlightsourceandinitializemonobeta-0"></span><div class="fragmentname">&lt;&lt;Generate <tt>photonRay</tt> from light source and initialize <tt>beta</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">RayDifferential photonRay;
<a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> nLight;
Float pdfPos, pdfDir;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Le =
    light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le" class="code">Sample_Le</a>(uLight0, uLight1, uLightTime,
                     &amp;photonRay, &amp;nLight, &amp;pdfPos, &amp;pdfDir);
if (pdfPos == 0 || pdfDir == 0 || Le.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) return;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = (<a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(nLight, photonRay.d) * Le) /
                (lightPdf * pdfPos * pdfDir);
if (beta.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
    return;</div><p>


</p>
<p>Now the integrator can start following the path through the scene, updating
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> after each scattering event.  The photon makes no
contribution at the first intersection found after it left the light
source, since that intersection represents direct illumination, which was
already accounted for when tracing paths starting from the camera.  For
subsequent intersections, illumination is contributed to nearby visible
points.

</p>
<p></p>
<span class="anchor" id="fragment-Followphotonpaththroughsceneandrecordintersections-0"></span><div class="fragmentname">&lt;&lt;Follow photon path through scene and record intersections&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
for (int depth = 0; depth &lt; <a href="#SPPMIntegrator::maxDepth" class="code">maxDepth</a>; ++depth) {
    if (!scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(photonRay, &amp;isect))
        break;
    if (depth &gt; 0) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontonearbyvisiblepoints-0">Add photon contribution to nearby visible points</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1702" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1702"><i></i></a><div id="fragbit-1702" class="collapse"><div class="fragmentcode">           Point3i photonGridIndex;
           if (<a href="#ToGrid" class="code">ToGrid</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, gridBounds, gridRes, &amp;photonGridIndex)) {
               int h = <a href="#hash" class="code">hash</a>(photonGridIndex, hashSize);
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontovisiblepointsinmonogridh-0">Add photon contribution to visible points in <tt>grid[h]</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1703" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1703"><i></i></a><div id="fragbit-1703" class="collapse"><div class="fragmentcode">                  for (SPPMPixelListNode *node = grid[h].load(std::memory_order_relaxed);
                       node != nullptr; node = node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>) {
                      SPPMPixel &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = *node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
                      Float <a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::radius" class="code">radius</a>;
                      if (<a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>) &gt; <a href="#SPPMPixel::radius" class="code">radius</a> * <a href="#SPPMPixel::radius" class="code">radius</a>)
                          continue;
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopixelPhiandMfornearbyphoton-0">Update <tt>pixel</tt> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> for nearby photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1704" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1704"><i></i></a><div id="fragbit-1704" class="collapse"><div class="fragmentcode">                         <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
                         <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a> = beta * pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::wo" class="code">wo</a>, wi);
                         for (int i = 0; i &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++i)
                             pixel.<a href="#SPPMPixel::Phi" class="code">Phi</a>[i].<a href="../Utilities/Parallelism.html#AtomicFloat::Add" class="code">Add</a>(<a href="#SPPMPixel::Phi" class="code">Phi</a>[i]);
                         ++pixel.M;</div></div> 
                  }</div></div>
           }</div></div>
    }
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewphotonraydirection-0">Sample new photon ray direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1705" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1705"><i></i></a><div id="fragbit-1705" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatphotonintersectionpoint-0">Compute BSDF at photon intersection point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1706" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1706"><i></i></a><div id="fragbit-1706" class="collapse"><div class="fragmentcode">          isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(photonRay, arena, true,
                                           <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance);
          if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
              --depth;
              photonRay = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(photonRay.d);
              continue;
          }
          const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;photonBSDF = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFmonofranddirectionmonowiforreflectedphoton-0">Sample BSDF <tt>fr</tt> and direction <tt>wi</tt> for reflected photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1707" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1707"><i></i></a><div id="fragbit-1707" class="collapse"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, wo = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
          Float pdf;
          BxDFType flags;
          &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonobsdfSampleforoutgoingphotonsample-0">Generate <tt>bsdfSample</tt> for outgoing photon sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1708" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1708"><i></i></a><div id="fragbit-1708" class="collapse"><div class="fragmentcode">             <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> bsdfSample(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                                <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
             haltonDim += 2;</div></div>
          <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> fr = photonBSDF.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, bsdfSample,
                                            &amp;pdf, BSDF_ALL, &amp;flags);
          if (fr.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdf == 0.f) break;</div></div>
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> bnew = beta * fr * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdf;
       &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatephotonpathwithRussianroulette-0">Possibly terminate photon path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1709" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1709"><i></i></a><div id="fragbit-1709" class="collapse"><div class="fragmentcode">          Float q = std::max((Float)0, 1 - bnew.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>() / beta.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>());
          if (<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex) &lt; q)
              break;
          beta = bnew / (1 - q);</div></div>
       photonRay = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
}</div><p>


</p>
<p>Given a photon intersection, <tt>ToGrid()</tt>&rsquo;s return value indicates if
it&rsquo;s within the extent of the grid.  If it isn&rsquo;t, then by construction,
none of the visible points is interested in this photon&rsquo;s contribution.
Otherwise, the visible points in the grid cell all need to be checked to
see if the photon is within their radius.

</p>
<p></p>
<span class="anchor" id="fragment-Addphotoncontributiontonearbyvisiblepoints-0"></span><div class="fragmentname">&lt;&lt;Add photon contribution to nearby visible points&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Point3i photonGridIndex;
if (<a href="#ToGrid" class="code">ToGrid</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, gridBounds, gridRes, &amp;photonGridIndex)) {
    int h = <a href="#hash" class="code">hash</a>(photonGridIndex, hashSize);
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Addphotoncontributiontovisiblepointsinmonogridh-0">Add photon contribution to visible points in <tt>grid[h]</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1710" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1710"><i></i></a><div id="fragbit-1710" class="collapse"><div class="fragmentcode">       for (SPPMPixelListNode *node = grid[h].load(std::memory_order_relaxed);
            node != nullptr; node = node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>) {
           SPPMPixel &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = *node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
           Float <a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::radius" class="code">radius</a>;
           if (<a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>) &gt; <a href="#SPPMPixel::radius" class="code">radius</a> * <a href="#SPPMPixel::radius" class="code">radius</a>)
               continue;
           &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopixelPhiandMfornearbyphoton-0">Update <tt>pixel</tt> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> for nearby photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1711" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1711"><i></i></a><div id="fragbit-1711" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
              <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a> = beta * pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::wo" class="code">wo</a>, wi);
              for (int i = 0; i &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++i)
                  pixel.<a href="#SPPMPixel::Phi" class="code">Phi</a>[i].<a href="../Utilities/Parallelism.html#AtomicFloat::Add" class="code">Add</a>(<a href="#SPPMPixel::Phi" class="code">Phi</a>[i]);
              ++pixel.M;</div></div> 
       }</div></div>
}</div><p>


</p>
<p>

</p>
<p>Recall that <tt>grid</tt> stores <tt>std::atomic</tt> pointers to
<a href="#SPPMPixelListNode"><tt>SPPMPixelListNode</tt></a>s. Normally, reading from a <tt>std::atomic</tt> value
means that the compiler must be careful to not reorder instructions that read
or write memory around the read of the value of <tt>grid[h]</tt>; this
constraint is necessary so that lock-free algorithms will work as expected.
In this case, the grid has been constructed and no other threads are
concurrently modifying it. Therefore, it&rsquo;s worthwhile to use the
<tt>std::atomic.load()</tt> method and letting it know that the &ldquo;relaxed&rdquo;
memory model, which doesn&rsquo;t have these constraints, can be used to read the
initial grid pointer.  This approach has a significant performance benefit:
for a simple scene of a few hundred triangles (where not too much time is
spent tracing rays), the photon pass runs in 20% less time using this
memory model on a 2015-era CPU.

</p>
<p></p>
<span class="anchor" id="fragment-Addphotoncontributiontovisiblepointsinmonogridh-0"></span><div class="fragmentname">&lt;&lt;Add photon contribution to visible points in <tt>grid[h]</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (SPPMPixelListNode *node = grid[h].load(std::memory_order_relaxed);
     node != nullptr; node = node-&gt;<a href="#SPPMPixelListNode::next" class="code">next</a>) {
    SPPMPixel &amp;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a> = *node-&gt;<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>;
    Float <a href="#SPPMPixel::radius" class="code">radius</a> = <a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::radius" class="code">radius</a>;
    if (<a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(<a href="#SPPMPixelListNode::pixel" class="code">pixel</a>.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>, isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>) &gt; <a href="#SPPMPixel::radius" class="code">radius</a> * <a href="#SPPMPixel::radius" class="code">radius</a>)
        continue;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopixelPhiandMfornearbyphoton-0">Update <tt>pixel</tt> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> for nearby photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1712" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1712"><i></i></a><div id="fragbit-1712" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a> = beta * pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::wo" class="code">wo</a>, wi);
       for (int i = 0; i &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++i)
           pixel.<a href="#SPPMPixel::Phi" class="code">Phi</a>[i].<a href="../Utilities/Parallelism.html#AtomicFloat::Add" class="code">Add</a>(<a href="#SPPMPixel::Phi" class="code">Phi</a>[i]);
       ++pixel.M;</div></div> 
}</div><p>


</p>
<p>Given a photon contribution, we need to update the sum for the pixel&rsquo;s
scattered radiance estimate from Equation&nbsp;(<a href="#eq:sppm-phi">16.14</a>).  The total
number of contributing photons in this pass is stored in <tt>M</tt>, and the
sum of the product of BSDF values with particle weights is stored in
<tt>Phi</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-UpdatemonopixelPhiandMfornearbyphoton-0"></span><div class="fragmentname">&lt;&lt;Update <tt>pixel</tt> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> for nearby photon&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a> = beta * pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(pixel.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::wo" class="code">wo</a>, wi);
for (int i = 0; i &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++i)
    pixel.<a href="#SPPMPixel::Phi" class="code">Phi</a>[i].<a href="../Utilities/Parallelism.html#AtomicFloat::Add" class="code">Add</a>(<a href="#SPPMPixel::Phi" class="code">Phi</a>[i]);
++pixel.M;</div><p>


</p>
<p>Each pixel&rsquo;s <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.678ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 722.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Phi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A6" d="M665 341c0 -101 -111 -194 -266 -206v-56c0 -35 0 -48 95 -48h33v-31c-36 3 -129 3 -170 3s-133 0 -169 -3v31h33c95 0 95 14 95 48v56c-149 15 -260 104 -260 207c0 99 107 191 260 206v56c0 35 0 48 -95 48h-33v31c36 -3 129 -3 170 -3s133 0 169 3v-31h-33 c-95 0 -95 -14 -95 -48v-56c152 -12 266 -103 266 -207zM316 158v367c-150 -20 -160 -132 -160 -184c0 -62 18 -164 160 -183zM565 342c0 76 -28 168 -166 184v-369c151 18 166 125 166 185Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-3A6" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.426ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1044.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
</g>
</svg> values are stored using atomic variables, which
in turn allows multiple threads to safely concurrently update their
values.  Because <tt>pbrt</tt>&rsquo;s <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum"><tt>Spectrum</tt></a> class doesn&rsquo;t allow atomic updates,
<tt>Phi</tt> is instead represented with an array of <a href="../Utilities/Parallelism.html#AtomicFloat"><tt>AtomicFloat</tt></a>
coefficients for each spectral sample.  This representation will require
some manual copying of values to and from <tt>Phi</tt> to
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum"><tt>Spectrum</tt></a>-typed variables in the following, but we think that this
small awkwardness is preferable to the complexity of, for example, a new
<tt>AtomicSpectrum</tt> type.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMPixelPublicData-3"></span><div class="fragmentname">&lt;&lt;SPPMPixel Public Data&gt;&gt;+=&nbsp;<a href="#fragment-SPPMPixelPublicData-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-SPPMPixelPublicData-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">AtomicFloat <span class="anchor" id="SPPMPixel::Phi"></span>Phi[<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples];
std::atomic&lt;int&gt; <span class="anchor" id="SPPMPixel::M"></span>M;</div><p>


</p>
<p>Having recorded the photon&rsquo;s contribution, the integrator needs to choose
a new outgoing direction from the intersection point and update the
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> value to account for the effect of scattering.
Equation&nbsp;(<a href="#eq:particle-tracing-weights">16.7</a>) shows
how to incrementally update the particle weight after a scattering event:
given some weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.25ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1399.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript i comma j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
</g>
</svg> that represents the weight for the
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.987ex" height="2.509ex" style="vertical-align: -0.671ex; margin-left: -0.029ex;" viewBox="-12.5 -791.3 425 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D457" x="0" y="0"></use>
</g>
</svg>th intersection of the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th particle history, after a scattering event
where a new vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.043ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 2171.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript i comma j plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="863" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1642" y="0"></use>
</g>
</g>
</svg> has been sampled, the weight
should be set to be
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="62.543ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 26928.1 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript i comma j plus 1 Baseline equals beta Subscript i comma j Baseline StartFraction 1 Over 1 minus q Subscript i comma j plus 1 Baseline EndFraction StartFraction f Subscript Baseline left-parenthesis normal p Subscript i italic comma j plus 1 Baseline right-arrow normal p Subscript i italic comma j Baseline right-arrow normal p Subscript i italic comma j minus 1 Baseline right-parenthesis upper G left-parenthesis normal p Subscript i italic comma j plus 1 Baseline left-right-arrow normal p Subscript i italic comma j Baseline right-parenthesis Over p left-parenthesis normal p Subscript i italic comma j plus 1 Baseline right-parenthesis EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43A" d="M760 695l-63 -255c-5 -18 -5 -20 -18 -20c-4 0 -15 0 -15 10s3 11 3 51c0 116 -59 193 -161 193c-99 0 -196 -61 -250 -129c-105 -130 -115 -295 -115 -326c0 -153 105 -210 201 -210c35 0 165 11 193 121c10 37 21 82 21 91c0 13 -5 16 -31 19c-23 2 -53 2 -53 2 c-22 0 -30 0 -30 11c0 20 12 20 21 20l140 -3c23 0 82 3 105 3c8 0 13 -4 13 -11c0 -19 -11 -20 -16 -20c-57 -1 -58 -3 -69 -48c-4 -17 -9 -34 -13 -51l-19 -77c-5 -21 -15 -59 -17 -61c0 0 -2 -4 -7 -4c-10 0 -36 37 -45 62c-18 -20 -37 -41 -87 -61 c-36 -15 -81 -24 -125 -24c-162 0 -273 115 -273 274c0 232 225 453 448 453c111 0 157 -75 166 -89l70 77c11 11 12 12 15 12c9 0 11 -7 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2194" d="M942 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-686c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4 c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72 h686c-30 20 -56 44 -78 72c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1036" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1815" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2581" y="0"></use>
<g transform="translate(3637,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
</g>
<g transform="translate(5037,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="4027" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1763" y="676"></use>
<g transform="translate(60,-687)">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="722" y="0"></use>
<g transform="translate(1723,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
<g transform="translate(446,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1036" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1815" y="0"></use>
</g>
</g>
</g>
</g>
</g>
<g transform="translate(9304,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="17105" height="60" x="0" y="220"></rect>
<g transform="translate(60,815)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="757" y="0"></use>
<g transform="translate(1146,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="863" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1642" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="3595" y="0"></use>
<g transform="translate(4874,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="6419" y="0"></use>
<g transform="translate(7697,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="863" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1642" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9868" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43A" x="10424" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="11211" y="0"></use>
<g transform="translate(11600,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="863" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1642" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="14050" y="0"></use>
<g transform="translate(15328,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="16595" y="0"></use>
</g>
<g transform="translate(6825,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="557" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="863" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1642" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3064" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="26649" y="0"></use>
</g>
</svg>
</div>
<p>

As with the path-tracing integrator, there are a number of reasons to
choose the next vertex in the path by sampling the BSDF&rsquo;s distribution at the
intersection point to get a direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1010.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
</svg> and tracing a ray in that direction
rather than directly sampling by area on the scene surfaces.  Therefore, we
again apply the Jacobian to account for this change in measure, all of the
terms in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.827ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 786.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper G</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43A" d="M760 695l-63 -255c-5 -18 -5 -20 -18 -20c-4 0 -15 0 -15 10s3 11 3 51c0 116 -59 193 -161 193c-99 0 -196 -61 -250 -129c-105 -130 -115 -295 -115 -326c0 -153 105 -210 201 -210c35 0 165 11 193 121c10 37 21 82 21 91c0 13 -5 16 -31 19c-23 2 -53 2 -53 2 c-22 0 -30 0 -30 11c0 20 12 20 21 20l140 -3c23 0 82 3 105 3c8 0 13 -4 13 -11c0 -19 -11 -20 -16 -20c-57 -1 -58 -3 -69 -48c-4 -17 -9 -34 -13 -51l-19 -77c-5 -21 -15 -59 -17 -61c0 0 -2 -4 -7 -4c-10 0 -36 37 -45 62c-18 -20 -37 -41 -87 -61 c-36 -15 -81 -24 -125 -24c-162 0 -273 115 -273 274c0 232 225 453 448 453c111 0 157 -75 166 -89l70 77c11 11 12 12 15 12c9 0 11 -7 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43A" x="0" y="0"></use>
</g>
</svg> except for a single <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.882ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2532.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartAbsoluteValue cosine theta EndAbsoluteValue</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="1784" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="2254" y="0"></use>
</g>
</svg> cancel out, and the expression
is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:photon-scatter-weight"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="40.511ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 17442 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript i comma j plus 1 Baseline equals beta Subscript i comma j Baseline StartFraction 1 Over 1 minus q Subscript i comma j plus 1 Baseline EndFraction StartFraction f left-parenthesis normal p comma omega comma omega Superscript prime Baseline right-parenthesis StartAbsoluteValue cosine theta Superscript prime Baseline EndAbsoluteValue Over p left-parenthesis omega prime Subscript Baseline right-parenthesis EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1036" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1815" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2581" y="0"></use>
<g transform="translate(3637,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
</g>
<g transform="translate(5037,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="4027" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1763" y="676"></use>
<g transform="translate(60,-687)">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="722" y="0"></use>
<g transform="translate(1723,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
<g transform="translate(446,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1036" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1815" y="0"></use>
</g>
</g>
</g>
</g>
</g>
<g transform="translate(9304,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="7618" height="60" x="0" y="220"></rect>
<g transform="translate(60,770)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="552" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="942" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1498" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="1943" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2566" y="0"></use>
<g transform="translate(3011,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4021" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="4578" y="0"></use>
<g transform="translate(4856,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(6362,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="7220" y="0"></use>
</g>
<g transform="translate(2662,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1903" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="17163" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:photon-scatter-weight">16.16</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p></p>
<span class="anchor" id="fragment-Samplenewphotonraydirection-0"></span><div class="fragmentname">&lt;&lt;Sample new photon ray direction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeBSDFatphotonintersectionpoint-0">Compute BSDF at photon intersection point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1713" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1713"><i></i></a><div id="fragbit-1713" class="collapse"><div class="fragmentcode">   isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(photonRay, arena, true,
                                    <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance);
   if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
       --depth;
       photonRay = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(photonRay.d);
       continue;
   }
   const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;photonBSDF = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFmonofranddirectionmonowiforreflectedphoton-0">Sample BSDF <tt>fr</tt> and direction <tt>wi</tt> for reflected photon</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1714" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1714"><i></i></a><div id="fragbit-1714" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, wo = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
   Float pdf;
   BxDFType flags;
   &lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonobsdfSampleforoutgoingphotonsample-0">Generate <tt>bsdfSample</tt> for outgoing photon sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1715" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1715"><i></i></a><div id="fragbit-1715" class="collapse"><div class="fragmentcode">      <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> bsdfSample(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                         <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
      haltonDim += 2;</div></div>
   <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> fr = photonBSDF.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, bsdfSample,
                                     &amp;pdf, BSDF_ALL, &amp;flags);
   if (fr.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdf == 0.f) break;</div></div>
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> bnew = beta * fr * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdf;
&lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatephotonpathwithRussianroulette-0">Possibly terminate photon path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1716" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1716"><i></i></a><div id="fragbit-1716" class="collapse"><div class="fragmentcode">   Float q = std::max((Float)0, 1 - bnew.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>() / beta.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>());
   if (<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex) &lt; q)
       break;
   beta = bnew / (1 - q);</div></div>
photonRay = (RayDifferential)isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div><p>


</p>
<p>As before, a <tt>nullptr</tt>-valued <tt>BSDF *</tt> indicates an intersection that
should be ignored.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeBSDFatphotonintersectionpoint-0"></span><div class="fragmentname">&lt;&lt;Compute BSDF at photon intersection point&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(photonRay, arena, true,
                                 <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance);
if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
    --depth;
    photonRay = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(photonRay.d);
    continue;
}
const <a href="../Materials/BSDFs.html#BSDF" class="code">BSDF</a> &amp;photonBSDF = *isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>;</div><p>


</p>
<p>Sampling the BSDF to find the scattered photon direction follows the usual
model.

</p>
<p></p>
<span class="anchor" id="fragment-SampleBSDFmonofranddirectionmonowiforreflectedphoton-0"></span><div class="fragmentname">&lt;&lt;Sample BSDF <tt>fr</tt> and direction <tt>wi</tt> for reflected photon&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, wo = -photonRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
Float pdf;
BxDFType flags;
&lt;&lt;<span class="fragmentname"><a href="#fragment-GeneratemonobsdfSampleforoutgoingphotonsample-0">Generate <tt>bsdfSample</tt> for outgoing photon sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1717" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1717"><i></i></a><div id="fragbit-1717" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> bsdfSample(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                      <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
   haltonDim += 2;</div></div>
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> fr = photonBSDF.<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, &amp;wi, bsdfSample,
                                  &amp;pdf, BSDF_ALL, &amp;flags);
if (fr.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdf == 0.f) break;</div><p>


</p>
<p>The next two dimensions of the Halton sample vector are used for the BSDF sample.

</p>
<p></p>
<span class="anchor" id="fragment-GeneratemonobsdfSampleforoutgoingphotonsample-0"></span><div class="fragmentname">&lt;&lt;Generate <tt>bsdfSample</tt> for outgoing photon sample&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> bsdfSample(<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim,     haltonIndex),
                   <a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim + 1, haltonIndex));
haltonDim += 2;</div><p>


</p>
<p>The photon scattering step should be implemented carefully in order to
keep the photon weights as similar to each other as possible.  A method
that gives a distribution of photons where all have exactly equal weights was
suggested by Jensen (<a href="Further_Reading.html#cite:Jensen01b">2001</a>, Section&nbsp;5.2).  First, the reflectance is
computed at the intersection point.  A random decision is then made whether
or not to continue the photon&rsquo;s path with probability proportional to this
reflectance.  If the photon continues, its scattered direction is found by
sampling from the BSDF&rsquo;s distribution, but it continues with its weight
unchanged except for adjusting the spectral distribution based on the
surface&rsquo;s color.  Thus, a surface that reflects very little light will
reflect few of the photons that reach it, but those that are scattered will
continue on with unchanged contributions and so forth.

</p>
<p>This particular approach isn&rsquo;t possible in <tt>pbrt</tt> due to a subtle
implementation detail (a similar issue held for light source sampling
previously as well): in <tt>pbrt</tt>, the <tt>BxDF</tt> interfaces are written so
that the distribution used for importance sampling BSDFs doesn&rsquo;t
necessarily have to perfectly match the actual distribution of the function
being sampled.  It is all the better if it does, but for many complex
BSDFs exactly sampling from its distribution is difficult or impossible.

</p>
<p>Therefore, here we will use an approach that generally leads to a similar
result but offers more flexibility: at each intersection point, an outgoing
direction is sampled with the BSDF&rsquo;s sampling distribution, and the photon&rsquo;s
updated weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 2303.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript i comma j plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1036" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1815" y="0"></use>
</g>
</g>
</svg> is computed using
Equation&nbsp;(<a href="#eq:photon-scatter-weight">16.16</a>).  Then the ratio of the luminance
of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 2303.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript i comma j plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1036" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1815" y="0"></use>
</g>
</g>
</svg> to the luminance of the photon&rsquo;s old weight
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.25ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1399.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript i comma j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
</g>
</svg> is used to set the probability of continuing the path
after applying Russian roulette.

</p>
<p>The termination probability <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.051ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 452.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
</g>
</svg> is thus set so that if the photon&rsquo;s weight is significantly
decreased at the scattering point, the termination probability will be high
and if the photon&rsquo;s weight is essentially unchanged, the termination
probability is low.  In particular, the termination probability is chosen
in a way such that if the photon continues, after its weight has been
adjusted for the possibility of termination, its luminance will be the same
as it was before scattering. It is easy to verify this property from the
fragment below.  (This property actually doesn&rsquo;t hold for the case where
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.7ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 5037.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript i comma j plus 1 Baseline greater-than beta Subscript i comma j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3E" d="M688 230l-581 -275c-25 -11 -42 25 -18 36l548 259l-548 259c-24 11 -7 47 18 36l581 -275c17 -8 17 -32 0 -40Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1036" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1815" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3E" x="2581" y="0"></use>
<g transform="translate(3637,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
<g transform="translate(566,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="624" y="0"></use>
</g>
</g>
</g>
</svg>, as can happen when the
ratio of the BSDF&rsquo;s value and the PDF is greater than&nbsp;1.)

</p>
<p></p>
<span class="anchor" id="fragment-PossiblyterminatephotonpathwithRussianroulette-0"></span><div class="fragmentname">&lt;&lt;Possibly terminate photon path with Russian roulette&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float q = std::max((Float)0, 1 - bnew.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>() / beta.<a href="../Color_and_Radiometry/The_SampledSpectrum_Class.html#Spectrum::y" class="code">y</a>());
if (<a href="../Sampling_and_Reconstruction/The_Halton_Sampler.html#RadicalInverse" class="code">RadicalInverse</a>(haltonDim++, haltonIndex) &lt; q)
    break;
beta = bnew / (1 - q);</div><p>


</p>
<p>After all of the photons for the iteration have been traced, the estimate
of the incident radiance visible in each pixel area can now be updated based
on contributions from photons in the current pass.

</p>
<p></p>
<span class="anchor" id="fragment-Updatepixelvaluesfromthispasssphotons-0"></span><div class="fragmentname">&lt;&lt;Update pixel values from this pass&rsquo;s photons&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (int i = 0; i &lt; nPixels; ++i) {
    SPPMPixel &amp;p = pixels[i];
    if (p.<a href="#SPPMPixel::M" class="code">M</a> &gt; 0) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatepixelphotoncountsearchradiusandtaufromphotons-0">Update pixel photon count, search radius, and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.188ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 511.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">tau</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70F" d="M511 407c0 -34 -36 -34 -49 -34h-168l-67 -342c-3 -15 -8 -43 -41 -43c-22 0 -29 16 -29 27c0 4 6 25 10 37l98 321h-83c-21 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 6 28 54 61 90c44 47 83 47 103 47h280c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70F" x="0" y="0"></use>
</g>
</svg> from photons</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1718" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1718"><i></i></a><div id="fragbit-1718" class="collapse"><div class="fragmentcode">           Float gamma = (Float)2 / (Float)3;
           Float Nnew = p.<a href="#SPPMPixel::N" class="code">N</a> + gamma * p.M;
           Float Rnew = p.<a href="#SPPMPixel::radius" class="code">radius</a> * std::sqrt(Nnew / (p.<a href="#SPPMPixel::N" class="code">N</a> + p.M));
           <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a>;
           for (int j = 0; j &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++j)
               <a href="#SPPMPixel::Phi" class="code">Phi</a>[j] = p.<a href="#SPPMPixel::Phi" class="code">Phi</a>[j];
           p.<a href="#SPPMPixel::tau" class="code">tau</a> = (p.<a href="#SPPMPixel::tau" class="code">tau</a> + p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a> * <a href="#SPPMPixel::Phi" class="code">Phi</a>) *
                   (Rnew * Rnew) / (p.<a href="#SPPMPixel::radius" class="code">radius</a> * p.<a href="#SPPMPixel::radius" class="code">radius</a>);
           p.<a href="#SPPMPixel::N" class="code">N</a> = Nnew;
           p.<a href="#SPPMPixel::radius" class="code">radius</a> = Rnew;</div></div>
        p.<a href="#SPPMPixel::M" class="code">M</a> = 0;
        for (int j = 0; j &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++j)
            p.<a href="#SPPMPixel::Phi" class="code">Phi</a>[j] = (Float)0;
    }
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ResetmonoVisiblePointinpixel-0">Reset <tt>VisiblePoint</tt> in pixel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1719" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1719"><i></i></a><div id="fragbit-1719" class="collapse"><div class="fragmentcode">       p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a> = 0.;
       p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a> = nullptr;</div></div>
}
</div><p>


</p>
<p>Equation&nbsp;(<a href="#eq:sppm-update-rules">16.13</a>) gives the rules to update the search
radius and other quantities related to the photon estimate.

</p>
<p></p>
<span class="anchor" id="fragment-Updatepixelphotoncountsearchradiusandtaufromphotons-0"></span><div class="fragmentname">&lt;&lt;Update pixel photon count, search radius, and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.188ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 511.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">tau</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70F" d="M511 407c0 -34 -36 -34 -49 -34h-168l-67 -342c-3 -15 -8 -43 -41 -43c-22 0 -29 16 -29 27c0 4 6 25 10 37l98 321h-83c-21 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 6 28 54 61 90c44 47 83 47 103 47h280c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70F" x="0" y="0"></use>
</g>
</svg> from photons&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float gamma = (Float)2 / (Float)3;
Float Nnew = p.<a href="#SPPMPixel::N" class="code">N</a> + gamma * p.M;
Float Rnew = p.<a href="#SPPMPixel::radius" class="code">radius</a> * std::sqrt(Nnew / (p.<a href="#SPPMPixel::N" class="code">N</a> + p.M));
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="#SPPMPixel::Phi" class="code">Phi</a>;
for (int j = 0; j &lt; <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>::nSamples; ++j)
    <a href="#SPPMPixel::Phi" class="code">Phi</a>[j] = p.<a href="#SPPMPixel::Phi" class="code">Phi</a>[j];
p.<a href="#SPPMPixel::tau" class="code">tau</a> = (p.<a href="#SPPMPixel::tau" class="code">tau</a> + p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a> * <a href="#SPPMPixel::Phi" class="code">Phi</a>) *
        (Rnew * Rnew) / (p.<a href="#SPPMPixel::radius" class="code">radius</a> * p.<a href="#SPPMPixel::radius" class="code">radius</a>);
p.<a href="#SPPMPixel::N" class="code">N</a> = Nnew;
p.<a href="#SPPMPixel::radius" class="code">radius</a> = Rnew;</div><p>


</p>
<p>Note that the number of photons that have contributed to the pixel <tt>N</tt>
is actually stored as a <tt>Float</tt>. This quantity must be treated as
continuously valued, not a discrete integer, for the progressive radiance
estimate to converge to the correct value in the limit.

</p>
<p></p>
<span class="anchor" id="fragment-SPPMPixelPublicData-4"></span><div class="fragmentname">&lt;&lt;SPPMPixel Public Data&gt;&gt;+=&nbsp;<a href="#fragment-SPPMPixelPublicData-3"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="SPPMPixel::N"></span>N = 0;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <span class="anchor" id="SPPMPixel::tau"></span>tau;</div><p>
 

</p>
<p>Before the next SPPM iteration begins, it&rsquo;s necessary to zero out the
visible point in the pixel so that we don&rsquo;t attempt to re-use this one if
no visible point and <tt>BDSF *</tt> is found in the next iteration.

</p>
<p></p>
<span class="anchor" id="fragment-ResetmonoVisiblePointinpixel-0"></span><div class="fragmentname">&lt;&lt;Reset <tt>VisiblePoint</tt> in pixel&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::beta" class="code">beta</a> = 0.;
p.<a href="#SPPMPixel::vp" class="code">vp</a>.<a href="#VisiblePoint::bsdf" class="code">bsdf</a> = nullptr;</div><p>


</p>
<p>


</p>
<p>Most of the &lt;&lt;<span class="fragmentname">Periodically store SPPM image in film and write
image</span>&gt;&gt; fragment is a straightforward matter of allocating an image of
<tt>Spectrum</tt> values to pass to <a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#Film::SetImage"><tt>Film::SetImage()</tt></a> and then
initializing the pixels in the image and before calling <tt>Film::WriteImage()</tt>.
We won&rsquo;t include that boilerplate here, in order to focus on the last step
of the SPPM algorithm, which combines the direct and indirect radiance
estimates.

</p>
<p>As described earlier, the direct lighting estimate needs to be divided by
the number of pixel samples (which in turn is how many iterations have
completed at this point) to get its average value.  The indirect photon
term is computed using
Equation&nbsp;(<a href="#eq:photon-est-outgoing-radiance">16.11</a>)&mdash;the two values then just
need to be added together.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeradiancemonoLforSPPMpixelmonopixel-0"></span><div class="fragmentname">&lt;&lt;Compute radiance <tt>L</tt> for SPPM pixel <tt>pixel</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">const SPPMPixel &amp;pixel = pixels[(y - pixelBounds.pMin.y) * (x1 - x0) +
                                (x - x0)];
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> L = pixel.<a href="#SPPMPixel::Ld" class="code">Ld</a> / (iter + 1);
L += pixel.<a href="#SPPMPixel::tau" class="code">tau</a> / (Np * <a href="../Utilities/Main_Include_File.html#Pi" class="code">Pi</a> * pixel.<a href="#SPPMPixel::radius" class="code">radius</a> * pixel.<a href="#SPPMPixel::radius" class="code">radius</a>);</div><p>


</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
  <div class="container-fluid-nav">
    <!--  <ul class="nav navbar-nav navbar-center"> -->
      <span class="navbar-text" style="text-align: center;">
        Thanks to William Newhall and 43 others for generously supporting <i>Physically
        Based Rendering</i> online
        through <a href="https://patreon.com/pbrbook">Patreon</a>.
    </span>
  </div>
</nav>

<nav class="navbar navbar-expand-md bg-light navbar-light">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>, &copy; 2004-2019 Matt Pharr, Wenzel Jakob, and Greg Humphreys</span>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Light_Transport_III_Bidirectional_Methods/Bidirectional_Path_Tracing.html">Light Transport III: Bidirectional Methods / Bidirectional Path Tracing</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
