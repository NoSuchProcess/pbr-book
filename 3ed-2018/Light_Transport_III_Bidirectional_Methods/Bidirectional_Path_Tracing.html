
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

  <script async src="https://cse.google.com/cse.js?cx=003601324460585362024:4xwpwgaitgd"></script>
  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
        
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Bidirectional Path Tracing</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_III_Bidirectional_Methods.html">Light Transport III: Bidirectional Methods</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Bidirectional Path Tracing</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_III_Bidirectional_Methods/Stochastic_Progressive_Photon_Mapping.html">(Previous: Stochastic Progressive Photon Mapping)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:bidir-path-tracing"></span><h2>16.3 Bidirectional Path Tracing</h2><p>



</p>
<p>

</p>
<p>The path-tracing algorithm described in Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#sec:path-tracing">14.5</a> was
the first fully general light transport algorithm in computer graphics,
handling both a wide variety of geometric representations, lights, and BSDF
models.  Although it works well for many scenes, path tracing can exhibit
high variance in the presence of particular tricky lighting conditions.
For example, consider the setting shown in
Figure&nbsp;<a href="#fig:forward-path-tricky">16.12</a>: a light source is illuminating a
small area on the ceiling such that the rest of the room is only
illuminated by indirect lighting bouncing from that area.  If we only trace
paths starting from the camera, we will almost never happen to sample a
path vertex in the illuminated region on the ceiling before we trace a
shadow ray to the light. Most of the paths will have no contribution, while
a few of them&mdash;the ones that happen to hit the small region on the
ceiling&mdash;will have a large contribution.  The resulting image will have
high variance.

</p>
<p></p>
<span class="anchor" id="fig:forward-path-tricky"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="difficult-path.svg" title=""><img src="difficult-path.svg" width=385 height=376 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.12: A Difficult Case for Path Tracing
Starting from the Camera. <span class="legend"> A light source is illuminating a small area on
the ceiling (thick line) such that only paths with a second-to-last vertex in the area
indicated will be able to find illumination from the light.  Bidirectional
methods, where a path is started from the light and is connected with a
path from the camera, can handle situations like these more robustly.
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Difficult lighting settings like this can be handled more effectively by
constructing paths that start from the camera on one end and from the light on
the other end and are connected in the middle with a visibility ray. The
resulting <em>bidirectional path-tracing</em> algorithm (henceforth referred to as BDPT)
is a generalization of the standard path-tracing algorithm that can be much
more efficient. In contrast to
stochastic progressive photon mapping, BDPT is unbiased and does not blur the
scene illumination.

</p>
<p>BDPT first incrementally constructs a <em>camera subpath</em> starting with a
point <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1010.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
</svg> on the camera. The next vertex, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1010.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
</svg>, is found by
computing the first intersection along the camera ray. Another vertex is
found by sampling the BSDF at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1010.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
</svg> and tracing a ray to find a point
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1010.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="787" y="-213"></use>
</g>
</svg>, and so forth. The resulting path of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> vertices is <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.393ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 6196.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 0 comma normal p 1 comma ellipsis comma normal p Subscript normal t minus 1 Baseline</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1010" y="0"></use>
<g transform="translate(1455,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2465" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="2911" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3915" y="0"></use>
<g transform="translate(4360,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</g>
</svg>. Following the same process starting from a
point on a light source <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.282ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 982.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
</svg> (and then using adjoint BSDFs at each vertex)
creates a <em>light subpath</em> of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 469.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
</g>
</svg> vertices, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.206ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 6116.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q 0 comma normal q 1 comma ellipsis comma normal q Subscript normal s minus 1 Baseline</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="982" y="0"></use>
<g transform="translate(1427,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2409" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="2855" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3859" y="0"></use>
<g transform="translate(4304,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
</g>
</svg>.

</p>
<p>Given the two subpaths, a complete light-carrying path can be found by
connecting a pair of vertices from each path.
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="29.389ex" height="2.509ex" style="vertical-align: -0.838ex;" viewBox="0 -719.6 12653.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline overbar Subscript Baseline equals normal q 0 comma ellipsis comma normal q Subscript s prime minus 1 Baseline comma normal p Subscript t prime minus 1 Baseline comma ellipsis comma normal p 0 comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="834" y="0"></use>
<g transform="translate(1890,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2872" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="3318" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4322" y="0"></use>
<g transform="translate(4767,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-176)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="485" y="355"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="825" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1603" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6883" y="0"></use>
<g transform="translate(7329,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-186)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="479" y="372"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="820" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1598" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="9470" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="9915" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="10919" y="0"></use>
<g transform="translate(11364,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="12374" y="0"></use>
</g>
</svg>
</div>
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.181ex" height="2.509ex" style="vertical-align: -0.505ex;" viewBox="0 -863.1 2661.2 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s prime less-than-or-equal-to s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2264" d="M691 75c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259zM702 -99c0 -11 -9 -20 -20 -20h-586c-11 0 -20 9 -20 20s9 20 20 20h586c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2264" x="1135" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="2191" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.679ex" height="2.509ex" style="vertical-align: -0.505ex;" viewBox="0 -863.1 2445.2 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t prime less-than-or-equal-to t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2264" d="M691 75c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259zM702 -99c0 -11 -9 -20 -20 -20h-586c-11 0 -20 9 -20 20s9 20 20 20h586c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="511" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2264" x="1027" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="2083" y="0"></use>
</g>
</svg>.
(Our notation orders the vertices in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.293ex" height="2.343ex" style="vertical-align: -0.671ex;" viewBox="0 -719.6 556.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline overbar Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
</g>
</svg> according to the propagation
of light).  If a
visibility ray between <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.916ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 2116.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript s prime minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-176)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="485" y="355"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="825" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1603" y="0"></use>
</g>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.973ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 2141 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t prime minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-186)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="479" y="372"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="820" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1598" y="0"></use>
</g>
</g>
</svg> is unoccluded,
then the path contribution can be found by evaluating the
BSDFs at the connecting vertices (see Figure&nbsp;<a href="#fig:bdpt-connections">16.13</a>).
More generally, these
subpaths can be combined using the theory of path-space integration from
Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/The_Light_Transport_Equation.html#sec:pathspace">14.4.4</a>.

</p>
<p></p>
<span class="anchor" id="fig:bdpt-connections"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="bdpt-connection.svg" title=""><img src="bdpt-connection.svg" width=453 height=296 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.13: <span class="legend">
Bidirectional path tracing is based on generating two subpaths, one
starting from a light and the other starting from the camera.
Light-carrying paths can be found by attempting to connect pairs of
vertices, one from each path.  If a visibility ray between the two (dashed
line) is unoccluded, the path&rsquo;s contribution can be added to the radiance
estimate.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Superficially, this approach bears some semblance to the two phases of the
photon mapper; a key difference is that BDPT computes an unbiased estimate
without density estimation. There are also significant differences in how
the fact that a given light path could have been constructed in multiple
different ways is handled.

</p>
<p>There are three refinements to the algorithm that we&rsquo;ve described so far
that improve its
performance in practice.  The first two are analogous to improvements made
to path tracing, and the third is a powerful variance reduction technique.
</p>
<ul>
<li> First, subpaths can be reused: given a path <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="22.936ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 9875.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q 0 comma ellipsis comma normal q Subscript s minus 1 Baseline comma normal p Subscript t minus 1 Baseline comma ellipsis comma normal p 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="982" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="1427" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2431" y="0"></use>
<g transform="translate(2876,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4688" y="0"></use>
<g transform="translate(5133,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6970" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="7415" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="8419" y="0"></use>
<g transform="translate(8864,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
</g>
</svg>, transport can 
be evaluated over all of the
paths given by connecting all the various combinations of
prefixes of the two paths together.  If two paths have <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 469.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg>
vertices, respectively, then a variety of unique paths can be constructed
from them, ranging in length from 2 to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.77ex" height="2.176ex" style="vertical-align: -0.505ex;" viewBox="0 -719.6 2053.9 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s plus t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="691" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="1692" y="0"></use>
</g>
</svg> vertices long.  
Figure&nbsp;<a href="#fig:bdpt-direct-strategies">16.14</a> illustrates these strategies for
the case of direct illumination.

<li> The second optimization is not to try to connect paths that use only
a single vertex from one of the subpaths. It is preferable to generate
those paths using optimized sampling routines provided by the camera and
light sources; for light sources, these are the direct lighting techniques
that were introduced in Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#sec:direct-lighting">14.3</a>.

<li> The third optimization weights the various strategies for generating
paths of a given length more carefully than just averaging all of the
strategies that construct paths of the same length.  BDPT&rsquo;s approach of
connecting subpaths means that a path containing <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
</g>
</svg> scattering events can
be generated in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.398ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2323.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n plus 3</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="822" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-33" x="1823" y="0"></use>
</g>
</svg> different ways. We can expect that some
strategies will be a good choice for producing certain types of paths while
being quite poor for others.  Multiple importance sampling can be
applied to combine the set of connection strategies into a single estimator
that uses each strategy where it is best. This application of MIS is crucial to BDPT&rsquo;s
efficiency.
</ul><p>


</p>
<p></p>
<span class="anchor" id="fig:bdpt-direct-strategies"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="bdpt-direct-connections.svg" title=""><img src="bdpt-direct-connections.svg" width=768 height=521 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.14: 
<span class="legend">
The four different ways in which bidirectional path tracing can create a
direct illumination path.
(a) Standard path tracing without direct illumination sampling,
where a ray generated using BSDF sampling from a point on a surface
happens to intersect a light source. 
(b) Path
tracing with direct illumination sampling, where the explicit shadow ray is
indicated with a dashed line. (c) Particle tracing from a light source with
an explicit visibility test between a point on a surface and the camera.
(d) Particle tracing where a particle happens to intersect the camera&rsquo;s lens.
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>One of BDPT&rsquo;s connection strategies is to directly connect light subpath
vertices to the camera: these paths almost always create a contribution
whose raster coordinates differ from the current pixel being rendered,
which violates the expectations of the <a href="../Introduction/pbrt_System_Overview.html#SamplerIntegrator"><tt>SamplerIntegrator</tt></a>
interface. Thus, <a href="#BDPTIntegrator"><tt>BDPTIntegrator</tt></a> derives from the more general
<a href="../Introduction/pbrt_System_Overview.html#Integrator"><tt>Integrator</tt></a> interface so that it can have more flexibility in how it
updates the image.  Its implementation is in the files
<a href="https://github.com/mmp/pbrt-v3/tree/master/src/integrators/bdpt.h"><tt>integrators/bdpt.h</tt></a><span class="anchor" id="integratorsbdpt.h"></span> and
<a href="https://github.com/mmp/pbrt-v3/tree/master/src/integrators/bdpt.cpp"><tt>integrators/bdpt.cpp</tt></a><span class="anchor" id="integratorsbdpt.cpp"></span>.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTDeclarations-0"></span><div class="fragmentname">&lt;&lt;BDPT Declarations&gt;&gt;=&nbsp;<a href="#fragment-BDPTDeclarations-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">class <span class="anchor" id="BDPTIntegrator"></span>BDPTIntegrator : public <a href="../Introduction/pbrt_System_Overview.html#Integrator" class="code">Integrator</a> {
public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-BDPTIntegratorPublicMethods-0">BDPTIntegrator Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1720" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1720"><i></i></a><div id="fragbit-1720" class="collapse"><div class="fragmentcode">       BDPTIntegrator(std::shared_ptr&lt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a>&gt; sampler, std::shared_ptr&lt;const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>&gt; camera,
                      int maxDepth, bool visualizeStrategies, bool visualizeWeights)
           : sampler(sampler), camera(camera), maxDepth(maxDepth),
             visualizeStrategies(visualizeStrategies),
             visualizeWeights(visualizeWeights) { }
       void Render(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene);</div></div>
private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-BDPTIntegratorPrivateData-0">BDPTIntegrator Private Data</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1721" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1721"><i></i></a><div id="fragbit-1721" class="collapse"><div class="fragmentcode">       std::shared_ptr&lt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a>&gt; sampler;
       std::shared_ptr&lt;const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>&gt; camera;
       const int maxDepth;
       </div></div>
};</div><p>


</p>
<p>The <tt>BDPTIntegrator</tt> constructor, which is straightforward and not
included here, initializes member variables with the provided camera,
sampler, and the maximum path depth.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTIntegratorPrivateData-0"></span><div class="fragmentname">&lt;&lt;BDPTIntegrator Private Data&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">std::shared_ptr&lt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a>&gt; <span class="anchor" id="BDPTIntegrator::sampler"></span>sampler;
std::shared_ptr&lt;const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>&gt; <span class="anchor" id="BDPTIntegrator::camera"></span>camera;
const int <span class="anchor" id="BDPTIntegrator::maxDepth"></span>maxDepth;
</div><p>


</p>
<p>

</p>
<p>

</p>
<p>All subpath creation and connection steps are performed in a nested parallel
loop over pixels in <a href="#BDPTIntegrator::Render"><tt>BDPTIntegrator::Render()</tt></a>.  The overall structure
of this method is very similar to <a href="../Introduction/pbrt_System_Overview.html#SamplerIntegrator::Render"><tt>SamplerIntegrator::Render()</tt></a>:
</p>
<ul>
<li> The image is subdivided into tiles of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.49ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 3224.9 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">16 times 16</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-36" d="M457 204c0 -132 -95 -226 -206 -226c-93 0 -209 71 -209 338c0 221 135 350 263 350c83 0 127 -48 127 -108c0 -39 -30 -48 -46 -48c-22 0 -46 15 -46 46c0 45 40 45 55 45c-22 34 -64 40 -88 40c-51 0 -175 -36 -175 -289v-24c20 48 57 99 125 99 c111 0 200 -96 200 -223zM367 205c0 49 0 100 -18 137c-31 62 -77 62 -93 62c-90 0 -122 -100 -122 -178c0 -18 0 -98 18 -145c6 -15 36 -75 99 -75c23 0 69 5 99 65c17 36 17 86 17 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-D7" d="M624 15c-7 -8 -20 -8 -28 0l-207 207l-207 -207c-8 -8 -21 -8 -28 0c-8 7 -8 20 0 28l207 207l-207 207c-8 8 -8 21 0 28c7 8 20 8 28 0l207 -207l207 207c8 8 21 8 28 0c8 -7 8 -20 0 -28l-207 -207l207 -207c8 -8 8 -21 0 -28Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-36" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-D7" x="1223" y="0"></use>
<g transform="translate(2223,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-36" x="500" y="0"></use>
</g>
</g>
</svg> pixels, which are
processed in parallel.
<li> For each tile, the method declares a <a href="../Utilities/Memory_Management.html#MemoryArena"><tt>MemoryArena</tt></a>, <tt>arena</tt>
and acquires a <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler"><tt>Sampler</tt></a> instance from <a href="#BDPTIntegrator::sampler"><tt>BDPTIntegrator::sampler</tt></a>
via a call to <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Clone"><tt>Sampler::Clone()</tt></a>.
<li> It then loops over the pixels in each tile, taking samples from each
one until <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::StartNextSample"><tt>Sampler::StartNextSample()</tt></a> returns <tt>false</tt>, at which
point it advances to the next pixel.
</ul><p>


</p>
<p>We won&rsquo;t include this code here, as the details should be familiar now.
Instead, we&rsquo;ll move forward to the fragment responsible for generating and
connecting the subpaths for a pixel sample.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTIntegratorPublicMethods-0"></span><div class="fragmentname">&lt;&lt;BDPTIntegrator Public Methods&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">void <span class="anchor" id="BDPTIntegrator::Render"></span>Render(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene);</div><p>


</p>
<p>

</p>
<p>Generating a single BDPT sample involves sampling a pixel
position in the image, generating camera and light subpaths, and then connecting them
using a variety of specialized connection strategies.

</p>
<p></p>
<span class="anchor" id="fragment-GenerateasinglesampleusingBDPT-0"></span><div class="fragmentname">&lt;&lt;Generate a single sample using BDPT&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> pFilm = (<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>)pPixel + tileSampler-&gt;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
&lt;&lt;<span class="fragmentname"><a href="#fragment-Tracethecameraandlightsubpaths-0">Trace the camera and light subpaths</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1722" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1722"><i></i></a><div id="fragbit-1722" class="collapse"><div class="fragmentcode">   Vertex *cameraVertices = arena.<a href="../Utilities/Memory_Management.html#MemoryArena::Alloc" class="code">Alloc</a>&lt;Vertex&gt;(<a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a> + 2);
   Vertex *lightVertices = arena.<a href="../Utilities/Memory_Management.html#MemoryArena::Alloc" class="code">Alloc</a>&lt;Vertex&gt;(<a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a> + 1);
   int nCamera = <a href="#GenerateCameraSubpath" class="code">GenerateCameraSubpath</a>(scene, *tileSampler, arena,
       <a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a> + 2, *camera, pFilm, cameraVertices);
   int nLight = <a href="#GenerateLightSubpath" class="code">GenerateLightSubpath</a>(scene, *tileSampler, arena,
       <a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a> + 1, cameraVertices[0].<a href="#Vertex::time" class="code">time</a>(), *lightDistr, lightVertices);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-ExecuteallBDPTconnectionstrategies-0">Execute all BDPT connection strategies</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1723" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1723"><i></i></a><div id="fragbit-1723" class="collapse"><div class="fragmentcode">   <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> L(0.f);
   for (int t = 1; t &lt;= nCamera; ++t) {
       for (int s = 0; s &lt;= nLight; ++s) {
           int depth = t + s - 2;
           if ((s == 1 &amp;&amp; t == 1) || depth &lt; 0 || depth &gt; <a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a>)
               continue;
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ExecutethestconnectionstrategyandupdatemonoL-0">Execute the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.773ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2055.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis s comma t right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="859" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="1304" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1665" y="0"></use>
</g>
</svg> connection strategy and update <tt>L</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1724" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1724"><i></i></a><div id="fragbit-1724" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> pFilmNew = pFilm;
              Float misWeight = 0.f;
              <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Lpath = <a href="#ConnectBDPT" class="code">ConnectBDPT</a>(scene, lightVertices, cameraVertices, s, t,
                  *lightDistr, *camera, *tileSampler, &amp;pFilmNew, &amp;misWeight);
              if (t != 1)
                  L += Lpath;
              else
                  film-&gt;<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#Film::AddSplat" class="code">AddSplat</a>(pFilmNew, Lpath);</div></div>
       }
   }
   filmTile-&gt;<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#FilmTile::AddSample" class="code">AddSample</a>(pFilm, L);</div></div></div><p>


</p>
<p>The <a href="#Vertex"><tt>Vertex</tt></a> class, which will be introduced in
Section&nbsp;<a href="#sec:bdpt-vertex">16.3.1</a>, represents a vertex along a subpath.  We
start by allocating two arrays for vertices for the two subpaths.  In
addition to a vertex on a surface, a <a href="#Vertex"><tt>Vertex</tt></a> can represent a vertex
for a scattering event in participating media, a vertex on a light source,
or a vertex on the camera lens.

</p>
<p>For each subpath, one more vertex than the maximum path length must be
allocated to store the starting vertex on the light or camera.  Camera
subpaths get yet again one more vertex, which allows camera paths to
randomly intersect light sources&mdash;this strategy is important for
rendering area lights seen by reflections only from specular surfaces, for
example. (The corresponding strategy of allowing a light subpath to
randomly intersect the camera lens is less useful in practice.)

</p>
<p>The <tt>GenerateCameraSubpath()</tt> and <tt>GenerateLightSubpath()</tt>
functions, which generate these two subpaths, will be defined in
Section&nbsp;<a href="#sec:bdpt-camera-light-subpaths">16.3.2</a>, after some preliminaries
related to the <a href="#Vertex"><tt>Vertex</tt></a> representation.

</p>
<p></p>
<span class="anchor" id="fragment-Tracethecameraandlightsubpaths-0"></span><div class="fragmentname">&lt;&lt;Trace the camera and light subpaths&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Vertex *cameraVertices = arena.<a href="../Utilities/Memory_Management.html#MemoryArena::Alloc" class="code">Alloc</a>&lt;Vertex&gt;(<a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a> + 2);
Vertex *lightVertices = arena.<a href="../Utilities/Memory_Management.html#MemoryArena::Alloc" class="code">Alloc</a>&lt;Vertex&gt;(<a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a> + 1);
int nCamera = <a href="#GenerateCameraSubpath" class="code">GenerateCameraSubpath</a>(scene, *tileSampler, arena,
    <a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a> + 2, *camera, pFilm, cameraVertices);
int nLight = <a href="#GenerateLightSubpath" class="code">GenerateLightSubpath</a>(scene, *tileSampler, arena,
    <a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a> + 1, cameraVertices[0].<a href="#Vertex::time" class="code">time</a>(), *lightDistr, lightVertices);</div><p>


</p>
<p>After the subpaths have been generated, a nested <tt>for</tt> loop iterates
over all pairs of vertices from the two subpaths and attempts to connect
them. In these loops, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 469.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> correspond to the number of vertices to
use from the corresponding subpath; an index of&nbsp;0 means that no
scattering events are
used from the corresponding subpath. In our implementation, this strategy
is only supported for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1803" y="0"></use>
</g>
</svg> case, which furthermore requires
<tt>cameraVertices[t]</tt> to be a surface intersection involving a light source.
Because the dual case&mdash;intersecting a camera with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1695" y="0"></use>
</g>
</svg>&mdash;is not supported, the
loop over camera subpaths starts at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg>.

</p>
<p>A path length of&nbsp;1 corresponds to connecting a point on the camera lens
or a light source to the other subpath. For light endpoints,
this is identical to the standard light sampling approach provided by
<a href="../Light_Sources/Light_Interface.html#Light::Sample_Li"><tt>Light::Sample_Li()</tt></a> and first used in
Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Direct_Lighting.html#sec:estimating-direct-lighting">14.3.1</a>; our implementation uses this
existing functionality. For camera endpoints, we will rely on the symmetric
analog <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Sample_Wi"><tt>Camera::Sample_Wi()</tt></a>. Since <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Sample_Wi"><tt>Camera::Sample_Wi()</tt></a> and
<a href="../Light_Sources/Light_Interface.html#Light::Sample_Li"><tt>Light::Sample_Li()</tt></a> cannot both be used at the same time, we skip
the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.289ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 3999.6 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="1803" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2442" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="3499" y="0"></use>
</g>
</svg> case.

</p>
<p></p>
<span class="anchor" id="fragment-ExecuteallBDPTconnectionstrategies-0"></span><div class="fragmentname">&lt;&lt;Execute all BDPT connection strategies&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> L(0.f);
for (int t = 1; t &lt;= nCamera; ++t) {
    for (int s = 0; s &lt;= nLight; ++s) {
        int depth = t + s - 2;
        if ((s == 1 &amp;&amp; t == 1) || depth &lt; 0 || depth &gt; <a href="#BDPTIntegrator::maxDepth" class="code">maxDepth</a>)
            continue;
        &lt;&lt;<span class="fragmentname"><a href="#fragment-ExecutethestconnectionstrategyandupdatemonoL-0">Execute the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.773ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2055.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis s comma t right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="859" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="1304" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1665" y="0"></use>
</g>
</svg> connection strategy and update <tt>L</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1725" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1725"><i></i></a><div id="fragbit-1725" class="collapse"><div class="fragmentcode">           <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> pFilmNew = pFilm;
           Float misWeight = 0.f;
           <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Lpath = <a href="#ConnectBDPT" class="code">ConnectBDPT</a>(scene, lightVertices, cameraVertices, s, t,
               *lightDistr, *camera, *tileSampler, &amp;pFilmNew, &amp;misWeight);
           if (t != 1)
               L += Lpath;
           else
               film-&gt;<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#Film::AddSplat" class="code">AddSplat</a>(pFilmNew, Lpath);</div></div>
    }
}
filmTile-&gt;<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#FilmTile::AddSample" class="code">AddSample</a>(pFilm, L);</div><p>


</p>
<p>The <a href="#ConnectBDPT"><tt>ConnectBDPT()</tt></a> function attempts to connect the two subpaths with
the given number of vertices; it returns the weighted contribution of the
radiance carried along the resulting path.  (It will be defined shortly, in
Section&nbsp;<a href="#sec:bdpt-connections">16.3.3</a>.)  In most cases, this contribution is
accumulated into the variable <tt>L</tt> that will be provided to the
<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#FilmTile"><tt>FilmTile</tt></a> after all of the subpath connections have been attempted.
However, the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> connection connects a vertex of the light subpath
directly to the camera and thus will produce different raster positions in
every iteration&mdash;in this case, the implementation calls
<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#Film::AddSplat"><tt>Film::AddSplat()</tt></a> to immediately record its sample contribution.

</p>
<p></p>
<span class="anchor" id="fragment-ExecutethestconnectionstrategyandupdatemonoL-0"></span><div class="fragmentname">&lt;&lt;Execute the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.773ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2055.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis s comma t right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="859" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="1304" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1665" y="0"></use>
</g>
</svg> connection strategy and update <tt>L</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> pFilmNew = pFilm;
Float misWeight = 0.f;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Lpath = <a href="#ConnectBDPT" class="code">ConnectBDPT</a>(scene, lightVertices, cameraVertices, s, t,
    *lightDistr, *camera, *tileSampler, &amp;pFilmNew, &amp;misWeight);
if (t != 1)
    L += Lpath;
else
    film-&gt;<a href="../Sampling_and_Reconstruction/Film_and_the_Imaging_Pipeline.html#Film::AddSplat" class="code">AddSplat</a>(pFilmNew, Lpath);</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#VertexAbstractionLayer"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:bdpt-vertex"></span><span id="VertexAbstractionLayer"></span><h3>16.3.1  Vertex Abstraction Layer</h3><p>



</p>
<p>A general advantage of path-space rendering techniques is their ability to
create paths in a large number of different ways, but this characteristic often leads
to cluttered and hard-to-debug implementations. Establishing connections
between pairs of vertices on the light and camera subpaths is a simple
operation when only surface interactions are involved but quickly becomes
unwieldy if one or both of the vertices may represent a scattering event in
participating media, for example.

</p>
<p>Instead of an inconveniently large number of conditional statements in the
core BDPT code, we&rsquo;ll define the <tt>Vertex</tt> type, which can represent
any kind of path vertex. All of the necessary conditional logic to handle
various cases that occur throughout the BDPT implementation will be
encapsulated in its methods.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTDeclarations-1"></span><div class="fragmentname">&lt;&lt;BDPT Declarations&gt;&gt;+=&nbsp;<a href="#fragment-BDPTDeclarations-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">struct <span class="anchor" id="Vertex"></span>Vertex {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-VertexPublicData-0">Vertex Public Data</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1726" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1726"><i></i></a><div id="fragbit-1726" class="collapse"><div class="fragmentcode">       VertexType type;
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta;
       union
       {
           EndpointInteraction ei;
           <a href="../Volume_Scattering/Media.html#MediumInteraction" class="code">MediumInteraction</a> mi;
           <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> si;
       };
       bool delta = false;
       Float pdfFwd = 0, pdfRev = 0;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-VertexPublicMethods-0">Vertex Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1727" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1727"><i></i></a><div id="fragbit-1727" class="collapse"><div class="fragmentcode">       Vertex() : <a href="#Vertex::ei" class="code">ei</a>() {}
       Vertex(<a href="#VertexType::Light" class="code">VertexType</a> <a href="#Vertex::type" class="code">type</a>, const EndpointInteraction &amp;<a href="#Vertex::ei" class="code">ei</a>,
              const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;<a href="#Vertex::beta" class="code">beta</a>)
           : <a href="#Vertex::type" class="code">type</a>(<a href="#Vertex::type" class="code">type</a>), <a href="#Vertex::beta" class="code">beta</a>(<a href="#Vertex::beta" class="code">beta</a>), <a href="#Vertex::ei" class="code">ei</a>(<a href="#Vertex::ei" class="code">ei</a>) { }
       Vertex(const <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;<a href="#Vertex::si" class="code">si</a>, const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;<a href="#Vertex::beta" class="code">beta</a>)
           : <a href="#Vertex::type" class="code">type</a>(<a href="#VertexType::Light" class="code">VertexType</a>::Surface), <a href="#Vertex::beta" class="code">beta</a>(<a href="#Vertex::beta" class="code">beta</a>), <a href="#Vertex::si" class="code">si</a>(<a href="#Vertex::si" class="code">si</a>) { }
       static inline Vertex CreateCamera(const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> *camera, const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray,
               const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;<a href="#Vertex::beta" class="code">beta</a>);
       static inline Vertex CreateCamera(const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> *camera,
               const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;it, const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;<a href="#Vertex::beta" class="code">beta</a>);
       static inline Vertex CreateLight(const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *<a href="#EndpointInteraction::light" class="code">light</a>, const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray,
               const <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> &amp;nLight, const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;Le, Float pdf);
       static inline Vertex CreateLight(const EndpointInteraction &amp;<a href="#Vertex::ei" class="code">ei</a>,
               const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;<a href="#Vertex::beta" class="code">beta</a>, Float pdf);
       static inline  Vertex CreateMedium(const <a href="../Volume_Scattering/Media.html#MediumInteraction" class="code">MediumInteraction</a> &amp;<a href="#Vertex::mi" class="code">mi</a>,
               const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;<a href="#Vertex::beta" class="code">beta</a>, Float pdf, const Vertex &amp;prev);
       static inline Vertex CreateSurface(const <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;<a href="#Vertex::si" class="code">si</a>,
               const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;<a href="#Vertex::beta" class="code">beta</a>, Float pdf, const Vertex &amp;prev);
       Vertex(const <a href="../Volume_Scattering/Media.html#MediumInteraction" class="code">MediumInteraction</a> &amp;<a href="#Vertex::mi" class="code">mi</a>, const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;<a href="#Vertex::beta" class="code">beta</a>)
           : <a href="#Vertex::type" class="code">type</a>(<a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>), <a href="#Vertex::beta" class="code">beta</a>(<a href="#Vertex::beta" class="code">beta</a>), <a href="#Vertex::mi" class="code">mi</a>(<a href="#Vertex::mi" class="code">mi</a>) { }
       const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;<a href="#Vertex::GetInteraction" class="code">GetInteraction</a>() const {
           switch (<a href="#Vertex::type" class="code">type</a>) {
               case <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>:  return <a href="#Vertex::mi" class="code">mi</a>;
               case <a href="#VertexType::Light" class="code">VertexType</a>::Surface: return <a href="#Vertex::si" class="code">si</a>;
               default:                  return <a href="#Vertex::ei" class="code">ei</a>;
           }
       }
       const <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> &amp;<a href="#Vertex::p" class="code">p</a>() const { return <a href="#Vertex::GetInteraction" class="code">GetInteraction</a>().<a href="#Vertex::p" class="code">p</a>; }
       Float time() const { return <a href="#Vertex::GetInteraction" class="code">GetInteraction</a>().time; }
       const <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> &amp;<a href="#Vertex::ng" class="code">ng</a>() const { return <a href="#Vertex::GetInteraction" class="code">GetInteraction</a>().n; }
       const <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> &amp;ns() const {
           if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::Surface)
               return <a href="#Vertex::si" class="code">si</a>.shading.n;
           else
               return <a href="#Vertex::GetInteraction" class="code">GetInteraction</a>().n;
       }
       bool <a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>() const { return <a href="#Vertex::ng" class="code">ng</a>() != <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(); }
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(const Vertex &amp;next) const {
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(next.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
           switch (<a href="#Vertex::type" class="code">type</a>) {
               case <a href="#VertexType::Light" class="code">VertexType</a>::Surface: return <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(<a href="#Vertex::si" class="code">si</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, wi);
               case <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>:  return <a href="#Vertex::mi" class="code">mi</a>.<a href="../Volume_Scattering/Media.html#MediumInteraction::phase" class="code">phase</a>-&gt;<a href="#Vertex::p" class="code">p</a>(<a href="#Vertex::mi" class="code">mi</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, wi);
           }
       }
       bool IsConnectible() const {
           switch (<a href="#Vertex::type" class="code">type</a>) {
               case <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>:  return true;
               case <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>:   return 
                   (<a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a>-&gt;<a href="../Light_Sources/Light_Interface.html#Light::flags" class="code">flags</a> &amp; (int)<a href="../Light_Sources/Light_Interface.html#LightFlags" class="code">LightFlags</a>::DeltaDirection) == 0;
               case <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>:  return true;
               case <a href="#VertexType::Light" class="code">VertexType</a>::Surface: return <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(
                   BxDFType(<a href="../Reflection_Models/Basic_Interface.html#BSDF_DIFFUSE" class="code">BSDF_DIFFUSE</a> | <a href="../Reflection_Models/Basic_Interface.html#BSDF_GLOSSY" class="code">BSDF_GLOSSY</a> |
                            <a href="../Reflection_Models/Basic_Interface.html#BSDF_REFLECTION" class="code">BSDF_REFLECTION</a> | <a href="../Reflection_Models/Basic_Interface.html#BSDF_TRANSMISSION" class="code">BSDF_TRANSMISSION</a>)) &gt; 0;
           }
       }
       bool <a href="#Vertex::IsLight" class="code">IsLight</a>() const {
           return <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> ||
               (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::Surface &amp;&amp; <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>());
       }
       bool <a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>() const {
           return <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> &amp;&amp; <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a> &amp;&amp;
                  ::<a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>(<a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a>-&gt;<a href="../Light_Sources/Light_Interface.html#Light::flags" class="code">flags</a>);
       }
       bool <a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>() const {
           return <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> &amp;&amp;
                  (!<a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a> || <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a>-&gt;<a href="../Light_Sources/Light_Interface.html#Light::flags" class="code">flags</a> &amp; (int)<a href="../Light_Sources/Light_Interface.html#LightFlags" class="code">LightFlags</a>::Infinite);
       }
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Le(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, const Vertex &amp;<a href="#Vertex::p" class="code">v</a>) const {
           if (!<a href="#Vertex::IsLight" class="code">IsLight</a>()) return <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>(0.<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>);
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(<a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
           if (<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnemittedradianceforinfinitelightsources-0">Return emitted radiance for infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1728" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1728"><i></i></a><div id="fragbit-1728" class="collapse"><div class="fragmentcode">                  <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(0.f);
                  for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
                      <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a> += light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(<a href="#Vertex::p" class="code">p</a>(), -w));
                  return <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>;</div></div>
           } else {
               const <a href="../Light_Sources/Area_Lights.html#AreaLight" class="code">AreaLight</a> *<a href="#EndpointInteraction::light" class="code">light</a> = <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>();
               return <a href="#EndpointInteraction::light" class="code">light</a>-&gt;<a href="../Light_Sources/Area_Lights.html#AreaLight::L" class="code">L</a>(<a href="#Vertex::si" class="code">si</a>, w);
           }
       }
       friend std::ostream&amp; operator&lt;&lt;(std::ostream&amp; os, const Vertex &amp;<a href="#Vertex::p" class="code">v</a>) {
           os &lt;&lt; "Vertex[" &lt;&lt; std::endl
              &lt;&lt; "  <a href="#Vertex::type" class="code">type</a> = ";
           switch (<a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::type" class="code">type</a>) {
               case <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>: os &lt;&lt; "camera"; break;
               case <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>: os &lt;&lt; "<a href="#EndpointInteraction::light" class="code">light</a>"; break;
               case <a href="#VertexType::Light" class="code">VertexType</a>::Surface: os &lt;&lt; "surface"; break;
               case <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a> : os &lt;&lt; "medium"; break;
           }
           os &lt;&lt; "," &lt;&lt; std::endl
              &lt;&lt; "  connectible = " &lt;&lt; <a href="#Vertex::p" class="code">v</a>.IsConnectible() &lt;&lt; "," &lt;&lt; std::endl
              &lt;&lt; "  <a href="#Vertex::p" class="code">p</a> = " &lt;&lt; <a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::p" class="code">p</a>() &lt;&lt; "," &lt;&lt; std::endl
              &lt;&lt; "  n = " &lt;&lt; <a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::ng" class="code">ng</a>() &lt;&lt; "," &lt;&lt; std::endl
              &lt;&lt; "  pdfFwd = " &lt;&lt; <a href="#Vertex::p" class="code">v</a>.pdfFwd &lt;&lt; "," &lt;&lt; std::endl
              &lt;&lt; "  pdfRev = " &lt;&lt; <a href="#Vertex::p" class="code">v</a>.pdfRev &lt;&lt; "," &lt;&lt; std::endl
              &lt;&lt; "  <a href="#Vertex::beta" class="code">beta</a> = " &lt;&lt; <a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::beta" class="code">beta</a> &lt;&lt; std::endl
              &lt;&lt; "]" &lt;&lt; std::endl;
           return os;
       };
       Float ConvertDensity(Float pdf, const Vertex &amp;next) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnsolidangledensityifmononextisaninfinitearealight-0">Return solid angle density if <tt>next</tt> is an infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1729" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1729"><i></i></a><div id="fragbit-1729" class="collapse"><div class="fragmentcode">              if (next.<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>())
                  return pdf;</div></div>
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = next.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>();
           Float invDist2 = 1 / w.<a href="../Geometry_and_Transformations/Vectors.html#Vector3::LengthSquared" class="code">LengthSquared</a>();
           if (next.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
               pdf *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(next.<a href="#Vertex::ng" class="code">ng</a>(), w * std::sqrt(invDist2));
           return pdf * invDist2;
       }
       Float Pdf(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, const Vertex *prev,
                 const Vertex &amp;next) const {
           if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>)
               return <a href="#Vertex::PdfLight" class="code">PdfLight</a>(scene, next);
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Computedirectionstoprecedingandnextvertex-0">Compute directions to preceding and next vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1730" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1730"><i></i></a><div id="fragbit-1730" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wp, wn = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(next.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
              if (prev)
                  wp = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(prev-&gt;<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
              </div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Computedirectionaldensitydependingonthevertextype-0">Compute directional density depending on the vertex type</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1731" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1731"><i></i></a><div id="fragbit-1731" class="collapse"><div class="fragmentcode">              Float pdf, unused;
              if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::<a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>)
                  <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::camera" class="code">camera</a>-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Pdf_We" class="code">Pdf_We</a>(<a href="#Vertex::ei" class="code">ei</a>.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wn), &amp;unused, &amp;pdf);
              else if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::Surface)
                  pdf = <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Pdf" class="code">Pdf</a>(wp, wn);
              else if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>)
                  pdf = <a href="#Vertex::mi" class="code">mi</a>.<a href="../Volume_Scattering/Media.html#MediumInteraction::phase" class="code">phase</a>-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>(wp, wn);
              </div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnprobabilityperunitareaatvertexmononext-0">Return probability per unit area at vertex <tt>next</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1732" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1732"><i></i></a><div id="fragbit-1732" class="collapse"><div class="fragmentcode">              return <a href="#Vertex::ConvertDensity" class="code">ConvertDensity</a>(pdf, next);</div></div>
       }
       Float <a href="#Vertex::PdfLight" class="code">PdfLight</a>(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, const Vertex &amp;<a href="#Vertex::p" class="code">v</a>) const {
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>();
           Float invDist2 = 1 / w.<a href="../Geometry_and_Transformations/Vectors.html#Vector3::LengthSquared" class="code">LengthSquared</a>();
           w *= std::sqrt(invDist2);
           Float pdf;
           if (<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Computeplanarsamplingdensityforinfinitelightsources-0">Compute planar sampling density for infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1733" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1733"><i></i></a><div id="fragbit-1733" class="collapse"><div class="fragmentcode">                  <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> worldCenter;
                  Float worldRadius;
                  scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::WorldBound" class="code">WorldBound</a>().<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::BoundingSphere" class="code">BoundingSphere</a>(&amp;worldCenter, &amp;worldRadius);
                  pdf = 1 / (Pi * worldRadius * worldRadius);</div></div>
           } else {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Getpointermonolighttothelightsourceatthevertex-0">Get pointer <tt>light</tt> to the light source at the vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1734" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1734"><i></i></a><div id="fragbit-1734" class="collapse"><div class="fragmentcode">                  const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *<a href="#EndpointInteraction::light" class="code">light</a> = <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> ?
                                       <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a> : <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>();
                  </div></div>
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Computesamplingdensityfornon-infinitelightsources-0">Compute sampling density for non-infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1735" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1735"><i></i></a><div id="fragbit-1735" class="collapse"><div class="fragmentcode">                  Float pdfPos, pdfDir;
                  light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Pdf_Le" class="code">Pdf_Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(p(), w, <a href="#Vertex::time" class="code">time</a>()), <a href="#Vertex::ng" class="code">ng</a>(), &amp;pdfPos, &amp;pdfDir);
                  pdf = pdfDir * invDist2;</div></div>
           }
           if (<a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
               pdf *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(<a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::ng" class="code">ng</a>(), w);
           return pdf;
       }
       Float PdfLightOrigin(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, const Vertex &amp;<a href="#Vertex::p" class="code">v</a>,
                            const Distribution1D &amp;lightDistr) const {
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(<a href="#Vertex::p" class="code">v</a>.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
           if (<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnsolidangledensityforinfinitelightsources-0">Return solid angle density for infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1736" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1736"><i></i></a><div id="fragbit-1736" class="collapse"><div class="fragmentcode">                  return <a href="#InfiniteLightDensity" class="code">InfiniteLightDensity</a>(scene, lightDistr, w);</div></div>
           } else {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnsolidangledensityfornon-infinitelightsources-0">Return solid angle density for non-infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1737" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1737"><i></i></a><div id="fragbit-1737" class="collapse"><div class="fragmentcode">                  Float pdfPos, pdfDir, pdfChoice = 0;
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Getpointermonolighttothelightsourceatthevertex-0">Get pointer <tt>light</tt> to the light source at the vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1738" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1738"><i></i></a><div id="fragbit-1738" class="collapse"><div class="fragmentcode">                     const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *<a href="#EndpointInteraction::light" class="code">light</a> = <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> ?
                                          <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a> : <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>();
                     </div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputethediscreteprobabilityofsamplingmonolightmonopdfChoice-0">Compute the discrete probability of sampling <tt>light</tt>, <tt>pdfChoice</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1739" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1739"><i></i></a><div id="fragbit-1739" class="collapse"><div class="fragmentcode">                     for (size_t i = 0; i &lt; scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>.size(); ++i) {
                         if (scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[i].get() == light) {
                             pdfChoice = lightDistr.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::DiscretePDF" class="code">DiscretePDF</a>(i);
                             break;
                         }
                     }
                     </div></div>
                  light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Pdf_Le" class="code">Pdf_Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(p(), w, <a href="#Vertex::time" class="code">time</a>()), <a href="#Vertex::ng" class="code">ng</a>(), &amp;pdfPos, &amp;pdfDir);
                  return pdfPos * pdfChoice;</div></div>
           }
       }</div></div>
};</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicData-0"></span><div class="fragmentname">&lt;&lt;Vertex Public Data&gt;&gt;=&nbsp;<a href="#fragment-VertexPublicData-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">VertexType <span class="anchor" id="Vertex::type"></span>type;</div><p>


</p>
<p>Altogether, four different types of path vertices are supported in
<tt>pbrt</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTHelperDefinitions-0"></span><div class="fragmentname">&lt;&lt;BDPT Helper Definitions&gt;&gt;=&nbsp;<a href="#fragment-BDPTHelperDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">enum class <span class="anchor" id="VertexType"></span>VertexType { <span class="anchor" id="VertexType::Camera"></span><a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>, <span class="anchor" id="VertexType::Light"></span><a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>, <span class="anchor" id="VertexType::Surface"></span>Surface, <span class="anchor" id="VertexType::Medium"></span><a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a> };</div><p>


</p>
<p>

</p>
<p>The <tt>beta</tt> member variable is analogous to the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg>
variable in the volumetric path tracer
(Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/Volumetric_Light_Transport.html#sec:volumetric-path-tracing">15.3.1</a>) or the weight carried by particles
in the <a href="../Light_Transport_III_Bidirectional_Methods/Stochastic_Progressive_Photon_Mapping.html#SPPMIntegrator"><tt>SPPMIntegrator</tt></a>: it contains the product of the
BSDF or phase function values, transmittances, and cosine terms for the
vertices in the path generated so far, divided by their respective sampling
PDFs.  For the light subpath, they also include the emitted radiance divided by
the density of the emission position and direction. For the camera subpath,
radiance is replaced by importance.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicData-1"></span><div class="fragmentname">&lt;&lt;Vertex Public Data&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicData-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicData-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <span class="anchor" id="Vertex::beta"></span>beta;</div><p>


</p>
<p>Instances of various types of <a href="../Geometry_and_Transformations/Interactions.html#Interaction"><tt>Interaction</tt></a>s represent type-specific
data about the vertex. This information is arranged as a space-efficient
C++ union since only one of the entries is used at a time.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicData-2"></span><div class="fragmentname">&lt;&lt;Vertex Public Data&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicData-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicData-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">union
{
    EndpointInteraction <span class="anchor" id="Vertex::ei"></span>ei;
    <a href="../Volume_Scattering/Media.html#MediumInteraction" class="code">MediumInteraction</a> <span class="anchor" id="Vertex::mi"></span>mi;
    <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> <span class="anchor" id="Vertex::si"></span>si;
};</div><p>


</p>
<p><a href="#EndpointInteraction"><tt>EndpointInteraction</tt></a> is a new interaction implementation that is used only by
BDPT.  It records the position of a path endpoint&mdash;i.e., a position on a
light source or the lens of the camera&mdash;and stores a pointer to the camera
or light in question.

</p>
<p></p>
<span class="anchor" id="fragment-EndpointInteractionDeclarations-0"></span><div class="fragmentname">&lt;&lt;EndpointInteraction Declarations&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="EndpointInteraction"></span>EndpointInteraction : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> {
    union {
        const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> *<span class="anchor" id="EndpointInteraction::camera"></span>camera;
        const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *<span class="anchor" id="EndpointInteraction::light"></span>light;
    };
    &lt;&lt;<span class="fragmentname"><a href="#fragment-EndpointInteractionPublicMethods-0">EndpointInteraction Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1740" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1740"><i></i></a><div id="fragbit-1740" class="collapse"><div class="fragmentcode">       EndpointInteraction() : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(), light(nullptr) { }
       EndpointInteraction(const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;it, const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> *camera)
            : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(it), camera(camera) { }
       EndpointInteraction(const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> *camera, const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray)
           : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(ray.o, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>), camera(camera) { }
       EndpointInteraction(const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *light, const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;r, const <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> &amp;nl)
           : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(r.o, r.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, r.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>), light(light) { <a href="../Geometry_and_Transformations/Interactions.html#Interaction::n" class="code">n</a> = nl; }
       EndpointInteraction(const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;it, const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *light)
            : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(it), light(light) { }
       EndpointInteraction(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray)
           : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(ray(1), ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>), light(nullptr) {
           <a href="../Geometry_and_Transformations/Interactions.html#Interaction::n" class="code">n</a> = <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(-ray.d);
       }</div></div>
};</div><p>


</p>
<p>There are multiple constructors that initialize the
<tt>EndpointInteraction</tt> contents using a pointer and either an existing
<tt>Interaction</tt> or a sampled ray.  For brevity, we only show the
constructors for light endpoints.

</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-EndpointInteractionPublicMethods-0"></span><div class="fragmentname">&lt;&lt;EndpointInteraction Public Methods&gt;&gt;=&nbsp;<a href="#fragment-EndpointInteractionPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><span class="anchor" id="EndpointInteraction::EndpointInteraction"></span>EndpointInteraction(const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *light, const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;r, const <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> &amp;nl)
    : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(r.o, r.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, r.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>), light(light) { <a href="../Geometry_and_Transformations/Interactions.html#Interaction::n" class="code">n</a> = nl; }</div><p>

</p>
<span class="anchor" id="fragment-EndpointInteractionPublicMethods-1"></span><div class="fragmentname">&lt;&lt;EndpointInteraction Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-EndpointInteractionPublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">EndpointInteraction(const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;it, const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *light)
     : <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(it), light(light) { }</div><p>


</p>
<p>

</p>
<p>

</p>
<p>A range of static helper functions create <a href="#Vertex"><tt>Vertex</tt></a> instances for the various types of
path vertices.  We&rsquo;ll only include their declarations here, as their
implementations are all
straightforward.  We could instead have provided a range of overloaded
constructors that took various <a href="../Geometry_and_Transformations/Interactions.html#Interaction"><tt>Interaction</tt></a> types as parameters, but
we think that having the name of the type of vertex being created explicit
in a function call makes the following code easier to read.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-0"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;=&nbsp;<a href="#fragment-VertexPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">static inline Vertex <span class="anchor" id="Vertex::CreateCamera"></span>CreateCamera(const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> *camera, const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray,
        const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;beta);
static inline Vertex CreateCamera(const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> *camera,
        const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;it, const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;beta);
static inline Vertex <span class="anchor" id="Vertex::CreateLight"></span>CreateLight(const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *light, const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray,
        const <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> &amp;nLight, const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;Le, Float pdf);
static inline Vertex CreateLight(const EndpointInteraction &amp;ei,
        const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;beta, Float pdf);
static inline  Vertex <span class="anchor" id="Vertex::CreateMedium"></span>CreateMedium(const <a href="../Volume_Scattering/Media.html#MediumInteraction" class="code">MediumInteraction</a> &amp;mi,
        const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;beta, Float pdf, const Vertex &amp;prev);
static inline Vertex <span class="anchor" id="Vertex::CreateSurface"></span>CreateSurface(const <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;si,
        const <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> &amp;beta, Float pdf, const Vertex &amp;prev);</div><p>


</p>
<p>

</p>
<p>

</p>
<p>It is often necessary to access the core fields in <tt>Interaction</tt> that
are common to all types of vertices; the <a href="#Vertex::GetInteraction"><tt>Vertex::GetInteraction()</tt></a>
method extracts this shared part. Since <a href="#Vertex::mi"><tt>Vertex::mi</tt></a>,
<a href="#Vertex::si"><tt>Vertex::si</tt></a>, and <a href="#Vertex::ei"><tt>Vertex::ei</tt></a> all derive from <a href="../Geometry_and_Transformations/Interactions.html#Interaction"><tt>Interaction</tt></a>
and are part of the same union and thus their base <tt>Interaction</tt>s are
at the same location in memory, the conditional logic below should be
removed by the compiler.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-1"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;<span class="anchor" id="Vertex::GetInteraction"></span>GetInteraction() const {
    switch (<a href="#Vertex::type" class="code">type</a>) {
        case <a href="#VertexType::Surface" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>:  return <a href="#Vertex::mi" class="code">mi</a>;
        case <a href="#VertexType::Surface" class="code">VertexType</a>::Surface: return <a href="#Vertex::si" class="code">si</a>;
        default:                  return <a href="#Vertex::ei" class="code">ei</a>;
    }
}</div><p>


</p>
<p>The convenience function <tt>Vertex::p()</tt> returns the vertex
position. We omit definitions of
<tt>Vertex::time()</tt><span class="anchor" id="Vertex::time"></span>,
<tt>Vertex::ng()</tt><span class="anchor" id="Vertex::ng"></span>, and
<tt>Vertex::ns()</tt><span class="anchor" id="Vertex::ns"></span>,
which are defined analogously, and return the time, geometric normal, and
shading normal, respectively, of the vertex.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-2"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">const <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> &amp;<span class="anchor" id="Vertex::p"></span><a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>() const { return <a href="#Vertex::GetInteraction" class="code">GetInteraction</a>().<a href="../Geometry_and_Transformations/Interactions.html#Interaction::p" class="code">p</a>; }</div><p>


</p>
<p>

</p>
<p>

</p>
<p>The <tt>delta</tt> attribute is only used by surface interactions and records
whether a Dirac delta function was sampled (e.g., when light is scattered by
a perfectly specular material).

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicData-3"></span><div class="fragmentname">&lt;&lt;Vertex Public Data&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicData-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicData-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Vertex::delta"></span>delta = false;</div><p>


</p>
<p>A simple way to find out whether a vertex (including endpoints) is located on a
surface is to check whether <a href="#Vertex::ng"><tt>Vertex::ng()</tt></a> returns a nonzero
result.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-3"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Vertex::IsOnSurface"></span>IsOnSurface() const { return <a href="#Vertex::ng" class="code">ng</a>() != <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(); }</div><p>


</p>
<p><a href="#Vertex::f"><tt>Vertex::f()</tt></a> evaluates the portion of the measurement equation,
(<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#eq:meas-eqn">16.1</a>), associated with a vertex. This method only needs to
handle surface and medium vertices since the BDPT implementation only
invokes it in those cases. Note that the next vertex in the path is the only one
passed to this method: though the direction to the predecessor vertex is
needed to evaluate the BRDF or phase function, this information is already
available in <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo"><tt>Interaction::wo</tt></a> from when the <a href="#Vertex"><tt>Vertex</tt></a> was first
created.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-4"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-3"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-5"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <span class="anchor" id="Vertex::f"></span><a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(const Vertex &amp;next) const {
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(next.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>() - <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>());
    switch (<a href="#Vertex::type" class="code">type</a>) {
        case <a href="#VertexType::Medium" class="code">VertexType</a>::Surface: return <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::f" class="code">f</a>(<a href="#Vertex::si" class="code">si</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, wi);
        case <a href="#VertexType::Medium" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>:  return <a href="#Vertex::mi" class="code">mi</a>.<a href="../Volume_Scattering/Media.html#MediumInteraction::phase" class="code">phase</a>-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>(<a href="#Vertex::mi" class="code">mi</a>.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, wi);
    }
}</div><p>


</p>
<p>

</p>
<p>The <a href="#Vertex::IsConnectible"><tt>Vertex::IsConnectible()</tt></a> method returns a Boolean value that
indicates whether a connection
strategy involving the current vertex can in principle succeed.  If, for
example, the vertex is a surface interaction whose BSDF only consists of
Dirac delta components, then we can never successfully connect it to a
subpath vertex in the other path: there&rsquo;s zero probability of choosing a
direction where the delta distribution is nonzero. The implementation assumes
that medium and camera vertices are always connectible (the latter
assumption would have to be modified if support for orthographic cameras is added).

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-5"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-4"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-6"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Vertex::IsConnectible"></span>IsConnectible() const {
    switch (<a href="#Vertex::type" class="code">type</a>) {
        case <a href="#VertexType::Surface" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>:  return true;
        case <a href="#VertexType::Surface" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>:   return 
            (ei.<a href="#EndpointInteraction::light" class="code">light</a>-&gt;<a href="../Light_Sources/Light_Interface.html#Light::flags" class="code">flags</a> &amp; (int)<a href="../Light_Sources/Light_Interface.html#LightFlags" class="code">LightFlags</a>::DeltaDirection) == 0;
        case <a href="#VertexType::Surface" class="code">VertexType</a>::<a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>:  return true;
        case <a href="#VertexType::Surface" class="code">VertexType</a>::Surface: return <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Materials/BSDFs.html#BSDF::NumComponents" class="code">NumComponents</a>(
            BxDFType(<a href="../Reflection_Models/Basic_Interface.html#BSDF_DIFFUSE" class="code">BSDF_DIFFUSE</a> | <a href="../Reflection_Models/Basic_Interface.html#BSDF_GLOSSY" class="code">BSDF_GLOSSY</a> |
                     <a href="../Reflection_Models/Basic_Interface.html#BSDF_REFLECTION" class="code">BSDF_REFLECTION</a> | <a href="../Reflection_Models/Basic_Interface.html#BSDF_TRANSMISSION" class="code">BSDF_TRANSMISSION</a>)) &gt; 0;
    }
}</div><p>


</p>
<p>A few helper methods are useful for working with lights&mdash;these are
necessary to deal with the considerable variety of light sources
supported by <tt>pbrt</tt>.

</p>
<p>For instance, when the <a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive"><tt>Primitive</tt></a> underlying a surface interaction
vertex is itself an area light, the vertex can take on different roles
depending on the BDPT connection strategy: it can be re-interpreted as a
light source and used as a path endpoint, or it can serve as a normal
scattering event to generate paths of greater length. The
<a href="#Vertex::IsLight"><tt>Vertex::IsLight()</tt></a> method therefore provides a comprehensive test for
whether a vertex can be interpreted as a light source.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-6"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-5"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-7"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Vertex::IsLight"></span>IsLight() const {
    return <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Surface" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> ||
        (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Surface" class="code">VertexType</a>::Surface &amp;&amp; <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>());
}</div><p>


</p>
<p>Light sources that have an emission profile that contains a Dirac delta
distribution must be treated specially in the computation of multiple
importance sampling weights; <a href="#Vertex::IsDeltaLight"><tt>Vertex::IsDeltaLight()</tt></a> checks for this
case.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-7"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-6"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-8"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Vertex::IsDeltaLight"></span><a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>() const {
    return <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> &amp;&amp; ei.<a href="#EndpointInteraction::light" class="code">light</a> &amp;&amp;
           ::<a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>(ei.<a href="#EndpointInteraction::light" class="code">light</a>-&gt;<a href="../Light_Sources/Light_Interface.html#Light::flags" class="code">flags</a>);
}</div><p>


</p>
<p>The <a href="#Vertex::IsInfiniteLight"><tt>Vertex::IsInfiniteLight()</tt></a> method indicates whether a vertex is
associated with an infinite area light. Such vertices can be created by
sampling an emitted ray from an <a href="../Light_Sources/Infinite_Area_Lights.html#InfiniteAreaLight"><tt>InfiniteAreaLight</tt></a> or by tracing a
ray from the camera that escapes into the environment. In the latter case,
the vertex is marked with the type <a href="#VertexType::Light"><tt>VertexType::Light</tt></a>, but
<tt>ei.light</tt> stores <tt>nullptr</tt> since no specific light source was
intersected.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-8"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-7"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-9"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Vertex::IsInfiniteLight"></span>IsInfiniteLight() const {
    return <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> &amp;&amp;
           (!ei.<a href="#EndpointInteraction::light" class="code">light</a> || ei.<a href="#EndpointInteraction::light" class="code">light</a>-&gt;<a href="../Light_Sources/Light_Interface.html#Light::flags" class="code">flags</a> &amp; (int)<a href="../Light_Sources/Light_Interface.html#LightFlags" class="code">LightFlags</a>::Infinite);
}</div><p>


</p>
<p>Finally, <tt>Le()</tt> can be used to find emitted radiance from
an intersected light source toward another vertex.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-9"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-8"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-10"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <span class="anchor" id="Vertex::Le"></span>Le(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, const Vertex &amp;<a href="#Vertex::p" class="code">v</a>) const {
    if (!<a href="#Vertex::IsLight" class="code">IsLight</a>()) return <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>(0.f);
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(<a href="#Vertex::p" class="code">v</a>.p() - p());
    if (<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnemittedradianceforinfinitelightsources-0">Return emitted radiance for infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1741" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1741"><i></i></a><div id="fragbit-1741" class="collapse"><div class="fragmentcode">           <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(0.f);
           for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
               <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a> += light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(<a href="#Vertex::p" class="code">p</a>(), -w));
           return <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>;</div></div>
    } else {
        const <a href="../Light_Sources/Area_Lights.html#AreaLight" class="code">AreaLight</a> *light = <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>();
        return light-&gt;<a href="../Light_Sources/Area_Lights.html#AreaLight::L" class="code">L</a>(<a href="#Vertex::si" class="code">si</a>, w);
    }
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Returnemittedradianceforinfinitelightsources-0"></span><div class="fragmentname">&lt;&lt;Return emitted radiance for infinite light sources&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(0.f);
for (const auto &amp;light : scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>)
    <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a> += light-&gt;<a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(<a href="#Vertex::p" class="code">p</a>(), -w));
return <a href="../Light_Sources/Infinite_Area_Lights.html#Light::Le" class="code">Le</a>;</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x1-ProbabilityDensities"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x1-ProbabilityDensities"></span><h4>Probability Densities</h4><p>


</p>
<p>BDPT&rsquo;s multiple importance sampling code requires detailed information
about the probability density of light-carrying paths with respect to a
range of different path sampling strategies. It is crucial that these
densities are expressed in the same probability measure so that ratios of
their probabilities are meaningful.  The implementation here uses the
<em>area product measure</em> for path probabilities. It expresses the
density of a path as the product of the densities of its individual
vertices, which are in turn given in a simple common (and consistent)
measure: <em>probability per unit area</em>.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="Note that an analogously defined
&ldquo;product solid angle measure&rdquo; would not satisfy the requirement of a common
and consistent measure: solid angle densities are always expressed with respect
to a specific vertex position&mdash;relating the densities
as &ldquo;seen&rdquo; from different vertices would require additional Jacobian factors
to account for the underlying change of variables.">
      <sup>&dagger;</sup>
    </button>
		
This is the same measure as was initially used to derive the surface form
of the LTE in Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/The_Light_Transport_Equation.html#sec:surface-lte">14.4.3</a>.

</p>
<p>Recall from Section&nbsp;<a href="../Color_and_Radiometry/Working_with_Radiometric_Integrals.html#sec:radiometric-integrals">5.5</a> that the Jacobian of
the mapping from solid angles to surface area involves the inverse squared
distance and the cosine of angle between the geometric normal at
<tt>next</tt> and <tt>wn</tt> (assuming <tt>next</tt> is a surface vertex&mdash;if it
is a point in a participating medium, there is no cosine term
(Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:pathspace-generalized">15.1.1</a>)). The
<tt>ConvertDensity()</tt> method returns the product of this Jacobian
(computed from the vertex attributes) and the <tt>pdf</tt> parameter,
which should express a solid angle density at the vertex.
(Infinite area light sources need special handling here; this case is
discussed later, in Section&nbsp;<a href="#sec:bdpt-infinite">16.3.5</a>.)

</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-10"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-9"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-11"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="Vertex::ConvertDensity"></span>ConvertDensity(Float pdf, const Vertex &amp;next) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnsolidangledensityifmononextisaninfinitearealight-0">Return solid angle density if <tt>next</tt> is an infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1742" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1742"><i></i></a><div id="fragbit-1742" class="collapse"><div class="fragmentcode">       if (next.<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>())
           return pdf;</div></div>
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = next.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>();
    Float invDist2 = 1 / w.<a href="../Geometry_and_Transformations/Vectors.html#Vector3::LengthSquared" class="code">LengthSquared</a>();
    if (next.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
        pdf *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(next.<a href="#Vertex::ng" class="code">ng</a>(), w * std::sqrt(invDist2));
    return pdf * invDist2;
}</div><p>


</p>
<p>Each vertex has two densities: the first, <tt>pdfFwd</tt>, stores <em>forward</em> density
of the current vertex, which is the probability per unit area of the
current vertex as generated by the path sampling algorithm.
The second density, <tt>pdfRev</tt>, is the hypothetical probability density of the
vertex if the direction of light transport was <em>reversed</em>&mdash;that is, if
radiance transport was used in place of importance transport for the camera
path and vice versa for the light path.  This reverse density will be
crucial for computing MIS weights in Section&nbsp;<a href="#sec:mis-computation">16.3.4</a>.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicData-4"></span><div class="fragmentname">&lt;&lt;Vertex Public Data&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicData-3"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="Vertex::pdfFwd"></span>pdfFwd = 0, <span class="anchor" id="Vertex::pdfRev"></span>pdfRev = 0;</div><p>


</p>
<p>The <a href="#Vertex::Pdf"><tt>Vertex::Pdf()</tt></a> method returns the probability per unit area of the
sampling technique associated with a given vertex. Given a preceding vertex
<tt>prev</tt>, it evaluates the density for sampling the vertex <tt>next</tt> for rays
leaving the vertex <tt>*this</tt>. The <tt>prev</tt> argument may be
equal to <tt>nullptr</tt> for path endpoints (i.e., cameras or light sources), which
have no predecessor.  Light sources require some extra care and are handled
separately via the <tt>PdfLight()</tt> method that will be discussed shortly.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-11"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-10"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-12"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="Vertex::Pdf"></span>Pdf(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, const Vertex *prev,
          const Vertex &amp;next) const {
    if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>)
        return <a href="#Vertex::PdfLight" class="code">PdfLight</a>(scene, next);
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Computedirectionstoprecedingandnextvertex-0">Compute directions to preceding and next vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1743" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1743"><i></i></a><div id="fragbit-1743" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wp, wn = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(next.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
       if (prev)
           wp = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(prev-&gt;<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
       </div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Computedirectionaldensitydependingonthevertextype-0">Compute directional density depending on the vertex type</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1744" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1744"><i></i></a><div id="fragbit-1744" class="collapse"><div class="fragmentcode">       Float pdf, unused;
       if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::<a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>)
           <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::camera" class="code">camera</a>-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Pdf_We" class="code">Pdf_We</a>(<a href="#Vertex::ei" class="code">ei</a>.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wn), &amp;unused, &amp;pdf);
       else if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::Surface)
           pdf = <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Pdf" class="code">Pdf</a>(wp, wn);
       else if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>)
           pdf = <a href="#Vertex::mi" class="code">mi</a>.<a href="../Volume_Scattering/Media.html#MediumInteraction::phase" class="code">phase</a>-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>(wp, wn);
       </div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnprobabilityperunitareaatvertexmononext-0">Return probability per unit area at vertex <tt>next</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1745" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1745"><i></i></a><div id="fragbit-1745" class="collapse"><div class="fragmentcode">       return <a href="#Vertex::ConvertDensity" class="code">ConvertDensity</a>(pdf, next);</div></div>
}</div><p>


</p>
<p>For all other vertex types, the function first computes normalized directions
to the preceding and next vertex (if present). 

</p>
<p></p>
<span class="anchor" id="fragment-Computedirectionstoprecedingandnextvertex-0"></span><div class="fragmentname">&lt;&lt;Compute directions to preceding and next vertex&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wp, wn = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(next.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
if (prev)
    wp = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(prev-&gt;<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
</div><p>


</p>
<p>Depending on the vertex type, <tt>Pdf()</tt> invokes the appropriate PDF method and
stores the probability per unit solid angle for sampling the direction to
<tt>next</tt> in the variable <tt>pdf</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Computedirectionaldensitydependingonthevertextype-0"></span><div class="fragmentname">&lt;&lt;Compute directional density depending on the vertex type&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pdf, unused;
if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::<a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a>)
    <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::camera" class="code">camera</a>-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Pdf_We" class="code">Pdf_We</a>(<a href="#Vertex::ei" class="code">ei</a>.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wn), &amp;unused, &amp;pdf);
else if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::Surface)
    pdf = <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Pdf" class="code">Pdf</a>(wp, wn);
else if (<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Medium" class="code">VertexType</a>::<a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>)
    pdf = <a href="#Vertex::mi" class="code">mi</a>.<a href="../Volume_Scattering/Media.html#MediumInteraction::phase" class="code">phase</a>-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>(wp, wn);
</div><p>


</p>
<p>Finally, the solid angle density is converted to a probability per unit
area at <tt>next</tt>.
    
</p>
<span class="anchor" id="fragment-Returnprobabilityperunitareaatvertexmononext-0"></span><div class="fragmentname">&lt;&lt;Return probability per unit area at vertex <tt>next</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">return <a href="#Vertex::ConvertDensity" class="code">ConvertDensity</a>(pdf, next);</div><p>


</p>
<p>Light-emitting vertices can be created in two different ways: by using a
sampling routine like <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le"><tt>Light::Sample_Le()</tt></a>, or by intersecting an
emissive surface via ray tracing.  To be able to compare these different
strategies as part of a multiple importance sampling scheme, it is
necessary to know the corresponding probability per unit area for a light
vertex.  This task is handled by the <tt>PdfLight()</tt> method.

</p>
<p>Its definition resembles that of <a href="#Vertex::Pdf"><tt>Vertex::Pdf()</tt></a>: it computes the
direction from the current vertex to the provided vertex and invokes
<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Pdf_Le"><tt>Light::Pdf_Le()</tt></a> to retrieve the solid angle density of the underlying
sampling strategy, which is subsequently converted into a density per unit
area at <tt>v</tt>. In contrast to <a href="#Vertex::Pdf"><tt>Vertex::Pdf()</tt></a>, this method also
treats surface vertices located on area lights as if they were light source
vertices. Once more, there is a special case for infinite area lights,
which we postpone until Section&nbsp;<a href="#sec:bdpt-infinite">16.3.5</a>.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-12"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-11"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-VertexPublicMethods-13"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="Vertex::PdfLight"></span>PdfLight(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, const Vertex &amp;v) const {
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = v.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>();
    Float invDist2 = 1 / w.<a href="../Geometry_and_Transformations/Vectors.html#Vector3::LengthSquared" class="code">LengthSquared</a>();
    w *= std::sqrt(invDist2);
    Float pdf;
    if (<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Computeplanarsamplingdensityforinfinitelightsources-0">Compute planar sampling density for infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1746" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1746"><i></i></a><div id="fragbit-1746" class="collapse"><div class="fragmentcode">           <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> worldCenter;
           Float worldRadius;
           scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::WorldBound" class="code">WorldBound</a>().<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::BoundingSphere" class="code">BoundingSphere</a>(&amp;worldCenter, &amp;worldRadius);
           pdf = 1 / (Pi * worldRadius * worldRadius);</div></div>
    } else {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Getpointermonolighttothelightsourceatthevertex-0">Get pointer <tt>light</tt> to the light source at the vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1747" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1747"><i></i></a><div id="fragbit-1747" class="collapse"><div class="fragmentcode">           const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *<a href="#EndpointInteraction::light" class="code">light</a> = <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> ?
                                <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a> : <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>();
           </div></div>
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Computesamplingdensityfornon-infinitelightsources-0">Compute sampling density for non-infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1748" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1748"><i></i></a><div id="fragbit-1748" class="collapse"><div class="fragmentcode">           Float pdfPos, pdfDir;
           light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Pdf_Le" class="code">Pdf_Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(p(), w, <a href="#Vertex::time" class="code">time</a>()), <a href="#Vertex::ng" class="code">ng</a>(), &amp;pdfPos, &amp;pdfDir);
           pdf = pdfDir * invDist2;</div></div>
    }
    if (v.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
        pdf *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(v.<a href="#Vertex::ng" class="code">ng</a>(), w);
    return pdf;
}</div><p>


</p>
<p>Depending on the vertex type, the pointer to the light source
implementation must be obtained from one of two different locations.

</p>
<p></p>
<span class="anchor" id="fragment-Getpointermonolighttothelightsourceatthevertex-0"></span><div class="fragmentname">&lt;&lt;Get pointer <tt>light</tt> to the light source at the vertex&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *<a href="#EndpointInteraction::light" class="code">light</a> = <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> ?
                     <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a> : <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>();
</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Computesamplingdensityfornon-infinitelightsources-0"></span><div class="fragmentname">&lt;&lt;Compute sampling density for non-infinite light sources&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pdfPos, pdfDir;
light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Pdf_Le" class="code">Pdf_Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(p(), w, <a href="#Vertex::time" class="code">time</a>()), <a href="#Vertex::ng" class="code">ng</a>(), &amp;pdfPos, &amp;pdfDir);
pdf = pdfDir * invDist2;</div><p>


</p>
<p>By symmetry, we would now expect a dual routine <tt>Vertex::PdfCamera()</tt>
that applies to camera endpoints. However, cameras in <tt>pbrt</tt> are never
represented using explicit geometry: thus, they cannot be reached by ray
intersections, which eliminates the need for a dedicated query function.
If desired, a perfectly symmetric implementation could be achieved by
instantiating scene geometry that is tagged with an &ldquo;area camera&rdquo;
analogous to area lights. This increases the set of possible BDPT
connection strategies, though their benefit is negligible in most scenes
due to the low probability of intersecting the camera.

</p>
<p>Note that the <tt>Pdf()</tt> and <tt>PdfLight()</tt> methods use the
directional probability density of the importance strategy implemented at
the current vertex as measured at the location of another given
vertex. However, this is not enough to fully characterize the behavior of
path endpoints, whose sampling routines generate rays from a 4D distribution. An
additional <tt>PdfLightOrigin()</tt> method fills the gap by providing
information about the spatial distribution of samples on the light sources
themselves. For the same reason as before, a dedicated
<tt>PdfCameraOrigin()</tt> method for camera endpoints is not needed.

</p>
<p></p>
<span class="anchor" id="fragment-VertexPublicMethods-13"></span><div class="fragmentname">&lt;&lt;Vertex Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-VertexPublicMethods-12"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="Vertex::PdfLightOrigin"></span>PdfLightOrigin(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, const Vertex &amp;v,
                     const Distribution1D &amp;lightDistr) const {
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="../Geometry_and_Transformations/Vectors.html#Vector3::Normalize" class="code">Normalize</a>(v.<a href="#Vertex::p" class="code">p</a>() - <a href="#Vertex::p" class="code">p</a>());
    if (<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnsolidangledensityforinfinitelightsources-0">Return solid angle density for infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1749" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1749"><i></i></a><div id="fragbit-1749" class="collapse"><div class="fragmentcode">           return <a href="#InfiniteLightDensity" class="code">InfiniteLightDensity</a>(scene, lightDistr, w);</div></div>
    } else {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnsolidangledensityfornon-infinitelightsources-0">Return solid angle density for non-infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1750" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1750"><i></i></a><div id="fragbit-1750" class="collapse"><div class="fragmentcode">           Float pdfPos, pdfDir, pdfChoice = 0;
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Getpointermonolighttothelightsourceatthevertex-0">Get pointer <tt>light</tt> to the light source at the vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1751" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1751"><i></i></a><div id="fragbit-1751" class="collapse"><div class="fragmentcode">              const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *<a href="#EndpointInteraction::light" class="code">light</a> = <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> ?
                                   <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a> : <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>();
              </div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputethediscreteprobabilityofsamplingmonolightmonopdfChoice-0">Compute the discrete probability of sampling <tt>light</tt>, <tt>pdfChoice</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1752" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1752"><i></i></a><div id="fragbit-1752" class="collapse"><div class="fragmentcode">              for (size_t i = 0; i &lt; scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>.size(); ++i) {
                  if (scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[i].get() == light) {
                      pdfChoice = lightDistr.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::DiscretePDF" class="code">DiscretePDF</a>(i);
                      break;
                  }
              }
              </div></div>
           light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Pdf_Le" class="code">Pdf_Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(p(), w, <a href="#Vertex::time" class="code">time</a>()), <a href="#Vertex::ng" class="code">ng</a>(), &amp;pdfPos, &amp;pdfDir);
           return pdfPos * pdfChoice;</div></div>
    }
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Returnsolidangledensityfornon-infinitelightsources-0"></span><div class="fragmentname">&lt;&lt;Return solid angle density for non-infinite light sources&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pdfPos, pdfDir, pdfChoice = 0;
&lt;&lt;<span class="fragmentname"><a href="#fragment-Getpointermonolighttothelightsourceatthevertex-0">Get pointer <tt>light</tt> to the light source at the vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1753" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1753"><i></i></a><div id="fragbit-1753" class="collapse"><div class="fragmentcode">   const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> *<a href="#EndpointInteraction::light" class="code">light</a> = <a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> ?
                        <a href="#Vertex::ei" class="code">ei</a>.<a href="#EndpointInteraction::light" class="code">light</a> : <a href="#Vertex::si" class="code">si</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::primitive" class="code">primitive</a>-&gt;<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive::GetAreaLight" class="code">GetAreaLight</a>();
   </div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputethediscreteprobabilityofsamplingmonolightmonopdfChoice-0">Compute the discrete probability of sampling <tt>light</tt>, <tt>pdfChoice</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1754" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1754"><i></i></a><div id="fragbit-1754" class="collapse"><div class="fragmentcode">   for (size_t i = 0; i &lt; scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>.size(); ++i) {
       if (scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[i].get() == light) {
           pdfChoice = lightDistr.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::DiscretePDF" class="code">DiscretePDF</a>(i);
           break;
       }
   }
   </div></div>
light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Pdf_Le" class="code">Pdf_Le</a>(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a>(p(), w, <a href="#Vertex::time" class="code">time</a>()), <a href="#Vertex::ng" class="code">ng</a>(), &amp;pdfPos, &amp;pdfDir);
return pdfPos * pdfChoice;</div><p>


</p>
<p>To determine the discrete probability of choosing <tt>light</tt> among the
available light sources, we must find the pointer to the light source and
look up the corresponding entry in <tt>lightDistr</tt>. If there are very
many light sources, the linear search here will be inefficient.  In that
case, this computation could be implemented more efficiently by storing
this probability directly in the light source class.

</p>
<p></p>
<span class="anchor" id="fragment-ComputethediscreteprobabilityofsamplingmonolightmonopdfChoice-0"></span><div class="fragmentname">&lt;&lt;Compute the discrete probability of sampling <tt>light</tt>, <tt>pdfChoice</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (size_t i = 0; i &lt; scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>.size(); ++i) {
    if (scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[i].get() == light) {
        pdfChoice = lightDistr.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::DiscretePDF" class="code">DiscretePDF</a>(i);
        break;
    }
}
</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#GeneratingtheCameraandLightSubpaths"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:bdpt-camera-light-subpaths"></span><span id="GeneratingtheCameraandLightSubpaths"></span><h3>16.3.2  Generating the Camera and Light Subpaths</h3><p>



</p>
<p>

</p>
<p>A symmetric pair of functions, <a href="#GenerateCameraSubpath"><tt>GenerateCameraSubpath()</tt></a> and
<a href="#GenerateLightSubpath"><tt>GenerateLightSubpath()</tt></a>, generates the two corresponding types of
subpaths.  Both do some initial work to get the path started and then call
out to a second function, <a href="#RandomWalk"><tt>RandomWalk()</tt></a>, which takes care of sampling
the following vertices and initializing the <tt>path</tt> array. Both of
these functions return the number of vertices in the subpath.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTUtilityFunctions-1"></span><div class="fragmentname">&lt;&lt;BDPT Utility Functions&gt;&gt;+=&nbsp;<a href="The_Path-Space_Measurement_Equation.html#fragment-BDPTUtilityFunctions-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-BDPTUtilityFunctions-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">int <span class="anchor" id="GenerateCameraSubpath"></span>GenerateCameraSubpath(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> &amp;sampler,
        <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena, int maxDepth, const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> &amp;camera,
        const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> &amp;pFilm, Vertex *path) {
    if (maxDepth == 0)
        return 0;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleinitialrayforcamerasubpath-0">Sample initial ray for camera subpath</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1755" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1755"><i></i></a><div id="fragbit-1755" class="collapse"><div class="fragmentcode">       CameraSample cameraSample;
       cameraSample.<a href="../Camera_Models/Camera_Model.html#CameraSample::pFilm" class="code">pFilm</a> = <a href="../Camera_Models/Camera_Model.html#CameraSample::pFilm" class="code">pFilm</a>;
       cameraSample.<a href="../Camera_Models/Camera_Model.html#CameraSample::time" class="code">time</a> = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
       cameraSample.<a href="../Camera_Models/Camera_Model.html#CameraSample::pLens" class="code">pLens</a> = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
       RayDifferential ray;
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = camera.<a href="../Camera_Models/Camera_Model.html#Camera::GenerateRayDifferential" class="code">GenerateRayDifferential</a>(cameraSample, &amp;ray);
       ray.<a href="../Geometry_and_Transformations/Rays.html#RayDifferential::ScaleDifferentials" class="code">ScaleDifferentials</a>(1 / std::sqrt(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::samplesPerPixel" class="code">samplesPerPixel</a>));</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Generatefirstvertexoncamerasubpathandstartrandomwalk-0">Generate first vertex on camera subpath and start random walk</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1756" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1756"><i></i></a><div id="fragbit-1756" class="collapse"><div class="fragmentcode">       Float pdfPos, pdfDir;
       path[0] = <a href="#Vertex::CreateCamera" class="code">Vertex</a>::CreateCamera(&amp;camera, ray, beta);
       camera.<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Pdf_We" class="code">Pdf_We</a>(ray, &amp;pdfPos, &amp;pdfDir);
       return <a href="#RandomWalk" class="code">RandomWalk</a>(scene, ray, sampler, arena, beta, pdfDir,
                         maxDepth - 1, <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Radiance" class="code">TransportMode</a>::Radiance,
                         path + 1) + 1;</div></div>
}</div><p>


</p>
<p>A camera path starts with a camera ray from
<a href="../Camera_Models/Camera_Model.html#Camera::GenerateRayDifferential"><tt>Camera::GenerateRayDifferential()</tt></a>.  As in the <a href="../Introduction/pbrt_System_Overview.html#SamplerIntegrator"><tt>SamplerIntegrator</tt></a>,
the ray&rsquo;s differentials are scaled so that they reflect the actual pixel
sampling density.

</p>
<p></p>
<span class="anchor" id="fragment-Sampleinitialrayforcamerasubpath-0"></span><div class="fragmentname">&lt;&lt;Sample initial ray for camera subpath&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">CameraSample cameraSample;
cameraSample.<a href="../Camera_Models/Camera_Model.html#CameraSample::pFilm" class="code">pFilm</a> = <a href="../Camera_Models/Camera_Model.html#CameraSample::pFilm" class="code">pFilm</a>;
cameraSample.<a href="../Camera_Models/Camera_Model.html#CameraSample::time" class="code">time</a> = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
cameraSample.<a href="../Camera_Models/Camera_Model.html#CameraSample::pLens" class="code">pLens</a> = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
RayDifferential ray;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = camera.<a href="../Camera_Models/Camera_Model.html#Camera::GenerateRayDifferential" class="code">GenerateRayDifferential</a>(cameraSample, &amp;ray);
ray.<a href="../Geometry_and_Transformations/Rays.html#RayDifferential::ScaleDifferentials" class="code">ScaleDifferentials</a>(1 / std::sqrt(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::samplesPerPixel" class="code">samplesPerPixel</a>));</div><p>


</p>
<p>The vertex at position <tt>path[0]</tt> is initialized with a special
endpoint vertex on the camera
lens (for cameras with finite apertures) or pinhole.
The <tt>RandomWalk()</tt> function then
takes care of generating the rest of the vertices.  <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode"><tt>TransportMode</tt></a>
reflects the quantity that is carried back to the origin of the
path&mdash;hence <tt>TransportMode::Radiance</tt> is used here. Since the first
element of <tt>path</tt> was already used for the endpoint vertex,
<a href="#RandomWalk"><tt>RandomWalk()</tt></a> is invoked such that it writes sampled vertices starting
at position <tt>path[1]</tt> with a maximum depth of <tt>maxDepth - 1</tt>.
The function returns the total number of sampled vertices.

</p>
<p></p>
<span class="anchor" id="fragment-Generatefirstvertexoncamerasubpathandstartrandomwalk-0"></span><div class="fragmentname">&lt;&lt;Generate first vertex on camera subpath and start random walk&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pdfPos, pdfDir;
path[0] = <a href="#Vertex::CreateCamera" class="code">Vertex</a>::CreateCamera(&amp;camera, ray, beta);
camera.<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Pdf_We" class="code">Pdf_We</a>(ray, &amp;pdfPos, &amp;pdfDir);
return <a href="#RandomWalk" class="code">RandomWalk</a>(scene, ray, sampler, arena, beta, pdfDir,
                  maxDepth - 1, <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Radiance" class="code">TransportMode</a>::Radiance,
                  path + 1) + 1;</div><p>


</p>
<p>

</p>
<p>The function <tt>GenerateLightSubpath()</tt> works in a similar fashion, with
some minor differences corresponding to the fact that the path starts from
a light source.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTUtilityFunctions-2"></span><div class="fragmentname">&lt;&lt;BDPT Utility Functions&gt;&gt;+=&nbsp;<a href="#fragment-BDPTUtilityFunctions-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-BDPTUtilityFunctions-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">int <span class="anchor" id="GenerateLightSubpath"></span>GenerateLightSubpath(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> &amp;sampler,
        <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena, int maxDepth, Float time,
        const Distribution1D &amp;lightDistr, Vertex *path) {
    if (maxDepth == 0)
        return 0;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleinitialrayforlightsubpath-0">Sample initial ray for light subpath</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1757" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1757"><i></i></a><div id="fragbit-1757" class="collapse"><div class="fragmentcode">       Float lightPdf;
       int lightNum = lightDistr.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>(), &amp;lightPdf);
       const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[lightNum];
       RayDifferential ray;
       <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> nLight;
       Float pdfPos, pdfDir;
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Le = light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le" class="code">Sample_Le</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), time,
                                      &amp;ray, &amp;nLight, &amp;pdfPos, &amp;pdfDir);
       if (pdfPos == 0 || pdfDir == 0 || Le.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
           return 0;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Generatefirstvertexonlightsubpathandstartrandomwalk-0">Generate first vertex on light subpath and start random walk</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1758" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1758"><i></i></a><div id="fragbit-1758" class="collapse"><div class="fragmentcode">       path[0] = <a href="#Vertex::CreateLight" class="code">Vertex</a>::CreateLight(light.get(), ray, nLight, Le,
                                     pdfPos * lightPdf);
       <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = Le * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(nLight, ray.d) / (lightPdf * pdfPos * pdfDir);
       int nVertices = <a href="#RandomWalk" class="code">RandomWalk</a>(scene, ray, sampler, arena, beta, pdfDir,
                                  maxDepth - 1, <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance,
                                  path + 1);
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Correctsubpathsamplingdensitiesforinfinitearealights-0">Correct subpath sampling densities for infinite area lights</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1759" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1759"><i></i></a><div id="fragbit-1759" class="collapse"><div class="fragmentcode">          if (path[0].<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Setspatialdensityofmonopath1forinfinitearealight-0">Set spatial density of <tt>path[1]</tt> for infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1760" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1760"><i></i></a><div id="fragbit-1760" class="collapse"><div class="fragmentcode">                 if (nVertices &gt; 0) {
                     path[1].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> = pdfPos;
                     if (path[1].<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
                         path[1].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(ray.d, path[1].<a href="#Vertex::ng" class="code">ng</a>());
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Setspatialdensityofmonopath0forinfinitearealight-0">Set spatial density of <tt>path[0]</tt> for infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1761" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1761"><i></i></a><div id="fragbit-1761" class="collapse"><div class="fragmentcode">                 path[0].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> = <a href="#InfiniteLightDensity" class="code">InfiniteLightDensity</a>(scene, lightDistr, ray.d);</div></div>
          }</div></div>
       return nVertices + 1;</div></div>
}</div><p>


</p>
<p>As usual in this integrator, a specific light is chosen by sampling from
the provided <a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D"><tt>Distribution1D</tt></a>.  Next, an emitted ray is sampled via
the light&rsquo;s implementation of <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le"><tt>Light::Sample_Le()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Sampleinitialrayforlightsubpath-0"></span><div class="fragmentname">&lt;&lt;Sample initial ray for light subpath&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float lightPdf;
int lightNum = lightDistr.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>(), &amp;lightPdf);
const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[lightNum];
RayDifferential ray;
<a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> nLight;
Float pdfPos, pdfDir;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Le = light-&gt;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le" class="code">Sample_Le</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), time,
                               &amp;ray, &amp;nLight, &amp;pdfPos, &amp;pdfDir);
if (pdfPos == 0 || pdfDir == 0 || Le.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
    return 0;</div><p>


</p>
<p>
The <tt>beta</tt> variable is initialized with the associated sampling
weight, which is given by the emitted radiance multiplied by a cosine
factor from the light transport equation and divided by the probability of
the sample in ray-space.  This step is analogous to
Equation&nbsp;(<a href="../Light_Transport_III_Bidirectional_Methods/Stochastic_Progressive_Photon_Mapping.html#eq:sppm-particle-weight">16.15</a>) and the approach implemented in the
fragment &lt;&lt;<span class="fragmentname"><a href="Stochastic_Progressive_Photon_Mapping.html#fragment-GeneratemonophotonRayfromlightsourceandinitializemonobeta-0">Generate <tt>photonRay</tt> from light source and
initialize <tt>beta</tt></a></span>&gt;&gt; from the particle tracing step of the SPPM
integrator.

</p>
<p></p>
<span class="anchor" id="fragment-Generatefirstvertexonlightsubpathandstartrandomwalk-0"></span><div class="fragmentname">&lt;&lt;Generate first vertex on light subpath and start random walk&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">path[0] = <a href="#Vertex::CreateLight" class="code">Vertex</a>::CreateLight(light.get(), ray, nLight, Le,
                              pdfPos * lightPdf);
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta = Le * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(nLight, ray.d) / (lightPdf * pdfPos * pdfDir);
int nVertices = <a href="#RandomWalk" class="code">RandomWalk</a>(scene, ray, sampler, arena, beta, pdfDir,
                           maxDepth - 1, <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Importance" class="code">TransportMode</a>::Importance,
                           path + 1);
&lt;&lt;<span class="fragmentname"><a href="#fragment-Correctsubpathsamplingdensitiesforinfinitearealights-0">Correct subpath sampling densities for infinite area lights</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1762" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1762"><i></i></a><div id="fragbit-1762" class="collapse"><div class="fragmentcode">   if (path[0].<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Setspatialdensityofmonopath1forinfinitearealight-0">Set spatial density of <tt>path[1]</tt> for infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1763" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1763"><i></i></a><div id="fragbit-1763" class="collapse"><div class="fragmentcode">          if (nVertices &gt; 0) {
              path[1].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> = pdfPos;
              if (path[1].<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
                  path[1].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(ray.d, path[1].<a href="#Vertex::ng" class="code">ng</a>());
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Setspatialdensityofmonopath0forinfinitearealight-0">Set spatial density of <tt>path[0]</tt> for infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1764" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1764"><i></i></a><div id="fragbit-1764" class="collapse"><div class="fragmentcode">          path[0].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> = <a href="#InfiniteLightDensity" class="code">InfiniteLightDensity</a>(scene, lightDistr, ray.d);</div></div>
   }</div></div>
return nVertices + 1;</div><p>


</p>
<p><a href="#RandomWalk"><tt>RandomWalk()</tt></a> traces paths starting at an initial vertex. It assumes
that a position and an outgoing direction at the corresponding path
endpoint were previously sampled and that this information is provided via
the input arguments <tt>ray</tt>, a path throughput weight <tt>beta</tt>, and
a parameter <tt>pdf</tt> that gives the probability of sampling the
ray per unit solid angle of <tt>ray.d</tt>. The parameter <tt>mode</tt> selects
between importance and radiance transport
(Section&nbsp;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#sec:adjoint-transport">16.1</a>). The path vertices are stored in
the provided <tt>path</tt> array up to a maximum number of <tt>maxDepth</tt>
vertices, and the actual number of generated vertices is returned at the end.

</p>
<p>

</p>
<p>
</p>
<span class="anchor" id="fragment-BDPTUtilityFunctions-3"></span><div class="fragmentname">&lt;&lt;BDPT Utility Functions&gt;&gt;+=&nbsp;<a href="#fragment-BDPTUtilityFunctions-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-BDPTUtilityFunctions-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">int <span class="anchor" id="RandomWalk"></span>RandomWalk(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, RayDifferential ray, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> &amp;sampler,
        <a href="../Utilities/Memory_Management.html#MemoryArena" class="code">MemoryArena</a> &amp;arena, <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> beta, Float pdf, int maxDepth,
        TransportMode mode, Vertex *path) {
    if (maxDepth == 0)
        return 0;
    int bounces = 0;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Declarevariablesforforwardandreverseprobabilitydensities-0">Declare variables for forward and reverse probability densities</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1765" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1765"><i></i></a><div id="fragbit-1765" class="collapse"><div class="fragmentcode">       Float pdfFwd = pdf, pdfRev = 0;</div></div>
    while (true) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Attempttocreatethenextsubpathvertexinmonopath-0">Attempt to create the next subpath vertex in <tt>path</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1766" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1766"><i></i></a><div id="fragbit-1766" class="collapse"><div class="fragmentcode">           <a href="../Volume_Scattering/Media.html#MediumInteraction" class="code">MediumInteraction</a> mi;
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Tracearayandsamplethemediumifany-0">Trace a ray and sample the medium, if any</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1767" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1767"><i></i></a><div id="fragbit-1767" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
              bool foundIntersection = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(ray, &amp;isect);
              if (ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>)
                  beta *= ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>-&gt;<a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#Medium::Sample" class="code">Sample</a>(ray, sampler, arena, &amp;mi);
              if (beta.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
                  break;
              Vertex &amp;vertex = path[bounces], &amp;prev = path[bounces - 1];</div></div>
           if (mi.<a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#MediumInteraction::IsValid" class="code">IsValid</a>()) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Recordmediuminteractioninmonopathandcomputeforwarddensity-0">Record medium interaction in <tt>path</tt> and compute forward density</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1768" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1768"><i></i></a><div id="fragbit-1768" class="collapse"><div class="fragmentcode">                  vertex = <a href="#Vertex::CreateMedium" class="code">Vertex</a>::CreateMedium(mi, beta, pdfFwd, prev);
                  if (++bounces &gt;= maxDepth)
                      break;</div></div>
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectionandcomputereversedensityatprecedingvertex-0">Sample direction and compute reverse density at preceding vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1769" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1769"><i></i></a><div id="fragbit-1769" class="collapse"><div class="fragmentcode">                  <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
                  pdfFwd = pdfRev = mi.<a href="../Volume_Scattering/Media.html#MediumInteraction::phase" class="code">phase</a>-&gt;<a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.d, &amp;wi, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
                  ray = mi.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
           } else {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlesurfaceinteractionforpathgeneration-0">Handle surface interaction for path generation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1770" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1770"><i></i></a><div id="fragbit-1770" class="collapse"><div class="fragmentcode">                  if (!foundIntersection) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Captureescapedrayswhentracingfromthecamera-0">Capture escaped rays when tracing from the camera</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1771" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1771"><i></i></a><div id="fragbit-1771" class="collapse"><div class="fragmentcode">                         if (mode == <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Radiance" class="code">TransportMode</a>::Radiance) {
                             vertex = <a href="#Vertex::CreateLight" class="code">Vertex</a>::CreateLight(EndpointInteraction(ray), beta,
                                                          pdfFwd);
                             ++bounces;
                         }</div></div>
                      break;
                  }
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Computescatteringfunctionsformonomodeandskipovermediumboundaries-0">Compute scattering functions for <tt>mode</tt> and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1772" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1772"><i></i></a><div id="fragbit-1772" class="collapse"><div class="fragmentcode">                     isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true, mode);
                     if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
                         ray = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(ray.d);
                         continue;
                     }</div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializemonovertexwithsurfaceintersectioninformation-0">Initialize <tt>vertex</tt> with surface intersection information</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1773" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1773"><i></i></a><div id="fragbit-1773" class="collapse"><div class="fragmentcode">                     vertex = <a href="#Vertex::CreateSurface" class="code">Vertex</a>::CreateSurface(isect, beta, pdfFwd, prev);</div></div>
                  if (++bounces &gt;= maxDepth)
                      break;
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFatcurrentvertexandcomputereverseprobability-0">Sample BSDF at current vertex and compute reverse probability</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1774" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1774"><i></i></a><div id="fragbit-1774" class="collapse"><div class="fragmentcode">                     <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>;
                     BxDFType type;
                     <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, &amp;wi, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdfFwd,
                                                       BSDF_ALL, &amp;type);
                     if (f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdfFwd == 0.f)
                         break;
                     beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdfFwd;
                     pdfRev = isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Pdf" class="code">Pdf</a>(wi, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, BSDF_ALL);
                     if (type &amp; BSDF_SPECULAR) {
                         vertex.<a href="#Vertex::delta" class="code">delta</a> = true;
                         pdfRev = pdfFwd = 0;
                     }
                     beta *= <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#CorrectShadingNormal" class="code">CorrectShadingNormal</a>(isect, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, wi, mode);</div></div>
                  ray = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
           }
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Computereverseareadensityatprecedingvertex-0">Compute reverse area density at preceding vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1775" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1775"><i></i></a><div id="fragbit-1775" class="collapse"><div class="fragmentcode">              prev.<a href="#Vertex::pdfRev" class="code">pdfRev</a> = vertex.<a href="#Vertex::ConvertDensity" class="code">ConvertDensity</a>(<a href="#Vertex::pdfRev" class="code">pdfRev</a>, prev);</div></div></div></div>
    }
    return bounces;
}</div><p>


</p>
<p>The two variables <tt>pdfFwd</tt> and <tt>pdfRev</tt> are updated during
every loop iteration and satisfy the following invariants: at the beginning of
each iteration, <tt>pdfFwd</tt> records the probability per unit solid angle of
the sampled ray direction <tt>ray.d</tt>. On the other hand, <tt>pdfRev</tt>
denotes the <em>reverse</em> probability at the end of each iteration&mdash;that is,
the density of the opposite light transport mode per unit solid angle along the
same ray segment.

</p>
<p></p>
<span class="anchor" id="fragment-Declarevariablesforforwardandreverseprobabilitydensities-0"></span><div class="fragmentname">&lt;&lt;Declare variables for forward and reverse probability densities&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pdfFwd = pdf, pdfRev = 0;</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Attempttocreatethenextsubpathvertexinmonopath-0"></span><div class="fragmentname">&lt;&lt;Attempt to create the next subpath vertex in <tt>path</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Volume_Scattering/Media.html#MediumInteraction" class="code">MediumInteraction</a> mi;
&lt;&lt;<span class="fragmentname"><a href="#fragment-Tracearayandsamplethemediumifany-0">Trace a ray and sample the medium, if any</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1776" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1776"><i></i></a><div id="fragbit-1776" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
   bool foundIntersection = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(ray, &amp;isect);
   if (ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>)
       beta *= ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>-&gt;<a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#Medium::Sample" class="code">Sample</a>(ray, sampler, arena, &amp;mi);
   if (beta.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
       break;
   Vertex &amp;vertex = path[bounces], &amp;prev = path[bounces - 1];</div></div>
if (mi.<a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#MediumInteraction::IsValid" class="code">IsValid</a>()) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Recordmediuminteractioninmonopathandcomputeforwarddensity-0">Record medium interaction in <tt>path</tt> and compute forward density</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1777" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1777"><i></i></a><div id="fragbit-1777" class="collapse"><div class="fragmentcode">       vertex = <a href="#Vertex::CreateMedium" class="code">Vertex</a>::CreateMedium(mi, beta, pdfFwd, prev);
       if (++bounces &gt;= maxDepth)
           break;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectionandcomputereversedensityatprecedingvertex-0">Sample direction and compute reverse density at preceding vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1778" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1778"><i></i></a><div id="fragbit-1778" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
       pdfFwd = pdfRev = mi.<a href="../Volume_Scattering/Media.html#MediumInteraction::phase" class="code">phase</a>-&gt;<a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.d, &amp;wi, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
       ray = mi.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
} else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlesurfaceinteractionforpathgeneration-0">Handle surface interaction for path generation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1779" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1779"><i></i></a><div id="fragbit-1779" class="collapse"><div class="fragmentcode">       if (!foundIntersection) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Captureescapedrayswhentracingfromthecamera-0">Capture escaped rays when tracing from the camera</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1780" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1780"><i></i></a><div id="fragbit-1780" class="collapse"><div class="fragmentcode">              if (mode == <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Radiance" class="code">TransportMode</a>::Radiance) {
                  vertex = <a href="#Vertex::CreateLight" class="code">Vertex</a>::CreateLight(EndpointInteraction(ray), beta,
                                               pdfFwd);
                  ++bounces;
              }</div></div>
           break;
       }
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computescatteringfunctionsformonomodeandskipovermediumboundaries-0">Compute scattering functions for <tt>mode</tt> and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1781" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1781"><i></i></a><div id="fragbit-1781" class="collapse"><div class="fragmentcode">          isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true, mode);
          if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
              ray = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(ray.d);
              continue;
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializemonovertexwithsurfaceintersectioninformation-0">Initialize <tt>vertex</tt> with surface intersection information</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1782" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1782"><i></i></a><div id="fragbit-1782" class="collapse"><div class="fragmentcode">          vertex = <a href="#Vertex::CreateSurface" class="code">Vertex</a>::CreateSurface(isect, beta, pdfFwd, prev);</div></div>
       if (++bounces &gt;= maxDepth)
           break;
       &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFatcurrentvertexandcomputereverseprobability-0">Sample BSDF at current vertex and compute reverse probability</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1783" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1783"><i></i></a><div id="fragbit-1783" class="collapse"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>;
          BxDFType type;
          <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, &amp;wi, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdfFwd,
                                            BSDF_ALL, &amp;type);
          if (f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdfFwd == 0.f)
              break;
          beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdfFwd;
          pdfRev = isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Pdf" class="code">Pdf</a>(wi, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, BSDF_ALL);
          if (type &amp; BSDF_SPECULAR) {
              vertex.<a href="#Vertex::delta" class="code">delta</a> = true;
              pdfRev = pdfFwd = 0;
          }
          beta *= <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#CorrectShadingNormal" class="code">CorrectShadingNormal</a>(isect, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, wi, mode);</div></div>
       ray = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div></div>
}
&lt;&lt;<span class="fragmentname"><a href="#fragment-Computereverseareadensityatprecedingvertex-0">Compute reverse area density at preceding vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1784" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1784"><i></i></a><div id="fragbit-1784" class="collapse"><div class="fragmentcode">   prev.<a href="#Vertex::pdfRev" class="code">pdfRev</a> = vertex.<a href="#Vertex::ConvertDensity" class="code">ConvertDensity</a>(<a href="#Vertex::pdfRev" class="code">pdfRev</a>, prev);</div></div></div><p>


</p>
<p>

</p>
<p>The loop body begins by intersecting the current ray against the scene
geometry.  If the ray is passing through a participating medium, the call
to <tt>Medium::Sample()</tt> possibly samples a scattering event between the
ray and the surface. It returns the medium sampling weight, which is
incorporated into the path contribution weight <tt>beta</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Tracearayandsamplethemediumifany-0"></span><div class="fragmentname">&lt;&lt;Trace a ray and sample the medium, if any&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> isect;
bool foundIntersection = scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::Intersect" class="code">Intersect</a>(ray, &amp;isect);
if (ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>)
    beta *= ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>-&gt;<a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#Medium::Sample" class="code">Sample</a>(ray, sampler, arena, &amp;mi);
if (beta.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>())
    break;
Vertex &amp;vertex = path[bounces], &amp;prev = path[bounces - 1];</div><p>


</p>
<p>When <a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#Medium::Sample"><tt>Medium::Sample()</tt></a> generates a medium scattering event, the
corresponding <tt>Interaction</tt> is stored in a <tt>Vertex</tt> 
and appended at the end of the <tt>path</tt> array. 
The <a href="#Vertex::CreateMedium"><tt>Vertex::CreateMedium()</tt></a> method converts the solid angle
density in <tt>pdfFwd</tt> to a probability
per unit area and stores the result in <a href="#Vertex::pdfFwd"><tt>Vertex::pdfFwd</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Recordmediuminteractioninmonopathandcomputeforwarddensity-0"></span><div class="fragmentname">&lt;&lt;Record medium interaction in <tt>path</tt> and compute forward density&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">vertex = <a href="#Vertex::CreateMedium" class="code">Vertex</a>::CreateMedium(mi, beta, pdfFwd, prev);
if (++bounces &gt;= maxDepth)
    break;</div><p>


</p>
<p>If the maximum path depth has not yet been exceeded, a scattered
direction is sampled from the phase function and used to spawn a new ray that will be
processed by the next loop iteration.

</p>
<p>At this point, we could evaluate the phase function with swapped arguments
to obtain the sampling density at the preceding vertex for a hypothetical
random walk that would have produced the same scattering interactions in
reverse order. Since phase functions are generally symmetric with respect
to their arguments, instead we simply reuse the value computed for <tt>pdfFwd</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Sampledirectionandcomputereversedensityatprecedingvertex-0"></span><div class="fragmentname">&lt;&lt;Sample direction and compute reverse density at preceding vertex&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
pdfFwd = pdfRev = mi.<a href="../Volume_Scattering/Media.html#MediumInteraction::phase" class="code">phase</a>-&gt;<a href="../Light_Transport_II_Volume_Rendering/Sampling_Volume_Scattering.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.d, &amp;wi, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
ray = mi.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div><p>


</p>
<p>For surfaces, the overall structure is similar, though some extra
care is required to deal with non-symmetric scattering and
surfaces that mark transitions between media.

</p>
<p></p>
<span class="anchor" id="fragment-Handlesurfaceinteractionforpathgeneration-0"></span><div class="fragmentname">&lt;&lt;Handle surface interaction for path generation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (!foundIntersection) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Captureescapedrayswhentracingfromthecamera-0">Capture escaped rays when tracing from the camera</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1785" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1785"><i></i></a><div id="fragbit-1785" class="collapse"><div class="fragmentcode">       if (mode == <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Radiance" class="code">TransportMode</a>::Radiance) {
           vertex = <a href="#Vertex::CreateLight" class="code">Vertex</a>::CreateLight(EndpointInteraction(ray), beta,
                                        pdfFwd);
           ++bounces;
       }</div></div>
    break;
}
&lt;&lt;<span class="fragmentname"><a href="#fragment-Computescatteringfunctionsformonomodeandskipovermediumboundaries-0">Compute scattering functions for <tt>mode</tt> and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1786" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1786"><i></i></a><div id="fragbit-1786" class="collapse"><div class="fragmentcode">   isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true, mode);
   if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
       ray = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(ray.d);
       continue;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Initializemonovertexwithsurfaceintersectioninformation-0">Initialize <tt>vertex</tt> with surface intersection information</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1787" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1787"><i></i></a><div id="fragbit-1787" class="collapse"><div class="fragmentcode">   vertex = <a href="#Vertex::CreateSurface" class="code">Vertex</a>::CreateSurface(isect, beta, pdfFwd, prev);</div></div>
if (++bounces &gt;= maxDepth)
    break;
&lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFatcurrentvertexandcomputereverseprobability-0">Sample BSDF at current vertex and compute reverse probability</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1788" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1788"><i></i></a><div id="fragbit-1788" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>;
   BxDFType type;
   <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, &amp;wi, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdfFwd,
                                     BSDF_ALL, &amp;type);
   if (f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdfFwd == 0.f)
       break;
   beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdfFwd;
   pdfRev = isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Pdf" class="code">Pdf</a>(wi, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, BSDF_ALL);
   if (type &amp; BSDF_SPECULAR) {
       vertex.<a href="#Vertex::delta" class="code">delta</a> = true;
       pdfRev = pdfFwd = 0;
   }
   beta *= <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#CorrectShadingNormal" class="code">CorrectShadingNormal</a>(isect, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, wi, mode);</div></div>
ray = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(wi);</div><p>


</p>
<p>The fragment &lt;&lt;<span class="fragmentname"><a href="#fragment-Captureescapedrayswhentracingfromthecamera-0">Capture escaped rays when tracing from the camera</a></span>&gt;&gt;
is necessary to support infinite area lights. It will be discussed in
Section&nbsp;<a href="#sec:bdpt-infinite">16.3.5</a>.  The following fragment, &lt;&lt;<span class="fragmentname"><a href="#fragment-Computescatteringfunctionsformonomodeandskipovermediumboundaries-0">Compute
scattering functions for <tt>mode</tt> and skip over medium boundaries</a></span>&gt;&gt;, is
analogous to &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#fragment-Computescatteringfunctionsandskipovermediumboundaries-0">Compute scattering functions and skip over medium
boundaries</a></span>&gt;&gt; from the basic path tracer except that scattering functions are
requested for the current light transport mode (radiance or importance
transport) using the <tt>mode</tt> parameter.

</p>
<p></p>
<span class="anchor" id="fragment-Computescatteringfunctionsformonomodeandskipovermediumboundaries-0"></span><div class="fragmentname">&lt;&lt;Compute scattering functions for <tt>mode</tt> and skip over medium boundaries&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">isect.<a href="../Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::ComputeScatteringFunctions" class="code">ComputeScatteringFunctions</a>(ray, arena, true, mode);
if (!isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>) {
    ray = isect.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRay" class="code">SpawnRay</a>(ray.d);
    continue;
}</div><p>


</p>
<p>Given a valid intersection, the current path vertex is initialized with the
corresponding surface intersection vertex,
where, again, the solid angle density
<tt>pdfFwd</tt> is converted to an area density before being stored in
<a href="#Vertex::pdfFwd"><tt>Vertex::pdfFwd</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Initializemonovertexwithsurfaceintersectioninformation-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>vertex</tt> with surface intersection information&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">vertex = <a href="#Vertex::CreateSurface" class="code">Vertex</a>::CreateSurface(isect, beta, pdfFwd, prev);</div><p>


</p>
<p>If the maximum path depth has not yet been exceeded,
a scattered direction is sampled from the BSDF and the path contribution in
<tt>beta</tt> is updated. For the surface case, we can&rsquo;t generally assume that
<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Pdf"><tt>BSDF::Pdf()</tt></a> is symmetric; hence we must re-evaluate the sampling density with
swapped arguments to obtain <tt>pdfRev</tt>. In case of a specular sampling
event, we mark the vertex using the flag <a href="#Vertex::delta"><tt>Vertex::delta</tt></a> and set
<tt>pdfFwd</tt> and <tt>pdfRev</tt> to&nbsp;0 to indicate that the underlying
interaction has no continuous density function. Finally, we correct for
non-symmetry related to the use of shading normals (see
Section&nbsp;<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#sec:non-symmetric">16.1.3</a> for details).

</p>
<p></p>
<span class="anchor" id="fragment-SampleBSDFatcurrentvertexandcomputereverseprobability-0"></span><div class="fragmentname">&lt;&lt;Sample BSDF at current vertex and compute reverse probability&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>;
BxDFType type;
<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> f = isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Sample_f" class="code">Sample_f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, &amp;wi, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(), &amp;pdfFwd,
                                  BSDF_ALL, &amp;type);
if (f.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() || pdfFwd == 0.f)
    break;
beta *= f * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, isect.shading.n) / pdfFwd;
pdfRev = isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::bsdf" class="code">bsdf</a>-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Reflection_Functions.html#BSDF::Pdf" class="code">Pdf</a>(wi, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, BSDF_ALL);
if (type &amp; BSDF_SPECULAR) {
    vertex.<a href="#Vertex::delta" class="code">delta</a> = true;
    pdfRev = pdfFwd = 0;
}
beta *= <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#CorrectShadingNormal" class="code">CorrectShadingNormal</a>(isect, <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, wi, mode);</div><p>


</p>
<p>The loop wraps up by converting the reverse density <tt>pdfRev</tt> to a
probability per unit area and storing it in the <tt>Vertex</tt> data
structure of the preceding vertex.

</p>
<p></p>
<span class="anchor" id="fragment-Computereverseareadensityatprecedingvertex-0"></span><div class="fragmentname">&lt;&lt;Compute reverse area density at preceding vertex&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">prev.<a href="#Vertex::pdfRev" class="code">pdfRev</a> = vertex.<a href="#Vertex::ConvertDensity" class="code">ConvertDensity</a>(<a href="#Vertex::pdfRev" class="code">pdfRev</a>, prev);</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#SubpathConnections"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:bdpt-connections"></span><span id="SubpathConnections"></span><h3>16.3.3  Subpath Connections</h3><p>



</p>
<p>

</p>
<p>The <a href="#ConnectBDPT"><tt>ConnectBDPT()</tt></a> function takes the light and camera subpaths and
the number of vertices <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 469.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> to use from each one, respectively.
It returns the corresponding
strategy&rsquo;s contribution.

</p>
<p>The connection strategy with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> uses only a
single camera vertex, the camera&rsquo;s position; the raster position of the
path&rsquo;s contribution is then based on which pixel the last vertex of the
light subpath is visible in (if any).  In this case,
the resulting position is returned via the <tt>pRaster</tt>
argument.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;BDPT Method Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <span class="anchor" id="ConnectBDPT"></span>ConnectBDPT(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, Vertex *lightVertices,
        Vertex *cameraVertices, int s, int t,
        const Distribution1D &amp;lightDistr, const <a href="../Camera_Models/Camera_Model.html#Camera" class="code">Camera</a> &amp;camera,
        <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> &amp;sampler, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> *pRaster, Float *misWeightPtr) {
    <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> L(0.f);
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Ignoreinvalidconnectionsrelatedtoinfinitearealights-0">Ignore invalid connections related to infinite area lights</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1789" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1789"><i></i></a><div id="fragbit-1789" class="collapse"><div class="fragmentcode">       if (t &gt; 1 &amp;&amp; s != 0 &amp;&amp; cameraVertices[t - 1].<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>)
           return <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>(0.f);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PerformconnectionandwritecontributiontomonoL-0">Perform connection and write contribution to <tt>L</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1790" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1790"><i></i></a><div id="fragbit-1790" class="collapse"><div class="fragmentcode">       Vertex sampled;
       if (s == 0) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Interpretthecamerasubpathasacompletepath-0">Interpret the camera subpath as a complete path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1791" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1791"><i></i></a><div id="fragbit-1791" class="collapse"><div class="fragmentcode">              const Vertex &amp;pt = cameraVertices[t - 1];
              if (pt.<a href="#Vertex::IsLight" class="code">IsLight</a>())
                  L = pt.<a href="#Vertex::Le" class="code">Le</a>(scene, cameraVertices[t - 2]) * pt.<a href="#Vertex::beta" class="code">beta</a>;</div></div>
       } else if (t == 1) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleapointonthecameraandconnectittothelightsubpath-0">Sample a point on the camera and connect it to the light subpath</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1792" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1792"><i></i></a><div id="fragbit-1792" class="collapse"><div class="fragmentcode">              const Vertex &amp;qs = lightVertices[s - 1];
              if (qs.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>()) {
                  <a href="../Light_Sources/Light_Interface.html#VisibilityTester" class="code">VisibilityTester</a> vis;
                  <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
                  Float pdf;
                  <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Wi = camera.<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Sample_Wi" class="code">Sample_Wi</a>(qs.<a href="#Vertex::GetInteraction" class="code">GetInteraction</a>(), sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(),
                                                 &amp;wi, &amp;pdf, pRaster, &amp;vis);
                  if (pdf &gt; 0 &amp;&amp; !Wi.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializedynamicallysampledvertexandmonoLfort1case-0">Initialize dynamically sampled vertex and <tt>L</tt> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> case</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1793" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1793"><i></i></a><div id="fragbit-1793" class="collapse"><div class="fragmentcode">                         sampled = <a href="#Vertex::CreateCamera" class="code">Vertex</a>::CreateCamera(&amp;camera, vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::P1" class="code">P1</a>(), Wi / pdf);
                         L = qs.<a href="#Vertex::beta" class="code">beta</a> * qs.<a href="#Vertex::f" class="code">f</a>(sampled) * vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::Tr" class="code">Tr</a>(scene, sampler) * sampled.<a href="#Vertex::beta" class="code">beta</a>;
                         if (qs.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
                             L *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, qs.<a href="#Vertex::ns" class="code">ns</a>());</div></div>
                  }
              }</div></div>
       } else if (s == 1) {
           &lt;&lt;<span class="fragmentname">Sample a point on a light and connect it to the camera subpath</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1794" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1794"><i></i></a><div id="fragbit-1794" class="collapse"><div class="fragmentcode">              const <a href="#Vertex::CreateLight" class="code">Vertex</a> &amp;pt = cameraVertices[t-1];
              if (pt.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>()) {
                  Float lightPdf;
                  <a href="../Light_Sources/Light_Interface.html#VisibilityTester" class="code">VisibilityTester</a> vis;
                  <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi; Float pdf;
                  int lightNum = lightDistr.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(sampler.Get1D(), &amp;lightPdf);
                  const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.lights[lightNum];
                  <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> lightWeight = light-&gt;<a href="../Light_Sources/Light_Interface.html#Light::Sample_Li" class="code">Sample_Li</a>(pt.GetInteraction(), sampler.Get2D(),
                                                          &amp;wi, &amp;pdf, &amp;vis);
                  if (pdf &gt; 0 &amp;&amp; !lightWeight.IsBlack()) {
                      EndpointInteraction ei(vis.P1(), light.get());
                      sampled = <a href="#Vertex::CreateLight" class="code">Vertex</a>::CreateLight(ei, lightWeight / (pdf * lightPdf), 0);
                      sampled.pdfFwd = sampled.<a href="#Vertex::PdfLightOrigin" class="code">PdfLightOrigin</a>(scene, pt, lightDistr);
                      L = pt.beta * pt.<a href="#Vertex::f" class="code">f</a>(sampled) * vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::Tr" class="code">Tr</a>(scene, sampler) * sampled.beta;
                      if (pt.IsOnSurface())
                          L *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, pt.<a href="#Vertex::ns" class="code">ns</a>());
                  }
              }</div></div>
       } else {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleallotherbidirectionalconnectioncases-0">Handle all other bidirectional connection cases</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1795" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1795"><i></i></a><div id="fragbit-1795" class="collapse"><div class="fragmentcode">              const Vertex &amp;qs = lightVertices[s - 1], &amp;pt = cameraVertices[t - 1];
              if (qs.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>() &amp;&amp; pt.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>()) {
                  L = qs.<a href="#Vertex::beta" class="code">beta</a> * qs.<a href="#Vertex::f" class="code">f</a>(pt) * pt.<a href="#Vertex::f" class="code">f</a>(qs) * pt.<a href="#Vertex::beta" class="code">beta</a>;
                  if (!L.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) L *= <a href="#G" class="code">G</a>(scene, sampler, qs, pt);
              }</div></div>
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMISweightforconnectionstrategy-0">Compute MIS weight for connection strategy</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1796" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1796"><i></i></a><div id="fragbit-1796" class="collapse"><div class="fragmentcode">       Float misWeight = L.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() ? 0.f :
            <a href="#MISWeight" class="code">MISWeight</a>(scene, lightVertices, cameraVertices, sampled, s, t,
                      lightDistr);
       L *= misWeight;
       if (misWeightPtr) *misWeightPtr = misWeight;</div></div>
    return L;
}</div><p>


</p>
<p>A number of cases must be considered when handling connections; special
handling is needed for those involving short subpaths with only zero or one
vertex. Some strategies dynamically sample an additional vertex, which is
stored in the temporary variable <tt>sampled</tt>.
    
</p>
<span class="anchor" id="fragment-PerformconnectionandwritecontributiontomonoL-0"></span><div class="fragmentname">&lt;&lt;Perform connection and write contribution to <tt>L</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Vertex sampled;
if (s == 0) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Interpretthecamerasubpathasacompletepath-0">Interpret the camera subpath as a complete path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1797" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1797"><i></i></a><div id="fragbit-1797" class="collapse"><div class="fragmentcode">       const Vertex &amp;pt = cameraVertices[t - 1];
       if (pt.<a href="#Vertex::IsLight" class="code">IsLight</a>())
           L = pt.<a href="#Vertex::Le" class="code">Le</a>(scene, cameraVertices[t - 2]) * pt.<a href="#Vertex::beta" class="code">beta</a>;</div></div>
} else if (t == 1) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleapointonthecameraandconnectittothelightsubpath-0">Sample a point on the camera and connect it to the light subpath</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1798" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1798"><i></i></a><div id="fragbit-1798" class="collapse"><div class="fragmentcode">       const Vertex &amp;qs = lightVertices[s - 1];
       if (qs.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>()) {
           <a href="../Light_Sources/Light_Interface.html#VisibilityTester" class="code">VisibilityTester</a> vis;
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
           Float pdf;
           <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Wi = camera.<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Sample_Wi" class="code">Sample_Wi</a>(qs.<a href="#Vertex::GetInteraction" class="code">GetInteraction</a>(), sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(),
                                          &amp;wi, &amp;pdf, pRaster, &amp;vis);
           if (pdf &gt; 0 &amp;&amp; !Wi.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializedynamicallysampledvertexandmonoLfort1case-0">Initialize dynamically sampled vertex and <tt>L</tt> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> case</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1799" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1799"><i></i></a><div id="fragbit-1799" class="collapse"><div class="fragmentcode">                  sampled = <a href="#Vertex::CreateCamera" class="code">Vertex</a>::CreateCamera(&amp;camera, vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::P1" class="code">P1</a>(), Wi / pdf);
                  L = qs.<a href="#Vertex::beta" class="code">beta</a> * qs.<a href="#Vertex::f" class="code">f</a>(sampled) * vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::Tr" class="code">Tr</a>(scene, sampler) * sampled.<a href="#Vertex::beta" class="code">beta</a>;
                  if (qs.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
                      L *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, qs.<a href="#Vertex::ns" class="code">ns</a>());</div></div>
           }
       }</div></div>
} else if (s == 1) {
    &lt;&lt;<span class="fragmentname">Sample a point on a light and connect it to the camera subpath</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1800" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1800"><i></i></a><div id="fragbit-1800" class="collapse"><div class="fragmentcode">       const <a href="#Vertex::CreateLight" class="code">Vertex</a> &amp;pt = cameraVertices[t-1];
       if (pt.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>()) {
           Float lightPdf;
           <a href="../Light_Sources/Light_Interface.html#VisibilityTester" class="code">VisibilityTester</a> vis;
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi; Float pdf;
           int lightNum = lightDistr.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::SampleDiscrete" class="code">SampleDiscrete</a>(sampler.Get1D(), &amp;lightPdf);
           const std::shared_ptr&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; &amp;light = scene.lights[lightNum];
           <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> lightWeight = light-&gt;<a href="../Light_Sources/Light_Interface.html#Light::Sample_Li" class="code">Sample_Li</a>(pt.GetInteraction(), sampler.Get2D(),
                                                   &amp;wi, &amp;pdf, &amp;vis);
           if (pdf &gt; 0 &amp;&amp; !lightWeight.IsBlack()) {
               EndpointInteraction ei(vis.P1(), light.get());
               sampled = <a href="#Vertex::CreateLight" class="code">Vertex</a>::CreateLight(ei, lightWeight / (pdf * lightPdf), 0);
               sampled.pdfFwd = sampled.<a href="#Vertex::PdfLightOrigin" class="code">PdfLightOrigin</a>(scene, pt, lightDistr);
               L = pt.beta * pt.<a href="#Vertex::f" class="code">f</a>(sampled) * vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::Tr" class="code">Tr</a>(scene, sampler) * sampled.beta;
               if (pt.IsOnSurface())
                   L *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, pt.<a href="#Vertex::ns" class="code">ns</a>());
           }
       }</div></div>
} else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleallotherbidirectionalconnectioncases-0">Handle all other bidirectional connection cases</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1801" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1801"><i></i></a><div id="fragbit-1801" class="collapse"><div class="fragmentcode">       const Vertex &amp;qs = lightVertices[s - 1], &amp;pt = cameraVertices[t - 1];
       if (qs.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>() &amp;&amp; pt.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>()) {
           L = qs.<a href="#Vertex::beta" class="code">beta</a> * qs.<a href="#Vertex::f" class="code">f</a>(pt) * pt.<a href="#Vertex::f" class="code">f</a>(qs) * pt.<a href="#Vertex::beta" class="code">beta</a>;
           if (!L.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) L *= <a href="#G" class="code">G</a>(scene, sampler, qs, pt);
       }</div></div>
}</div><p>


</p>
<p>The first case (<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1803" y="0"></use>
</g>
</svg>) applies when no vertices on the light subpath are
used and can only succeed when the camera subpath <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.393ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 6196.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 0 comma normal p 1 comma ellipsis comma normal p Subscript t minus 1 Baseline</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1010" y="0"></use>
<g transform="translate(1455,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2465" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="2911" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3915" y="0"></use>
<g transform="translate(4360,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</g>
</svg> is already a complete path&mdash;that is, when vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.265ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1836.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</svg>
can be interpreted as a light source. In this case, <tt>L</tt> is set to the
product of the path throughput weight and the emission at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.265ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1836.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fragment-Interpretthecamerasubpathasacompletepath-0"></span><div class="fragmentname">&lt;&lt;Interpret the camera subpath as a complete path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">const Vertex &amp;pt = cameraVertices[t - 1];
if (pt.<a href="#Vertex::IsLight" class="code">IsLight</a>())
    L = pt.<a href="#Vertex::Le" class="code">Le</a>(scene, cameraVertices[t - 2]) * pt.<a href="#Vertex::beta" class="code">beta</a>;</div><p>


</p>
<p>The second case applies when <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg>&mdash;that is, when a prefix of the light subpath
is directly connected to the camera (Figure&nbsp;<a href="#fig:bdpt-t-equals-1">16.15</a>). To
permit optimized importance sampling strategies analogous to direct
illumination routines for light sources, we will ignore the actual camera
vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1010.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
</svg> and sample a new one using
<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Sample_Wi"><tt>Camera::Sample_Wi()</tt></a>&mdash;this optimization corresponds to the second
bullet listed at the beginning of Section&nbsp;<a href="#sec:bidir-path-tracing">16.3</a>.
This type of connection can only succeed if the light subpath vertex
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1811.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
</svg> supports sampled connections; otherwise the BSDF at
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1811.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
</svg> will certainly return&nbsp;0 and there&rsquo;s no reason to attempt
a connection.

</p>
<p></p>
<span class="anchor" id="fig:bdpt-t-equals-1"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="bdpt-direct-sampling.svg" title=""><img src="bdpt-direct-sampling.svg" width=404 height=281 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.15: <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> Sampling Strategy for BDPT. <span class="legend">
We&rsquo;d like to connect a subset of the light subpath to the camera.  Given
the last vertex of the light subpath, <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Sample_Wi"><tt>Camera::Sample_Wi()</tt></a> samples a
vertex on the lens <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 1010.4 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-326"></use>
</g>
</svg> corresponding to a ray leaving the camera to the light
path vertex (if there is such a ray that intersects the film).
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Sampleapointonthecameraandconnectittothelightsubpath-0"></span><div class="fragmentname">&lt;&lt;Sample a point on the camera and connect it to the light subpath&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">const Vertex &amp;qs = lightVertices[s - 1];
if (qs.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>()) {
    <a href="../Light_Sources/Light_Interface.html#VisibilityTester" class="code">VisibilityTester</a> vis;
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi;
    Float pdf;
    <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> Wi = camera.<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Camera::Sample_Wi" class="code">Sample_Wi</a>(qs.<a href="#Vertex::GetInteraction" class="code">GetInteraction</a>(), sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>(),
                                   &amp;wi, &amp;pdf, pRaster, &amp;vis);
    if (pdf &gt; 0 &amp;&amp; !Wi.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializedynamicallysampledvertexandmonoLfort1case-0">Initialize dynamically sampled vertex and <tt>L</tt> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> case</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1802" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1802"><i></i></a><div id="fragbit-1802" class="collapse"><div class="fragmentcode">           sampled = <a href="#Vertex::CreateCamera" class="code">Vertex</a>::CreateCamera(&amp;camera, vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::P1" class="code">P1</a>(), Wi / pdf);
           L = qs.<a href="#Vertex::beta" class="code">beta</a> * qs.<a href="#Vertex::f" class="code">f</a>(sampled) * vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::Tr" class="code">Tr</a>(scene, sampler) * sampled.<a href="#Vertex::beta" class="code">beta</a>;
           if (qs.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
               L *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, qs.<a href="#Vertex::ns" class="code">ns</a>());</div></div>
    }
}</div><p>


</p>
<p>

</p>
<p>If the camera vertex was generated successfully, <tt>pRaster</tt> is initialized
and <tt>vis</tt> holds the connection segment. Following Equation&nbsp;(<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#eq:meas-eqn">16.1</a>),
we can compute
the final contribution as the product of the subpath weights, the
transmittance over the connecting segment, the BRDF or phase function, and
a cosine factor when <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1811.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
</svg> is a surface vertex.

</p>
<p></p>
<span class="anchor" id="fragment-InitializedynamicallysampledvertexandmonoLfort1case-0"></span><div class="fragmentname">&lt;&lt;Initialize dynamically sampled vertex and <tt>L</tt> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> case&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">sampled = <a href="#Vertex::CreateCamera" class="code">Vertex</a>::CreateCamera(&amp;camera, vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::P1" class="code">P1</a>(), Wi / pdf);
L = qs.<a href="#Vertex::beta" class="code">beta</a> * qs.<a href="#Vertex::f" class="code">f</a>(sampled) * vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::Tr" class="code">Tr</a>(scene, sampler) * sampled.<a href="#Vertex::beta" class="code">beta</a>;
if (qs.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
    L *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, qs.<a href="#Vertex::ns" class="code">ns</a>());</div><p>


</p>
<p>We omit the next case, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1803" y="0"></use>
</g>
</svg>, here. It corresponds to performing a direct
lighting calculation at the last vertex of the camera subpath.  Its
implementation is similar to the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> case&mdash;the main differences are that
roles of lights and cameras are exchanged and that a light source must be
chosen using <tt>lightDistr</tt> before a light sample can be generated.

</p>
<p>

</p>
<p>The last case, &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleallotherbidirectionalconnectioncases-0">Handle all other bidirectional connection cases</a></span>&gt;&gt;,
is responsible for most types of connections: it applies whenever the
camera and light subpath prefixes are long enough so that no special cases
are triggered (i.e., when <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.225ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 3110.7 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s comma t greater-than 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3E" d="M688 230l-581 -275c-25 -11 -42 25 -18 36l548 259l-548 259c-24 11 -7 47 18 36l581 -275c17 -8 17 -32 0 -40Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="469" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="914" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3E" x="1553" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2610" y="0"></use>
</g>
</svg>).
If we consider
the generalized path contribution equation from Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:pathspace-generalized">15.1.1</a>, we have
constructed camera and light subpaths with the incremental path construction
approach used in Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#sec:path-incremental-sampling">14.5.3</a> for regular path
tracing. Given the throughput of these paths up to the current vertices,
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.676ex" height="3.343ex" style="vertical-align: -0.838ex;" viewBox="0 -1078.4 2444 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove upper T With caret left-parenthesis normal q overbar Subscript s Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="704" y="0"></use>
<g transform="translate(1094,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="747" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2054" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.564ex" height="3.343ex" style="vertical-align: -0.838ex;" viewBox="0 -1078.4 2395.6 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove upper T With caret left-parenthesis normal p Subscript Baseline overbar Subscript t Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="704" y="0"></use>
<g transform="translate(1094,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2006" y="0"></use>
</g>
</svg>, respectively, where
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.256ex" height="2.509ex" style="vertical-align: -0.838ex;" viewBox="0 -719.6 8721.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p overbar Subscript t Baseline equals normal p 0 comma normal p 1 comma ellipsis comma normal p Subscript t minus 1 Baseline comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="787" y="-326"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1189" y="0"></use>
<g transform="translate(2246,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3256" y="0"></use>
<g transform="translate(3701,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4712" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="5157" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6161" y="0"></use>
<g transform="translate(6606,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="8442" y="0"></use>
</g>
</svg>
</div>
<p>

and similarly for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.231ex" height="2.509ex" style="vertical-align: -0.838ex;" viewBox="0 -719.6 960.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q overbar Subscript s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="747" y="-326"></use>
</g>
</svg>, we can find that the
contribution of a path of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> light vertices and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 469.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
</g>
</svg> camera vertices is given
by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="60.91ex" height="7.843ex" style="vertical-align: -3.338ex;" viewBox="0 -1939.5 26225 3376.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column ModifyingAbove upper P With caret left-parenthesis normal q overbar Subscript s Baseline normal p overbar Subscript t Baseline right-parenthesis equals upper L Subscript normal e Superscript Baseline ModifyingAbove upper T With caret left-parenthesis normal q overbar Subscript s Baseline right-parenthesis 2nd Column left-bracket ModifyingAbove f With caret left-parenthesis normal q Subscript Baseline Subscript s minus 2 Baseline right-arrow normal q Subscript Baseline Subscript s minus 1 Baseline right-arrow normal p Subscript Baseline Subscript t minus 1 Baseline right-parenthesis ModifyingAbove upper G With caret left-parenthesis normal q Subscript s minus italic 1 Baseline left-right-arrow normal p Subscript t minus italic 1 Baseline right-parenthesis 2nd Row 1st Column Blank 2nd Column ModifyingAbove f With caret left-parenthesis normal q Subscript Baseline Subscript s minus 1 Baseline right-arrow normal p Subscript Baseline Subscript t minus 1 Baseline right-arrow normal p Subscript Baseline Subscript t minus 2 Baseline right-parenthesis right-bracket ModifyingAbove upper T With caret left-parenthesis normal p Subscript Baseline overbar Subscript t Baseline right-parenthesis upper W Subscript normal e Superscript Baseline period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D443" d="M754 532c0 -112 -139 -216 -281 -216h-170l-62 -250c-1 -6 -3 -11 -3 -17c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -20 -20c-21 0 -43 2 -65 2l-64 1l-127 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l134 537c3 12 4 15 4 19 c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h324c131 0 197 -74 197 -151zM661 556c0 69 -53 96 -136 96h-96c-43 0 -45 -3 -54 -38l-68 -272h141c44 0 104 8 154 53c39 36 59 122 59 161Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE2-5B" d="M383 -327c0 -13 -10 -23 -23 -23h-143v1200h143c13 0 23 -10 23 -23s-10 -23 -23 -23h-97v-1108h97c13 0 23 -10 23 -23Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43A" d="M760 695l-63 -255c-5 -18 -5 -20 -18 -20c-4 0 -15 0 -15 10s3 11 3 51c0 116 -59 193 -161 193c-99 0 -196 -61 -250 -129c-105 -130 -115 -295 -115 -326c0 -153 105 -210 201 -210c35 0 165 11 193 121c10 37 21 82 21 91c0 13 -5 16 -31 19c-23 2 -53 2 -53 2 c-22 0 -30 0 -30 11c0 20 12 20 21 20l140 -3c23 0 82 3 105 3c8 0 13 -4 13 -11c0 -19 -11 -20 -16 -20c-57 -1 -58 -3 -69 -48c-4 -17 -9 -34 -13 -51l-19 -77c-5 -21 -15 -59 -17 -61c0 0 -2 -4 -7 -4c-10 0 -36 37 -45 62c-18 -20 -37 -41 -87 -61 c-36 -15 -81 -24 -125 -24c-162 0 -273 115 -273 274c0 232 225 453 448 453c111 0 157 -75 166 -89l70 77c11 11 12 12 15 12c9 0 11 -7 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2194" d="M942 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-686c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4 c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72 h686c-30 20 -56 44 -78 72c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE2-5D" d="M200 850v-1200h-143c-13 0 -23 10 -23 23s10 23 23 23h97v1108h-97c-13 0 -23 10 -23 23s10 23 23 23h143Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,851)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D443" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="672" y="205"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="754" y="0"></use>
<g transform="translate(1144,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="747" y="-326"></use>
</g>
<g transform="translate(2104,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3016" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3683" y="0"></use>
<g transform="translate(4740,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
</g>
<g transform="translate(6002,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6707" y="0"></use>
<g transform="translate(7096,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="747" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="8057" y="0"></use>
</g>
</g>
<g transform="translate(8713,0)">
<g transform="translate(0,851)">
 <use xlink:href="#E1-LATINMODERNSIZE2-5B" x="0" y="0"></use>
<g transform="translate(417,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="539" y="227"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="970" y="0"></use>
<g transform="translate(1359,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1248" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="3502" y="0"></use>
<g transform="translate(4780,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="6923" y="0"></use>
<g transform="translate(8201,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1140" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10017" y="0"></use>
<g transform="translate(10407,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43A" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="615" y="227"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="11193" y="0"></use>
<g transform="translate(11583,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="13672" y="0"></use>
<g transform="translate(14951,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="16787" y="0"></use>
</g>
<g transform="translate(0,-963)">
<g transform="translate(2000,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="539" y="227"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2552" y="0"></use>
<g transform="translate(2942,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="5084" y="0"></use>
<g transform="translate(6362,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1140" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="8457" y="0"></use>
<g transform="translate(9735,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1140" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11552" y="0"></use>
 <use xlink:href="#E1-LATINMODERNSIZE2-5D" x="11941" y="0"></use>
<g transform="translate(12359,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13063" y="0"></use>
<g transform="translate(13453,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="14365" y="0"></use>
<g transform="translate(14921,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="16280" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>

The first and last products involving the emission, importance and
generalized throughput terms, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.221ex" height="3.343ex" style="vertical-align: -0.838ex;" viewBox="0 -1078.4 3539.8 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal e Superscript Baseline ModifyingAbove upper T With caret left-parenthesis normal q overbar Subscript s Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
<g transform="translate(1095,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1800" y="0"></use>
<g transform="translate(2189,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="747" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3150" y="0"></use>
</g>
</svg> for the light path and
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.107ex" height="3.343ex" style="vertical-align: -0.838ex;" viewBox="0 -1078.4 3921.1 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove upper T With caret left-parenthesis normal p Subscript Baseline overbar Subscript t Baseline right-parenthesis upper W Subscript normal e Superscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D44A" d="M1048 672c0 -19 -10 -19 -19 -20c-63 -5 -87 -41 -112 -85l-328 -570c-5 -9 -11 -19 -24 -19c-12 0 -14 5 -16 26l-37 505l-294 -510c-9 -15 -12 -21 -24 -21c-14 0 -15 8 -16 26l-45 611c-2 28 -3 37 -53 37c-16 0 -25 0 -25 12c0 19 13 19 18 19c34 0 70 -3 105 -3 c41 0 83 3 123 3c0 0 14 0 14 -11c0 -20 -11 -20 -21 -20c-76 -1 -76 -24 -76 -36l38 -507l253 441l-6 77c-2 19 -9 25 -53 25c-14 0 -24 0 -24 11c0 20 13 20 19 20c23 0 82 -3 105 -3c40 0 82 3 122 3c4 0 15 -1 15 -11c0 -20 -10 -20 -27 -20c-73 -1 -71 -27 -70 -47 l37 -496l270 471c8 14 13 22 13 33c0 30 -35 38 -59 39c-6 0 -15 1 -15 12c0 19 13 19 19 19c33 0 70 -3 104 -3c25 0 53 3 77 3c8 0 12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="704" y="0"></use>
<g transform="translate(1094,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2006" y="0"></use>
<g transform="translate(2562,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D44A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1335" y="-213"></use>
</g>
</g>
</svg> for the camera path, are already available in the
<a href="#Vertex::beta"><tt>Vertex::beta</tt></a> fields of the connection vertices, so we only need to
compute the term in brackets to find the path&rsquo;s overall contribution. The
symmetric nature of BDPT is readily apparent: the final contribution is
equal to the product of the subpath weights, the BRDF or phase functions
and a (symmetric) generalized geometry term. Note that this strategy cannot
succeed when one of the connection vertices is marked as not
connectible&mdash;in this case, no connection attempt is made.

</p>
<p>The product of subpath weights and the two BSDFs is often&nbsp;0; this
case happens, for example, if the connecting segment requires that light be
transmitted through one of the two surfaces but the corresponding surface
isn&rsquo;t transmissive.  In this case, it&rsquo;s worth avoiding the unnecessary call to
the <a href="#G"><tt>G()</tt></a> function, which traces a shadow ray to test visibility.

</p>
<p></p>
<span class="anchor" id="fragment-Handleallotherbidirectionalconnectioncases-0"></span><div class="fragmentname">&lt;&lt;Handle all other bidirectional connection cases&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">const Vertex &amp;qs = lightVertices[s - 1], &amp;pt = cameraVertices[t - 1];
if (qs.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>() &amp;&amp; pt.<a href="#Vertex::IsConnectible" class="code">IsConnectible</a>()) {
    L = qs.<a href="#Vertex::beta" class="code">beta</a> * qs.<a href="#Vertex::f" class="code">f</a>(pt) * pt.<a href="#Vertex::f" class="code">f</a>(qs) * pt.<a href="#Vertex::beta" class="code">beta</a>;
    if (!L.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>()) L *= <a href="#G" class="code">G</a>(scene, sampler, qs, pt);
}</div><p>


</p>
<p>The generalized geometry term, Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:g-generalized">15.5</a>), is
computed in a separate function <a href="#G"><tt>G()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTUtilityFunctions-4"></span><div class="fragmentname">&lt;&lt;BDPT Utility Functions&gt;&gt;+=&nbsp;<a href="#fragment-BDPTUtilityFunctions-3"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-BDPTUtilityFunctions-5"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a> <span class="anchor" id="G"></span>G(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> &amp;sampler, const Vertex &amp;v0,
           const Vertex &amp;v1) {
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> d = v0.<a href="#Vertex::p" class="code">p</a>() - v1.<a href="#Vertex::p" class="code">p</a>();
    Float g = 1 / d.<a href="../Geometry_and_Transformations/Vectors.html#Vector3::LengthSquared" class="code">LengthSquared</a>();
    d *= std::sqrt(g);
    if (v0.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
        g *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(v0.<a href="#Vertex::ns" class="code">ns</a>(), d);
    if (v1.<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
        g *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(v1.<a href="#Vertex::ns" class="code">ns</a>(), d);
    <a href="../Light_Sources/Light_Interface.html#VisibilityTester" class="code">VisibilityTester</a> vis(v0.<a href="#Vertex::GetInteraction" class="code">GetInteraction</a>(), v1.<a href="#Vertex::GetInteraction" class="code">GetInteraction</a>());
    return g * vis.<a href="../Light_Sources/Light_Interface.html#VisibilityTester::Tr" class="code">Tr</a>(scene, sampler);
}</div><p>


</p>
<p>The computation of the multiple importance sampling weight for the connected
path is implemented as a separate function <tt>MISWeight()</tt>, which we
discuss next.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeMISweightforconnectionstrategy-0"></span><div class="fragmentname">&lt;&lt;Compute MIS weight for connection strategy&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float misWeight = L.<a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum::IsBlack" class="code">IsBlack</a>() ? 0.f :
     <a href="#MISWeight" class="code">MISWeight</a>(scene, lightVertices, cameraVertices, sampled, s, t,
               lightDistr);
L *= misWeight;
if (misWeightPtr) *misWeightPtr = misWeight;</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#MultipleImportanceSampling"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:mis-computation"></span><span id="MultipleImportanceSampling"></span><h3>16.3.4  Multiple Importance Sampling</h3><p>



</p>
<p>Recall the example of a light pointed up at the ceiling, indirectly
illuminating a room.  Even without multiple importance sampling,
bidirectional path tracing will do much better than path tracing by
reducing the number of paths with no contribution, since the paths from the
light provide camera path vertices more light-carrying targets to hit with
connection segments (see Figure 16.17, which shows the effectiveness of
various types of bidirectional connections).
However, the image will still suffer from variance caused by paths with unexpectedly
large contributions due to vertices on the camera subpaths that happen to
find the bright spot on the ceiling. MIS can be applied to address this
issue; it automatically recognizes that connection strategies that involve
at least one scattering event on the light subpath lead to superior
sampling strategies in this case. 
This ability comes at the cost of having to know the probabilities for
constructing a path according to all available strategies and is the reason for
caching the <a href="#Vertex::pdfFwd"><tt>Vertex::pdfFwd</tt></a> and <a href="#Vertex::pdfRev"><tt>Vertex::pdfRev</tt></a> values earlier.

</p>
<p>

</p>
<p>In this section, we will explain the <a href="#MISWeight"><tt>MISWeight()</tt></a> function that
computes the multiple importance sampling weight associated with a
particular BDPT sampling strategy. It takes a light and camera subpath and
an integer pair <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.773ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2055.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis s comma t right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="859" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="1304" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1665" y="0"></use>
</g>
</svg> identifying the prefixes used by a successful BDPT
connection attempt, producing a complete path <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.013ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 9908.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q 0 comma ellipsis comma normal q Subscript s minus 1 Baseline comma normal p Subscript t minus 1 Baseline comma ellipsis comma normal p 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="982" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="1427" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2431" y="0"></use>
<g transform="translate(2876,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4741" y="0"></use>
<g transform="translate(5186,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1140" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7003" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="7448" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="8452" y="0"></use>
<g transform="translate(8897,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
</g>
</svg>. It iterates over all
alternative strategies that could hypothetically have generated the same
input path but with an earlier or later crossover point between the light
and camera subpaths.  Figure&nbsp;<a href="#fig:bdpt-mis">16.16</a> shows the basic idea
and Figure&nbsp;<a href="#fig:bdpt-mis-before">16.17</a> shows images from the various
strategies individually.

</p>
<p></p>
<span class="anchor" id="fig:bdpt-mis"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="Bidir%20four%20strategies.svg" title=""><img src="Bidir%20four%20strategies.svg" width=625 height=526 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 16.16: Multiple Importance Sampling in the Context of BDPT.
<span class="legend"> Given a specific connection strategy <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.295ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 5724.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis s equals 2 comma t equals 2 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1136" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="2193" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2693" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="3138" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3778" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="4834" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5334" y="0"></use>
</g>
</svg> shown at the top, 
<a href="#MISWeight"><tt>MISWeight()</tt></a> considers other strategies that could have produced the same
path (bottom). The <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1695" y="0"></use>
</g>
</svg> case is omitted for simplicity. (It only makes sense in
systems where the sensor of the camera can be intersected by rays.)</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p> </p>
<span class="anchor" id="fig:bdpt-mis-before"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 50.118%; position:relative;">
<div id="bdpt-strategies.png69" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('bdpt-strategies.png69'), { image: 'bdpt-strategies.png' });
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 16.17: The Individual BDPT Strategies. <span class="legend">
Each row corresponds to light paths of a certain length. Note how almost
every sampling strategy has deficiencies of some kind, evident in the form 
of high variance in these images. (Regular path tracing only samples
the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1803" y="0"></use>
</g>
</svg> paths.)  Applying multiple importance sampling to
path contributions is an effective way to reduce this variance.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The function then
reweights the path contribution using the balance heuristic from
Section&nbsp;<a href="../Monte_Carlo_Integration/Importance_Sampling.html#sec:multiple-importance-sampling">13.10.1</a>, taking all of these
possible sampling strategies into account.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="To keep the
implementation simple, each vertex is assumed to be sampled from a
2D probability distribution. This may lead to slightly
sub-optimal weights in participating media, where the distance sampling
along rays causes the vertices to be distributed in three dimensions,
though the method remains unbiased despite this inaccuracy.">
      <sup>&dagger;</sup>
    </button>
		 It is
straightforward to switch to other MIS variants (e.g., based on the power heuristic) if
desired.

</p>
<p>Weighted versions of the images in Figure&nbsp;<a href="#fig:bdpt-mis-before">16.17</a> are
shown in Figure&nbsp;<a href="#fig:bdpt-mis-after">16.18</a>.

</p>
<p>
 </p>
<span class="anchor" id="fig:bdpt-mis-after"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 50.118%; position:relative;">
<div id="bdpt-weighted.png70" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('bdpt-weighted.png70'), { image: 'bdpt-weighted.png' });
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 16.18: Variance Reduction Due to Multiple Importance Sampling. <span class="legend">
The same sampling strategies as in Figure&nbsp;<a href="#fig:bdpt-mis-before">16.17</a>, but
now weighted using multiple importance sampling&mdash;effectively &ldquo;turning
off&rdquo; each strategy where it does not perform well. The final result is
computed by summing all of these images.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Let <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.773ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2055.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis s comma t right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="859" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="1304" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1665" y="0"></use>
</g>
</svg> denote the currently considered connection strategy, which
concatenates a prefix <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.013ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 4741.8 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q 0 comma ellipsis comma normal q Subscript s minus 1 Baseline</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="982" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="1427" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2431" y="0"></use>
<g transform="translate(2876,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
</g>
</svg> from the light subpath
and a (reversed) prefix <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.966ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 4721.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t minus 1 Baseline comma ellipsis comma normal p 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1140" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1816" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="2261" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3265" y="0"></use>
<g transform="translate(3711,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
</g>
</svg>
from the camera subpath, producing a path
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.227ex" height="1.843ex" style="vertical-align: -0.002ex; margin-bottom: -0.336ex;" viewBox="0 -647.8 528.5 793.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal x Subscript Baseline overbar</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
</svg> of length <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.264ex" height="2.176ex" style="vertical-align: -0.505ex;" viewBox="0 -719.6 3988.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n equals s plus t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="878" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="1934" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2626" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="3627" y="0"></use>
</g>
</svg> with vertices that we will refer to as <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.917ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 825.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal x Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
</svg> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.366ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4893.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis 0 less-than-or-equal-to i less-than n right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2264" d="M691 75c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259zM702 -99c0 -11 -9 -20 -20 -20h-586c-11 0 -20 9 -20 20s9 20 20 20h586c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3C" d="M689 -9c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2264" x="1167" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="2224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3C" x="2847" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="3903" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4504" y="0"></use>
</g>
</svg>:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="45.859ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 19744.8 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal x Subscript Baseline overbar equals left-parenthesis normal x 0 comma ellipsis comma normal x Subscript n minus italic 1 Baseline right-parenthesis equals left-parenthesis normal q 0 comma ellipsis comma normal q Subscript s minus 1 Baseline comma normal p Subscript t minus 1 Baseline comma ellipsis comma normal p 0 right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="806" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1862" y="0"></use>
<g transform="translate(2252,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3234" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="3679" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4683" y="0"></use>
<g transform="translate(5128,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1335" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7055" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="7722" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="8778" y="0"></use>
<g transform="translate(9168,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="10150" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="10595" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="11600" y="0"></use>
<g transform="translate(12045,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="13910" y="0"></use>
<g transform="translate(14355,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1140" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="16171" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="16617" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="17621" y="0"></use>
<g transform="translate(18066,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="19076" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="19466" y="0"></use>
</g>
</svg>
</div>
<p>

Suppose that the probability per unit area of vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.917ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 825.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal x Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
</svg> is given by
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.844ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2946.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Superscript right-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2525" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.844ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2946.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Superscript left-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2190" d="M942 250c0 -11 -9 -20 -20 -20h-766c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127 c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72h766c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2525" y="0"></use>
</g>
</svg> for sampling strategies
based on importance and radiance transport, respectively. Then the area product
density of the current path is simply the product of the importance transport
densities up to vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1811.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal x Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
</svg> and the radiance transport densities
for the remainder:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="48.351ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 20817.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis equals p Superscript right-arrow Baseline left-parenthesis normal x 0 right-parenthesis midline-horizontal-ellipsis p Superscript right-arrow Baseline left-parenthesis normal x Subscript s minus 1 Baseline right-parenthesis dot p Superscript left-arrow Baseline left-parenthesis normal x Subscript s Baseline right-parenthesis midline-horizontal-ellipsis p Superscript left-arrow Baseline left-parenthesis normal x Subscript n minus 1 Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-22EF" d="M162 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM441 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM720 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-22C5" d="M192 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2190" d="M942 250c0 -11 -9 -20 -20 -20h-766c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127 c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72h766c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="935" y="0"></use>
<g transform="translate(1324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1853" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2520" y="0"></use>
<g transform="translate(3577,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4888" y="0"></use>
<g transform="translate(5277,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6259" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="6816" y="0"></use>
<g transform="translate(7759,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="9070" y="0"></use>
<g transform="translate(9459,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11271" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="11883" y="0"></use>
<g transform="translate(12383,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13694" y="0"></use>
<g transform="translate(14084,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="14991" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="15548" y="0"></use>
<g transform="translate(16491,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="17802" y="0"></use>
<g transform="translate(18191,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1335" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="20118" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="20507" y="0"></use>
</g>
</svg>
</div>
<p>

Implementation-wise, the above expression is straightforward to evaluate:
the importance transport densities <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.954ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2994.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Superscript right-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2573" y="0"></use>
</g>
</svg> are already
cached in the <a href="#Vertex::pdfFwd"><tt>Vertex::pdfFwd</tt></a> fields of the light subpath, and the
same holds true for the radiance transport densities on the camera subpath.

</p>
<p>More generally, we are also interested in the path density according to
other connection strategies <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.604ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 1982.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis i comma j right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="735" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D457" x="1180" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1592" y="0"></use>
</g>
</svg> that could <em>in theory</em> have created
this path. This requires that they generate paths of a compatible length&mdash;i.e.,
that <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.47ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 5368.9 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus j equals s plus t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D457" x="1568" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2258" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="3315" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="4006" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="5007" y="0"></use>
</g>
</svg>. Their corresponding path density is given by 
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:path-density"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="47.986ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 20660.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis equals p Superscript right-arrow Baseline left-parenthesis normal x 0 right-parenthesis midline-horizontal-ellipsis p Superscript right-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis dot p Superscript left-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis midline-horizontal-ellipsis p Superscript left-arrow Baseline left-parenthesis normal x Subscript n minus 1 Baseline right-parenthesis comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-22EF" d="M162 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM441 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM720 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-22C5" d="M192 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2190" d="M942 250c0 -11 -9 -20 -20 -20h-766c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127 c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72h766c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2433" y="0"></use>
<g transform="translate(3489,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4800" y="0"></use>
<g transform="translate(5189,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6172" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="6728" y="0"></use>
<g transform="translate(7671,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="8982" y="0"></use>
<g transform="translate(9372,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11149" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="11760" y="0"></use>
<g transform="translate(12261,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13572" y="0"></use>
<g transform="translate(13962,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="14834" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="15391" y="0"></use>
<g transform="translate(16334,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="17645" y="0"></use>
<g transform="translate(18034,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1335" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="19961" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="20350" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:path-density">16.17</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.557ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 4114.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0 less-than-or-equal-to i less-than-or-equal-to n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2264" d="M691 75c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259zM702 -99c0 -11 -9 -20 -20 -20h-586c-11 0 -20 9 -20 20s9 20 20 20h586c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2264" x="778" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1834" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2264" x="2457" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="3514" y="0"></use>
</g>
</svg>.  Evaluating these will also involve the reverse
probabilities in <a href="#Vertex::pdfRev"><tt>Vertex::pdfRev</tt></a>.

</p>
<p>Recall from Section&nbsp;<a href="../Monte_Carlo_Integration/Importance_Sampling.html#sec:multiple-importance-sampling">13.10.1</a>
that the balance heuristic weight for strategy <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 469.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
</g>
</svg> out of a set of
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
</g>
</svg> sampling strategies with uniform sample allocation was given by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:balance-heuristic-inefficient"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="18.932ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 8151.3 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis equals StartFraction p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over sigma-summation Underscript i Endscripts p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNOPERATORS-2211" d="M999 -1l-86 -249h-829c-18 0 -27 0 -27 11c0 4 1 6 9 16l355 439l-365 502c0 31 1 32 28 32h829l86 -234h-25c-70 187 -300 194 -414 194h-396l325 -446c6 -9 7 -10 7 -14s-2 -7 -9 -16l-347 -429h425c147 0 216 24 232 29c85 29 152 90 177 165h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="1013" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1148" y="0"></use>
<g transform="translate(1537,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2066" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2733" y="0"></use>
<g transform="translate(3512,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3842" height="60" x="0" y="220"></rect>
<g transform="translate(799,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="935" y="0"></use>
<g transform="translate(1324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1853" y="0"></use>
</g>
<g transform="translate(60,-771)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
<g transform="translate(1567,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2415" y="0"></use>
<g transform="translate(2804,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3333" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="7872" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:balance-heuristic-inefficient">16.18</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

This is the expression we would like to evaluate in <a href="#MISWeight"><tt>MISWeight()</tt></a>, though
there are two practical issues that must first be addressed.

</p>
<p>First, path densities can easily under- or overflow the range of
representable values in single or even double precision.  Area densities of
individual vertices can be seen to be inversely proportional to the square
of the scene dimensions: for instance, uniformly scaling the scene to half
its size will quadruple the vertex densities. When computing the area
product density of a path with 10 vertices, the same scaling operation
will cause an increase in path density of approximately
one million times.  When working with
very small or large scenes (compared to a box of unit volume), the floating
point exponent of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.079ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2186.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
</svg> can quickly exceed the valid range.

</p>
<p>

</p>
<p>Second, a naive MIS implementation has time complexity of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2596.9 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper O left-parenthesis n Superscript 4 Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D442" d="M740 436c0 -239 -223 -458 -435 -458c-144 0 -256 101 -256 267c0 233 220 460 436 460c149 0 255 -108 255 -269zM651 475c0 149 -90 205 -172 205c-79 0 -177 -52 -246 -156c-77 -117 -91 -263 -91 -307c0 -132 70 -213 169 -213c84 0 166 59 214 120 c99 123 126 279 126 351Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D442" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-34" x="849" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2207" y="0"></use>
</g>
</svg>, where
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
</g>
</svg> is the maximum path length.  Evaluation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.079ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2186.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
</svg> based on
Equation&nbsp;(<a href="#eq:path-density">16.17</a>) involves a linear sweep over <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
</g>
</svg> vertices,
and the MIS weight in Equation&nbsp;(<a href="#eq:balance-heuristic-inefficient">16.18</a>)
requires another sweep over <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
</g>
</svg> strategies. Given that this must be done
once per connection strategy for a number of strategies that is
proportional to the square of the subpath length, we are left with an
algorithm of quartic complexity.

</p>
<p>We will avoid both of these issues by using a more efficient incremental computation that
works with ratios of probability densities to achieve better numerical and
run-time behavior.

</p>
<p>Dividing both the numerator and denominator of
Equation&nbsp;(<a href="#eq:balance-heuristic-inefficient">16.18</a>) by <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.283ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2274.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="935" y="0"></use>
<g transform="translate(1324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1853" y="0"></use>
</g>
</svg> yields
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:balance-heuristic-bdpt"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="53.917ex" height="8.843ex" style="vertical-align: -4.505ex; margin-right: -1.289ex;" viewBox="0 -1867.7 23214 3807.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis equals StartStartFraction 1 OverOver sigma-summation Underscript i Endscripts StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction EndEndFraction equals left-parenthesis sigma-summation Underscript i equals 0 Overscript s minus 1 Endscripts StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction plus 1 plus sigma-summation Underscript i equals s plus 1 Overscript n Endscripts StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction right-parenthesis Superscript negative 1 Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNOPERATORS-2211" d="M999 -1l-86 -249h-829c-18 0 -27 0 -27 11c0 4 1 6 9 16l355 439l-365 502c0 31 1 32 28 32h829l86 -234h-25c-70 187 -300 194 -414 194h-396l325 -446c6 -9 7 -10 7 -14s-2 -7 -9 -16l-347 -429h425c147 0 216 24 232 29c85 29 152 90 177 165h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE5-28" d="M608 -780c0 -9 -7 -16 -16 -16c-4 0 -7 1 -10 3c-199 150 -381 545 -381 893v300c0 348 182 743 381 893c3 2 6 3 10 3c9 0 16 -7 16 -16c0 -5 -3 -10 -6 -13c-190 -142 -323 -535 -323 -867v-300c0 -332 133 -725 323 -867c3 -3 6 -8 6 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE5-29" d="M462 100c0 -348 -182 -743 -382 -893c-2 -2 -6 -3 -9 -3c-9 0 -16 7 -16 16c0 5 2 10 6 13c190 142 323 535 323 867v300c0 332 -133 725 -323 867c-4 3 -6 8 -6 13c0 9 7 16 16 16c3 0 7 -1 9 -3c200 -150 382 -545 382 -893v-300Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="1013" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1148" y="0"></use>
<g transform="translate(1537,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2066" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2733" y="0"></use>
<g transform="translate(3512,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3668" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1583" y="676"></use>
<g transform="translate(60,-1170)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
<g transform="translate(1400,0)">
<g transform="translate(286,0)">
<rect stroke="none" width="1740" height="60" x="0" y="220"></rect>
<g transform="translate(95,620)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="620" y="-291"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-28" x="883" y="0"></use>
<g transform="translate(900,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-AF" x="13" y="-4"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-29" x="1801" y="0"></use>
</g>
<g transform="translate(60,-475)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="620" y="-291"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-28" x="984" y="0"></use>
<g transform="translate(971,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-AF" x="13" y="-4"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-29" x="1902" y="0"></use>
</g>
</g>
</g>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="7976" y="0"></use>
 <use xlink:href="#E1-LATINMODERNSIZE5-28" x="8754" y="0"></use>
<g transform="translate(9584,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
<g transform="translate(147,-1090)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="1124" y="0"></use>
</g>
<g transform="translate(104,1151)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
<g transform="translate(11029,0)">
<g transform="translate(286,0)">
<rect stroke="none" width="2362" height="60" x="0" y="220"></rect>
<g transform="translate(103,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="935" y="0"></use>
<g transform="translate(1324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1853" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="14021" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="15021" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="15744" y="0"></use>
<g transform="translate(16745,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="293" y="0"></use>
<g transform="translate(0,-1090)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="1124" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1593" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="2372" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1136" y="1627"></use>
</g>
<g transform="translate(18776,0)">
<g transform="translate(286,0)">
<rect stroke="none" width="2362" height="60" x="0" y="220"></rect>
<g transform="translate(103,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="935" y="0"></use>
<g transform="translate(1324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1853" y="0"></use>
</g>
</g>
</g>
<g transform="translate(21546,0)">
 <use xlink:href="#E1-LATINMODERNSIZE5-29" x="0" y="0"></use>
<g transform="translate(663,1023)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="778" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="22380" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:balance-heuristic-bdpt">16.19</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

The two sums above consider alternative strategies that would have taken
additional steps on the camera or light subpath, respectively. Let us 
define a more concise notation for the individual summand terms:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.676ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 6318.8 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis equals StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="795" y="0"></use>
<g transform="translate(1185,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1713" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2381" y="0"></use>
<g transform="translate(3159,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="2362" height="60" x="0" y="220"></rect>
<g transform="translate(103,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="935" y="0"></use>
<g transform="translate(1324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1853" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="6040" y="0"></use>
</g>
</svg>
</div>
<p>

These satisfy the following recurrence relations:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:balance-heuristic-recurrence"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="53.191ex" height="13.509ex" style="vertical-align: -6.171ex;" viewBox="0 -3159.4 22901.6 5816.5" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column r Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis 2nd Column equals StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript i plus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction StartFraction p Subscript i plus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction equals StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript i plus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction r Subscript i plus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis left-parenthesis i less-than s right-parenthesis comma 2nd Row 1st Column r Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis 2nd Column equals StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript i minus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction StartFraction p Subscript i minus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript s Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction equals StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript i minus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction r Subscript i minus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis left-parenthesis i greater-than s right-parenthesis period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3C" d="M689 -9c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3E" d="M688 230l-581 -275c-25 -11 -42 25 -18 36l548 259l-548 259c-24 11 -7 47 18 36l581 -275c17 -8 17 -32 0 -40Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,1517)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="795" y="0"></use>
<g transform="translate(1185,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1713" y="0"></use>
</g>
<g transform="translate(0,-1518)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="795" y="0"></use>
<g transform="translate(1185,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1713" y="0"></use>
</g>
</g>
<g transform="translate(2370,0)">
<g transform="translate(0,1517)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(778,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3179" height="60" x="0" y="220"></rect>
<g transform="translate(512,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1752" y="0"></use>
<g transform="translate(2141,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2670" y="0"></use>
</g>
</g>
</g>
<g transform="translate(4642,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="3179" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1752" y="0"></use>
<g transform="translate(2141,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2670" y="0"></use>
</g>
<g transform="translate(468,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="935" y="0"></use>
<g transform="translate(1324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1853" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="8340" y="0"></use>
<g transform="translate(9118,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3179" height="60" x="0" y="220"></rect>
<g transform="translate(512,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1752" y="0"></use>
<g transform="translate(2141,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2670" y="0"></use>
</g>
</g>
</g>
<g transform="translate(12982,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="14682" y="0"></use>
<g transform="translate(15072,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15600" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="16990" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="17379" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3C" x="18003" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="19059" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="19529" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="19918" y="0"></use>
</g>
<g transform="translate(0,-1518)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(778,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3179" height="60" x="0" y="220"></rect>
<g transform="translate(512,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1752" y="0"></use>
<g transform="translate(2141,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2670" y="0"></use>
</g>
</g>
</g>
<g transform="translate(4642,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="3179" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1752" y="0"></use>
<g transform="translate(2141,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2670" y="0"></use>
</g>
<g transform="translate(468,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="935" y="0"></use>
<g transform="translate(1324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1853" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="8340" y="0"></use>
<g transform="translate(9118,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3179" height="60" x="0" y="220"></rect>
<g transform="translate(512,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1752" y="0"></use>
<g transform="translate(2141,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2670" y="0"></use>
</g>
</g>
</g>
<g transform="translate(12982,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="14682" y="0"></use>
<g transform="translate(15072,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15600" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="16990" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="17379" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3E" x="18003" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="19059" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="19529" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="19918" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:balance-heuristic-recurrence">16.20</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

The recurrence weights in the above equations are ratios of path densities of two 
adjacent sampling strategies, which differ only in how a single vertex is
generated. Thus, they can be reduced to probability ratios of the affected vertex:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="75.574ex" height="13.509ex" style="vertical-align: -6.171ex;" viewBox="0 -3159.4 32538.9 5816.5" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript i plus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction 2nd Column equals StartFraction p Superscript right-arrow Baseline left-parenthesis normal x 0 right-parenthesis midline-horizontal-ellipsis p Superscript right-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis dot p Superscript left-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis dot p Superscript left-arrow Baseline left-parenthesis normal x Subscript i plus 1 Baseline right-parenthesis midline-horizontal-ellipsis p Superscript left-arrow Baseline left-parenthesis normal x Subscript n minus 1 Baseline right-parenthesis Over p Superscript right-arrow Baseline left-parenthesis normal x 0 right-parenthesis midline-horizontal-ellipsis p Superscript right-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis dot p Superscript right-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis dot p Superscript left-arrow Baseline left-parenthesis normal x Subscript i plus 1 Baseline right-parenthesis midline-horizontal-ellipsis p Superscript left-arrow Baseline left-parenthesis normal x Subscript n minus 1 Baseline right-parenthesis EndFraction equals StartFraction p Superscript left-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis Over p Superscript right-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis EndFraction comma 2nd Row 1st Column StartFraction p Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis Over p Subscript i minus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis EndFraction 2nd Column equals StartFraction p Superscript right-arrow Baseline left-parenthesis normal x 0 right-parenthesis midline-horizontal-ellipsis p Superscript right-arrow Baseline left-parenthesis normal x Subscript i minus 2 Baseline right-parenthesis dot p Superscript right-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis dot p Superscript left-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis midline-horizontal-ellipsis p Superscript left-arrow Baseline left-parenthesis normal x Subscript n minus 1 Baseline right-parenthesis Over p Superscript right-arrow Baseline left-parenthesis normal x 0 right-parenthesis midline-horizontal-ellipsis p Superscript right-arrow Baseline left-parenthesis normal x Subscript i minus 2 Baseline right-parenthesis dot p Superscript left-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis dot p Superscript left-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis midline-horizontal-ellipsis p Superscript left-arrow Baseline left-parenthesis normal x Subscript n minus 1 Baseline right-parenthesis EndFraction equals StartFraction p Superscript right-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis Over p Superscript left-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis EndFraction period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-22EF" d="M162 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM441 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM720 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-22C5" d="M192 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2190" d="M942 250c0 -11 -9 -20 -20 -20h-766c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127 c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72h766c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,1517)">
<g transform="translate(120,0)">
<rect stroke="none" width="3179" height="60" x="0" y="220"></rect>
<g transform="translate(512,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1752" y="0"></use>
<g transform="translate(2141,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2670" y="0"></use>
</g>
</g>
</g>
<g transform="translate(47,-1518)">
<g transform="translate(120,0)">
<rect stroke="none" width="3132" height="60" x="0" y="220"></rect>
<g transform="translate(488,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="847" y="0"></use>
<g transform="translate(1237,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1765" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1704" y="0"></use>
<g transform="translate(2094,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2622" y="0"></use>
</g>
</g>
</g>
</g>
<g transform="translate(3687,0)">
<g transform="translate(0,1517)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(778,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="21429" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2682" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="3239" y="0"></use>
<g transform="translate(4182,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5493" y="0"></use>
<g transform="translate(5882,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7612" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="8224" y="0"></use>
<g transform="translate(8724,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="10035" y="0"></use>
<g transform="translate(10425,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11250" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="11862" y="0"></use>
<g transform="translate(12363,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13674" y="0"></use>
<g transform="translate(14063,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15793" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="16349" y="0"></use>
<g transform="translate(17292,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="18603" y="0"></use>
<g transform="translate(18993,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1335" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="20919" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="408"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2682" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="3239" y="0"></use>
<g transform="translate(4182,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5493" y="0"></use>
<g transform="translate(5882,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7612" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="8224" y="0"></use>
<g transform="translate(8724,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="10035" y="0"></use>
<g transform="translate(10425,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11250" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="11862" y="0"></use>
<g transform="translate(12363,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13674" y="0"></use>
<g transform="translate(14063,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15793" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="16349" y="0"></use>
<g transform="translate(17292,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="18603" y="0"></use>
<g transform="translate(18993,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1335" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="20919" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="23003" y="0"></use>
<g transform="translate(23781,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3035" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2525" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="408"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2525" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="27334" y="0"></use>
</g>
<g transform="translate(0,-1518)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(778,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="21429" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2682" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="3239" y="0"></use>
<g transform="translate(4182,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5493" y="0"></use>
<g transform="translate(5882,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7612" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="8224" y="0"></use>
<g transform="translate(8724,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="10035" y="0"></use>
<g transform="translate(10425,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="12155" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="12766" y="0"></use>
<g transform="translate(13267,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="14578" y="0"></use>
<g transform="translate(14968,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15793" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="16349" y="0"></use>
<g transform="translate(17292,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="18603" y="0"></use>
<g transform="translate(18993,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1335" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="20919" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="408"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2682" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="3239" y="0"></use>
<g transform="translate(4182,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5493" y="0"></use>
<g transform="translate(5882,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7612" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="8224" y="0"></use>
<g transform="translate(8724,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="10035" y="0"></use>
<g transform="translate(10425,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="12155" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22C5" x="12766" y="0"></use>
<g transform="translate(13267,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="14578" y="0"></use>
<g transform="translate(14968,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15793" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-22EF" x="16349" y="0"></use>
<g transform="translate(17292,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="18603" y="0"></use>
<g transform="translate(18993,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1335" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="20919" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="23003" y="0"></use>
<g transform="translate(23781,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3939" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3430" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="408"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3430" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="28239" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>

Combining this result with
Equation&nbsp;(<a href="#eq:balance-heuristic-recurrence">16.20</a>), we obtain the following
recursive expression for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.848ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 795.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
</g>
</svg>:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:balance-heuristic-recursive"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="42.118ex" height="15.176ex" style="vertical-align: -7.005ex;" viewBox="0 -3518.2 18133.9 6534.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript i Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis equals StartLayout Enlarged left-brace 1st Row 1st Column 1 comma 2nd Column if i equals s 2nd Row 1st Column StartFraction p Superscript left-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis Over p Superscript right-arrow Baseline left-parenthesis normal x Subscript i Baseline right-parenthesis EndFraction r Subscript i plus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis comma 2nd Column if i less-than s period 3rd Row 1st Column StartFraction p Superscript right-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis Over p Superscript left-arrow Baseline left-parenthesis normal x Subscript i minus 1 Baseline right-parenthesis EndFraction r Subscript i minus 1 Baseline left-parenthesis normal x Subscript Baseline overbar right-parenthesis comma 2nd Column if i greater-than s period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7B" d="M425 -238c0 -7 -5 -12 -12 -12c-105 0 -196 52 -196 125v250c0 58 -55 113 -130 113c-7 0 -12 5 -12 12s5 12 12 12c75 0 130 55 130 113v250c0 73 91 125 196 125c7 0 12 -5 12 -12s-5 -12 -12 -12c-75 0 -130 -49 -130 -101v-250c0 -58 -48 -104 -115 -125 c67 -21 115 -67 115 -125v-250c0 -52 55 -101 130 -101c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-66" d="M357 635c0 -24 -15 -44 -44 -44c-27 0 -43 20 -43 43c0 25 18 38 30 42c-15 7 -30 7 -33 7c-44 0 -92 -48 -92 -136v-116h117v-31h-114v-322c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v324h-79v31h79v115c0 106 85 159 155 159 c53 0 90 -33 90 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2190" d="M942 250c0 -11 -9 -20 -20 -20h-766c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127 c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72h766c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3C" d="M689 -9c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3E" d="M688 230l-581 -275c-25 -11 -42 25 -18 36l548 259l-548 259c-24 11 -7 47 18 36l581 -275c17 -8 17 -32 0 -40Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSYMBOLS-23A7" d="M755 724c0 -11 -7 -21 -17 -24c-138 -51 -236 -202 -236 -325v-375h-102v375c0 151 151 312 320 373c3 1 6 2 9 2c14 0 26 -12 26 -26Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSYMBOLS-23A9" d="M755 26c0 -14 -12 -26 -26 -26c-3 0 -6 1 -9 2c-169 61 -320 222 -320 373v375h102v-375c0 -123 98 -274 236 -325c10 -3 17 -13 17 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSYMBOLS-23A8" d="M502 1500v-375c0 -147 -120 -300 -265 -375c145 -75 265 -228 265 -375v-375h-102v375c0 137 -97 300 -236 351c-10 3 -17 13 -17 24s7 21 17 24c139 51 236 214 236 351v375h102Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-E003" d="M502 0h-102v748h102v-748Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="795" y="0"></use>
<g transform="translate(1185,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1713" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2381" y="0"></use>
<g transform="translate(3437,0)">
<g transform="translate(0,3384)">
 <use xlink:href="#E1-LATINMODERNSYMBOLS-23A7" x="0" y="-751"></use>
<g transform="translate(0,-2431.48594) scale(1,2.30906)">
 <use xlink:href="#E1-LATINMODERNSIZE7-E003"></use>
</g>
 <use xlink:href="#E1-LATINMODERNSYMBOLS-23A8" x="0" y="-3885"></use>
<g transform="translate(0,-5565.280940000001) scale(1,2.30906)">
 <use xlink:href="#E1-LATINMODERNSIZE7-E003"></use>
</g>
 <use xlink:href="#E1-LATINMODERNSYMBOLS-23A9" x="0" y="-6269"></use>
</g>
<g transform="translate(1069,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,2584)">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="500" y="0"></use>
</g>
<g transform="translate(0,767)">
<g transform="translate(120,0)">
<rect stroke="none" width="3035" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2525" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="408"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="747" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2525" y="0"></use>
</g>
</g>
<g transform="translate(3442,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5142" y="0"></use>
<g transform="translate(5531,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6060" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6449" y="0"></use>
</g>
<g transform="translate(0,-1868)">
<g transform="translate(120,0)">
<rect stroke="none" width="3939" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2192" x="712" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3430" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2190" x="712" y="408"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1310" y="0"></use>
<g transform="translate(1700,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3430" y="0"></use>
</g>
</g>
<g transform="translate(5175,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6875" y="0"></use>
<g transform="translate(7265,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-78" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="14" y="-49"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7793" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="8183" y="0"></use>
</g>
</g>
<g transform="translate(9451,0)">
<g transform="translate(0,2584)">
 <use xlink:href="#E1-LATINMODERNMAIN-69"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-66" x="278" y="0"></use>
<g transform="translate(917,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="623" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="1679" y="0"></use>
</g>
</g>
<g transform="translate(0,767)">
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="332" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-66" x="610" y="0"></use>
<g transform="translate(1249,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3C" x="623" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="1679" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="3398" y="0"></use>
</g>
<g transform="translate(0,-1868)">
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="332" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-66" x="610" y="0"></use>
<g transform="translate(1249,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3E" x="623" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="1679" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="3398" y="0"></use>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:balance-heuristic-recursive">16.21</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

The main portion of the <a href="#MISWeight"><tt>MISWeight()</tt></a> function accumulates these
probability ratios in a temporary variable <tt>sumRi</tt> using an incremental
evaluation scheme based on Equation&nbsp;(<a href="#eq:balance-heuristic-recursive">16.21</a>). The
last line returns the reciprocal of the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.848ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 795.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
</g>
</svg> terms according to
Equation&nbsp;(<a href="#eq:balance-heuristic-bdpt">16.19</a>). There is also a special case at the
beginning, which directly returns a weight of&nbsp;1 for paths with two
vertices, which can only be generated by a single strategy.

</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-BDPTUtilityFunctions-5"></span><div class="fragmentname">&lt;&lt;BDPT Utility Functions&gt;&gt;+=&nbsp;<a href="#fragment-BDPTUtilityFunctions-4"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="MISWeight"></span>MISWeight(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene, Vertex *lightVertices,
        Vertex *cameraVertices, Vertex &amp;sampled, int s, int t,
        const Distribution1D &amp;lightPdf) {
    if (s + t == 2)
        return 1;
    Float sumRi = 0;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Definehelperfunctionmonoremap0thatdealswithDiracdeltafunctions-0">Define helper function <tt>remap0</tt> that deals with Dirac delta functions</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1803" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1803"><i></i></a><div id="fragbit-1803" class="collapse"><div class="fragmentcode">       auto remap0 = [](float f) -&gt; float { return f != 0 ? f : 1; };</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Temporarilyupdatevertexpropertiesforcurrentstrategy-0">Temporarily update vertex properties for current strategy</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1804" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1804"><i></i></a><div id="fragbit-1804" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-Lookupconnectionverticesandtheirpredecessors-0">Look up connection vertices and their predecessors</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1805" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1805"><i></i></a><div id="fragbit-1805" class="collapse"><div class="fragmentcode">          Vertex *qs      = s &gt; 0 ? &amp;lightVertices[s - 1]  : nullptr,
                 *pt      = t &gt; 0 ? &amp;cameraVertices[t - 1] : nullptr,
                 *qsMinus = s &gt; 1 ? &amp;lightVertices[s - 2]  : nullptr,
                 *ptMinus = t &gt; 1 ? &amp;cameraVertices[t - 2] : nullptr;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatesampledvertexfors1ort1strategy-0">Update sampled vertex for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1803" y="0"></use>
</g>
</svg> or <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> strategy</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1806" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1806"><i></i></a><div id="fragbit-1806" class="collapse"><div class="fragmentcode">          ScopedAssignment&lt;Vertex&gt; a1;
          if (s == 1)      a1 = { qs, sampled };
          else if (t == 1) a1 = { pt, sampled };</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Markconnectionverticesasnon-degenerate-0">Mark connection vertices as non-degenerate</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1807" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1807"><i></i></a><div id="fragbit-1807" class="collapse"><div class="fragmentcode">          ScopedAssignment&lt;bool&gt; a2, a3;
          if (pt) a2 = { &amp;pt-&gt;<a href="#Vertex::delta" class="code">delta</a>, false };
          if (qs) a3 = { &amp;qs-&gt;<a href="#Vertex::delta" class="code">delta</a>, false };</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatereversedensityofvertexpt_t-1-0">Update reverse density of vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.219ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1816.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1140" y="0"></use>
</g>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1808" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1808"><i></i></a><div id="fragbit-1808" class="collapse"><div class="fragmentcode">          ScopedAssignment&lt;Float&gt; a4;
          if (pt)
              a4 = { &amp;pt-&gt;<a href="#Vertex::pdfRev" class="code">pdfRev</a>,
                     s &gt; 0 ? qs-&gt;<a href="#Vertex::Pdf" class="code">Pdf</a>(scene, qsMinus, *pt) :
                             pt-&gt;<a href="#Vertex::PdfLightOrigin" class="code">PdfLightOrigin</a>(scene, *ptMinus, lightPdf) };</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatereversedensityofvertexpt_t-2-0">Update reverse density of vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.219ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1816.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript t minus 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1140" y="0"></use>
</g>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1809" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1809"><i></i></a><div id="fragbit-1809" class="collapse"><div class="fragmentcode">          ScopedAssignment&lt;Float&gt; a5;
          if (ptMinus)
              a5 = { &amp;ptMinus-&gt;<a href="#Vertex::pdfRev" class="code">pdfRev</a>,
                     s &gt; 0 ? pt-&gt;<a href="#Vertex::Pdf" class="code">Pdf</a>(scene, qs, *ptMinus) :
                             pt-&gt;<a href="#Vertex::PdfLight" class="code">PdfLight</a>(scene, *ptMinus) };</div></div>
       &lt;&lt;<span class="fragmentname">Update reverse density of vertices <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.331ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1864.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript Baseline Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.331ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1864.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript Baseline Subscript s minus 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1248" y="0"></use>
</g>
</g>
</svg></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1810" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1810"><i></i></a><div id="fragbit-1810" class="collapse"><div class="fragmentcode"></div></div></div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Considerhypotheticalconnectionstrategiesalongthecamerasubpath-0">Consider hypothetical connection strategies along the camera subpath</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1811" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1811"><i></i></a><div id="fragbit-1811" class="collapse"><div class="fragmentcode">       Float ri = 1;
       for (int i = t - 1; i &gt; 0; --i) {
           ri *= remap0(cameraVertices[i].<a href="#Vertex::pdfRev" class="code">pdfRev</a>) /
                 remap0(cameraVertices[i].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a>);
           if (!cameraVertices[i].<a href="#Vertex::delta" class="code">delta</a> &amp;&amp; !cameraVertices[i - 1].<a href="#Vertex::delta" class="code">delta</a>)
               sumRi += ri;
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Considerhypotheticalconnectionstrategiesalongthelightsubpath-0">Consider hypothetical connection strategies along the light subpath</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1812" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1812"><i></i></a><div id="fragbit-1812" class="collapse"><div class="fragmentcode">       ri = 1;
       for (int i = s - 1; i &gt;= 0; --i) {
           ri *= remap0(lightVertices[i].<a href="#Vertex::pdfRev" class="code">pdfRev</a>) /
                 remap0(lightVertices[i].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a>);
           bool deltaLightvertex = i &gt; 0 ? lightVertices[i - 1].<a href="#Vertex::delta" class="code">delta</a>
                                         : lightVertices[0].<a href="#Vertex::IsDeltaLight" class="code">IsDeltaLight</a>();
           if (!lightVertices[i].<a href="#Vertex::delta" class="code">delta</a> &amp;&amp; !deltaLightvertex)
               sumRi += ri;
       }</div></div>
    return 1 / (1 + sumRi);
}</div><p>


</p>
<p>A helper function <tt>remap0()</tt> returns its
argument while mapping 0-valued arguments to&nbsp;1. It is used to handle the
special case of Dirac delta functions in the path, which have a
continuous density of&nbsp;0. Such degenerate vertices cannot be joined using any
deterministic connection strategy, and their discrete probability cancels when
iterating over the remaining set of strategies because it occurs both in the
numerator and denominator of the summands in
Equation&nbsp;(<a href="#eq:balance-heuristic-bdpt">16.19</a>). The purpose of the helper function
is to temporarily map these densities to a nonzero value to make sure that this
cancellation occurs without causing a division by&nbsp;0.

</p>
<p></p>
<span class="anchor" id="fragment-Definehelperfunctionmonoremap0thatdealswithDiracdeltafunctions-0"></span><div class="fragmentname">&lt;&lt;Define helper function <tt>remap0</tt> that deals with Dirac delta functions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">auto remap0 = [](float f) -&gt; float { return f != 0 ? f : 1; };</div><p>


</p>
<p>To avoid an excessively large number of calls to the various <tt>Vertex</tt>
PDF functions, the weight computation uses the cached probabilities
in <a href="#Vertex::pdfFwd"><tt>Vertex::pdfFwd</tt></a> and <a href="#Vertex::pdfRev"><tt>Vertex::pdfRev</tt></a>. Since these values only
capture information about the original camera and light subpaths, they must
still be updated to match the full path configuration near the crossover
point&mdash;specifically <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1811.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.265ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1836.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</svg> and their
predecessors. This is implemented in the somewhat technical fragment
&lt;&lt;<span class="fragmentname"><a href="#fragment-Temporarilyupdatevertexpropertiesforcurrentstrategy-0">Temporarily update vertex properties for current strategy</a></span>&gt;&gt;, which
we discuss last.

</p>
<p>We iterate over hypothetical strategies that would have taken
additional steps from the light direction, using a temporary variable
<tt>ri</tt> to store the current iterate <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.848ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 795.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="638" y="-213"></use>
</g>
</svg>. The fragment name makes
reference to the camera subpath, since these extra steps involve vertices
that were in reality sampled from the camera side. All vertex densities are passed
through the function <tt>remap0()</tt>, and the ratio is only added to a running sum
when endpoints of the current hypothetical connection strategy are marked as
non-degenerate. The loop terminates before reaching the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.4ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2325.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis n comma 0 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="990" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1435" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1935" y="0"></use>
</g>
</svg> strategy,
which shouldn&rsquo;t be considered since the camera cannot be intersected.

</p>
<p></p>
<span class="anchor" id="fragment-Considerhypotheticalconnectionstrategiesalongthecamerasubpath-0"></span><div class="fragmentname">&lt;&lt;Consider hypothetical connection strategies along the camera subpath&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float ri = 1;
for (int i = t - 1; i &gt; 0; --i) {
    ri *= remap0(cameraVertices[i].<a href="#Vertex::pdfRev" class="code">pdfRev</a>) /
          remap0(cameraVertices[i].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a>);
    if (!cameraVertices[i].<a href="#Vertex::delta" class="code">delta</a> &amp;&amp; !cameraVertices[i - 1].<a href="#Vertex::delta" class="code">delta</a>)
        sumRi += ri;
}</div><p>


</p>
<p>The next step considers additional steps along the light subpath and largely
resembles the previous case. A special case arises when the current strategy
would involve intersecting a light source (i.e., when <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1803" y="0"></use>
</g>
</svg>): this will fail
when the endpoint involves a Dirac delta distribution, hence the additional
test below.

</p>
<p></p>
<span class="anchor" id="fragment-Considerhypotheticalconnectionstrategiesalongthelightsubpath-0"></span><div class="fragmentname">&lt;&lt;Consider hypothetical connection strategies along the light subpath&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">ri = 1;
for (int i = s - 1; i &gt;= 0; --i) {
    ri *= remap0(lightVertices[i].<a href="#Vertex::pdfRev" class="code">pdfRev</a>) /
          remap0(lightVertices[i].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a>);
    bool deltaLightvertex = i &gt; 0 ? lightVertices[i - 1].<a href="#Vertex::delta" class="code">delta</a>
                                  : lightVertices[0].<a href="#Vertex::IsDeltaLight" class="code">IsDeltaLight</a>();
    if (!lightVertices[i].<a href="#Vertex::delta" class="code">delta</a> &amp;&amp; !deltaLightvertex)
        sumRi += ri;
}</div><p>


</p>
<p>Finally, we will define the missing fragment &lt;&lt;<span class="fragmentname"><a href="#fragment-Temporarilyupdatevertexpropertiesforcurrentstrategy-0">Temporarily update vertex
properties for current strategy</a></span>&gt;&gt;, which modifies <a href="#Vertex"><tt>Vertex</tt></a> attributes
with new values specific to the current connection strategy <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.773ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2055.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis s comma t right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="859" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="1304" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1665" y="0"></use>
</g>
</svg>. To reduce
the amount of code needed for both the update and the subsequent cleanup
operations, we will introduce a helper class <a href="#ScopedAssignment"><tt>ScopedAssignment</tt></a> that
temporarily modifies a given variable and then reverts its change when
program execution leaves the scope it was defined in. It
stores a pointer <a href="#ScopedAssignment::target"><tt>ScopedAssignment::target</tt></a> to a memory location of
arbitrary type (specified via the <tt>Type</tt> template parameter) and a
snapshot of the original value in <a href="#ScopedAssignment::backup"><tt>ScopedAssignment::backup</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTHelperDefinitions-1"></span><div class="fragmentname">&lt;&lt;BDPT Helper Definitions&gt;&gt;+=&nbsp;<a href="#fragment-BDPTHelperDefinitions-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-BDPTHelperDefinitions-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">template &lt;typename Type&gt; class <span class="anchor" id="ScopedAssignment"></span>ScopedAssignment {
public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ScopedAssignmentPublicMethods-0">ScopedAssignment Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1813" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1813"><i></i></a><div id="fragbit-1813" class="collapse"><div class="fragmentcode">       ScopedAssignment(Type *<a href="#ScopedAssignment::target" class="code">target</a> = nullptr,
                        Type value = Type()) : <a href="#ScopedAssignment::target" class="code">target</a>(<a href="#ScopedAssignment::target" class="code">target</a>) {
           if (<a href="#ScopedAssignment::target" class="code">target</a>) {
               <a href="#ScopedAssignment::backup" class="code">backup</a> = *<a href="#ScopedAssignment::target" class="code">target</a>;
               *<a href="#ScopedAssignment::target" class="code">target</a> = value;
           }
       }
       ~ScopedAssignment() { if (<a href="#ScopedAssignment::target" class="code">target</a>) *<a href="#ScopedAssignment::target" class="code">target</a> = <a href="#ScopedAssignment::backup" class="code">backup</a>; }
       ScopedAssignment &amp;operator=(ScopedAssignment &amp;&amp;other) {
           <a href="#ScopedAssignment::target" class="code">target</a> = other.<a href="#ScopedAssignment::target" class="code">target</a>;
           <a href="#ScopedAssignment::backup" class="code">backup</a> = other.<a href="#ScopedAssignment::backup" class="code">backup</a>;
           other.<a href="#ScopedAssignment::target" class="code">target</a> = nullptr;
           return *this;
       }</div></div>
private:
    Type *<span class="anchor" id="ScopedAssignment::target"></span>target, <span class="anchor" id="ScopedAssignment::backup"></span>backup;
};</div><p>


</p>
<p>The <a href="#ScopedAssignment"><tt>ScopedAssignment</tt></a> constructor takes a pointer to a target memory
location and overwrites it with the <tt>value</tt> parameter after making a
backup copy. The destructor simply reverts any changes.

</p>
<p></p>
<span class="anchor" id="fragment-ScopedAssignmentPublicMethods-0"></span><div class="fragmentname">&lt;&lt;ScopedAssignment Public Methods&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><span class="anchor" id="ScopedAssignment::ScopedAssignment"></span>ScopedAssignment(Type *<a href="#ScopedAssignment::target" class="code">target</a> = nullptr,
                 Type value = Type()) : <a href="#ScopedAssignment::target" class="code">target</a>(<a href="#ScopedAssignment::target" class="code">target</a>) {
    if (<a href="#ScopedAssignment::target" class="code">target</a>) {
        <a href="#ScopedAssignment::backup" class="code">backup</a> = *<a href="#ScopedAssignment::target" class="code">target</a>;
        *<a href="#ScopedAssignment::target" class="code">target</a> = value;
    }
}
~ScopedAssignment() { if (<a href="#ScopedAssignment::target" class="code">target</a>) *<a href="#ScopedAssignment::target" class="code">target</a> = <a href="#ScopedAssignment::backup" class="code">backup</a>; }
</div><p>


</p>
<p>

</p>
<p>The main update operation then consists of finding the connection vertices
and their predecessors and updating vertex probabilities and other
attributes so that the two <a href="#Vertex"><tt>Vertex</tt></a> arrays reflect the chosen
connection strategy.

</p>
<p></p>
<span class="anchor" id="fragment-Temporarilyupdatevertexpropertiesforcurrentstrategy-0"></span><div class="fragmentname">&lt;&lt;Temporarily update vertex properties for current strategy&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Lookupconnectionverticesandtheirpredecessors-0">Look up connection vertices and their predecessors</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1814" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1814"><i></i></a><div id="fragbit-1814" class="collapse"><div class="fragmentcode">   Vertex *qs      = s &gt; 0 ? &amp;lightVertices[s - 1]  : nullptr,
          *pt      = t &gt; 0 ? &amp;cameraVertices[t - 1] : nullptr,
          *qsMinus = s &gt; 1 ? &amp;lightVertices[s - 2]  : nullptr,
          *ptMinus = t &gt; 1 ? &amp;cameraVertices[t - 2] : nullptr;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Updatesampledvertexfors1ort1strategy-0">Update sampled vertex for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1803" y="0"></use>
</g>
</svg> or <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> strategy</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1815" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1815"><i></i></a><div id="fragbit-1815" class="collapse"><div class="fragmentcode">   ScopedAssignment&lt;Vertex&gt; a1;
   if (s == 1)      a1 = { qs, sampled };
   else if (t == 1) a1 = { pt, sampled };</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Markconnectionverticesasnon-degenerate-0">Mark connection vertices as non-degenerate</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1816" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1816"><i></i></a><div id="fragbit-1816" class="collapse"><div class="fragmentcode">   ScopedAssignment&lt;bool&gt; a2, a3;
   if (pt) a2 = { &amp;pt-&gt;<a href="#Vertex::delta" class="code">delta</a>, false };
   if (qs) a3 = { &amp;qs-&gt;<a href="#Vertex::delta" class="code">delta</a>, false };</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Updatereversedensityofvertexpt_t-1-0">Update reverse density of vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.219ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1816.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1140" y="0"></use>
</g>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1817" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1817"><i></i></a><div id="fragbit-1817" class="collapse"><div class="fragmentcode">   ScopedAssignment&lt;Float&gt; a4;
   if (pt)
       a4 = { &amp;pt-&gt;<a href="#Vertex::pdfRev" class="code">pdfRev</a>,
              s &gt; 0 ? qs-&gt;<a href="#Vertex::Pdf" class="code">Pdf</a>(scene, qsMinus, *pt) :
                      pt-&gt;<a href="#Vertex::PdfLightOrigin" class="code">PdfLightOrigin</a>(scene, *ptMinus, lightPdf) };</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Updatereversedensityofvertexpt_t-2-0">Update reverse density of vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.219ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1816.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript t minus 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1140" y="0"></use>
</g>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1818" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1818"><i></i></a><div id="fragbit-1818" class="collapse"><div class="fragmentcode">   ScopedAssignment&lt;Float&gt; a5;
   if (ptMinus)
       a5 = { &amp;ptMinus-&gt;<a href="#Vertex::pdfRev" class="code">pdfRev</a>,
              s &gt; 0 ? pt-&gt;<a href="#Vertex::Pdf" class="code">Pdf</a>(scene, qs, *ptMinus) :
                      pt-&gt;<a href="#Vertex::PdfLight" class="code">PdfLight</a>(scene, *ptMinus) };</div></div>
&lt;&lt;<span class="fragmentname">Update reverse density of vertices <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.331ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1864.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript Baseline Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.331ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1864.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript Baseline Subscript s minus 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1248" y="0"></use>
</g>
</g>
</svg></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1819" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1819"><i></i></a><div id="fragbit-1819" class="collapse"><div class="fragmentcode"></div></div></div><p>


</p>
<p>We begin by obtaining pointers to the affected connection vertices
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1811.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.265ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1836.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</svg> and their predecessors.

</p>
<p></p>
<span class="anchor" id="fragment-Lookupconnectionverticesandtheirpredecessors-0"></span><div class="fragmentname">&lt;&lt;Look up connection vertices and their predecessors&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Vertex *qs      = s &gt; 0 ? &amp;lightVertices[s - 1]  : nullptr,
       *pt      = t &gt; 0 ? &amp;cameraVertices[t - 1] : nullptr,
       *qsMinus = s &gt; 1 ? &amp;lightVertices[s - 2]  : nullptr,
       *ptMinus = t &gt; 1 ? &amp;cameraVertices[t - 2] : nullptr;</div><p>


</p>
<p>Recall that strategies with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1803" y="0"></use>
</g>
</svg> or <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> perform camera and light source
sampling and thus generate a new endpoint. The implementation accounts for this
by temporarily overriding <tt>*qs</tt> or <tt>*pt</tt> with the sampled vertex
provided via the <tt>sampled</tt> argument of <a href="#MISWeight"><tt>MISWeight()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Updatesampledvertexfors1ort1strategy-0"></span><div class="fragmentname">&lt;&lt;Update sampled vertex for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1803" y="0"></use>
</g>
</svg> or <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1695" y="0"></use>
</g>
</svg> strategy&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">ScopedAssignment&lt;Vertex&gt; a1;
if (s == 1)      a1 = { qs, sampled };
else if (t == 1) a1 = { pt, sampled };</div><p>


</p>
<p>Certain materials in <tt>pbrt</tt> (e.g., the <a href="../Materials/Material_Interface_and_Implementations.html#UberMaterial"><tt>UberMaterial</tt></a>) instantiate both
specular and non-specular <tt>BxDF</tt> lobes, which requires some additional
consideration at this point: suppose the specular lobe of such a material is
sampled while generating the camera or light subpath. In this case, the
associated <a href="#Vertex"><tt>Vertex</tt></a> will have its <a href="#Vertex::delta"><tt>Vertex::delta</tt></a> flag set to
<tt>true</tt>, causing <a href="#MISWeight"><tt>MISWeight()</tt></a> to (correctly) ignore it as a
hypothetical connection vertex when comparing the densities of different
strategies.
On the other hand, it is possible that a BDPT strategy later connects this
degenerate vertex to a vertex on the other subpath using its non-specular
component. In this case, its &ldquo;personality&rdquo; must temporarily change to that of
a non-degenerate vertex. We always force the <tt>Vertex::delta</tt> attribute of
the connection vertices to <tt>false</tt> to account for this possibility.

</p>
<p></p>
<span class="anchor" id="fragment-Markconnectionverticesasnon-degenerate-0"></span><div class="fragmentname">&lt;&lt;Mark connection vertices as non-degenerate&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">ScopedAssignment&lt;bool&gt; a2, a3;
if (pt) a2 = { &amp;pt-&gt;<a href="#Vertex::delta" class="code">delta</a>, false };
if (qs) a3 = { &amp;qs-&gt;<a href="#Vertex::delta" class="code">delta</a>, false };</div><p>


</p>
<p>Next, we will update the reverse sampling densities of the connection
vertices and their predecessors, starting with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.265ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1836.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</svg>. This vertex
was originally sampled on the camera subpath, but it could also have been
reached using an extra step from the light side
(<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="19.909ex" height="2.176ex" style="vertical-align: -0.671ex;" viewBox="0 -647.8 8572.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript s minus 2 Baseline right-arrow normal q Subscript s minus 1 Baseline right-arrow normal p Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1173" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2089" y="0"></use>
<g transform="translate(3367,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="5457" y="0"></use>
<g transform="translate(6735,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</g>
</svg> in three-point form); the resulting
density at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.265ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1836.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
</svg> is evaluated using <a href="#Vertex::Pdf"><tt>Vertex::Pdf()</tt></a>.

</p>
<p>The case <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1803" y="0"></use>
</g>
</svg> is special: here, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.164ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 931.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="787" y="-213"></use>
</g>
</svg> is an intersection with a
light source found on the camera subpath. The alternative reverse sampling
strategy generates a light sample using <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le"><tt>Light::Sample_Le()</tt></a>, and we
evaluate its spatial density with the help of
<a href="#Vertex::PdfLightOrigin"><tt>Vertex::PdfLightOrigin()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Updatereversedensityofvertexpt_t-1-0"></span><div class="fragmentname">&lt;&lt;Update reverse density of vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.219ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1816.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript t minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1140" y="0"></use>
</g>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">ScopedAssignment&lt;Float&gt; a4;
if (pt)
    a4 = { &amp;pt-&gt;<a href="#Vertex::pdfRev" class="code">pdfRev</a>,
           s &gt; 0 ? qs-&gt;<a href="#Vertex::Pdf" class="code">Pdf</a>(scene, qsMinus, *pt) :
                   pt-&gt;<a href="#Vertex::PdfLightOrigin" class="code">PdfLightOrigin</a>(scene, *ptMinus, lightPdf) };</div><p>


</p>
<p>The next fragment initializes the <tt>pdfRev</tt> field of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.265ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1836.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript t minus 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1168" y="0"></use>
</g>
</g>
</svg>
with the density of the reverse strategy
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="19.966ex" height="2.176ex" style="vertical-align: -0.671ex;" viewBox="0 -647.8 8596.6 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript s minus 1 Baseline right-arrow normal p Subscript t minus 1 Baseline right-arrow normal p Subscript t minus 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="394" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1173" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2089" y="0"></use>
<g transform="translate(3367,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1168" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="5481" y="0"></use>
<g transform="translate(6760,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1168" y="0"></use>
</g>
</g>
</g>
</svg>. Once more, there is a special case for
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.351ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2304.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="747" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1803" y="0"></use>
</g>
</svg>, where the alternative reverse strategy samples an emitted ray via
<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#Light::Sample_Le"><tt>Light::Sample_Le()</tt></a> and intersects it against the scene geometry; the
corresponding density is evaluated using <a href="#Vertex::PdfLight"><tt>Vertex::PdfLight()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Updatereversedensityofvertexpt_t-2-0"></span><div class="fragmentname">&lt;&lt;Update reverse density of vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.219ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1816.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript t minus 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1140" y="0"></use>
</g>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">ScopedAssignment&lt;Float&gt; a5;
if (ptMinus)
    a5 = { &amp;ptMinus-&gt;<a href="#Vertex::pdfRev" class="code">pdfRev</a>,
           s &gt; 0 ? pt-&gt;<a href="#Vertex::Pdf" class="code">Pdf</a>(scene, qs, *ptMinus) :
                   pt-&gt;<a href="#Vertex::PdfLight" class="code">PdfLight</a>(scene, *ptMinus) };</div><p>


</p>
<p>The last fragment, &lt;&lt;<span class="fragmentname">Update reverse density of vertices <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.331ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1864.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript Baseline Subscript s minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1248" y="0"></use>
</g>
</g>
</svg>
and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.331ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1864.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal q Subscript Baseline Subscript s minus 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-71" d="M527 -194l-113 3l-112 -3v31c67 0 78 0 78 45v179c-22 -29 -63 -72 -133 -72c-116 0 -213 101 -213 226c0 130 105 227 221 227c80 0 121 -63 134 -91l38 91h22v-560c0 -45 11 -45 78 -45v-31zM383 136v141c0 53 -42 140 -122 140c-74 0 -144 -83 -144 -202 c0 -115 61 -204 134 -204c47 0 79 27 92 41c22 24 40 52 40 84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D460" d="M420 356c0 -39 -24 -56 -46 -56s-31 15 -31 29c0 22 20 44 48 45c-15 39 -65 46 -90 46c-88 0 -112 -61 -112 -90c0 -45 40 -52 76 -60c44 -9 73 -14 100 -42c12 -12 31 -37 31 -73c0 -45 -39 -166 -201 -166c-86 0 -143 40 -143 97c0 45 30 66 56 66c21 0 37 -12 37 -35 c0 -28 -25 -58 -63 -53c23 -53 100 -53 114 -53c120 0 143 84 143 110c0 55 -52 66 -104 76c-29 6 -103 21 -103 99c0 44 37 146 169 146c76 0 119 -41 119 -86Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-71" x="0" y="0"></use>
<g transform="translate(528,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D460" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="469" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1248" y="0"></use>
</g>
</g>
</svg></span>&gt;&gt;, is not included here. It is analogous except that it
does not require a similar special case for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.101ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2196.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1695" y="0"></use>
</g>
</svg>.

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#InfiniteAreaLightsandBDPT"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:bdpt-infinite"></span><span id="InfiniteAreaLightsandBDPT"></span><h3>16.3.5  Infinite Area Lights and BDPT</h3><p>



</p>
<p>The infinite area light, first introduced in
Section&nbsp;<a href="../Light_Sources/Infinite_Area_Lights.html#sec:infinite-area-lights">12.6</a>, provides a convenient way of
illuminating scenes with realistic captured illumination. Unfortunately,
its definition as an infinitely distant directional source turns out to be
rather difficult to reconcile with BDPT&rsquo;s path integral formulation, which
expresses probabilities in terms of area densities, which in turn requires
finite-sized emitting surfaces.

</p>
<p>Through some gymnastics, we could represent infinite area lights with
finite shapes. For example, an infinite area light&rsquo;s radiance emission
distribution could be described by a large emitting sphere that surrounded
the scene, where the directional distribution of emitted radiance at each
point on the interior of the sphere was the same as the infinite area
light&rsquo;s emitted radiance for the same direction. This approach would
require a significantly more complex implementation of
<a href="../Light_Sources/Infinite_Area_Lights.html#InfiniteAreaLight"><tt>InfiniteAreaLight</tt></a> with no practical benefits apart from BDPT
compatibility.

</p>
<p>Instead of changing the functionality of <a href="../Light_Sources/Infinite_Area_Lights.html#InfiniteAreaLight"><tt>InfiniteAreaLight</tt></a>, we will
instead make infinite area lights a special case in BDPT. Since
illumination from these lights is most naturally integrated over solid angles, our
approach will be to add support for solid angle integration to the vertex
abstraction layer. In practice, scenes may contain multiple infinite area
lights; we will follow the convention of treating them as one combined
light when evaluating the emitted radiance or determining sample
probabilities.

</p>
<p>First, we will create a special endpoint vertex any time a camera path ray escapes
the scene.  The &lt;&lt;<span class="fragmentname"><a href="#fragment-Captureescapedrayswhentracingfromthecamera-0">Capture escaped rays when tracing from the
camera</a></span>&gt;&gt; fragment is invoked by <a href="#RandomWalk"><tt>RandomWalk()</tt></a> whenever no surface
intersection could be found while generating the camera subpath. In the
implementation of the <a href="#Vertex::CreateLight"><tt>Vertex::CreateLight()</tt></a> method called here,
the <tt>pdfFwd</tt> variable recording the probability per unit solid angle
is stored directly in <tt>Vertex::pdfFwd</tt> without conversion by
<a href="#Vertex::ConvertDensity"><tt>Vertex::ConvertDensity()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Captureescapedrayswhentracingfromthecamera-0"></span><div class="fragmentname">&lt;&lt;Capture escaped rays when tracing from the camera&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (mode == <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#TransportMode::Radiance" class="code">TransportMode</a>::Radiance) {
    vertex = <a href="#Vertex::CreateLight" class="code">Vertex</a>::CreateLight(EndpointInteraction(ray), beta,
                                 pdfFwd);
    ++bounces;
}</div><p>


</p>
<p>

</p>
<p>The existence of light vertices on the camera subpath leads to certain
nonsensical connection strategies. For instance, we couldn&rsquo;t possibly connect a
light vertex on the camera subpath to another vertex on the light subpath. The
following check in <a href="#ConnectBDPT"><tt>ConnectBDPT()</tt></a> detects and ignores
such connection attempts.
    
</p>
<span class="anchor" id="fragment-Ignoreinvalidconnectionsrelatedtoinfinitearealights-0"></span><div class="fragmentname">&lt;&lt;Ignore invalid connections related to infinite area lights&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (t &gt; 1 &amp;&amp; s != 0 &amp;&amp; cameraVertices[t - 1].<a href="#Vertex::type" class="code">type</a> == <a href="#VertexType::Light" class="code">VertexType</a>::<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>)
    return <a href="../Color_and_Radiometry/Spectral_Representation.html#Spectrum" class="code">Spectrum</a>(0.f);</div><p>


</p>
<p>Some parts of the code may still attempt to invoke <tt>ConvertDensity()</tt>
with a <tt>next</tt> <a href="#Vertex"><tt>Vertex</tt></a> that refers to an infinite area light. The
following fragment detects this case at the beginning of
<tt>ConvertDensity()</tt> and directly returns the supplied solid angle
density without conversion in that case.

</p>
<p></p>
<span class="anchor" id="fragment-Returnsolidangledensityifmononextisaninfinitearealight-0"></span><div class="fragmentname">&lt;&lt;Return solid angle density if <tt>next</tt> is an infinite area light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (next.<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>())
    return pdf;</div><p>


</p>
<p>Next, we need to adapt the light subpath sampling routine to correct the
probability values returned by the ray sampling function
<a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#InfiniteAreaLight::Sample_Le"><tt>InfiniteAreaLight::Sample_Le()</tt></a>. This case is detected in an additional
fragment at the end of <a href="#GenerateLightSubpath"><tt>GenerateLightSubpath()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Correctsubpathsamplingdensitiesforinfinitearealights-0"></span><div class="fragmentname">&lt;&lt;Correct subpath sampling densities for infinite area lights&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (path[0].<a href="#Vertex::IsInfiniteLight" class="code">IsInfiniteLight</a>()) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Setspatialdensityofmonopath1forinfinitearealight-0">Set spatial density of <tt>path[1]</tt> for infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1820" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1820"><i></i></a><div id="fragbit-1820" class="collapse"><div class="fragmentcode">       if (nVertices &gt; 0) {
           path[1].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> = pdfPos;
           if (path[1].<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
               path[1].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(ray.d, path[1].<a href="#Vertex::ng" class="code">ng</a>());
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Setspatialdensityofmonopath0forinfinitearealight-0">Set spatial density of <tt>path[0]</tt> for infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1821" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1821"><i></i></a><div id="fragbit-1821" class="collapse"><div class="fragmentcode">       path[0].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> = <a href="#InfiniteLightDensity" class="code">InfiniteLightDensity</a>(scene, lightDistr, ray.d);</div></div>
}</div><p>


</p>
<p>Recall that <a href="../Light_Transport_III_Bidirectional_Methods/The_Path-Space_Measurement_Equation.html#InfiniteAreaLight::Sample_Le"><tt>InfiniteAreaLight::Sample_Le()</tt></a> samples a ray direction (with a
corresponding density <tt>pdfDir</tt>) and a ray origin on a perpendicular disk
(with a corresponding density <tt>pdfPos</tt>) that touches the scene&rsquo;s bounding
sphere. Due to foreshortening, the resulting ray has a corresponding spatial
density of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.98ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 6019 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">monospace p monospace d monospace f monospace upper P monospace o monospace s StartAbsoluteValue cosine theta EndAbsoluteValue</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D699" d="M488 216c0 -127 -97 -222 -206 -222c-32 0 -75 9 -116 51v-206h44c16 0 41 0 41 -31c0 -30 -26 -30 -40 -30h-159c-14 0 -40 0 -40 30c0 31 25 31 41 31h44v531h-45c-14 0 -40 0 -40 30c0 31 25 31 41 31h73c38 0 40 -14 40 -43c34 31 79 49 127 49 c106 0 195 -98 195 -221zM419 216c0 87 -58 160 -132 160c-63 0 -121 -53 -121 -112v-73c0 -48 35 -136 113 -136c70 0 140 65 140 161Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D68D" d="M512 31c0 -31 -25 -31 -41 -31h-73c-40 0 -40 14 -40 50c-28 -29 -70 -56 -126 -56c-106 0 -196 97 -196 221c0 127 96 222 205 222c43 0 84 -16 117 -45v158h-45c-14 0 -40 0 -40 30c0 31 25 31 41 31h73c34 0 40 -10 40 -41v-509h45c14 0 40 0 40 -30zM358 194v71 c0 55 -49 111 -113 111c-70 0 -140 -65 -140 -161c0 -89 60 -160 131 -160c77 0 122 83 122 139Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D68F" d="M437 557c0 -28 -23 -44 -43 -44c-35 0 -44 39 -44 43c-30 0 -97 0 -97 -78v-47h122c16 0 40 0 40 -31c0 -30 -25 -30 -40 -30h-122v-309h101c15 0 41 0 41 -31c0 -30 -26 -30 -41 -30h-271c-15 0 -41 0 -41 31c0 30 26 30 41 30h101v309h-101c-15 0 -40 0 -40 30 c0 31 25 31 41 31h100v53c0 87 77 133 157 133c16 0 96 0 96 -60Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D67F" d="M480 428c0 -93 -73 -183 -189 -183h-125v-184h30c15 0 41 0 41 -31c0 -30 -26 -30 -41 -30h-129c-15 0 -41 0 -41 30c0 31 25 31 41 31h30v489h-30c-15 0 -41 0 -41 31c0 30 26 30 41 30h224c115 0 189 -90 189 -183zM411 428c0 53 -43 122 -139 122h-106v-244h106 c96 0 139 69 139 122Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D698" d="M467 216c0 -126 -95 -222 -205 -222s-205 95 -205 222c0 125 93 224 205 224s205 -99 205 -224zM398 223c0 91 -64 156 -136 156c-71 0 -136 -65 -136 -156c0 -93 62 -168 136 -168s136 75 136 168Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D69C" d="M459 125c0 -48 -32 -131 -190 -131c-28 0 -81 2 -130 38c-12 -37 -28 -38 -37 -38c-30 0 -30 25 -30 41v97c0 20 0 41 35 41c26 0 30 -11 35 -29c25 -78 81 -89 128 -89c91 0 128 33 128 70c0 53 -80 66 -129 74c-92 14 -197 31 -197 123c0 36 23 118 190 118 c19 0 63 0 107 -21c2 7 6 21 30 21c30 0 30 -25 30 -41v-69c0 -20 0 -41 -35 -41c-31 0 -33 17 -34 34c-3 26 -17 56 -100 56c-95 0 -127 -31 -127 -57c0 -39 68 -51 97 -55l68 -12c32 -5 161 -26 161 -130Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D699" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D68D" x="525" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D68F" x="1051" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D67F" x="1576" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D698" x="2102" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D69C" x="2627" y="0"></use>
<g transform="translate(3486,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="1784" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="2254" y="0"></use>
</g>
</g>
</svg> at its first intersection with the
scene geometry, where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 469.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
</g>
</svg> is the angle between <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.686ex" height="3.343ex" style="vertical-align: -1.171ex;" viewBox="0 -934.9 2878.6 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">monospace r monospace a monospace y monospace period monospace d</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D69B" d="M487 375c0 -27 -20 -43 -42 -43c-25 0 -42 20 -43 44c-121 0 -180 -96 -180 -190v-125h111c15 0 41 0 41 -31c0 -30 -26 -30 -41 -30h-261c-16 0 -40 0 -40 31c0 30 25 30 40 30h81v309h-81c-16 0 -40 0 -40 31c0 30 25 30 40 30h110c34 0 40 -10 40 -41v-34 c55 63 119 81 170 81c83 0 95 -42 95 -62Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D68A" d="M519 31c0 -31 -22 -31 -50 -31c-38 0 -86 1 -108 32c-47 -31 -109 -38 -146 -38c-102 0 -165 65 -165 134c0 96 123 146 300 149c0 71 -52 102 -128 102c-9 0 -22 0 -36 -1c-20 -2 -21 -3 -21 -11c-1 -37 -29 -46 -44 -46c-24 0 -45 16 -45 46c0 73 102 73 145 73 c144 0 198 -84 198 -155v-216c8 -3 18 -8 60 -8c15 0 40 0 40 -30zM350 134v84c-145 -4 -231 -41 -231 -90c0 -39 41 -73 103 -73c8 0 53 0 89 17c39 18 39 39 39 62Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D6A2" d="M500 400c0 -30 -25 -30 -40 -30h-30l-155 -455c-4 -11 -49 -143 -149 -143c-49 0 -83 40 -83 82c0 26 17 44 44 44c25 0 43 -18 43 -43c0 -13 -5 -22 -5 -22c15 1 51 3 80 58c13 25 38 109 38 109s0 3 -4 13l-142 357h-31c-15 0 -40 0 -40 30c0 31 24 31 40 31h117 c16 0 40 0 40 -31c0 -30 -25 -30 -40 -30h-25l93 -240c7 -19 16 -40 21 -59h1c7 31 13 49 26 86l72 213h-28c-16 0 -40 0 -40 31c0 30 25 30 40 30h117c16 0 40 0 40 -31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMONOSPACE-1D68D" d="M512 31c0 -31 -25 -31 -41 -31h-73c-40 0 -40 14 -40 50c-28 -29 -70 -56 -126 -56c-106 0 -196 97 -196 221c0 127 96 222 205 222c43 0 84 -16 117 -45v158h-45c-14 0 -40 0 -40 30c0 31 25 31 41 31h73c34 0 40 -10 40 -41v-509h45c14 0 40 0 40 -30zM358 194v71 c0 55 -49 111 -113 111c-70 0 -140 -65 -140 -161c0 -89 60 -160 131 -160c77 0 122 83 122 139Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D69B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D68A" x="525" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D6A2" x="1051" y="0"></use>
<g transform="translate(1576,0)">
<text font-family="monospace" stroke="none" transform="scale(71.759) matrix(1 0 0 -1 0 0)">.</text>
</g>
 <use xlink:href="#E1-LATINMODERNMONOSPACE-1D68D" x="2353" y="0"></use>
</g>
</svg> and the
geometric normal.

</p>
<p></p>
<span class="anchor" id="fragment-Setspatialdensityofmonopath1forinfinitearealight-0"></span><div class="fragmentname">&lt;&lt;Set spatial density of <tt>path[1]</tt> for infinite area light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (nVertices &gt; 0) {
    path[1].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> = pdfPos;
    if (path[1].<a href="#Vertex::IsOnSurface" class="code">IsOnSurface</a>())
        path[1].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> *= <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(ray.d, path[1].<a href="#Vertex::ng" class="code">ng</a>());
}</div><p>


</p>
<p>Following our new convention, the spatial density of infinite area light
endpoints is now expressed as a probability per unit solid angle. We will
create a helper function <a href="#InfiniteLightDensity"><tt>InfiniteLightDensity()</tt></a> that determines this
value while also accounting for the presence of other infinite area lights.

</p>
<p></p>
<span class="anchor" id="fragment-Setspatialdensityofmonopath0forinfinitearealight-0"></span><div class="fragmentname">&lt;&lt;Set spatial density of <tt>path[0]</tt> for infinite area light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">path[0].<a href="#Vertex::pdfFwd" class="code">pdfFwd</a> = <a href="#InfiniteLightDensity" class="code">InfiniteLightDensity</a>(scene, lightDistr, ray.d);</div><p>


</p>
<p>This function performs a weighted sum of the directional densities of all
infinite area lights using the light probabilities in <tt>lightDistr</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-BDPTHelperDefinitions-2"></span><div class="fragmentname">&lt;&lt;BDPT Helper Definitions&gt;&gt;+=&nbsp;<a href="#fragment-BDPTHelperDefinitions-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">inline Float <span class="anchor" id="InfiniteLightDensity"></span>InfiniteLightDensity(const <a href="../Introduction/pbrt_System_Overview.html#Scene" class="code">Scene</a> &amp;scene,
        const Distribution1D &amp;<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::func" class="code">lightDistr</a>, const <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> &amp;w) {
    Float pdf = 0;
    for (size_t i = 0; i &lt; scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>.size(); ++i) 
        if (scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[i]-&gt;<a href="../Light_Sources/Light_Interface.html#Light::flags" class="code">flags</a> &amp; (int)<a href="../Light_Sources/Light_Interface.html#LightFlags" class="code">LightFlags</a>::Infinite)
            pdf += scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::lights" class="code">lights</a>[i]-&gt;<a href="../Light_Transport_I_Surface_Reflection/Sampling_Light_Sources.html#Light::Pdf_Li" class="code">Pdf_Li</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(), -w) *
                   <a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::func" class="code">lightDistr</a>.func[i];
    return pdf / (<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::func" class="code">lightDistr</a>.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::funcInt" class="code">funcInt</a> * <a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::func" class="code">lightDistr</a>.<a href="../Monte_Carlo_Integration/Sampling_Random_Variables.html#Distribution1D::Count" class="code">Count</a>());
}</div><p>


</p>
<p>The remaining two changes are analogous and address the probability
computation in the <tt>PdfLightOrigin()</tt> and <tt>PdfLight()</tt>
methods. For the former, we similarly return the combined solid angle
density when an infinite area light is detected.

</p>
<p></p>
<span class="anchor" id="fragment-Returnsolidangledensityforinfinitelightsources-0"></span><div class="fragmentname">&lt;&lt;Return solid angle density for infinite light sources&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">return <a href="#InfiniteLightDensity" class="code">InfiniteLightDensity</a>(scene, lightDistr, w);</div><p>


</p>
<p>In <tt>PdfLight()</tt>, we compute the probability of sampling a ray origin on a
disk whose radius is equal to the scene&rsquo;s bounding sphere. The remainder of
<tt>PdfLight()</tt> already accounts for the necessary cosine foreshortening
factor; hence we do not need to multiply by it here.

</p>
<p></p>
<span class="anchor" id="fragment-Computeplanarsamplingdensityforinfinitelightsources-0"></span><div class="fragmentname">&lt;&lt;Compute planar sampling density for infinite light sources&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> worldCenter;
Float worldRadius;
scene.<a href="../Introduction/pbrt_System_Overview.html#Scene::WorldBound" class="code">WorldBound</a>().<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::BoundingSphere" class="code">BoundingSphere</a>(&amp;worldCenter, &amp;worldRadius);
pdf = 1 / (Pi * worldRadius * worldRadius);</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
  <div class="container-fluid-nav">
    <!--  <ul class="nav navbar-nav navbar-center"> -->
      <span class="navbar-text" style="text-align: center;">
        Thanks to Aras Pranckevicius and 43 others for generously supporting <i>Physically
        Based Rendering</i> online
        through <a href="https://patreon.com/pbrbook">Patreon</a>.
    </span>
  </div>
</nav>

<nav class="navbar navbar-expand-md bg-light navbar-light">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>, &copy; 2004-2021 Matt Pharr, Wenzel Jakob, and Greg Humphreys under the <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a> license. (<a href="https://github.com/mmp/pbr-book-website/">github</a>)</span>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Light_Transport_III_Bidirectional_Methods/Metropolis_Light_Transport.html">Light Transport III: Bidirectional Methods / Metropolis Light Transport</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
